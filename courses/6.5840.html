<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.26" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.102" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"MIT 6.5840 åˆ†å¸ƒå¼ç³»ç»Ÿ","image":[""],"dateModified":"2026-02-13T06:35:50.000Z","author":[{"@type":"Person","name":"yedou","url":"https://yedou37.github.io"}]}</script><meta property="og:url" content="https://yedou37.github.io/courses/6.5840.html"><meta property="og:site_name" content="Yedou's Notebook"><meta property="og:title" content="MIT 6.5840 åˆ†å¸ƒå¼ç³»ç»Ÿ"><meta property="og:description" content="MapReduce è¦æŠŠå¤§è±¡è£…å†°ç®±ï¼ˆå¤„ç† PB çº§æ•°æ®ï¼‰ï¼Œåˆ†ä¸‰æ­¥ï¼š Split (åˆ‡åˆ†): æŠŠå¤§æ–‡ä»¶åˆ‡æˆæ— æ•°ä¸ª 64MB çš„å°å— (Input Splits)ã€‚ Map (æ˜ å°„): æŠŠå°å—è½¬åŒ–æˆ <Key, Value> å¯¹ã€‚ Reduce (å½’çº¦): æŠŠç›¸åŒ Key çš„æ•°æ®èšåœ¨ä¸€èµ·å¤„ç†ã€‚ åœºæ™¯ï¼š ç»Ÿè®¡å•è¯é¢‘ç‡ (Word Count)ã€‚ Map é˜¶æ®µ..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2026-02-13T06:35:50.000Z"><meta property="article:modified_time" content="2026-02-13T06:35:50.000Z"><link rel="icon" href="/logo.jpg"><title>MIT 6.5840 åˆ†å¸ƒå¼ç³»ç»Ÿ | Yedou's Notebook</title><meta name="description" content="MapReduce è¦æŠŠå¤§è±¡è£…å†°ç®±ï¼ˆå¤„ç† PB çº§æ•°æ®ï¼‰ï¼Œåˆ†ä¸‰æ­¥ï¼š Split (åˆ‡åˆ†): æŠŠå¤§æ–‡ä»¶åˆ‡æˆæ— æ•°ä¸ª 64MB çš„å°å— (Input Splits)ã€‚ Map (æ˜ å°„): æŠŠå°å—è½¬åŒ–æˆ <Key, Value> å¯¹ã€‚ Reduce (å½’çº¦): æŠŠç›¸åŒ Key çš„æ•°æ®èšåœ¨ä¸€èµ·å¤„ç†ã€‚ åœºæ™¯ï¼š ç»Ÿè®¡å•è¯é¢‘ç‡ (Word Count)ã€‚ Map é˜¶æ®µ...">
    <link rel="preload" href="/assets/style-CVnMh6PC.css" as="style"><link rel="stylesheet" href="/assets/style-CVnMh6PC.css">
    <link rel="modulepreload" href="/assets/app-DErs339O.js"><link rel="modulepreload" href="/assets/6.5840.html-DtnVzopv.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container no-navbar external-link-icon has-toc" vp-container><!----><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/" aria-label="æˆ‘çš„ç¬”è®°åº“"><!---->æˆ‘çš„ç¬”è®°åº“<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="vp-icon" icon="fa6-solid:folder-open" sizing="both" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">åŸºç¡€çŸ¥è¯†æ¦‚è§ˆ</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><iconify-icon class="vp-icon" icon="fa6-solid:folder-open" sizing="both" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">è¯¾ç¨‹ç¬”è®°æ¦‚è§ˆ</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/courses/CS144.html" aria-label="CS144è®¡ç®—æœºç½‘ç»œ"><!---->CS144è®¡ç®—æœºç½‘ç»œ<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/courses/6.5840.html" aria-label="MIT 6.5840 åˆ†å¸ƒå¼ç³»ç»Ÿ"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:share-2" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->MIT 6.5840 åˆ†å¸ƒå¼ç³»ç»Ÿ<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><iconify-icon class="vp-icon" icon="fa6-solid:share-2" sizing="height" height="1em"></iconify-icon>MIT 6.5840 åˆ†å¸ƒå¼ç³»ç»Ÿ</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://yedou37.github.io" target="_blank" rel="noopener noreferrer">yedou</a></span><span property="author" content="yedou"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2026/1/28</span><meta property="datePublished" content="2026-01-28T11:28:32.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 39 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT39M"></span><!----><!----></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><hr><h1 id="mapreduce" tabindex="-1"><a class="header-anchor" href="#mapreduce"><span>MapReduce</span></a></h1><p>è¦æŠŠå¤§è±¡è£…å†°ç®±ï¼ˆå¤„ç† PB çº§æ•°æ®ï¼‰ï¼Œåˆ†ä¸‰æ­¥ï¼š</p><ol><li><strong>Split (åˆ‡åˆ†):</strong>Â æŠŠå¤§æ–‡ä»¶åˆ‡æˆæ— æ•°ä¸ª 64MB çš„å°å— (Input Splits)ã€‚</li><li><strong>Map (æ˜ å°„):</strong>Â æŠŠå°å—è½¬åŒ–æˆÂ &lt;Key, Value&gt;Â å¯¹ã€‚</li><li><strong>Reduce (å½’çº¦):</strong>Â æŠŠç›¸åŒ Key çš„æ•°æ®èšåœ¨ä¸€èµ·å¤„ç†ã€‚</li></ol><ul><li><p><strong>åœºæ™¯ï¼š</strong>Â ç»Ÿè®¡å•è¯é¢‘ç‡ (Word Count)ã€‚</p></li><li><p><strong>Map é˜¶æ®µï¼š</strong></p><ul><li>Worker A è¯»æ–‡ä»¶ 1ï¼Œå‘ç° &quot;Apple&quot;ï¼Œè¾“å‡ºÂ &lt;Apple, 1&gt;ã€‚</li><li>Worker B è¯»æ–‡ä»¶ 2ï¼Œå‘ç° &quot;Apple&quot;ï¼Œè¾“å‡ºÂ &lt;Apple, 1&gt;ã€‚</li><li><strong>é—®é¢˜ï¼š</strong>Â è¿™ä¸¤ä¸ªÂ &lt;Apple, 1&gt;Â åˆ†æ•£åœ¨ä¸åŒæœºå™¨ä¸Šï¼ŒReduce æ€ä¹ˆæ±‚å’Œï¼Ÿ</li></ul></li><li><p><strong>Partitioning (åˆ†åŒº):</strong></p><ul><li>ç³»ç»Ÿé¢„å…ˆè§„å®šï¼šhash(&quot;Apple&quot;) % nReduceã€‚å‡è®¾ç»“æœæ˜¯ 0ã€‚</li><li>æ‰€æœ‰ Worker éƒ½çŸ¥é“ï¼šåªè¦é‡åˆ° &quot;Apple&quot;ï¼Œå°±æ‰”è¿›Â <strong>0 å·æ¡¶</strong>ã€‚</li><li>åªè¦é‡åˆ° &quot;Banana&quot;ï¼Œå°±æ‰”è¿›Â <strong>1 å·æ¡¶</strong>ã€‚</li></ul></li><li><p><strong>Shuffle é˜¶æ®µï¼š</strong></p><ul><li>Reduce Worker 0 å¯åŠ¨æ—¶ï¼Œå®ƒä¼šå»<strong>æ‰€æœ‰</strong>Â Map Worker é‚£é‡Œï¼ŒæŠŠÂ <strong>0 å·æ¡¶</strong>Â çš„æ•°æ®å…¨éƒ¨æ‹‰è¿‡æ¥ã€‚</li><li>è¿™æ ·ï¼Œæ‰€æœ‰çš„ &quot;Apple&quot; æœ€ç»ˆéƒ½ä¼šæ±‡èšåˆ° Reduce Worker 0 æ‰‹é‡Œã€‚</li></ul></li><li><p><strong>Coordinator (ä»¥å‰å« Master):</strong></p><ul><li><strong>æ•°é‡ï¼šåªæœ‰ 1 ä¸ªè¿›ç¨‹ã€‚</strong></li><li><strong>èº«ä»½ï¼š</strong>Â æ€»åŒ…å·¥å¤´ã€å¤§ç®¡å®¶ã€‚</li><li><strong>èŒè´£ï¼š</strong>Â å®ƒä¸å¹²ç´¯æ´»ï¼ˆä¸è¯»å†™æ•°æ®ï¼‰ï¼Œåªè´Ÿè´£<strong>åˆ†é…ä»»åŠ¡</strong>ã€<strong>è®°è´¦</strong>ï¼ˆè°åœ¨å¹²ä»€ä¹ˆã€å¹²å®Œæ²¡æœ‰ï¼‰å’Œ<strong>è®¡æ—¶</strong>ï¼ˆè°è¶…æ—¶äº†ï¼‰ã€‚</li></ul></li><li><p><strong>Worker:</strong></p><ul><li><strong>æ•°é‡ï¼šN ä¸ªè¿›ç¨‹ (ç”±ä½ å†³å®š)ã€‚</strong></li><li>åœ¨æµ‹è¯•è„šæœ¬ä¸­ï¼Œé€šå¸¸ä¼šå¯åŠ¨ 3~5 ä¸ª Worker è¿›ç¨‹å¹¶å‘è·‘ã€‚</li><li><strong>èº«ä»½ï¼š</strong>Â é€šç”¨æ‰“å·¥äººã€‚</li><li><strong>èŒè´£ï¼š</strong>Â ä¹Ÿå°±æ˜¯ä½ å†™çš„Â worker.goã€‚å®ƒå¯åŠ¨åä¼šæ˜¯ä¸ªæ­»å¾ªç¯ï¼Œä¸æ–­é—® Coordinatorï¼šâ€œè€æ¿ï¼Œç°åœ¨æœ‰å•¥æ´»ï¼Ÿâ€ <ul><li>å¦‚æœå¤„äº Map é˜¶æ®µï¼ŒCoordinator ä¼šç»™å®ƒæ´¾ Map ä»»åŠ¡ã€‚</li><li>å¦‚æœ Map é˜¶æ®µå…¨ç»“æŸäº†ï¼ŒCoordinator ä¼šç»™å®ƒæ´¾ Reduce ä»»åŠ¡ã€‚</li><li><strong>Worker è‡ªå·±ä¸çŸ¥é“ä¹Ÿä¸å…³å¿ƒç°åœ¨çš„é˜¶æ®µï¼Œå®ƒåªå¬å‘½è¡Œäº‹ã€‚</strong></li></ul></li></ul></li></ul><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>[ åªæœ‰ 1 ä¸ªè¿›ç¨‹ ]</span></span>
<span class="line"><span>      +-----------------+</span></span>
<span class="line"><span>      |   Coordinator   | &lt;---- ä¿å­˜ç€ä»»åŠ¡è¡¨ (Excel)</span></span>
<span class="line"><span>      +-----------------+       1. Mapä»»åŠ¡çŠ¶æ€: [Done, Idle, InProgress...]</span></span>
<span class="line"><span>         ^   ^   ^   |          2. Reduceä»»åŠ¡çŠ¶æ€: [Idle, Idle...]</span></span>
<span class="line"><span>         :   :   :   |</span></span>
<span class="line"><span>(RPCè°ƒç”¨):   :   :   | (RPCå›å¤: &quot;å»åš Mapä»»åŠ¡ #3&quot;)</span></span>
<span class="line"><span>&quot;æ±‚æ´¾æ´»&quot; :   :   :   |</span></span>
<span class="line"><span>         :   :   :   v</span></span>
<span class="line"><span>      +-----------+   +-----------+   +-----------+</span></span>
<span class="line"><span>      | Worker A  |   | Worker B  |   | Worker C  |  &lt;--- N ä¸ªè¿›ç¨‹</span></span>
<span class="line"><span>      +-----------+   +-----------+   +-----------+</span></span>
<span class="line"><span>            |               |               |</span></span>
<span class="line"><span>   (1) è¯»å–è¾“å…¥æ–‡ä»¶     (1) è¯»å–è¾“å…¥    (å¯èƒ½æ˜¯é—²ç½®</span></span>
<span class="line"><span>       pg-xx.txt        pg-yy.txt      æˆ–æ­£åœ¨å¤„ç†)</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>      [æ‰§è¡Œ MapF]      [æ‰§è¡Œ MapF]</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>   (2) ç”Ÿæˆä¸­é—´æ–‡ä»¶     (2) ç”Ÿæˆä¸­é—´æ–‡ä»¶</span></span>
<span class="line"><span>       mr-3-0          mr-4-0</span></span>
<span class="line"><span>       mr-3-1          mr-4-1</span></span>
<span class="line"><span>       ...             ...</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>            +---------------+</span></span>
<span class="line"><span>                    |</span></span>
<span class="line"><span>      -------------------------------------</span></span>
<span class="line"><span>      |    W A I T   (åŒæ­¥å±éšœ)           |  &lt;--- Mapå…¨éƒ¨åšå®Œæ‰èƒ½è¿›ä¸‹ä¸€æ­¥</span></span>
<span class="line"><span>      -------------------------------------</span></span>
<span class="line"><span>                    |</span></span>
<span class="line"><span>      +-----------+   +-----------+</span></span>
<span class="line"><span>      | Worker A  |   | Worker B  |  &lt;--- è¿˜æ˜¯é‚£æ‰¹äººï¼Œç°åœ¨è½¬èŒåš Reduce</span></span>
<span class="line"><span>      +-----------+   +-----------+</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>   (3) è¯»å–ä¸­é—´æ–‡ä»¶     (3) è¯»å–ä¸­é—´æ–‡ä»¶</span></span>
<span class="line"><span>       æ‰€æœ‰ mr-*-0      æ‰€æœ‰ mr-*-1</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>      [æ‰§è¡Œ ReduceF]   [æ‰§è¡Œ ReduceF]</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>   (4) å†™æœ€ç»ˆç»“æœ       (4) å†™æœ€ç»ˆç»“æœ</span></span>
<span class="line"><span>       mr-out-0         mr-out-1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¯¹äºworker-æ—¢è¦æ‰§è¡Œmap-reduce-ä»»åŠ¡-ä¹Ÿè¦å‘coordinatorå‘é€å¿ƒè·³åŒ…" tabindex="-1"><a class="header-anchor" href="#å¯¹äºworker-æ—¢è¦æ‰§è¡Œmap-reduce-ä»»åŠ¡-ä¹Ÿè¦å‘coordinatorå‘é€å¿ƒè·³åŒ…"><span>å¯¹äºworker æ—¢è¦æ‰§è¡Œmap reduce ä»»åŠ¡ ä¹Ÿè¦å‘coordinatorå‘é€å¿ƒè·³åŒ…</span></a></h3><h4 id="ä½¿ç”¨ä¸¤ä¸ªgoruntimes" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨ä¸¤ä¸ªgoruntimes"><span>ä½¿ç”¨ä¸¤ä¸ªgoruntimes</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// åˆ›å»ºä¸€ä¸ªchannelç”¨äºé€šçŸ¥å¿ƒè·³goroutineä»»åŠ¡å·²å®Œæˆ</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	doneChan</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> make</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">chan</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// å¯åŠ¨å¿ƒè·³goroutine</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	go</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			case</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">doneChan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				// workeré€€å‡º</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				return</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			case</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">After</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">): </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// æ¯ç§’å‘é€ä¸€æ¬¡å¿ƒè·³</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">				SendHeartbeat</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å•ç‹¬ä¸€ä¸ªçº¿ç¨‹ å®šæ—¶å‘é€å¿ƒè·³åŒ… å¦‚æœæ”¶åˆ°doneChançš„è¯å°±é€€å‡º è¿™ä¸ªchennelæ˜¯åŸæ¥çš„çº¿ç¨‹ä¸å¿ƒè·³åŒ…çº¿ç¨‹è¿›è¡Œé€šä¿¡çš„é€šé“</p><h3 id="å¹¶è¡Œmap-reduceçš„ç»“æœæ€»æ˜¯å°äºçº¿æ€§-map-reduce" tabindex="-1"><a class="header-anchor" href="#å¹¶è¡Œmap-reduceçš„ç»“æœæ€»æ˜¯å°äºçº¿æ€§-map-reduce"><span>å¹¶è¡Œmap reduceçš„ç»“æœæ€»æ˜¯å°äºçº¿æ€§ map reduce</span></a></h3><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yet </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">365</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yet </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">383</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21617</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22072</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yielded </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">9</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yielded </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">12</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21623</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">a22079</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yoked </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21625</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22081</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yonder </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">31</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yonder </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">33</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21627</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21630</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22083</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">22086</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> you </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6270</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> young </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">321</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> younger </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">31</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youngest </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> you </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">7005</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> young </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">365</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> younger </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">36</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youngest </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">28</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21632</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22088</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> your </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1305</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> your </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1477</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21634</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21637</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22090</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">22093</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yours </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourself </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">155</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourselves </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">11</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youth </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">61</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yours </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">34</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourself </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">172</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourselves </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">14</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youth </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">105</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21650</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22106</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è™½ç„¶æˆ‘æœ€åˆåœ¨æ‰€æœ‰coordinatorçš„æ–¹æ³•ä¸Šéƒ½åŠ äº†å¤§é” ä½†æ˜¯è¿˜æ˜¯å‡ºç°äº†æ•°æ®ä¸¢å¤±çš„é—®é¢˜ å¯ä»¥çœ‹å‡ºï¼šç»“æœæ•°æ®å‡å°äºåº”æœ‰çš„æ•°å­—</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			// worker is not busy ask for a task</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">			RequestTask</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">worker)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">has_work_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">				time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				continue</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">is_reduce_task_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">										// map task</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				file, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> os</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Open</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> err </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nil {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Fatalf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cannot open %v&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				content, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ioutil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ReadAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(file)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> err </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nil {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Fatalf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cannot read %v&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">				file</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				//fmt.Println(string(content[0:20]))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">				kva</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> mapf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">string</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(content))</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">				TaskDone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">worker)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">can_write_files_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">					// abort all tasks</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">					//log.Println(&quot;abort&quot;)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">					continue</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				// write to files</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				//log.Println(&quot;mid write to files&quot;)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">				ofiles</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> []*os.File{}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nReduce_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">); i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">					file_name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;mr-mid-&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> strconv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Itoa</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_id_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;-&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> strconv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Itoa</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(i)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">					ofile, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> os</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Create</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(file_name)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">					ofiles </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> append</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(ofiles, ofile)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> _, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> range kva { </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					fmt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Fprintf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">ofiles</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ihash</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">%</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nReduce_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)], </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;%v %v</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				} 	</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> _, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">ofile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> range ofiles {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					ofile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç›®å‰ä¸ºäº†å®ç°aborté€»è¾‘ æˆ‘é€‰æ‹©äº† å…ˆå®Œæˆmapæˆ–è€…reduceä»»åŠ¡ ç„¶åé€šçŸ¥coordinator å¦‚æœcoordinatorè®¤å®šäº†è¿™ä¸ªworkerå°±æ˜¯åº”è¯¥å®Œæˆæ“ä½œçš„workerï¼ˆä¸æ˜¯ä¹‹å‰è¢«æ”¾å¼ƒçš„â€”â€”ä»»åŠ¡å·²ç»åˆ†é…ç»™åˆ«äººäº†ï¼‰é‚£ä¹ˆå°±èƒ½å†™æ–‡ä»¶ ä½†æ˜¯è¿™é‡Œå‡ºç°äº†ç«æ€æ¡ä»¶ å¯¹äºcoordinator ä»–è®¤ä¸ºä»»åŠ¡å®Œæˆäº† ä½†æ˜¯å…¶å®æ–‡ä»¶è¿˜æ²¡æœ‰çœŸæ­£è¢«å†™å®Œ å¦‚æœè¿™ä¸ªæ—¶å€™è¿›å…¥reduce é‚£ä¹ˆå°±ä¼šè¯»å–è¿˜æ²¡æœ‰å®Œå…¨å†™å®Œçš„è„æ•°æ® å¯¼è‡´æœ€åç»Ÿè®¡ç»“æœåå°</p><p><strong>Worker å‘Šè¯‰ Coordinator &quot;æˆ‘åšå®Œäº†&quot; å’Œ Worker &quot;å®é™…æŠŠæ•°æ®è½ç›˜&quot; ä¹‹é—´çš„æ—¶é—´å·®</strong> å¯¼è‡´äº†<strong>æ—¶åºé”™ä¹±</strong></p><h4 id="è§£å†³æ–¹æ³•-ä½¿ç”¨åŸå­æ–‡ä»¶é‡å‘½å" tabindex="-1"><a class="header-anchor" href="#è§£å†³æ–¹æ³•-ä½¿ç”¨åŸå­æ–‡ä»¶é‡å‘½å"><span>è§£å†³æ–¹æ³• ä½¿ç”¨åŸå­æ–‡ä»¶é‡å‘½å</span></a></h4><p>os.Rename(&quot;tmp-mr-out-1&quot;, &quot;mr-out-1&quot;)Â (è¿™æ˜¯ä¸€ä¸ªåŸå­ç¬é—´åŠ¨ä½œ)<br><strong>åªè¦ Coordinator è®¤ä¸ºä»»åŠ¡å®Œæˆäº†ï¼Œç£ç›˜ä¸Šçš„æ–‡ä»¶å°±ä¸€å®šæ˜¯å®Œæ•´çš„</strong></p><h3 id="å¦‚æœè¿™ä¸ªworker-çªç„¶å´©æºƒäº†" tabindex="-1"><a class="header-anchor" href="#å¦‚æœè¿™ä¸ªworker-çªç„¶å´©æºƒäº†"><span>å¦‚æœè¿™ä¸ªworker çªç„¶å´©æºƒäº†</span></a></h3><p>å‡å¦‚ä¸€ä¸ªåˆ†å¸ƒå¼èŠ‚ç‚¹çªç„¶æ–­ç”µ å¦‚æœåŸæ¥æ˜¯ç›´æ¥å†™åœ¨ç»“æœæ–‡ä»¶ä¸­çš„ é‚£ä¹ˆä¼šç•™ä¸‹ä¸€ä¸ªæŸåçš„æ–‡ä»¶</p><h4 id="è§£å†³æ–¹æ³•-è¿˜æ˜¯åŸå­æ–‡ä»¶é‡å‘½å" tabindex="-1"><a class="header-anchor" href="#è§£å†³æ–¹æ³•-è¿˜æ˜¯åŸå­æ–‡ä»¶é‡å‘½å"><span>è§£å†³æ–¹æ³• è¿˜æ˜¯åŸå­æ–‡ä»¶é‡å‘½å</span></a></h4><ol><li><strong>å´©æºƒå‘ç”Ÿåœ¨å†™ä¸´æ—¶æ–‡ä»¶æ—¶</strong>ï¼š <ul><li>å¦‚æœ Worker åœ¨å†™å…¥Â mr-mid-tmp-xxxÂ çš„è¿‡ç¨‹ä¸­æŒ‚æ‰äº†ï¼ˆæ–­ç”µã€ç½‘ç»œæ–­å¼€ã€è¿›ç¨‹å´©æºƒï¼‰ã€‚</li><li>ç£ç›˜ä¸Šåªä¼šç•™ä¸‹ä¸€ä¸ªå†™äº†ä¸€åŠçš„<strong>åƒåœ¾æ–‡ä»¶</strong>ï¼ˆGarbage/Partial Fileï¼‰ã€‚</li><li>ä½†æ˜¯ï¼Œæœ€ç»ˆçš„æ–‡ä»¶åÂ mr-mid-X-YÂ <strong>æ ¹æœ¬å°±æ²¡æœ‰è¢«åˆ›å»º</strong>ï¼ˆæˆ–è€…å¦‚æœä¹‹å‰æœ‰æ—§çš„ï¼Œä¹Ÿæ²¡è¢«ç¢°è¿‡ï¼‰ã€‚</li><li>Coordinator å‘ç°è¿™ä¸ª Worker è¶…æ—¶ï¼ˆä¸å†å‘é€å¿ƒè·³ï¼‰ï¼Œå°±ä¼šæŠŠä»»åŠ¡é‡æ–°åˆ†é…ç»™å¦ä¸€ä¸ª Workerã€‚</li><li>æ–°çš„ Worker ä¼šé‡æ–°åˆ›å»ºä¸€ä¸ª<strong>æ–°çš„</strong>ä¸´æ—¶æ–‡ä»¶å¼€å§‹å†™ã€‚</li><li><strong>ç»“è®º</strong>ï¼šç³»ç»ŸçŠ¶æ€æ˜¯å¹²å‡€çš„ï¼Œæ²¡æœ‰è„æ•°æ®æ±¡æŸ“æœ€ç»ˆç»“æœã€‚</li></ul></li><li><strong>å´©æºƒå‘ç”Ÿåœ¨é‡å‘½åé‚£ä¸€ç¬é—´</strong>ï¼š <ul><li>åœ¨æ“ä½œç³»ç»Ÿï¼ˆå°¤å…¶æ˜¯ POSIX æ ‡å‡†çš„æ–‡ä»¶ç³»ç»Ÿï¼‰ä¸­ï¼ŒRenameÂ æ˜¯<strong>åŸå­</strong>çš„ã€‚</li><li>è¿™æ„å‘³ç€ï¼šè¦ä¹ˆæ”¹åæˆåŠŸï¼Œæ–‡ä»¶ç¬é—´å˜æˆæœ€ç»ˆæ–‡ä»¶ï¼›è¦ä¹ˆå®Œå…¨æ²¡å‘ç”Ÿï¼Œæ–‡ä»¶è¿˜æ˜¯ä¸´æ—¶æ–‡ä»¶åã€‚</li><li><strong>ç»å¯¹ä¸ä¼šå‡ºç°</strong>â€œæ”¹åæ”¹äº†ä¸€åŠâ€æˆ–è€…â€œæ–‡ä»¶æŸåâ€çš„æƒ…å†µã€‚</li><li>è¿™å°±åƒä¸€ä¸ª<strong>å¼€å…³</strong>ï¼Œåªæœ‰ 0 å’Œ 1ï¼Œæ²¡æœ‰ä¸­é—´çŠ¶æ€ã€‚</li></ul></li></ol><h3 id="è¿™å°±æ˜¯æ‰€è°“çš„-commit-point-æäº¤ç‚¹" tabindex="-1"><a class="header-anchor" href="#è¿™å°±æ˜¯æ‰€è°“çš„-commit-point-æäº¤ç‚¹"><span>è¿™å°±æ˜¯æ‰€è°“çš„â€œCommit Pointâ€ï¼ˆæäº¤ç‚¹ï¼‰</span></a></h3><p>åœ¨ MapReduce Worker ä»£ç ä¸­ï¼Œos.RenameÂ å°±ç›¸å½“äºæ•°æ®åº“äº‹åŠ¡ä¸­çš„Â <strong>COMMIT</strong>Â å‘½ä»¤ï¼š</p><ul><li><strong>Rename ä¹‹å‰</strong>ï¼šæ‰€æœ‰çš„è®¡ç®—å’Œ IO éƒ½æ˜¯â€œè‰ç¨¿â€ï¼Œéšæ—¶å¯ä»¥æ‰”æ‰ï¼Œå¯¹å¤–ç•Œï¼ˆCoordinator å’Œ Reducerï¼‰ä¸å¯è§ã€‚</li><li><strong>Rename ä¹‹å</strong>ï¼šæ•°æ®ç¬é—´ç”Ÿæ•ˆï¼Œå¯¹å¤–ç•Œå¯è§ã€‚</li></ul><h4 id="å¦‚æœworker1è¢«æŠ›å¼ƒäº†-æ–°æŒ‡æ´¾çš„worker2å®Œæˆäº†å·¥ä½œ-è¿™æ—¶worker1åˆå®Œæˆäº†æ€ä¹ˆåŠ" tabindex="-1"><a class="header-anchor" href="#å¦‚æœworker1è¢«æŠ›å¼ƒäº†-æ–°æŒ‡æ´¾çš„worker2å®Œæˆäº†å·¥ä½œ-è¿™æ—¶worker1åˆå®Œæˆäº†æ€ä¹ˆåŠ"><span>å¦‚æœworker1è¢«æŠ›å¼ƒäº† æ–°æŒ‡æ´¾çš„worker2å®Œæˆäº†å·¥ä½œ è¿™æ—¶worker1åˆå®Œæˆäº†æ€ä¹ˆåŠ</span></a></h4><p>paperä¸­å†™é“</p><blockquote><p>We rely on atomic commits of map and reduce task outputs to achieve this property. Each in-progress task writes its output to private temporary files. A reduce task produces one such file, and a map task produces R such files (one per reduce task). When a map task completes, the worker sends a message to the master and includes the names of the R temporary files in the message. If the master receives a completion message for an already completed map task, it <strong>ignores</strong> the message. Otherwise, it records the names of R files in a master data structure. When a reduce task completes, the reduce worker atomically renames its temporary output file to the final output file. If the same reduce task is executed on multiple machines, <strong>multiple rename calls will be executed for the same final output file. We rely on the atomic rename operation provided by the underlying file system</strong> to guarantee that the final file system state contains just the data produced by one execution of the reduce task.</p></blockquote><p>å¯¹äºmap ç³»ç»Ÿè®°å½•ä¸‹ç¬¬ä¸€ä¸ªå‘å‡ºdoneçš„workeråˆ›å»ºçš„é‚£äº›æ–‡ä»¶ å¿½ç•¥åé¢çš„<br> å¯¹äºreduceæ¯æ¬¡éƒ½ä¼šå…ˆåˆ›å»ºä¸´æ—¶æ–‡ä»¶ ç„¶åè¿›è¡ŒåŸå­é‡å‘½å æ“ä½œç³»ç»Ÿä¿è¯äº†æœ€åçš„ç»“æœæ˜¯ä¸€æ¬¡æ“ä½œçš„è¾“å‡º</p><h3 id="coordinatorçš„å¹‚ç­‰æ€§-å’Œ-map-reduceæ–¹æ³•çš„ç¡®å®šæ€§" tabindex="-1"><a class="header-anchor" href="#coordinatorçš„å¹‚ç­‰æ€§-å’Œ-map-reduceæ–¹æ³•çš„ç¡®å®šæ€§"><span>coordinatorçš„å¹‚ç­‰æ€§ å’Œ map reduceæ–¹æ³•çš„ç¡®å®šæ€§</span></a></h3><p>Coordinator æ£€æŸ¥ Task X çš„çŠ¶æ€ã€‚å‘ç°å·²ç»æ˜¯Â CompletedÂ äº†ï¼Œäºæ˜¯<strong>ä»€ä¹ˆéƒ½ä¸åš</strong>ï¼ˆæˆ–è€…ä»…è¿”å›ä¸€ä¸ªç¡®è®¤ï¼Œä½†ä¸ä¿®æ”¹å†…éƒ¨çŠ¶æ€ï¼‰ã€‚</p><ul><li><p>å…¬å¼è¡¨è¾¾ï¼š<code>HandleDone(Task X) = HandleDone(HandleDone(Task X))</code><br> å¯¹äº map å’Œ reduce æ–¹æ³•æ¥è¯´ ä¸åŒ…å«éšæœºæ•° æ¯æ¬¡æ‰§è¡Œçš„ç»“æœä¸€å®šæ˜¯ä¸€æ ·çš„</p></li><li><p>æ‰€ä»¥å°±å¯ä»¥æŠŠä¸€ä¸ªä»»åŠ¡åˆ†é…ç»™å¤šä¸ªworkeræ‰§è¡Œ ä¸ä¼šå½±å“æœ€åç»“æœ</p></li></ul><blockquote><p>Google çš„å®ç°æŒ‡å‡ºï¼Œå¦‚æœä½ çš„å‡½æ•°æ˜¯ä¸ç¡®å®šçš„ï¼ˆæ¯”å¦‚åŒ…å«éšæœºæ•°ï¼‰ï¼ŒMapReduce æ¡†æ¶åªèƒ½ä¿è¯è¾“å‡ºç»“æœæ˜¯â€œæŸä¸€æ¬¡â€æ‰§è¡Œçš„ç»“æœï¼Œä½†æ— æ³•ä¿è¯å¤šæ¬¡è¿è¡Œç»“æœä¸€è‡´ï¼ˆå¼±ä¸€è‡´æ€§ï¼‰ã€‚ä½†åœ¨æ ‡å‡†ä½¿ç”¨åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬éƒ½å‡è®¾å‡½æ•°æ˜¯ç¡®å®šæ€§çš„ï¼Œè¿™æ ·å°±å¯ä»¥æ”¾å¿ƒåœ°è®© Straggler å’Œ Backup Worker äº’ç›¸è¦†ç›–æ–‡ä»¶ï¼Œè€Œä¸ç”¨æ‹…å¿ƒæ•°æ®é”™ä¹±</p></blockquote><h1 id="raft" tabindex="-1"><a class="header-anchor" href="#raft"><span>RAFT</span></a></h1><h2 id="cap" tabindex="-1"><a class="header-anchor" href="#cap"><span>CAP</span></a></h2><p>åœ¨ CAP å®šç†ä¸­ï¼ŒRaft æ˜¯ä¸€ä¸ªå…¸å‹çš„ <strong>CP ç³»ç»Ÿ</strong>ï¼šå®ƒä¼˜å…ˆä¿è¯ä¸€è‡´æ€§ï¼Œåœ¨æ— æ³•è¾¾æˆå…±è¯†æ—¶ï¼Œå®å¯ç‰ºç‰²å¯ç”¨æ€§ï¼ˆAï¼‰ã€‚</p><h3 id="raft-æ˜¯å¦‚ä½•ç»´æŒ-cap-çš„" tabindex="-1"><a class="header-anchor" href="#raft-æ˜¯å¦‚ä½•ç»´æŒ-cap-çš„"><span>Raft æ˜¯å¦‚ä½•ç»´æŒ CAP çš„ï¼Ÿ</span></a></h3><h4 id="_1-å¼ºä¸€è‡´æ€§-consistency" tabindex="-1"><a class="header-anchor" href="#_1-å¼ºä¸€è‡´æ€§-consistency"><span>1. å¼ºä¸€è‡´æ€§ (Consistency)</span></a></h4><p>Raft ä¿è¯çš„æ˜¯ <strong>çº¿æ€§ä¸€è‡´æ€§ï¼ˆLinearizabilityï¼‰</strong>ï¼Œå°±åƒåªæœ‰ä¸€å°æœºå™¨åœ¨å·¥ä½œä¸€æ ·ï¼š</p><ul><li><strong>æ—¥å¿—åŒ¹é…åŸåˆ™</strong>ï¼šå¦‚æœä¸¤ä¸ªèŠ‚ç‚¹çš„æ—¥å¿—åœ¨æŸä¸ªä½ç½® Index å’Œ Term éƒ½ç›¸åŒï¼Œé‚£ä¹ˆå®ƒä»¬ä¹‹å‰çš„æ—¥å¿—ä¹Ÿä¸€å®šç›¸åŒã€‚</li><li><strong>é€‰ä¸¾çº¦æŸ</strong>ï¼šä¸åŒ…å«æœ€æ–°å·²æäº¤æ—¥å¿—çš„èŠ‚ç‚¹æ ¹æœ¬å½“ä¸ä¸Š Leaderã€‚</li><li><strong>è¿‡åŠæ•°åŸåˆ™</strong>ï¼šä»»ä½•ä¸€ä¸ªå·²æäº¤çš„æ—¥å¿—ï¼Œå¿…ç„¶å­˜åœ¨äºè¿‡åŠæ•°èŠ‚ç‚¹ä¸Šã€‚è€Œä»»ä½•ä¸¤ä¸ªâ€œè¿‡åŠæ•°â€é›†åˆå¿…æœ‰äº¤é›†ã€‚è¿™ä¿è¯äº†æ–° Leader é€‰ä¸¾æ—¶ä¸€å®šèƒ½çœ‹åˆ°æ—§ Leader æäº¤è¿‡çš„ç—•è¿¹ã€‚</li></ul><h4 id="_2-åˆ†åŒºå®¹é”™æ€§-partition-tolerance" tabindex="-1"><a class="header-anchor" href="#_2-åˆ†åŒºå®¹é”™æ€§-partition-tolerance"><span>2. åˆ†åŒºå®¹é”™æ€§ (Partition Tolerance)</span></a></h4><p>Raft å¤©ç”Ÿå°±æ˜¯ä¸ºäº†åº”å¯¹ç½‘ç»œåˆ†åŒºè®¾è®¡çš„ï¼š</p><ul><li><strong>è„‘è£‚å¤„ç†</strong>ï¼šå¦‚æœ 5 ä¸ªèŠ‚ç‚¹è¢«åˆ‡æˆäº† 3 ä¸ªï¼ˆåˆ†åŒº Aï¼‰å’Œ 2 ä¸ªï¼ˆåˆ†åŒº Bï¼‰ã€‚ <ul><li>åˆ†åŒº B å‡‘ä¸å¤Ÿ 3 ç¥¨ï¼Œé€‰ä¸å‡º Leaderï¼Œæ— æ³•å·¥ä½œã€‚</li><li>åˆ†åŒº A èƒ½é€‰å‡º Leaderï¼Œç»§ç»­å·¥ä½œã€‚</li><li>å½“ç½‘ç»œæ¢å¤ï¼Œåˆ†åŒº B çš„èŠ‚ç‚¹å‘ç°åˆ†åŒº A çš„ Term æ›´é«˜ï¼Œä¼šç«‹åˆ»æ”¾å¼ƒæŠµæŠ—ï¼ŒåŒæ­¥åˆ†åŒº A çš„æ—¥å¿—ã€‚</li></ul></li><li><strong>ç½‘ç»œéš”ç¦»</strong>ï¼šå³ä½¿æ¶ˆæ¯ä¸¢äº†ã€å»¶è¿Ÿäº†ã€ä¹±åºäº†ï¼ŒRaft çš„åºåˆ—å·ï¼ˆIndexï¼‰å’Œä»»æœŸï¼ˆTermï¼‰éƒ½èƒ½ç¡®ä¿æ•°æ®æœ€ç»ˆå¯¹é½ã€‚</li></ul><h4 id="_3-å¯ç”¨æ€§-availability-â€”â€”-raft-ç‰ºç‰²äº†å®ƒ" tabindex="-1"><a class="header-anchor" href="#_3-å¯ç”¨æ€§-availability-â€”â€”-raft-ç‰ºç‰²äº†å®ƒ"><span>3. å¯ç”¨æ€§ (Availability) â€”â€” Raft ç‰ºç‰²äº†å®ƒ</span></a></h4><p>Raft åœ¨æŸäº›æƒ…å†µä¸‹ä¼š<strong>æš‚æ—¶ä¸å¯ç”¨</strong>ï¼Œä»¥ä¿å…¨æ•°æ®çš„ä¸€è‡´æ€§ï¼š</p><ul><li><strong>é€‰ä¸¾ç©ºçª—æœŸ</strong>ï¼šå½“ Leader æŒ‚äº†ï¼Œåˆ°æ–° Leader é€‰å‡ºæ¥çš„å‡ åæ¯«ç§’å†…ï¼Œç³»ç»Ÿæ— æ³•å¤„ç†è¯·æ±‚ã€‚</li><li><strong>å°‘æ•°æ´¾åˆ†åŒº</strong>ï¼šå¦‚æœä½ æ‰€åœ¨çš„ç½‘ç»œåˆ†åŒºå‡‘ä¸å¤ŸåŠæ•°ï¼Œç³»ç»Ÿä¼šç›´æ¥æŠ¥é”™ï¼Œæ‹’ç»æœåŠ¡ã€‚</li><li><strong>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¯´ Raft æ˜¯ CP è€Œä¸æ˜¯ APã€‚</strong> å®ƒåšä¿¡ï¼š<strong>â€œå®å¯ä¸ç»™ç»“æœï¼Œä¹Ÿç»ä¸ç»™é”™çš„ç»“æœã€‚â€</strong></li></ul><h3 id="ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ap-ä»€ä¹ˆæ—¶å€™ä½¿ç”¨cp" tabindex="-1"><a class="header-anchor" href="#ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ap-ä»€ä¹ˆæ—¶å€™ä½¿ç”¨cp"><span>ä»€ä¹ˆæ—¶å€™ä½¿ç”¨AP ä»€ä¹ˆæ—¶å€™ä½¿ç”¨CP</span></a></h3><h4 id="a-ä½¿ç”¨-cp-çš„åœºæ™¯-ä¸€è‡´æ€§è‡³ä¸Š" tabindex="-1"><a class="header-anchor" href="#a-ä½¿ç”¨-cp-çš„åœºæ™¯-ä¸€è‡´æ€§è‡³ä¸Š"><span>A. ä½¿ç”¨ CP çš„åœºæ™¯ï¼ˆä¸€è‡´æ€§è‡³ä¸Šï¼‰</span></a></h4><p>å¦‚æœä½ è§‰å¾—â€œå®å¯ç³»ç»Ÿæš‚æ—¶ä¸å¯ç”¨ï¼Œä¹Ÿç»å¯¹ä¸èƒ½ç»™é”™æ•°æ®â€ï¼Œå°±é€‰ CPã€‚</p><ul><li><strong>é‡‘è/æ”¯ä»˜</strong>ï¼šä½ çš„é“¶è¡Œä½™é¢ã€‚å¦‚æœå› ä¸ºæ–­ç½‘å¯¼è‡´ä½ æ˜æ˜èŠ±äº†é’±ä½†ä½™é¢æ²¡å‡ï¼Œé“¶è¡Œå°±äºæ­»äº†ã€‚</li><li><strong>åˆ†å¸ƒå¼é”/é…ç½®ä¸­å¿ƒ</strong>ï¼šå¦‚ <strong>etcd (Kubernetes çš„å¤§è„‘)</strong>ã€<strong>ZooKeeper</strong>ã€‚å¦‚æœä¸¤ä¸ªèŠ‚ç‚¹åŒæ—¶æŠ¢åˆ°äº†åŒä¸€ä¸ªé”ï¼Œæˆ–è€…è¯»åˆ°äº†ä¸åŒçš„é…ç½®ï¼Œç³»ç»Ÿä¼šå‘ç”Ÿé€»è¾‘ç¾éš¾ã€‚</li><li><strong>æ•°æ®åº“å…ƒæ•°æ®</strong>ï¼šTiDB ç­‰åˆ†å¸ƒå¼æ•°æ®åº“çš„ç´¢å¼•ä¿¡æ¯ã€‚</li></ul><h4 id="b-ä½¿ç”¨-ap-çš„åœºæ™¯-å¯ç”¨æ€§è‡³ä¸Š" tabindex="-1"><a class="header-anchor" href="#b-ä½¿ç”¨-ap-çš„åœºæ™¯-å¯ç”¨æ€§è‡³ä¸Š"><span>B. ä½¿ç”¨ AP çš„åœºæ™¯ï¼ˆå¯ç”¨æ€§è‡³ä¸Šï¼‰</span></a></h4><p>å¦‚æœä½ è§‰å¾—â€œç³»ç»Ÿå¿…é¡»ç§’å›ï¼Œæ•°æ®æ—§ä¸€ç‚¹ç‚¹æ²¡å…³ç³»â€ï¼Œå°±é€‰ APã€‚</p><ul><li><strong>ç¤¾äº¤åª’ä½“</strong>ï¼šä½ åœ¨å¾®åšå‘ä¸ªçŠ¶æ€ï¼Œç”±äºç½‘ç»œåˆ†åŒºï¼Œä½ çš„æœ‹å‹æ™šäº† 5 ç§’æ‰çœ‹åˆ°ï¼Œæˆ–è€…ç‚¹èµæ•°æš‚æ—¶å°‘æ˜¾ç¤ºäº†å‡ ä¸ªã€‚è¿™å®Œå…¨æ²¡é—®é¢˜ï¼Œä½†å¦‚æœå¾®åšå› ä¸ºæ–­ç½‘ç›´æ¥æ‰“ä¸å¼€ï¼Œç”¨æˆ·å°±ä¼šè·‘å…‰ã€‚</li><li><strong>è´­ç‰©è½¦/æ¨èç³»ç»Ÿ</strong>ï¼šäºšé©¬é€Šå‘ç°ï¼Œå¦‚æœç»“è´¦ç³»ç»Ÿå› ä¸ºä¸€è‡´æ€§æ£€æŸ¥æ…¢äº† 1 æ¯«ç§’ï¼Œå°±ä¼šæŸå¤±æ•°ç™¾ä¸‡ç¾å…ƒã€‚æ‰€ä»¥ä»–ä»¬å…è®¸è´­ç‰©è½¦æ•°æ®æš‚æ—¶ä¸ä¸€è‡´ï¼Œç­‰è”ç½‘åå†åˆå¹¶ã€‚</li><li><strong>ç¼“å­˜ç³»ç»Ÿ</strong>ï¼šå¦‚ CDNã€DNSã€‚ä½ ä¿®æ”¹äº†åŸŸåè§£æï¼Œå…¨çƒç”Ÿæ•ˆéœ€è¦æ—¶é—´ï¼ˆä¸ä¸€è‡´ï¼‰ï¼Œä½†è¿™æ¯”æ•´ä¸ªäº’è”ç½‘æœä¸åˆ°è¯¥åŸŸåè¦å¥½å¾—å¤šã€‚</li></ul><hr><h2 id="base" tabindex="-1"><a class="header-anchor" href="#base"><span>BASE</span></a></h2><p>BASE æ˜¯ä¸‰ä¸ªçŸ­è¯­çš„ç¼©å†™ï¼š<strong>B</strong>asically <strong>A</strong>vailableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰ã€<strong>S</strong>oft stateï¼ˆè½¯çŠ¶æ€ï¼‰ã€<strong>E</strong>ventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰ã€‚</p><hr><h3 id="_1-basically-available-åŸºæœ¬å¯ç”¨" tabindex="-1"><a class="header-anchor" href="#_1-basically-available-åŸºæœ¬å¯ç”¨"><span>1. Basically Availableï¼ˆåŸºæœ¬å¯ç”¨ï¼‰</span></a></h3><p>å½“ç³»ç»Ÿå‡ºç°ä¸å¯é¢„çŸ¥çš„æ•…éšœæ—¶ï¼Œå…è®¸æŸå¤±éƒ¨åˆ†å¯ç”¨æ€§ï¼Œ<strong>ä¿è¯æ ¸å¿ƒåŠŸèƒ½å¯ç”¨</strong>ã€‚è¿™æ˜¯ä¸€ç§â€œå¼ƒè½¦ä¿å¸…â€çš„ç­–ç•¥ã€‚</p><ul><li><strong>å“åº”æ—¶é—´ä¸Šçš„æŸå¤±ï¼š</strong> æ­£å¸¸æƒ…å†µä¸‹è®¢å•å¤„ç† 10msï¼Œå‹åŠ›å¤§æˆ–éƒ¨åˆ†èŠ‚ç‚¹æ•…éšœæ—¶ï¼Œå¢åŠ åˆ° 1sã€‚è™½ç„¶å˜æ…¢äº†ï¼Œä½†è¿˜èƒ½ä¸‹å•ã€‚</li><li><strong>åŠŸèƒ½ä¸Šçš„æŸå¤±ï¼š</strong> ç”µå•†å¤§ä¿ƒæ—¶ï¼Œä¸ºäº†ä¿æŠ¤ä¸‹å•æµç¨‹ï¼Œç³»ç»Ÿå¯èƒ½ä¼šå…³é—­â€œæŸ¥çœ‹å†å²è®¢å•â€æˆ–â€œè¯„è®ºâ€åŠŸèƒ½ï¼Œæˆ–è€…å°†åŸæœ¬å®æ—¶çš„åº“å­˜æ˜¾ç¤ºæ”¹ä¸ºâ€œæœ‰è´§/æ— è´§â€è¿™ç§æ¨¡ç³Šæè¿°ã€‚</li></ul><h3 id="_2-soft-state-è½¯çŠ¶æ€" tabindex="-1"><a class="header-anchor" href="#_2-soft-state-è½¯çŠ¶æ€"><span>2. Soft stateï¼ˆè½¯çŠ¶æ€ï¼‰</span></a></h3><p>è½¯çŠ¶æ€æ˜¯æŒ‡å…è®¸ç³»ç»Ÿä¸­çš„æ•°æ®å­˜åœ¨<strong>ä¸­é—´çŠ¶æ€</strong>ï¼Œå¹¶è®¤ä¸ºè¯¥ä¸­é—´çŠ¶æ€çš„å­˜åœ¨ä¸ä¼šå½±å“ç³»ç»Ÿçš„æ•´ä½“å¯ç”¨æ€§ã€‚</p><ul><li><strong>æ•°æ®åŒæ­¥çš„æ»åï¼š</strong> åœ¨å¼ºä¸€è‡´æ€§ï¼ˆACIDï¼‰ä¸­ï¼ŒçŠ¶æ€è½¬æ¢æ˜¯ç¬é—´å®Œæˆçš„ï¼ˆä»â€œæœªæ”¯ä»˜â€ç›´æ¥å˜â€œå·²æ”¯ä»˜â€ï¼‰ã€‚</li><li><strong>ä¾‹å­ï¼š</strong> åœ¨ BASE æ¨¡å‹ä¸‹ï¼Œå½“ä½ ä»˜å®Œé’±ï¼Œè®¢å•çŠ¶æ€å¯èƒ½åœ¨å‡ ç§’é’Ÿå†…å¤„äºâ€œæ”¯ä»˜å¤„ç†ä¸­â€ã€‚è¿™ä¸ªâ€œå¤„ç†ä¸­â€å°±æ˜¯è½¯çŠ¶æ€ï¼Œå®ƒåæ˜ äº†ä¸åŒèŠ‚ç‚¹é—´å¼‚æ­¥åŒæ­¥æ•°æ®çš„è¿‡ç¨‹ã€‚</li></ul><h3 id="_3-eventually-consistent-æœ€ç»ˆä¸€è‡´æ€§" tabindex="-1"><a class="header-anchor" href="#_3-eventually-consistent-æœ€ç»ˆä¸€è‡´æ€§"><span>3. Eventually consistentï¼ˆæœ€ç»ˆä¸€è‡´æ€§ï¼‰</span></a></h3><p>è¿™æ˜¯ BASE çš„æ ¸å¿ƒã€‚ç³»ç»Ÿä¸éœ€è¦åœ¨ä»»ä½•æ—¶åˆ»éƒ½ä¿è¯æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼Œä½†å¿…é¡»ä¿è¯åœ¨ç»è¿‡ä¸€æ®µæ—¶é—´ï¼ˆé€šå¸¸å¾ˆçŸ­ï¼‰åï¼Œæ•°æ®æœ€ç»ˆèƒ½è¾¾åˆ°ä¸€è‡´çš„çŠ¶æ€ã€‚</p><ul><li><strong>ä¸è¿½æ±‚â€œå®æ—¶åŒæ­¥â€ï¼š</strong> åªè¦æ²¡æœ‰æ–°çš„æ›´æ–°æ“ä½œï¼Œæœ€ç»ˆæ‰€æœ‰çš„è®¿é—®éƒ½èƒ½å¾—åˆ°æœ€æ–°çš„å€¼ã€‚</li><li><strong>ä¿®æ­£æœºåˆ¶ï¼š</strong> æœ€ç»ˆä¸€è‡´æ€§æ˜¯é€šè¿‡é‡è¯•ã€å¼‚æ­¥æ ¡å‡†ã€å¯¹è´¦ç­‰æ‰‹æ®µå®ç°çš„ã€‚</li><li><strong>ä¾‹å­ï¼š</strong> ä½ åœ¨æœ‹å‹åœˆå‘äº†å¼ ç…§ç‰‡ï¼Œä½ çš„æœ‹å‹ A ç«‹åˆ»çœ‹åˆ°äº†ï¼Œæœ‹å‹ B å¯èƒ½è¿‡äº† 2 ç§’æ‰åˆ·å‡ºæ¥ã€‚è™½ç„¶é‚£ 2 ç§’å†…ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä½ ä»¬çœ‹åˆ°çš„å†…å®¹æ˜¯ä¸€æ ·çš„ã€‚</li></ul><hr><h2 id="raft-çš„å·¥ä½œæµç¨‹" tabindex="-1"><a class="header-anchor" href="#raft-çš„å·¥ä½œæµç¨‹"><span>RAFT çš„å·¥ä½œæµç¨‹</span></a></h2><h3 id="ç¬¬ä¸€é˜¶æ®µ-åˆå§‹åŒ–ä¸é€‰ä¸¾-å¯»æ‰¾æƒå¨" tabindex="-1"><a class="header-anchor" href="#ç¬¬ä¸€é˜¶æ®µ-åˆå§‹åŒ–ä¸é€‰ä¸¾-å¯»æ‰¾æƒå¨"><span>ç¬¬ä¸€é˜¶æ®µï¼šåˆå§‹åŒ–ä¸é€‰ä¸¾ï¼ˆå¯»æ‰¾æƒå¨ï¼‰</span></a></h3><p>æ‰€æœ‰èŠ‚ç‚¹å¯åŠ¨æ—¶éƒ½æ˜¯ <strong>Follower</strong>ã€‚</p><ol><li><strong>å¿ƒè·³è¶…æ—¶</strong>ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰ä¸€ä¸ªéšæœºçš„é—¹é’Ÿã€‚è°çš„é—¹é’Ÿå…ˆå“ï¼Œè°å°±å˜èº« <strong>Candidate</strong>ã€‚</li></ol><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rf </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ticker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">killed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		state</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">state</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> state</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> StateLeader</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			go</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">BroadCastAppendEntries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Millisecond</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			elapsed</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Since</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastActiveTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">electionTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> elapsed</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				go</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">startElection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Millisecond</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ˜¯leader å°±å‘é€å¿ƒè·³åŒ…ï¼ˆå…¶å®æ˜¯å¤åˆ¶log ä½†æ˜¯ç©ºçš„ä¾ç„¶ä¼šå‘é€ï¼‰</p><ol start="2"><li><strong>æ‹‰ç¥¨ï¼ˆRequestVoteï¼‰</strong>ï¼šCandidate ç»™æ‰€æœ‰äººå‘é‚®ä»¶ï¼šâ€œæˆ‘æ˜¯ä»»æœŸï¼ˆTermï¼‰Xï¼Œè¯·æŠ•æˆ‘ä¸€ç¥¨ã€‚â€</li><li><strong>æŠ•ç¥¨è§„åˆ™ï¼ˆC çš„ä¿è¯ï¼‰</strong>ï¼š <ul><li>ä¸€ä¸ªä»»æœŸå†…åªèƒ½æŠ•ä¸€å¼ ç¥¨ã€‚</li><li><strong>æœ€é‡è¦</strong>ï¼šå¦‚æœä½ çš„æ—¥å¿—è¿˜æ²¡æˆ‘æ–°ï¼ˆTerm å°æˆ–é•¿åº¦çŸ­ï¼‰ï¼Œæˆ‘ç»ä¸æŠ•ç»™ä½ ã€‚è¿™ä¿è¯äº† <strong>Leader ä¸€å®šæ‹¥æœ‰æ‰€æœ‰å¯èƒ½å·²ç»æäº¤çš„æ—¥å¿—</strong>ã€‚</li></ul></li></ol><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	upToDate</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LastLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lastTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LastLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lastTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LastLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lastIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// Â TermÂ ä»£è¡¨äº†â€œæƒå¨æ€§â€çš„ä»£é™…ã€‚ä¸€ä¸ªæ‹¥æœ‰æ›´é«˜Â TermÂ æ—¥å¿—çš„èŠ‚ç‚¹ï¼Œæ„å‘³ç€å®ƒç»å†äº†æ›´æ™šè¿‘çš„é€‰ä¸¾å‘¨æœŸã€‚å³ä½¿å®ƒçš„Â IndexÂ è¾ƒçŸ­ï¼Œå®ƒä¹Ÿå¯èƒ½åŒ…å«äº†å·²ç»è¢«æäº¤ï¼ˆCommitï¼‰çš„æœ€å®Œæ•´æ•°æ®ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">voteFor</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">voteFor</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">CandidateId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> upToDate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">resetElectionTimerLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//  åªæœ‰å½“ä½ **çœŸçš„æˆäºˆäº†é€‰ç¥¨**ï¼Œæ‰èƒ½é‡ç½®è®¡æ—¶å™¨ã€‚å¦‚æœä¸ç»™ç¥¨ä¹Ÿé‡ç½®ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡å‘å‡æŠ•ç¥¨è¯·æ±‚è®©å…¨é›†ç¾¤æ°¸è¿œæ— æ³•é€‰å‡º Leaderï¼ˆå¿ƒè·³è¢«æŠ‘åˆ¶ï¼‰ã€‚</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">voteFor</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">CandidateId</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">persist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Vote</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Vote</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>æˆä¸º Leader</strong>ï¼šæ‹¿åˆ°è¶…è¿‡åŠæ•°ï¼ˆMajorityï¼‰çš„ç¥¨ï¼Œæ­£å¼ä¸Šä½ã€‚</li></ol><hr><h3 id="ç¬¬äºŒé˜¶æ®µ-æ—¥å¿—å¤åˆ¶-è¾¾æˆå…±è¯†" tabindex="-1"><a class="header-anchor" href="#ç¬¬äºŒé˜¶æ®µ-æ—¥å¿—å¤åˆ¶-è¾¾æˆå…±è¯†"><span>ç¬¬äºŒé˜¶æ®µï¼šæ—¥å¿—å¤åˆ¶ï¼ˆè¾¾æˆå…±è¯†ï¼‰</span></a></h3><p>ä¸€æ—¦æœ‰äº† Leaderï¼Œç³»ç»Ÿå¼€å§‹å¤„ç†è¯·æ±‚ã€‚</p><ol><li><strong>æ¥æ”¶æŒ‡ä»¤</strong>ï¼šLeader æ”¶åˆ°å‘½ä»¤ï¼Œå…ˆåœ¨è‡ªå·±çš„æ—¥å¿—é‡Œå†™ä¸€ç¬”ï¼ŒçŠ¶æ€æ˜¯â€œæœªæäº¤â€ã€‚</li><li><strong>åˆ†å‘ï¼ˆAppendEntriesï¼‰</strong>ï¼šLeader æŠŠè¿™è¡Œæ—¥å¿—å‘ç»™æ‰€æœ‰ Followerã€‚</li><li><strong>ä¸€è‡´æ€§æ£€æŸ¥ï¼ˆC çš„æ ¸å¿ƒï¼‰</strong>ï¼š <ul><li>Leader å‘é€ç¬¬ 10 å·æ—¥å¿—æ—¶ï¼Œä¼šå¸¦ä¸Šç¬¬ 9 å·æ—¥å¿—çš„ä¿¡æ¯ï¼ˆIndex 9, Term 2ï¼‰ã€‚</li><li>Follower æ£€æŸ¥è‡ªå·±çš„ç¬¬ 9 å·æ—¥å¿—ã€‚å¦‚æœä¸åŒ¹é…ï¼ŒFollower ä¼šæ‹’ç»ã€‚</li><li>Leader ä¼šä¸æ–­å¾€å‰é€€ï¼Œç›´åˆ°æ‰¾åˆ°åŒæ–¹ä¸€è‡´çš„åœ°æ–¹ï¼Œç„¶åæŠŠ Follower åé¢ä¸ä¸€è‡´çš„éƒ¨åˆ†å…¨éƒ¨<strong>è¦†ç›–</strong>æ‰ã€‚<strong>ï¼ˆLeader æ°¸è¿œæ˜¯å¯¹çš„ï¼‰</strong>ã€‚</li></ul></li></ol><h5 id="æƒ…å†µä¸€-è¶Šè¿‡å¿«ç…§è¾¹ç•Œ-ä¿æŠ¤é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#æƒ…å†µä¸€-è¶Šè¿‡å¿«ç…§è¾¹ç•Œ-ä¿æŠ¤é€»è¾‘"><span>æƒ…å†µä¸€ï¼šè¶Šè¿‡å¿«ç…§è¾¹ç•Œï¼ˆä¿æŠ¤é€»è¾‘ï¼‰</span></a></h5><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastIncludedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastIncludedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>åœºæ™¯æè¿°</strong>ï¼šLeader è¯•å›¾åŒæ­¥ä¸€æ®µéå¸¸æ—§çš„æ—¥å¿—ï¼Œå…¶ <code>PrevLogIndex</code> æŒ‡å‘çš„ä½ç½®å·²ç»åœ¨ Follower çš„å¿«ç…§ï¼ˆSnapshotï¼‰é‡Œäº†ã€‚</li><li><strong>ä¸ºä»€ä¹ˆä¼šå‘ç”Ÿ</strong>ï¼šç½‘ç»œå»¶è¿Ÿã€‚Leader å‘å‡ºçš„ <code>AppendEntries</code> RPC åœ¨è·¯ä¸Šå µäº†å¾ˆä¹…ï¼Œå½“å®ƒåˆ°è¾¾æ—¶ï¼ŒFollower å·²ç»å®Œæˆäº†åƒåœ¾å›æ”¶ï¼ŒæŠŠæ—§æ—¥å¿—åšæˆäº†å¿«ç…§å¹¶åˆ é™¤äº†ã€‚</li><li><strong>é€»è¾‘è¯¦è§£</strong>ï¼š <ul><li>Follower æ— æ³•æ£€æŸ¥å¿«ç…§é‡Œçš„æ—¥å¿— Termï¼ˆå› ä¸ºå·²ç»åˆ äº†ï¼‰ï¼Œæ‰€ä»¥ä¸èƒ½å›å¤ <code>Success</code>ã€‚</li><li><strong>åº”å¯¹æ–¹æ¡ˆ</strong>ï¼šå‘Šè¯‰ Leaderï¼Œæˆ‘ç°åœ¨çš„æ—¥å¿—æœ€æ—©æ˜¯ä» <code>lastIncludedIndex + 1</code> å¼€å§‹çš„ã€‚Leader æ”¶åˆ°åä¼šæ„è¯†åˆ°ï¼šâ€œå“¦ï¼Œä½ å¤ªæ—§äº†ï¼ŒAE åŒæ­¥å·²ç»è·Ÿä¸ä¸Šäº†ï¼Œæˆ‘å¾—ç»™ä½ å‘ <code>InstallSnapshot</code> RPC äº†ã€‚â€</li></ul></li></ul><hr><h5 id="æƒ…å†µäºŒ-follower-æ—¥å¿—å¤ªçŸ­-æ—¥å¿—ç¼ºå¤±" tabindex="-1"><a class="header-anchor" href="#æƒ…å†µäºŒ-follower-æ—¥å¿—å¤ªçŸ­-æ—¥å¿—ç¼ºå¤±"><span>æƒ…å†µäºŒï¼šFollower æ—¥å¿—å¤ªçŸ­ï¼ˆæ—¥å¿—ç¼ºå¤±ï¼‰</span></a></h5><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLenLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLenLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>åœºæ™¯æè¿°</strong>ï¼šLeader è®¤ä¸º Follower åº”è¯¥æœ‰ 100 æ¡æ—¥å¿—ï¼Œæ‰€ä»¥ä» 101 æ¡å¼€å§‹å‘ï¼ˆ<code>PrevLogIndex=100</code>ï¼‰ã€‚ä½† Follower å®é™…åªæœ‰ 50 æ¡æ—¥å¿—ã€‚</li><li><strong>æ ¸å¿ƒé€»è¾‘</strong>ï¼š <ul><li>ä¸ä¸€è‡´çš„åŸå› æ˜¯**â€œç©ºéš™â€**ï¼ˆGapï¼‰ã€‚</li><li><strong>å¿«é€Ÿå›é€€ï¼ˆOptimizationï¼‰</strong>ï¼šå¦‚æœä¸åŠ è¿™æ®µï¼ŒLeader åªèƒ½ä¸€æ¬¡æ¬¡å‡ 1ï¼ˆä» 100 è¯•åˆ° 99, 98... ç›´åˆ° 50ï¼‰ï¼Œæ•ˆç‡æä½ã€‚</li><li><strong>è§£å†³ç­–ç•¥</strong>ï¼šFollower ç›´æ¥å‘Šè¯‰ Leaderï¼šâ€œæˆ‘æ ¹æœ¬æ²¡è¿™ä¹ˆé•¿ï¼Œæˆ‘ç°åœ¨çš„æœ«å°¾æ˜¯ 50ã€‚ä½ ä¸‹æ¬¡ç›´æ¥ä» 51ï¼ˆ<code>GetLogLenLocked() + 1</code>ï¼‰å¼€å§‹è¯•å§ã€‚â€</li><li><code>ConflictTerm = -1</code> æ˜¯ä¸€ä¸ªçº¦å®šï¼Œå‘Šè¯‰ Leaderï¼šå†²çªä¸æ˜¯å› ä¸ºä»»æœŸä¸å¯¹ï¼Œè€Œæ˜¯å› ä¸ºæˆ‘<strong>æ—¥å¿—å¤ªçŸ­äº†</strong>ã€‚</li></ul></li></ul><hr><h5 id="æƒ…å†µä¸‰-ä»»æœŸå†²çª-ç»å…¸ä¸ä¸€è‡´" tabindex="-1"><a class="header-anchor" href="#æƒ…å†µä¸‰-ä»»æœŸå†²çª-ç»å…¸ä¸ä¸€è‡´"><span>æƒ…å†µä¸‰ï¼šä»»æœŸå†²çªï¼ˆç»å…¸ä¸ä¸€è‡´ï¼‰</span></a></h5><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    index</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastIncludedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">index</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        index</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">--</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> index</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>åœºæ™¯æè¿°</strong>ï¼šè¿™æ˜¯æœ€ç»å…¸çš„ Raft å†²çªã€‚Leader å’Œ Follower åœ¨ <code>PrevLogIndex</code> å¤„éƒ½æœ‰æ—¥å¿—ï¼Œä½†<strong>ä»»æœŸå·ä¸åŒ</strong>ã€‚è¿™è¯´æ˜ Follower è¿™é‡Œçš„æ—¥å¿—æ˜¯æ¥è‡ªæŸä¸ªâ€œè¢«åºŸé»œâ€çš„æ—§ Leader çš„ã€‚</li><li><strong>é€»è¾‘è¯¦è§£</strong>ï¼š <ol><li><strong>è®°å½•å†²çªä»»æœŸ</strong>ï¼šFollower è¯´ï¼šâ€œæˆ‘è¿™é‡Œ <code>Index=100</code> çš„åœ°æ–¹ä»»æœŸæ˜¯ 2ï¼Œè€Œä½ è¯´æ˜¯ 3ï¼Œå’±ä¿©å¯¹ä¸ä¸Šã€‚â€ï¼ˆ<code>reply.ConflictTerm = 2</code>ï¼‰ã€‚</li><li><strong>å¯»æ‰¾è¯¥ä»»æœŸçš„èµ·ç‚¹</strong>ï¼šFollower å¾€å›æ‰¾ï¼Œå‘ç°ä»»æœŸ 2 çš„æ—¥å¿—æ˜¯ä» <code>Index=80</code> å¼€å§‹çš„ã€‚</li><li><strong>å¿«é€Ÿè·³è¿‡æ•´ä¸ªä»»æœŸ</strong>ï¼šFollower å‘Šè¯‰ Leaderï¼šâ€œæˆ‘è¿™é‡Œæ•´ä¸ªä»»æœŸ 2 ä¼°è®¡éƒ½æ˜¯é”™çš„ï¼Œä½ ä¸‹æ¬¡ç›´æ¥ä» <code>Index=80</code> è¯•è¯•çœ‹ã€‚â€</li></ol></li><li><strong>ä¸ºä»€ä¹ˆè¿™ä¹ˆåš</strong>ï¼šåœ¨ Raft ä¸­ï¼Œå¦‚æœä¸€ä¸ª Index å¤„çš„ Term ä¸åŒ¹é…ï¼Œé‚£ä¹ˆè¿™ä¸ª Term ä¹‹åçš„æ‰€æœ‰æ—¥å¿—ä¸€å®šéƒ½æ˜¯é”™çš„ã€‚ç›´æ¥è·³è¿‡ä¸€æ•´ä¸ª Term è¿œæ¯”ä¸€æ¡æ¡å›é€€å¿«å¾—å¤šã€‚</li></ul><h5 id="æœ€åè¿›è¡Œè¦†ç›–å’Œè¿½åŠ " tabindex="-1"><a class="header-anchor" href="#æœ€åè¿›è¡Œè¦†ç›–å’Œè¿½åŠ "><span>æœ€åè¿›è¡Œè¦†ç›–å’Œè¿½åŠ </span></a></h5><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 2. å¦‚æœé€šè¿‡æ£€æŸ¥ï¼Œå¤„ç†æ—¥å¿—è¦†ç›–å’Œè¿½åŠ </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entry</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> range</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		index</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLenLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			// å¦‚æœå·²æœ‰çš„æ—¥å¿—å’Œæ–°çš„å†²çªäº†ï¼Œæ‰åˆ é™¤åé¢çš„</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨Â rf.log = append(rf.log[:rf.GetLogLocked(index)], args.Entries[i:]...)Â è¿™ç§å†™æ³•ï¼Ÿä¹Ÿå°±æ˜¯ï¼Œ**ä¸ºä»€ä¹ˆå¿…é¡»å…ˆåˆ¤æ–­Â TermÂ æ˜¯å¦ä¸åŒ¹é…ï¼Œå¦‚æœä¸åŒ¹é…æ‰æˆªæ–­ï¼Ÿ**Â å¦‚æœæˆ‘æ”¶åˆ°ä¸€ä¸ªå·²ç»å¤„ç†è¿‡çš„æ—§ RPC åŒ…ï¼Œç›´æ¥æˆªæ–­ä¼šå¯¼è‡´ä»€ä¹ˆé—®é¢˜ï¼Ÿ</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// - å‡è®¾ Leader å‘é€äº† RPC-1ï¼ˆIndex 10-11ï¼‰å’Œ RPC-2ï¼ˆIndex 12-13ï¼‰ã€‚RPC-2 å…ˆåˆ°ï¼ŒFollower å­˜ä¸‹äº† 10-13ã€‚ç„¶å RPC-1 ååˆ°ã€‚ **åæœï¼š**Â å¦‚æœä½ æ— è„‘æˆªæ–­Â rf.log[:10]Â ç„¶åè¿½åŠ  RPC-1 é‡Œçš„ 10-11ï¼Œé‚£ä¹ˆ Follower å·²ç»å­˜å¥½çš„ 12-13 å°±ä¼š**ä¸¢å¤±**ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> entry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">				rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[:</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">				rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> append</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			// å¦‚æœ Term ç›¸åŒ ç»§ç»­å¾€åçœ‹ä¸‹ä¸€æ¡</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			// è¶…å‡ºæœ¬åœ°é•¿åº¦äº†ï¼Œç›´æ¥è¿½åŠ å‰©ä¸‹æ‰€æœ‰çš„</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> append</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:]...)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">persist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 3. æ›´æ–° commitIndex</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LeaderCommit</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">commitedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		// è®ºæ–‡åŸæ–‡ï¼šcommitIndex = min(leaderCommit, index of last new entry)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		lastNewEntryIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">commitedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> min</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LeaderCommit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastNewEntryIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>å¹‚ç­‰æ€§</strong> ï¼šé€šè¿‡åˆ¤æ–­Â TermÂ æ˜¯å¦å†²çªæ¥å†³å®šæ˜¯å¦æˆªæ–­æ—¥å¿—ã€‚è¿™æ ·å³ä¾¿ RPC è¯·æ±‚å‘ç”Ÿä¹±åºã€é‡ä¼ æˆ–é‡å ï¼ŒFollower ä¹Ÿèƒ½ä¿è¯æ—¥å¿—çš„ä¸€è‡´æ€§ï¼Œä¸ä¼šå› ä¸ºå¤„ç†æ—§çš„ RPC åŒ…è€Œæ„å¤–åˆ é™¤äº†å·²ç»æ¥æ”¶åˆ°çš„ã€æ›´é åçš„æ­£ç¡®æ—¥å¿—</p><ol start="4"><li><strong>è¾¾æˆå…±è¯†</strong>ï¼šLeader æ”¶åˆ°è¿‡åŠæ•°çš„æˆåŠŸå›å¤ã€‚</li></ol><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rf </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">UpdateCommitIndexLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() { </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLenLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">commitedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">--</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			count</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> p</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> range</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">peers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">					if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> p</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">me</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">					if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">matchIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">						count</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">++</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">					}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> count</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">peers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">				rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">commitedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}			</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// æ¯æ¬¡æ”¶åˆ°æˆåŠŸå¤åˆ¶æ—¥å¿—çš„å›å¤éƒ½ä¼šè°ƒç”¨è¿™ä¸ª éå†æ‰€æœ‰followerçš„match index è¶…è¿‡åŠæ•°æ—§æŠŠä»–commit</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ³¨æ„è¿™é‡Œåˆ¤æ–­äº†è¦commitçš„æ—¥å¿—termå’Œå½“å‰term è¿™æ˜¯è®ºæ–‡ä¸­figure8çš„æƒ…å†µ leaderæ°¸è¿œä¸èƒ½ç›´æ¥commitä½äºå½“å‰termçš„ä»»ä½•æ¡ç›® åªèƒ½ç­‰åˆ°é«˜termæœ‰ä¸€æ¡è¢«commitäº† æ‰è¢«é¡ºå¸¦commit</p><hr><h3 id="ç¬¬ä¸‰é˜¶æ®µ-æäº¤ä¸å®‰å…¨-ä¸å¯é€†è½¬" tabindex="-1"><a class="header-anchor" href="#ç¬¬ä¸‰é˜¶æ®µ-æäº¤ä¸å®‰å…¨-ä¸å¯é€†è½¬"><span>ç¬¬ä¸‰é˜¶æ®µï¼šæäº¤ä¸å®‰å…¨ï¼ˆä¸å¯é€†è½¬ï¼‰</span></a></h3><ol><li><strong>æäº¤ï¼ˆCommitï¼‰</strong>ï¼šLeader å‘ç°è¿‡åŠæ•°éƒ½è®°å¥½äº†ï¼ŒæŠŠ <code>commitIndex</code> æ¨é«˜ã€‚</li><li><strong>å‘ŠçŸ¥</strong>ï¼šLeader åœ¨ä¸‹æ¬¡å¿ƒè·³ä¸­å‘Šè¯‰å¤§å®¶ï¼šâ€œç¬¬ 10 å·å·²ç»æäº¤äº†ã€‚â€</li><li><strong>Figure 8 çº¦æŸ</strong>ï¼šLeader åªèƒ½é€šè¿‡æäº¤å½“å‰ä»»æœŸçš„æ—¥å¿—æ¥é¡ºå¸¦æäº¤æ—§æ—¥å¿—ã€‚</li></ol><hr><h2 id="å¦‚ä½•ä¿æŒå¼ºä¸€è‡´æ€§â€”â€”prevlogidx-prevlogterm" tabindex="-1"><a class="header-anchor" href="#å¦‚ä½•ä¿æŒå¼ºä¸€è‡´æ€§â€”â€”prevlogidx-prevlogterm"><span>å¦‚ä½•ä¿æŒå¼ºä¸€è‡´æ€§â€”â€”PrevLogIdx PrevLogTerm</span></a></h2><p>å¯ä»¥æŠŠ <code>PrevLogIndex</code> å’Œ <code>PrevLogTerm</code> æƒ³è±¡æˆ<strong>æ‹¼å›¾çš„æ¥å£</strong>æˆ–è€…<strong>æ‹‰é“¾çš„é”æ‰£</strong>ã€‚</p><h3 id="é€šä¿—è§£é‡Š-æ‹‰é“¾åŸç†" tabindex="-1"><a class="header-anchor" href="#é€šä¿—è§£é‡Š-æ‹‰é“¾åŸç†"><span>é€šä¿—è§£é‡Šï¼šæ‹‰é“¾åŸç†</span></a></h3><p>å‡è®¾ Leader è¦ç»™ Follower å‘é€ç¬¬ 100 å·æ—¥å¿—ã€‚Leader ä¸èƒ½ç›´æ¥æ‰”è¿‡å»è¯´ï¼šâ€œè¿™æ˜¯ç¬¬ 100 å·ï¼Œä½ å­˜ä¸‹â€ã€‚<br> å› ä¸º Follower å¯èƒ½æ¯”è¾ƒå¡ï¼Œå®ƒçš„æ—¥å¿—æ‰å­˜åˆ°ç¬¬ 80 å·ã€‚å¦‚æœå®ƒç›´æ¥å­˜ä¸‹ç¬¬ 100 å·ï¼Œä¸­é—´å°±ç¼ºäº† 19 æ¡ï¼Œè¿™å°±å®Œè›‹äº†ã€‚</p><p>æ‰€ä»¥ï¼ŒLeader åœ¨å‘ç¬¬ 100 å·æ—¥å¿—æ—¶ï¼Œå¿…é¡»å¸¦ä¸Šç¬¬ 99 å·çš„ä¿¡æ¯ä½œä¸ºâ€œéªŒè¯ç â€ï¼š</p><ul><li><strong>PrevLogIndex (å‰ä¸€æ¡æ—¥å¿—çš„ç´¢å¼•)</strong>: 99</li><li><strong>PrevLogTerm (å‰ä¸€æ¡æ—¥å¿—çš„ä»»æœŸ)</strong>: æ¯”å¦‚ Term 5</li></ul><p>Leader å¯¹ Follower è¯´ï¼šâ€œæˆ‘è¦ç»™ä½ å‘ç¬¬ 100 å·æ—¥å¿—ã€‚ä½†åœ¨æ¥æ”¶ä¹‹å‰ï¼Œè¯·ä½ æ£€æŸ¥ä¸€ä¸‹ä½ é‚£é‡Œæœ‰æ²¡æœ‰ç¬¬ 99 å·æ—¥å¿—ï¼Œä¸”å®ƒçš„ä»»æœŸæ˜¯ä¸æ˜¯ Term 5ï¼Ÿâ€</p><ul><li><strong>æƒ…å†µ A (åŒ¹é…)</strong>ï¼šFollower çœ‹äº†ä¸€çœ¼ï¼Œè‡ªå·±ç¡®å®æœ‰ç¬¬ 99 å·ï¼Œä¹Ÿæ˜¯ Term 5ã€‚äºæ˜¯å›å¤ï¼šâ€œåŒ¹é…æˆåŠŸï¼Œæˆ‘æ”¶ä¸‹ç¬¬ 100 å·ã€‚â€ï¼ˆæ‹‰é“¾æ‹‰ä¸Šäº†ï¼‰ã€‚</li><li><strong>æƒ…å†µ B (ç¼ºå¤±)</strong>ï¼šFollower å‘ç°è‡ªå·±åªæœ‰ç¬¬ 80 å·ã€‚å®ƒå›å¤ï¼šâ€œæ‹’ç»ï¼Œæˆ‘æ²¡æœ‰ç¬¬ 99 å·ã€‚â€ Leader æ”¶åˆ°æ‹’ç»åï¼Œä¸‹æ¬¡å°±ä¼šè¯•ç€å‘ç¬¬ 81 å·ï¼ˆå¸¦ä¸Šç¬¬ 80 å·åšéªŒè¯ï¼‰ã€‚</li><li><strong>æƒ…å†µ C (å†²çª)</strong>ï¼šFollower æœ‰ç¬¬ 99 å·ï¼Œä½†æ˜¯æ˜¯ Term 4ï¼ˆæ—§ Leader ç•™ä¸‹çš„åƒåœ¾æ•°æ®ï¼‰ã€‚å®ƒå›å¤ï¼šâ€œæ‹’ç»ï¼Œæˆ‘æœ‰ç¬¬ 99 å·ï¼Œä½†Termä¸å¯¹ã€‚â€ Leader æ”¶åˆ°åï¼ŒçŸ¥é“è¿™é‡Œæ•°æ®ä¸ä¸€è‡´ï¼Œä¸‹æ¬¡ä¼šå¼ºè¡Œè¦†ç›–å®ƒã€‚</li></ul><hr><h3 id="å›¾è§£" tabindex="-1"><a class="header-anchor" href="#å›¾è§£"><span>å›¾è§£</span></a></h3><p>å‡è®¾ç°åœ¨çš„çŠ¶æ€å¦‚ä¸‹ï¼š</p><p><strong>Leader çš„æ—¥å¿—ï¼š</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Index: 1  2  3  4  5</span></span>
<span class="line"><span>Term:  1  1  2  3  3</span></span>
<span class="line"><span>       ^  ^  ^  ^  ^</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Leader æƒ³è¦å‘é€ Index=4 å’Œ Index=5 çš„æ—¥å¿—ç»™ Followerã€‚<br> æ­¤æ—¶ï¼Œ<code>AppendEntries</code> RPC å‚æ•°ä¼šæ˜¯ï¼š</p><ul><li><strong>Entries</strong>: <code>[Log(Index:4, Term:3), Log(Index:5, Term:3)]</code></li><li><strong>PrevLogIndex</strong>: 3 (æ–°æ—¥å¿—çš„å‰ä¸€æ¡)</li><li><strong>PrevLogTerm</strong>: 2 (Index 3 å¤„çš„ä»»æœŸ)</li></ul><p><strong>åœºæ™¯ 1ï¼šFollower æ˜¯å¥åº·çš„</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Follower A æ—¥å¿—:</span></span>
<span class="line"><span>Index: 1  2  3</span></span>
<span class="line"><span>Term:  1  1  2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Follower A æ”¶åˆ° RPCï¼š</p><ol><li>çœ‹ <code>PrevLogIndex</code> (3)ã€‚æˆ‘æœ‰ Index 3 å—ï¼Ÿæœ‰ã€‚</li><li>çœ‹ <code>PrevLogTerm</code> (2)ã€‚æˆ‘ Index 3 çš„ Term æ˜¯ 2 å—ï¼Ÿæ˜¯ã€‚</li><li><strong>æˆåŠŸ</strong>ã€‚æŠŠæ–°çš„æ—¥å¿— 4 å’Œ 5 æ¥åœ¨åé¢ã€‚</li></ol><p><strong>åœºæ™¯ 2ï¼šFollower è½åäº† (ç¼ºå¤±)</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Follower B æ—¥å¿—:</span></span>
<span class="line"><span>Index: 1  2</span></span>
<span class="line"><span>Term:  1  1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Follower B æ”¶åˆ° RPCï¼š</p><ol><li>çœ‹ <code>PrevLogIndex</code> (3)ã€‚æˆ‘æœ‰ Index 3 å—ï¼Ÿ<strong>æ²¡æœ‰ï¼</strong></li><li><strong>å¤±è´¥</strong>ã€‚è¿”å› <code>Success = false</code>ã€‚</li><li>Leader æ”¶åˆ°å¤±è´¥ï¼Œä¼šå°† <code>nextIndex</code> å‡å°ï¼Œä¸‹æ¬¡æ”¹ä¸ºå‘é€ Index 3ï¼ˆå¸¦ä¸Š PrevLogIndex: 2ï¼‰ã€‚</li></ol><p><strong>åœºæ™¯ 3ï¼šFollower æ­¤æ—¶æœ‰è„æ•°æ® (å†²çª)</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Follower C æ—¥å¿—:</span></span>
<span class="line"><span>Index: 1  2  3</span></span>
<span class="line"><span>Term:  1  1  1  &lt;-- æ³¨æ„è¿™é‡Œæ˜¯ 1ï¼ŒLeader æœŸæœ›æ˜¯ 2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Follower C æ”¶åˆ° RPCï¼š</p><ol><li>çœ‹ <code>PrevLogIndex</code> (3)ã€‚æˆ‘æœ‰ Index 3 å—ï¼Ÿæœ‰ã€‚</li><li>çœ‹ <code>PrevLogTerm</code> (2)ã€‚æˆ‘ Index 3 çš„ Term æ˜¯ 2 å—ï¼Ÿ<strong>ä¸æ˜¯ï¼Œæˆ‘æ˜¯ 1ã€‚</strong></li><li><strong>å¤±è´¥</strong>ã€‚è¿”å› <code>Success = false</code>ã€‚</li><li>è¿™è¡¨ç¤º Follower çš„ Index 3 æ˜¯é”™çš„ï¼ŒLeader ä¹‹åä¼šä¸€æ­¥æ­¥å›é€€ï¼Œæœ€ç»ˆæŠŠè¿™ä¸ª Term 1 çš„é”™è¯¯æ—¥å¿—è¦†ç›–æ‰ã€‚</li></ol><hr><h3 id="ä»£ç å®ç°é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#ä»£ç å®ç°é€»è¾‘"><span>ä»£ç å®ç°é€»è¾‘</span></a></h3><h4 id="ä¸ºä»€ä¹ˆéœ€è¦-index-0-dummy-entry" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆéœ€è¦-index-0-dummy-entry"><span>ä¸ºä»€ä¹ˆéœ€è¦ Index 0 (Dummy Entry)ï¼Ÿ</span></a></h4><p>ä¸ºäº†æ–¹ä¾¿å¤„ç† <code>PrevLogIndex</code>ï¼Œæˆ‘ä»¬é€šå¸¸åœ¨ <code>rf.log</code> åˆå§‹åŒ–æ—¶æ”¾ä¸€ä¸ªç©ºçš„æ—¥å¿—å ä½ã€‚<br><code>rf.log[0] = LogEntry{Term: 0}</code><br> è¿™æ ·ï¼Œå¦‚æœ Leader è¦å‘ç¬¬ä¸€æ¡çœŸçš„æ—¥å¿—ï¼ˆIndex 1ï¼‰ï¼Œå®ƒçš„ <code>PrevLogIndex</code> å°±æ˜¯ 0ï¼Œ<code>PrevLogTerm</code> å°±æ˜¯ 0ã€‚ä½ å°±ä¸ç”¨å†™ä¸€å † <code>if index == 0</code> çš„ç‰¹æ®Šåˆ¤æ–­é€»è¾‘äº†ã€‚</p><h4 id="leader-ç«¯æ€ä¹ˆè®¡ç®—-å‘é€æ–¹" tabindex="-1"><a class="header-anchor" href="#leader-ç«¯æ€ä¹ˆè®¡ç®—-å‘é€æ–¹"><span>Leader ç«¯æ€ä¹ˆè®¡ç®—ï¼Ÿ (å‘é€æ–¹)</span></a></h4><p>Leader ç»´æŠ¤äº† <code>nextIndex[]</code>ï¼Œè¡¨ç¤ºä¸‹ä¸€ä¸ªè¦å‘ç»™æŸä¸ª Peer çš„æ—¥å¿—ç´¢å¼•ã€‚</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// å‡è®¾è¦å‘ç»™ server p</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nextIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nextIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// PrevLogIndex å°±æ˜¯æˆ‘ä»¬è¦å‘çš„è¿™ä¸€æ‰¹çš„å‰ä¸€ä¸ª</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> nextIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// è¦å‘çš„æ—¥å¿—åˆ‡ç‰‡</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entries</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nextIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AppendEntriesArgs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    PrevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:  </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:      </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ... å…¶ä»–å­—æ®µ</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="follower-ç«¯æ€ä¹ˆæ£€æŸ¥-æ¥æ”¶æ–¹" tabindex="-1"><a class="header-anchor" href="#follower-ç«¯æ€ä¹ˆæ£€æŸ¥-æ¥æ”¶æ–¹"><span>Follower ç«¯æ€ä¹ˆæ£€æŸ¥ï¼Ÿ (æ¥æ”¶æ–¹)</span></a></h4><p>è¿™æ˜¯ <code>AppendEntries</code> ä¸­æœ€å…³é”®çš„é€»è¾‘ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rf </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">AppendEntries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">AppendEntriesArgs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">reply</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">AppendEntriesReply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 1. Term æ£€æŸ¥</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { ... }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 2. ä¸€è‡´æ€§æ£€æŸ¥ (Consistency Check)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // æƒ…å†µ A: æˆ‘è¿è¿™ä¸ªä½ç½®çš„æ—¥å¿—éƒ½æ²¡æœ‰ (æ—¥å¿—å¤ªçŸ­)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // æƒ…å†µ B: æˆ‘æœ‰è¿™ä¸ªä½ç½®çš„æ—¥å¿—ï¼Œä½†æ˜¯ Term ä¸åŒ¹é…</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // ä¼˜åŒ–ï¼š3C ä¼šåœ¨è¿™é‡Œåšå†²çªä¼˜åŒ–</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 3. åˆ°äº†è¿™é‡Œï¼Œè¯´æ˜å‰é¢éƒ½åŒ¹é…ä¸Šäº†ï¼</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å³ä½¿ entries æ˜¯ç©ºçš„ï¼ˆå¿ƒè·³ï¼‰ï¼Œä¹Ÿè¯´æ˜è‡³å°‘åˆ° PrevLogIndex ä½ç½®æ˜¯ä¸€è‡´çš„ã€‚</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 4. å¤„ç†æ—¥å¿—è¿½åŠ å’Œå†²çªè¦†ç›– (Log Truncation and Append)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // éå† args.Entriesï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªä¸åŒ¹é…çš„ä½ç½®ï¼Œåˆ é™¤å®ƒåŠä¹‹åçš„æ‰€æœ‰ï¼Œç„¶åæŠŠæ–°çš„æ¥ä¸Šå»ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ... (åç»­å®ç°)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>PrevLogIndex</strong>: è¿™æ¬¡è¦ä¼ çš„æ–°è´§ä¹‹å‰ï¼Œæœ€åé‚£æ¡æ—§è´§çš„ç¼–å·ã€‚</li><li><strong>PrevLogTerm</strong>: é‚£æ¡æ—§è´§çš„ç”Ÿäº§æ‰¹æ¬¡ã€‚</li><li><strong>ä½œç”¨</strong>: åªæœ‰æ—§è´§å¯¹ä¸Šäº†ï¼Œæ‰å…è®¸æ¥æ–°è´§ã€‚è¿™æ˜¯ Raft ä¿è¯æ‰€æœ‰èŠ‚ç‚¹æ—¥å¿—æœ€ç»ˆä¸€æ¨¡ä¸€æ ·çš„æ ¹æœ¬åŸå› ï¼ˆæ•°å­¦å½’çº³æ³•ï¼‰ã€‚</li></ul><h2 id="æŒä¹…åŒ–ä¸æäº¤" tabindex="-1"><a class="header-anchor" href="#æŒä¹…åŒ–ä¸æäº¤"><span>æŒä¹…åŒ–ä¸æäº¤</span></a></h2><p>æŒä¹…åŒ–æ˜¯ä¸€ä¸ªèŠ‚ç‚¹è‡ªå·±çš„è¡Œä¸º ä½œç”¨æ˜¯å°† Â <code>currentTerm</code>ã€<code>voteFor</code>Â å’ŒÂ <code>log[]</code> å­˜å‚¨åˆ°ç£ç›˜ä¸­ é˜²æ­¢æ–­ç”µ æˆ–è€…ç”¨äºæ–­ç”µåçš„æ¢å¤</p><p>æäº¤åˆ™æ˜¯è¾¾æˆå…±è¯†ä»¥å äº¤ç»™ä¸Šå±‚çš„kv serverè¿›è¡Œæ‰§è¡Œ æäº¤çš„ä¿¡æ¯æ˜¯ä¸èƒ½æ”¹å˜çš„ ä½†æ˜¯æŒä¹…åŒ–çš„ä¿¡æ¯å¯èƒ½è¢«æ–°çš„leaderè¦†ç›–æ‰</p><p><strong>ä¸€å®šè¦å…ˆæŒä¹…åŒ–å†å›å¤RPC</strong><br><strong>æäº¤çš„å‰ææ˜¯åŠæ•°ä»¥ä¸Šçš„èŠ‚ç‚¹å®Œæˆäº†æŒä¹…åŒ– è€Œä¸æ˜¯å®Œæˆäº†æ—¥å¿—çš„ä¸€è‡´</strong></p><h2 id="lastapplied-å’Œ-lastcommitedçš„åŒºåˆ«" tabindex="-1"><a class="header-anchor" href="#lastapplied-å’Œ-lastcommitedçš„åŒºåˆ«"><span>LastApplied å’Œ LastCommitedçš„åŒºåˆ«</span></a></h2><p>appliedæ˜¯ä¸Šå±‚kvserveræœ€ååº”ç”¨åˆ°çŠ¶æ€æœºçš„æ—¥å¿— ä¹Ÿå°±æ˜¯ä¸Šä¸€æ¬¡è¢«æ”¾è¿›apply chançš„é‚£ä¸ªæ—¥å¿—</p><p>è€Œlast commitæ˜¯æœ€åä¸€ä¸ªåœ¨raftå†…éƒ¨è¾¾æˆä¸€è‡´çš„æ—¥å¿—æ¡ç›®</p><p>ä»è¿™é‡Œå¯ä»¥çœ‹å‡º commitæ¡ç›®ä¸€å®šè‡³å°‘å¤§äºç­‰äºappliedçš„æ¡ç›®ï¼ˆåªæœ‰è¾¾æˆå…±è¯†çš„æ—¥å¿—æ‰ä¼šè¢«åº”ç”¨åˆ°kvä¸­ï¼‰</p><p>raftä¸­ä¸“é—¨æœ‰ä¸€ä¸ªåç¨‹<code>applier</code>ç”¨æ¥æŸ¥çœ‹commitæ˜¯å¦å‰è¿›äº† ä»–ä¼šå¯¹applyè½åçš„æ¯ä¸ªæ¡ç›®åˆ›å»ºä¸€ä¸ªapply msg æ”¾å…¥apply chan è®©ä¸Šå±‚çš„kvserverè¿›è¡Œå¤„ç†</p><h2 id="æ–°å½“é€‰çš„leaderä¸èƒ½commitæ—§termçš„æ—¥å¿—" tabindex="-1"><a class="header-anchor" href="#æ–°å½“é€‰çš„leaderä¸èƒ½commitæ—§termçš„æ—¥å¿—"><span>æ–°å½“é€‰çš„Leaderä¸èƒ½commitæ—§Termçš„æ—¥å¿—</span></a></h2><p>å¦‚æœç”¨ä¸€å¥è¯ä½œä¸ºæŠ€æœ¯å®šä¹‰ï¼Œé‚£å°±æ˜¯ï¼š<strong>Raft åªæœ‰å½“å‰ä»»æœŸçš„æ—¥å¿—å¯ä»¥è§¦å‘å‰¯æœ¬æ•°ç»Ÿè®¡ï¼ˆCounting replicasï¼‰ï¼Œè€Œæ—§ä»»æœŸçš„æ—¥å¿—åªèƒ½é€šè¿‡â€œæ—¥å¿—åŒ¹é…åŸåˆ™ï¼ˆLog Matching Propertyï¼‰â€è¢«åŠ¨åœ°è¢«å¸¦åŠ¨æäº¤ã€‚</strong></p><h3 id="_1-ç»ä¸-æ•°æ•°" tabindex="-1"><a class="header-anchor" href="#_1-ç»ä¸-æ•°æ•°"><span>1. ç»ä¸â€œæ•°æ•°â€</span></a></h3><p>Leader å³ä½¿çœ‹åˆ°æŸæ¡<strong>æ—§ä»»æœŸ</strong>çš„æ—¥å¿—å·²ç»å­˜åœ¨äº 99% çš„èŠ‚ç‚¹ä¸Šï¼Œä»–ä¹Ÿç»å¯¹<strong>ä¸èƒ½</strong>æŠŠè‡ªå·±çš„ <code>commitIndex</code> ç§»åŠ¨åˆ°é‚£é‡Œã€‚</p><h3 id="_2-ç»ä¸-è¿çº¦" tabindex="-1"><a class="header-anchor" href="#_2-ç»ä¸-è¿çº¦"><span>2. ç»ä¸â€œè¿çº¦â€</span></a></h3><p>Leader å¿…é¡»ç­‰åˆ°æœ‰ä¸€æ¡<strong>å½“å‰ä»»æœŸ</strong>çš„æ—¥å¿—è¢«è¿‡åŠæ•°èŠ‚ç‚¹ç¡®è®¤ã€‚</p><ul><li>æ¯”å¦‚ Leader ç°åœ¨æ˜¯ Term 4ï¼Œä»–åœ¨åŒæ­¥ä¸€æ¡ Term 2 çš„æ—§æ—¥å¿—ã€‚</li><li>ä»–å¿…é¡»ç­‰åˆ°è€æ¿å‘æ¥æ–°æŒ‡ä»¤ï¼Œä»–åœ¨æœ¬å­ä¸Šè®°ä¸‹ <code>(Index: 10, Term: 4)</code>ã€‚</li><li>åªæœ‰å½“è¿™æ¡ <code>(Index: 10, Term: 4)</code> åˆ°äº†è¿‡åŠæ•°èŠ‚ç‚¹ï¼Œä»–æ‰èƒ½å®£å¸ƒ Index 10 åŠå…¶ä¹‹å‰çš„æ‰€æœ‰æ—¥å¿—ï¼ˆåŒ…æ‹¬é‚£æ¡ Term 2ï¼‰å…¨éƒ¨ç”Ÿæ•ˆã€‚</li></ul><h3 id="_3-ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯-å½“å‰ä»»æœŸ" tabindex="-1"><a class="header-anchor" href="#_3-ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯-å½“å‰ä»»æœŸ"><span>3. ä¸ºä»€ä¹ˆå¿…é¡»æ˜¯â€œå½“å‰ä»»æœŸâ€ï¼Ÿ</span></a></h3><p>å› ä¸º<strong>åªæœ‰å½“å‰ä»»æœŸçš„æ—¥å¿—èƒ½å¤Ÿä»£è¡¨è¿™ä¸ª Leader çš„â€œæƒå¨â€</strong>ã€‚</p><ul><li>é«˜ä»»æœŸçš„æ—¥å¿—ï¼ˆTerm 4ï¼‰å¤©ç”Ÿå°±æœ‰â€œå‹åˆ¶â€ä½ä»»æœŸï¼ˆTerm 2, Term 3ï¼‰çš„èƒ½åŠ›ã€‚</li><li>ä¸€æ—¦ Term 4 çš„æ—¥å¿—åœ¨è¿‡åŠæ•°èŠ‚ç‚¹ä¸Šæ‰äº†æ ¹ï¼Œä»»ä½•ä»»æœŸå°äº 4 çš„èŠ‚ç‚¹éƒ½ä¸å¯èƒ½å†å½“é€‰ Leader äº†ã€‚</li><li>è¿™æ—¶å€™å†å®£å¸ƒä¹‹å‰çš„æ—¥å¿—ç”Ÿæ•ˆï¼Œæ‰æ˜¯çœŸæ­£çš„å®‰å…¨ã€‚</li></ul><hr><h3 id="é¢è¯•å®˜å¯èƒ½ä¼šè¿½é—®-å¦‚æœä¸€ç›´æ²¡æœ‰æ–°è¯·æ±‚æ€ä¹ˆåŠ" tabindex="-1"><a class="header-anchor" href="#é¢è¯•å®˜å¯èƒ½ä¼šè¿½é—®-å¦‚æœä¸€ç›´æ²¡æœ‰æ–°è¯·æ±‚æ€ä¹ˆåŠ"><span>é¢è¯•å®˜å¯èƒ½ä¼šè¿½é—®ï¼šâ€œå¦‚æœä¸€ç›´æ²¡æœ‰æ–°è¯·æ±‚æ€ä¹ˆåŠï¼Ÿâ€</span></a></h3><p>è¿™æ˜¯ä¸€ä¸ªå¥½å‘ã€‚å¦‚æœè€æ¿ï¼ˆClientï¼‰ä¸€ç›´ä¸å‘æ–°è¯·æ±‚ï¼Œé‚£æ—§ä»»æœŸçš„æ—¥å¿—æ˜¯ä¸æ˜¯æ°¸è¿œæ²¡æ³•æäº¤äº†ï¼Ÿ</p><p><strong>ç­”æ¡ˆæ˜¯ï¼šNo-op æ—¥å¿—ã€‚</strong><br> åœ¨å¾ˆå¤šç”Ÿäº§çº§åˆ«çš„ Raft å®ç°ï¼ˆæ¯”å¦‚ etcdï¼‰ä¸­ï¼ŒLeader å½“é€‰åçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å…ˆå‘ä¸€æ¡ä¸å¸¦å†…å®¹çš„ <strong>No-opï¼ˆç©ºæŒ‡ä»¤ï¼‰æ—¥å¿—</strong>ã€‚</p><ul><li>è¿™æ¡ No-op æ—¥å¿—çš„ä»»æœŸæ˜¯å½“å‰ä»»æœŸã€‚</li><li>å®ƒä¸€æ—¦è¿‡åŠæäº¤ï¼Œå°±èƒ½ç«‹åˆ»æŠŠä¹‹å‰æ‰€æœ‰ä»»æœŸçš„æ—§è´¦å…¨éƒ¨â€œå†²æ­£â€å¹¶æäº¤ã€‚</li><li>è¿™å°±è§£å†³äº†â€œæ²¡æœ‰æ–°ä¸šåŠ¡è¯·æ±‚æ—¶ï¼Œæ—§è´¦æ— æ³•æäº¤â€çš„é—®é¢˜ã€‚</li></ul><hr><h3 id="ä»£ç " tabindex="-1"><a class="header-anchor" href="#ä»£ç "><span>ä»£ç </span></a></h3><p>åœ¨ <code>UpdateCommitIndexLocked</code> å‡½æ•°é‡Œï¼Œè¿™è¡Œé€»è¾‘å°±æ˜¯ Figure 8 çš„çµé­‚ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// i æ˜¯æ­£åœ¨å°è¯•æ›´æ–°çš„ commitIndex å€™é€‰å€¼</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// &lt;--- å°±æ˜¯è¿™ä¸€è¡Œï¼</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // åªæœ‰å½“å‰ä»»æœŸçš„æ—¥å¿—æ‰æ•¢å»æ•°å‰¯æœ¬æ•°</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> count</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">peers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">commitedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="raftä¸­é‡åˆ°çš„é—®é¢˜" tabindex="-1"><a class="header-anchor" href="#raftä¸­é‡åˆ°çš„é—®é¢˜"><span>RAFTä¸­é‡åˆ°çš„é—®é¢˜</span></a></h2><h3 id="åœ¨tickerä¸­ä¸èƒ½å¼€å¯åç¨‹è¿›è¡Œé€‰ä¸¾â€”â€”election-storm" tabindex="-1"><a class="header-anchor" href="#åœ¨tickerä¸­ä¸èƒ½å¼€å¯åç¨‹è¿›è¡Œé€‰ä¸¾â€”â€”election-storm"><span>åœ¨tickerä¸­ä¸èƒ½å¼€å¯åç¨‹è¿›è¡Œé€‰ä¸¾â€”â€”election storm</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rf </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ticker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">killed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		state</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">state</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> state</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> StateLeader</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			go</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">BroadCastAppendEntries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Millisecond</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			elapsed</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Since</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastActiveTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">electionTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> elapsed</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				// go rf.startElection() &lt;- ä¸æ­£ç¡®</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">				rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">startElection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Millisecond</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœåç¨‹è°ƒåº¦å‡ºç°é—®é¢˜ å¯¼è‡´æ²¡æœ‰åŠæ—¶å½’é›¶è®¡æ—¶å™¨ å°±ä¼šæœ‰è¾¾åˆ°è¶…æ—¶æ—¶é—´å¹¶ä¸”å¼€ä¸€ä¸ªé€‰ä¸¾åç¨‹ï¼ˆterm++ï¼‰<br> åˆä¸€æ¬¡è¶…æ—¶çš„æ—¶å€™åˆä¼šè§¦å‘é€‰ä¸¾å¯¼è‡´termè¢«æŠ¬å‡çš„å¾ˆé«˜ï¼ˆä¸ä¼šå½±å“ä¸€è‡´æ€§ä½†æ˜¯ä¼šä¸¥é‡å½±å“å¯ç”¨æ€§ï¼‰</p><h3 id="ä½•æ—¶é‡ç½®è¶…æ—¶è®¡æ—¶å™¨" tabindex="-1"><a class="header-anchor" href="#ä½•æ—¶é‡ç½®è¶…æ—¶è®¡æ—¶å™¨"><span>ä½•æ—¶é‡ç½®è¶…æ—¶è®¡æ—¶å™¨</span></a></h3><blockquote><p>â€œåœ¨å®ç° <code>RequestVote</code> æ—¶ï¼Œ<strong>é‡ç½®è®¡æ—¶å™¨çš„æ—¶æœºå¿…é¡»éå¸¸è°¨æ…</strong>ã€‚</p><p>åªæœ‰åœ¨<strong>çœŸæ­£æˆäºˆé€‰ç¥¨</strong>æ—¶é‡ç½®ï¼Œæ˜¯ä¸ºäº†é˜²æ­¢æ¶æ„èŠ‚ç‚¹é€šè¿‡æ— æ•ˆè¯·æ±‚æŠ‘åˆ¶æ­£å¸¸é€‰ä¸¾ã€‚</p><p>æ­¤å¤–ï¼Œä¸ºäº†é˜²æ­¢æ—¥å¿—è½åçš„èŠ‚ç‚¹ä»…ä»…é é«˜ Term å¹²æ‰°é›†ç¾¤ç¨³å®šæ€§ï¼Œè™½ç„¶æ ‡å‡† Raft è§„å®šåªè¦çœ‹åˆ°é«˜ Term å°±è½¬ä¸º Followerï¼Œä½†åœ¨å®é™…å·¥ç¨‹ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸ä¼šé…åˆ <strong>Pre-Vote</strong> æœºåˆ¶ã€‚å³ï¼šèŠ‚ç‚¹åœ¨è½¬ä¸º Follower å‰ï¼Œä¼šå…ˆç¡®è®¤ Candidate æ˜¯å¦çœŸçš„æœ‰èµ„æ ¼ï¼ˆæ—¥å¿—å¤Ÿæ–°ï¼‰ä»¥åŠå½“å‰é›†ç¾¤æ˜¯å¦çœŸçš„ä¸¢å¤±äº† Leaderã€‚è¿™ä¿è¯äº†é›†ç¾¤çš„ç¨³å®šæ€§ï¼ˆStabilityï¼‰ã€‚â€</p></blockquote><h3 id="å•ä¸ªåˆ†åŒºä¸­çš„èŠ‚ç‚¹æŠ¬é«˜termâ€”â€”pre-voteè§£å†³" tabindex="-1"><a class="header-anchor" href="#å•ä¸ªåˆ†åŒºä¸­çš„èŠ‚ç‚¹æŠ¬é«˜termâ€”â€”pre-voteè§£å†³"><span>å•ä¸ªåˆ†åŒºä¸­çš„èŠ‚ç‚¹æŠ¬é«˜Termâ€”â€”pre-voteè§£å†³</span></a></h3><ul><li><strong>åœºæ™¯</strong>ï¼šèŠ‚ç‚¹ A è¢«ç½‘ç»œåˆ†åŒºéš”ç¦»äº†ã€‚å®ƒåœ¨è‡ªå·±çš„å°é»‘å±‹é‡Œä¸æ–­è¶…æ—¶ï¼ŒTerm ä¸€ç›´å¢åŠ åˆ°äº† 100ã€‚</li><li><strong>åŠ¨ä½œ</strong>ï¼šéš”ç¦»è§£é™¤ï¼ŒèŠ‚ç‚¹ A å›å½’ã€‚å®ƒå‘èµ·çš„ <code>RequestVote(Term=100)</code> åˆ°è¾¾äº†æ­£åœ¨æ­£å¸¸å·¥ä½œçš„ Leaderï¼ˆTerm=10ï¼‰ã€‚</li><li><strong>ååº”</strong>ï¼šLeader çœ‹åˆ° Term 100ï¼Œå¤§åƒä¸€æƒŠï¼Œç«‹åˆ»å˜å› Followerã€‚ä½† Leader å‘ç° A çš„æ—¥å¿—å¤ªæ—§ï¼Œä¸ç»™å®ƒæŠ•ç¥¨ã€‚</li><li><strong>é™·é˜±</strong>ï¼šæ­¤æ—¶ï¼Œæ—§ Leader å˜æˆäº† Followerï¼Œä¸”<strong>æ²¡æœ‰é‡ç½®è®¡æ—¶å™¨</strong>ã€‚è¿™æ„å‘³ç€æ—§ Leader ä¼šåœ¨å¾ˆçŸ­çš„æ—¶é—´å†…ï¼ˆå› ä¸ºå®ƒä¹‹å‰çš„è®¡æ—¶å™¨å·²ç»åœ¨è·‘äº†ï¼‰å‘ç”Ÿè¶…æ—¶ï¼Œå†æ¬¡å‘èµ· Term 101 çš„é€‰ä¸¾ã€‚</li></ul><p><strong>ç»“æœ</strong>ï¼šè¿™ä¸ªè½åèŠ‚ç‚¹è™½ç„¶æ²¡å½“ä¸Š Leaderï¼Œä½†å®ƒåƒä¸ªâ€œæ…å±æ£â€ä¸€æ ·ï¼Œä»…ä»…é ä¸€ä¸ªé«˜ Term å°±æŠŠç°æœ‰çš„ Leader ç»™è¸¢ä¸‹æ¥äº†ï¼Œå¯¼è‡´é›†ç¾¤å‘ç”Ÿäº†ä¸€æ¬¡æ— æ„ä¹‰çš„éœ‡è¡ã€‚</p><hr><p>ä¸ºäº†è§£å†³ä¸Šè¿°â€œæ…å±æ£â€é—®é¢˜ï¼Œå·¥ä¸šçº§çš„ Raftï¼ˆå¦‚ etcdï¼‰å¼•å…¥äº† <strong>Pre-Vote</strong> æœºåˆ¶ï¼š</p><ol><li>å½“ä¸€ä¸ª Candidate æƒ³å‘èµ·é€‰ä¸¾æ—¶ï¼Œå®ƒå…ˆå‘ä¸€ä¸ª <strong>Pre-Vote</strong>ï¼ˆä¸å¢åŠ è‡ªå·±çš„ Termï¼‰ã€‚</li><li>å¤§å®¶æ”¶åˆ° Pre-Vote åï¼Œæ£€æŸ¥ï¼š <ul><li>ä½ çš„æ—¥å¿—å¤Ÿæ–°å—ï¼Ÿ</li><li><strong>æˆ‘æœ€è¿‘æ˜¯ä¸æ˜¯åˆšæ”¶åˆ°è¿‡ Leader çš„å¿ƒè·³ï¼Ÿ</strong>ï¼ˆå¦‚æœæˆ‘æœ€è¿‘æ”¶åˆ°äº†å¿ƒè·³ï¼Œè¯´æ˜é›†ç¾¤æœ‰æ´»ç€çš„ Leaderï¼Œæˆ‘ç›´æ¥æ‹’ç»ä½ çš„é¢„æŠ•ç¥¨ï¼‰ã€‚</li></ul></li><li>åªæœ‰ Candidate æ‹¿åˆ°å¤§å¤šæ•°äººçš„ Pre-Vote è®¸å¯ï¼Œå®ƒæ‰æ­£å¼å¢åŠ  <code>currentTerm</code> å¹¶å‘èµ·çœŸæ­£çš„ <code>RequestVote</code>ã€‚</li></ol><p><strong>ä¸ºä»€ä¹ˆè¿™èƒ½è§£å†³é—®é¢˜ï¼Ÿ</strong></p><ul><li>é‚£ä¸ªè½åèŠ‚ç‚¹ A å›å½’æ—¶ï¼Œå®ƒå‘å‡ºçš„ Pre-Vote ä¼šè¢«å¤§å®¶æ‹’ç»ï¼ˆå› ä¸ºå¤§å®¶èƒ½è¿ä¸Š Leaderï¼‰ï¼ŒA ç”šè‡³æ²¡æœ‰æœºä¼šæŠŠå¤§å®¶çš„ <code>currentTerm</code> é¡¶ä¸Šå»ã€‚</li></ul><h1 id="kvraft-å®æˆ˜" tabindex="-1"><a class="header-anchor" href="#kvraft-å®æˆ˜"><span>KVRAFT å®æˆ˜</span></a></h1><h2 id="clerk-client" tabindex="-1"><a class="header-anchor" href="#clerk-client"><span>Clerk/Client</span></a></h2><p>è¿™ä¸ªéƒ¨åˆ†åªéœ€è¦å®Œæˆå‘kvserverå‘é€çš„RPCæ„å»º<br> éœ€è¦æ³¨æ„çš„æ˜¯</p><ul><li>éœ€è¦å‘æ‰€æœ‰å¯èƒ½çš„serverè¿›è¡Œè¯¢é—® ç›´åˆ°æ‰¾åˆ°leader kvserveræ‰è¡Œ å¯ç”¨æ€§æ–¹é¢æ˜¯raftä¿è¯çš„</li><li>éœ€è¦ç»´æŠ¤clinet id å’Œ seq no æ¥ä¿è¯å„ç§æ“ä½œçš„çº¿æ€§ä¸€è‡´æ€§å’Œå¹‚ç­‰æ€§ï¼ˆå¦‚æœæœåŠ¡å™¨å‘ç°seqnoå·²ç»è¿‡æ—¶äº† å°±ä¸ä¼šåœ¨ä»–çš„çŠ¶æ€æœºä¸Šåº”ç”¨äº†ï¼‰</li></ul><h2 id="kvserver" tabindex="-1"><a class="header-anchor" href="#kvserver"><span>KVserver</span></a></h2><p>KVserver å®é™…ä¸Šæ˜¯ä¸€ä¸ªæ‰§è¡Œè€… æœ¬è´¨ä¸Šå°±æ˜¯ç»´æŠ¤äº†ä¸€ä¸ªå†…å­˜é‡Œçš„map ç„¶åèƒ½å¤Ÿæ¥å—ä¸‰ç§æŒ‡ä»¤ GET PUT APPEND<br> è€Œraftä¸ç†è§£è¿™ä¸ªæŒ‡ä»¤ ä»–çœ¼é‡Œåªæœ‰å­—èŠ‚æµæ—¥å¿— å¹¶ä¸”ä»–ä¿è¯è¿™ä¸ªæ—¥å¿—åœ¨æ‰€æœ‰æœºå™¨ä¸­è¾¾æˆå…±è¯†<br> ä¸€æ—¦raftæŠŠè¿™ä¸ªæ—¥å¿—æˆåŠŸå¤åˆ¶ç»™åŠæ•°èŠ‚ç‚¹ ä»–å°±ä¼šé€šè¿‡apply channelå‘Šè¯‰KVserver ä½ å¯ä»¥æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤äº†</p><p>å¦‚æœä¸é€šè¿‡ Raft ç»™æŒ‡ä»¤ï¼Œè€Œæ˜¯ KVServer æ”¶åˆ°è¯·æ±‚ç›´æ¥æ”¹ mapï¼š</p><ul><li>Server 1 æ”¶åˆ° Put(a, 1)ï¼Œæ”¹äº† mapã€‚</li><li>Server 2 æ²¡æ”¶åˆ°ï¼Œå®ƒçš„ map è¿˜æ˜¯æ—§çš„ã€‚<br><strong>ç»“æœ</strong>ï¼šä¸¤ä¸ªæœåŠ¡å™¨çš„çŠ¶æ€ä¸ä¸€æ ·äº†ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿå´©æºƒã€‚<br> é€šè¿‡ Raft ç»™æŒ‡ä»¤çš„é€»è¾‘æ˜¯ï¼š</li><li>å®¢æˆ·ç«¯æ‰¾ Server 1 è¯´ï¼šæˆ‘æƒ³ Put(a, 1)ã€‚</li><li>Server 1 ä¸æ•¢ç›´æ¥æ”¹ mapï¼Œå®ƒå…ˆé—® Raftï¼šæŠŠè¿™ä¸ªè®°åœ¨è´¦æœ¬ä¸Šè¡Œä¸è¡Œï¼Ÿ</li><li>Raft å‘Šè¯‰ Server 1ã€2ã€3ï¼šå¤§å®¶éƒ½è®°å¥½äº†ï¼ŒIndex 100 æ˜¯ Put(a, 1)ã€‚</li><li>Server 1ã€2ã€3 çš„ applyLoop éƒ½ä» Raft é‚£é‡Œæ‹¿åˆ°äº†è¿™æ¡æŒ‡ä»¤ã€‚</li><li>å¤§å®¶åŒæ—¶æ”¹ mapã€‚<br><strong>ç»“æœ</strong>ï¼šå…¨ä¸–ç•Œçš„ map æ°¸è¿œä¿æŒåŒæ­¥ã€‚</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>èŠ‚ç‚¹ 1                     èŠ‚ç‚¹ 2                     èŠ‚ç‚¹ 3</span></span>
<span class="line"><span>+--------------+          +--------------+          +--------------+</span></span>
<span class="line"><span>|   KVServer   |          |   KVServer   |          |   KVServer   |</span></span>
<span class="line"><span>+--------------+          +--------------+          +--------------+</span></span>
<span class="line"><span>|     Raft     | &lt;------&gt; |     Raft     | &lt;------&gt; |     Raft     |</span></span>
<span class="line"><span>+--------------+          +--------------+          +--------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>åªæœ‰ Leader èº«ä»½çš„ KVServer ä¼šå¤„ç† Client çš„è¯·æ±‚ã€‚</strong></p><ul><li><strong>Client çš„è§†è§’</strong>ï¼šClient ä¼šè½®è¯¢æœåŠ¡å™¨ã€‚å¦‚æœå®ƒå‘ä¸€ä¸ª Follower å‘é€è¯·æ±‚ï¼Œè¿™ä¸ª KVServer ä¼šçœ‹ä¸€çœ¼å®ƒå†…éƒ¨çš„ Raft çŠ¶æ€ï¼Œè¯´ï¼šâ€œæˆ‘ä¸æ˜¯ Leaderï¼Œä½ å»é—®èŠ‚ç‚¹ Xâ€ã€‚</li><li><strong>å†™æ“ä½œ (Put/Append)</strong>ï¼šå¿…é¡»ç”± Leader æäº¤åˆ° Raft æ—¥å¿—ï¼Œç­‰åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹ç¡®è®¤åæ‰èƒ½ä¿®æ”¹æ•°æ®åº“ã€‚</li><li><strong>è¯»æ“ä½œ (Get)</strong>ï¼šä¸ºäº†ä¿è¯è¯»åˆ°çš„æ˜¯æœ€æ–°çš„ï¼ŒLeader ä¹Ÿéœ€è¦æŠŠ Get ä½œä¸ºä¸€ä¸ªæ—¥å¿—èµ°ä¸€é Raft æµç¨‹ï¼ˆæˆ–è€…ä½¿ç”¨æ›´é«˜çº§çš„ Read Index æœºåˆ¶ï¼‰ï¼Œç¡®ä¿å®ƒåœ¨æ‰§è¡Œè¯»çš„ä¸€åˆ»ä¾ç„¶æ˜¯ Leaderã€‚</li></ul><h3 id="kvserver-å’Œ-raft-çš„äº¤äº’æµç¨‹" tabindex="-1"><a class="header-anchor" href="#kvserver-å’Œ-raft-çš„äº¤äº’æµç¨‹"><span>KVServer å’Œ Raft çš„äº¤äº’æµç¨‹</span></a></h3><p>è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„â€œå¼‚æ­¥è½¬åŒæ­¥â€çš„è¿‡ç¨‹ï¼Œåˆ†ä¸ºå››ä¸ªæ­¥éª¤ï¼š</p><ol><li><strong>æè®® (Proposal)</strong>ï¼š <ul><li>Client è°ƒç”¨Â Put(key, val)ã€‚</li><li>KVServer æ”¶åˆ°åï¼Œè°ƒç”¨Â rf.Start(op)ã€‚</li><li>Raft è¯´ï¼šâ€œå¥½ï¼Œæˆ‘æŠŠå®ƒè®°åœ¨æˆ‘çš„æ—¥å¿—ç¬¬ 100 å·ä½ç½®äº†ï¼Œä½†æˆ‘è¿˜æ²¡ç¡®å®šå®ƒèƒ½ä¸èƒ½ç”Ÿæ•ˆã€‚â€</li></ul></li><li><strong>å¤åˆ¶ (Replication)</strong>ï¼š <ul><li>Leader çš„ Raft å¼€å§‹ç–¯ç‹‚ç»™å…¶ä»–èŠ‚ç‚¹çš„ Raft å‘æ¶ˆæ¯ï¼šâ€œå¤§å®¶å¿«æŠŠè¿™è¡Œå­—è®°åœ¨ç¬¬ 100 å·ä½ç½®ï¼â€</li></ul></li><li><strong>æäº¤ä¸åº”ç”¨ (Commit &amp; Apply)</strong>ï¼š <ul><li>å½“åŠæ•°ä»¥ä¸ŠèŠ‚ç‚¹è®°å¥½äº†ï¼ŒLeader çš„ Raft å°±ä¼šè®¤ä¸ºç¬¬ 100 å·æ—¥å¿—å·²æäº¤ã€‚</li><li><strong>å…³é”®ç‚¹</strong>ï¼šRaft é€šè¿‡Â applyChÂ å‘Šè¯‰ KVServerï¼šâ€œç¬¬ 100 å·æ—¥å¿—ç°åœ¨å®‰å…¨äº†ï¼Œä½ å¯ä»¥æ‰§è¡Œå®ƒäº†ã€‚â€</li></ul></li><li><strong>å“åº” (Reply)</strong>ï¼š <ul><li>KVServer çš„Â applierÂ åç¨‹ä»Â applyChÂ æ‹¿åˆ°æ¶ˆæ¯ï¼Œä¿®æ”¹Â kv.dbã€‚</li><li>KVServer æ‰¾åˆ°æ­£åœ¨ç­‰ 100 å·ç´¢å¼•çš„é‚£ä¸ª RPC Handlerï¼Œé€šè¿‡Â waitChÂ å–Šä¸€å£°ï¼šâ€œå–‚ï¼åšå¥½äº†ï¼â€</li><li>RPC Handler å›å¤ Clientï¼šâ€œæˆåŠŸï¼â€</li></ul></li></ol><h3 id="åˆ†å¸ƒå¼ç³»ç»Ÿæœ€éš¾çš„å°±æ˜¯-å‡ºäº‹çš„æ—¶å€™-ã€‚" tabindex="-1"><a class="header-anchor" href="#åˆ†å¸ƒå¼ç³»ç»Ÿæœ€éš¾çš„å°±æ˜¯-å‡ºäº‹çš„æ—¶å€™-ã€‚"><span>åˆ†å¸ƒå¼ç³»ç»Ÿæœ€éš¾çš„å°±æ˜¯â€œå‡ºäº‹çš„æ—¶å€™â€ã€‚</span></a></h3><h4 id="æƒ…å†µ-a-leader-çªç„¶æ–­ç½‘-å®•æœºäº†" tabindex="-1"><a class="header-anchor" href="#æƒ…å†µ-a-leader-çªç„¶æ–­ç½‘-å®•æœºäº†"><span>æƒ…å†µ Aï¼šLeader çªç„¶æ–­ç½‘/å®•æœºäº†</span></a></h4><ul><li><strong>Raft å±‚</strong>ï¼šå…¶ä»–èŠ‚ç‚¹ä¼šå‘ç° Leader æ¶ˆå¤±äº†ï¼Œè‡ªåŠ¨é€‰å‡ºæ–° Leaderã€‚</li><li><strong>KVServer å±‚</strong>ï¼šæ—§ Leader çš„ Handler è¿˜åœ¨ç­‰Â waitChã€‚ç”±äºå®ƒä¸å†æ˜¯ Leaderï¼Œå®ƒçš„ Raft æ°¸è¿œä¸ä¼šåœ¨Â applyChÂ é‡Œè¿”å›é‚£ä¸ªç´¢å¼•ã€‚Handler ä¼š<strong>è¶…æ—¶</strong>ï¼ˆè¿™å°±æ˜¯ä½ ä»£ç é‡ŒÂ time.AfterÂ çš„ä½œç”¨ï¼‰ï¼Œå¹¶å‘Šè¯‰ Clientï¼šâ€œå‡ºäº‹äº†ï¼Œä½ å»é—®åˆ«äººå§ã€‚â€</li></ul><h4 id="æƒ…å†µ-b-ç½‘ç»œåˆ†åŒº-è„‘è£‚" tabindex="-1"><a class="header-anchor" href="#æƒ…å†µ-b-ç½‘ç»œåˆ†åŒº-è„‘è£‚"><span>æƒ…å†µ Bï¼šç½‘ç»œåˆ†åŒºï¼ˆè„‘è£‚ï¼‰</span></a></h4><ul><li>å‡è®¾æœ‰ 5 ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹ 1 å’Œ 2 è¢«éš”ç¦»äº†ã€‚èŠ‚ç‚¹ 1 è§‰å¾—è‡ªå·±è¿˜æ˜¯ Leaderã€‚</li><li>Client å‘èŠ‚ç‚¹ 1 å‘è¯·æ±‚ã€‚èŠ‚ç‚¹ 1 è°ƒç”¨Â rf.Start()ã€‚</li><li>ä½†æ˜¯ï¼ç”±äºå®ƒåªèƒ½è”ç»œåˆ°èŠ‚ç‚¹ 2ï¼Œå‡‘ä¸å¤Ÿ 3 ç¥¨ï¼ˆåŠæ•°ï¼‰ï¼Œè¿™ä¸ªæ—¥å¿—æ°¸è¿œæ— æ³•Â <strong>Commit</strong>ã€‚</li><li>Client ä¼šä¸€ç›´ç­‰ï¼Œç›´åˆ°è¶…æ—¶ã€‚è¿™ä¿è¯äº†<strong>æ•°æ®ä¸ä¼šåœ¨é”™è¯¯çš„åˆ†åŒºé‡Œè¢«ä¿®æ”¹</strong>ã€‚</li></ul><h4 id="æƒ…å†µ-c-æ—§æŒ‡ä»¤å»¶è¿Ÿåˆ°è¾¾" tabindex="-1"><a class="header-anchor" href="#æƒ…å†µ-c-æ—§æŒ‡ä»¤å»¶è¿Ÿåˆ°è¾¾"><span>æƒ…å†µ Cï¼šæ—§æŒ‡ä»¤å»¶è¿Ÿåˆ°è¾¾</span></a></h4><ul><li>å¦‚æœä¸€ä¸ªÂ AppendÂ æŒ‡ä»¤å› ä¸ºç½‘ç»œå»¶è¿Ÿï¼Œåœ¨ 10 ç§’åæ‰åˆ°è¾¾ã€‚</li><li>KVServer ä¼šæ£€æŸ¥Â lastAppliedÂ è¡¨ã€‚å¦‚æœå‘ç°è¿™ä¸ªå®¢æˆ·ç«¯çš„åºåˆ—å·ï¼ˆSeqNoï¼‰å·²ç»å¤„ç†è¿‡äº†ï¼Œå®ƒå°±ä¼š<strong>ç›´æ¥ä¸¢å¼ƒ</strong>è¿™ä¸ªæ“ä½œï¼Œä¸ä¿®æ”¹æ•°æ®åº“ï¼Œä½†ä¼šè¿”å›Â OKï¼ˆå¹‚ç­‰æ€§ï¼‰ã€‚</li></ul><h3 id="å…¨éƒ¨æµç¨‹" tabindex="-1"><a class="header-anchor" href="#å…¨éƒ¨æµç¨‹"><span>å…¨éƒ¨æµç¨‹</span></a></h3><ol><li><strong>Client -&gt; KVServer (RPC Handler)</strong>: <ul><li><code>Handler</code> åˆ›å»º <code>Op{Type: Append, Key: &quot;a&quot;, Val: &quot;1&quot;, ClerkId: 88, SeqNo: 5}</code>ã€‚</li><li>è°ƒç”¨ <code>index, term, isLeader := rf.Start(op)</code>ã€‚</li><li><code>Handler</code> åˆ›å»º <code>ch := make(chan Op, 1)</code> å¹¶å­˜å…¥ <code>waitChs[index]</code>ã€‚</li></ul></li><li><strong>KVServer -&gt; Raft (Log Replication)</strong>: <ul><li>Raft åœ¨é›†ç¾¤é—´åŒæ­¥è¿™æ¡æ—¥å¿—ã€‚</li><li>æ­¤æ—¶ <code>Handler</code> æ­£åœ¨ <code>select { case &lt;-ch: ... }</code> å¤„é˜»å¡ã€‚</li></ul></li><li><strong>Raft -&gt; KVServer (Applier Loop)</strong>: <ul><li>Raft è¾¾æˆå…±è¯†ï¼ŒæŠŠ <code>ApplyMsg{CommandIndex: 100, Command: Op{...}}</code> å¡å…¥ <code>applyCh</code></li><li><code>Applier</code> åç¨‹è¯»åˆ°è¿™æ¡æ¶ˆæ¯ã€‚</li></ul></li><li><strong>KVServer å†…éƒ¨çŠ¶æ€æ›´æ–°</strong>: <ul><li><code>Applier</code> æ£€æŸ¥ <code>lastApplied[88]</code>ã€‚å¦‚æœå½“å‰è®°å½•çš„åºå·å°äº 5ï¼Œåˆ™æ‰§è¡Œ <code>db[&quot;a&quot;] += &quot;1&quot;</code>ã€‚</li><li>æ‰§è¡Œå®Œåï¼Œ<code>Applier</code> æŸ¥æ‰¾ <code>waitChs[100]</code>ã€‚</li><li><strong>å…³é”®åŠ¨ä½œ</strong>ï¼š<code>Applier</code> æŠŠ <code>Op</code> å‘è¿› <code>ch</code>ã€‚</li></ul></li><li><strong>KVServer -&gt; Client (RPC Response)</strong>: <ul><li><code>Handler</code> è¢«å”¤é†’ï¼Œæ”¶åˆ° <code>Op</code>ã€‚</li><li>æ£€æŸ¥æ”¶åˆ°çš„ <code>Op</code> æ˜¯å¦è¿˜æ˜¯ <code>ClerkId=88, SeqNo=5</code>ï¼ˆé˜²æ­¢ Index 100 å·²ç»è¢«æ–° Leader çš„å…¶ä»–å‘½ä»¤è¦†ç›–ï¼‰ã€‚</li><li>æ ¡éªŒé€šè¿‡ï¼Œç»™ Client å›å¤ <code>OK</code>ã€‚</li></ul></li></ol><hr><h4 id="ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡é€šä¿¡" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡é€šä¿¡"><span>ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡é€šä¿¡ï¼Ÿ</span></a></h4><p>è¿™ç§è®¾è®¡å®Œç¾è§£å†³äº†åˆ†å¸ƒå¼ç¯å¢ƒä¸‹çš„ä¸‰ä¸ªåœ°é›·ï¼š</p><ol><li><strong>è§£è€¦ (Decoupling)</strong>ï¼š<br> KVServer ä¸éœ€è¦çŸ¥é“ Raft æ˜¯æ€ä¹ˆåŒæ­¥æ—¥å¿—çš„ï¼Œå®ƒåªéœ€è¦ç»™ Raft ä¸€ä¸ªä»»åŠ¡ï¼Œç„¶åç­‰ Raft çš„å›æ‰§ã€‚</li><li><strong>çº¿æ€§åŒ– (Linearizability)</strong>ï¼š<br> å› ä¸º <code>Applier</code> æ˜¯å•çº¿ç¨‹ï¼ˆä¸€ä¸ªåç¨‹ï¼‰å¤„ç† <code>applyCh</code> çš„ï¼Œè¿™ä¿è¯äº†æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡ŒæŒ‡ä»¤çš„<strong>é¡ºåºå®Œå…¨ä¸€è‡´</strong>ã€‚å³ä¾¿æœ‰ 100 ä¸ª Handler åŒæ—¶åœ¨è·‘ï¼Œæœ€ç»ˆæ”¹æ•°æ®åº“çš„é¡ºåºä¹Ÿåªå–å†³äº Raft æ—¥å¿—çš„é¡ºåºã€‚</li><li><strong>å®‰å…¨æ€§ (Safety)</strong>ï¼š<br> å³ä½¿ Leader åœ¨åŒæ­¥è¿‡ç¨‹ä¸­æŒ‚äº†ï¼Œç”±äº Handler æ ¡éªŒäº† <code>ClerkId</code> å’Œ <code>SeqNo</code>ï¼Œå®ƒèƒ½æ•é”åœ°å‘ç°ï¼šâ€œRaft ç¡®å®è¿”å›äº† Index 100 çš„ç»“æœï¼Œä½†é‚£ä¸ªç»“æœä¸æ˜¯æˆ‘ä¹‹å‰è¦å­˜çš„â€˜1â€™ï¼Œè€Œæ˜¯åˆ«äººå­˜çš„â€˜2â€™ã€‚â€ è¿™æ ·å®ƒå°±ä¸ä¼šç»™å®¢æˆ·ç«¯è¿”å›é”™è¯¯çš„æˆåŠŸä¿¡æ¯ã€‚</li></ol><h1 id="raft-kv-åœ¨ç°å®ç”Ÿæ´»ä¸­æ˜¯æ€ä¹ˆè¢«ä½¿ç”¨çš„" tabindex="-1"><a class="header-anchor" href="#raft-kv-åœ¨ç°å®ç”Ÿæ´»ä¸­æ˜¯æ€ä¹ˆè¢«ä½¿ç”¨çš„"><span>RAFT KV åœ¨ç°å®ç”Ÿæ´»ä¸­æ˜¯æ€ä¹ˆè¢«ä½¿ç”¨çš„</span></a></h1><p>å‡è®¾æˆ‘æœ‰äº”å°æœºå™¨ ä¸‹é¢ç®¡ç†äº†ä¸Šåƒä¸ªGPUæœºå™¨ ç”¨æ¥è®­ç»ƒæ¨¡å‹</p><p>KV RAFTå…¶å®åªå¯¹å¤–æä¾›ä¸¤ä¸ªæ¥å£ ä¸€ä¸ªæ˜¯PUT ä¸€ä¸ªæ˜¯GET ä½†æ˜¯ä»–èƒ½ä¿è¯</p><ul><li>çº¿æ€§ä¸€è‡´æ€§ï¼šåªè¦æœ‰ä¸€ä¸ªPUTæˆåŠŸäº† å‰©ä¸‹ä»»ä½•äºº åœ¨ä»»ä½•åœ°æ–¹ è°ƒç”¨GET ä¸€å®šèƒ½å¤Ÿå¾—åˆ°è¿™ä¸ªä¸€æ ·çš„å€¼</li><li>é«˜å¯ç”¨æ€§ï¼šè¿™äº”ä¸ªç®¡ç†è€…å¦‚æœæœ‰ä¸‰ä¸ªå¯ç”¨ å°±èƒ½å¤Ÿæ­£å¸¸è¿›è¡ŒæœåŠ¡</li><li>æŒä¹…æ€§ä¸å”¯ä¸€æ€§</li></ul><h3 id="ä¸€ã€-è¿™-5-å°æœºå™¨-kv-raft-åœ¨åœ°ç†ä¸Šåˆ†å¸ƒåœ¨å“ªé‡Œ" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€-è¿™-5-å°æœºå™¨-kv-raft-åœ¨åœ°ç†ä¸Šåˆ†å¸ƒåœ¨å“ªé‡Œ"><span>ä¸€ã€ è¿™ 5 å°æœºå™¨ï¼ˆKV-Raftï¼‰åœ¨åœ°ç†ä¸Šåˆ†å¸ƒåœ¨å“ªé‡Œï¼Ÿ</span></a></h3><p>åœ¨ç°å®ä¸–ç•Œä¸­ï¼Œè¿™ 5 å°æœºå™¨çš„ç‰©ç†ä½ç½®å–å†³äºä½ å¯¹ <strong>â€œå®¹ç¾â€</strong> çš„è¦æ±‚ã€‚</p><ol><li><p><strong>åŒæœºæˆ¿åˆ†å¸ƒï¼ˆLANï¼‰</strong>ï¼š</p><ul><li>æ”¾åœ¨ä¸€ä¸ªæœºæˆ¿çš„ 5 ä¸ªä¸åŒæœºæ¶ä¸Šã€‚</li><li><strong>ä¼˜ç‚¹</strong>ï¼šé€Ÿåº¦æå¿«ï¼Œå»¶è¿Ÿ &lt; 1msã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šå¦‚æœæ•´ä¸ªæœºæˆ¿ç€ç«æˆ–æ–­ç”µï¼Œç³»ç»Ÿå°±å½»åº•æŒ‚äº†ã€‚</li></ul></li><li><p><strong>è·¨å¯ç”¨åŒºåˆ†å¸ƒï¼ˆMulti-AZï¼‰</strong>ï¼š</p><ul><li>åœ¨åŒä¸€ä¸ªåŸå¸‚ï¼ˆæ¯”å¦‚åŒ—äº¬ï¼‰ï¼Œåˆ†å¸ƒåœ¨ 3 ä¸ªä¸åŒçš„æ•°æ®ä¸­å¿ƒï¼ˆæœºæˆ¿ Aã€Bã€Cï¼‰ã€‚</li><li><strong>ä¼˜ç‚¹</strong>ï¼šèƒ½æŠµå¾¡å•ä¸ªæœºæˆ¿çº§åˆ«çš„æ•…éšœã€‚</li><li><strong>è¿™ç§æœ€å¸¸è§</strong>ï¼ˆæ¯”å¦‚ AWS æˆ–é˜¿é‡Œäº‘çš„å…¸å‹æ¶æ„ï¼‰ã€‚</li></ul></li><li><p><strong>è·¨åœ°åŸŸ/å…¨çƒåˆ†å¸ƒï¼ˆGeo-Distributedï¼‰</strong>ï¼š</p><ul><li>æ¯”å¦‚ 1 å°åœ¨çº½çº¦ï¼Œ1 å°åœ¨ä¼¦æ•¦ï¼Œ1 å°åœ¨ä¸œäº¬ï¼Œ2 å°åœ¨æ–°åŠ å¡ã€‚</li><li><strong>ä¼˜ç‚¹</strong>ï¼šèƒ½æŠµå¾¡æˆ˜äº‰ã€åœ°éœ‡ç­‰åŒºåŸŸæ€§ç¾éš¾ã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šéå¸¸æ…¢ï¼å› ä¸ºå…‰é€Ÿé™åˆ¶ï¼ŒRaft è¾¾æˆå…±è¯†ï¼ˆå¤šæ•°æ´¾ç¡®è®¤ï¼‰å¯èƒ½éœ€è¦å‡ ç™¾æ¯«ç§’ã€‚Google çš„ <strong>Spanner</strong> æ•°æ®åº“å°±æ˜¯è¿™ç§æ¶æ„ã€‚</li></ul></li></ol><hr><h3 id="äºŒã€-åªæœ‰-put-å’Œ-get-æ€ä¹ˆç®¡ç†å‡ åƒå°-gpu" tabindex="-1"><a class="header-anchor" href="#äºŒã€-åªæœ‰-put-å’Œ-get-æ€ä¹ˆç®¡ç†å‡ åƒå°-gpu"><span>äºŒã€ åªæœ‰ <code>Put</code> å’Œ <code>Get</code>ï¼Œæ€ä¹ˆç®¡ç†å‡ åƒå° GPUï¼Ÿ</span></a></h3><p>è¿™å¬èµ·æ¥ä¸å¯æ€è®®ï¼Œä½†<strong>å…¨ä¸–ç•Œæœ€å¤æ‚çš„é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼ˆå¦‚ Kubernetesï¼‰æ­£æ˜¯è¿™ä¹ˆå¹²çš„ã€‚</strong></p><p>Kubernetes åº•å±‚ç”¨çš„æ˜¯ <strong>etcd</strong>ï¼Œè€Œ etcd æœ¬è´¨ä¸Šå’Œç°åœ¨å†™çš„ <strong>KV-Raft</strong> å‡ ä¹ä¸€æ¨¡ä¸€æ ·ã€‚</p><h4 id="_1-å®ƒæ˜¯å¦‚ä½•é€šè¿‡ä¸¤ä¸ªæ–¹æ³•ç®¡ç†é›†ç¾¤çš„" tabindex="-1"><a class="header-anchor" href="#_1-å®ƒæ˜¯å¦‚ä½•é€šè¿‡ä¸¤ä¸ªæ–¹æ³•ç®¡ç†é›†ç¾¤çš„"><span>1. å®ƒæ˜¯å¦‚ä½•é€šè¿‡ä¸¤ä¸ªæ–¹æ³•ç®¡ç†é›†ç¾¤çš„ï¼Ÿ</span></a></h4><p>ç§˜è¯€åœ¨äºï¼š<strong>æ‰€æœ‰çš„ç®¡ç†æŒ‡ä»¤ï¼Œåœ¨æœ¬è´¨ä¸Šéƒ½æ˜¯â€œçŠ¶æ€çš„å˜åŒ–â€ã€‚</strong></p><ul><li><p><strong>åœºæ™¯ï¼šç»™ GPU 1 å·åˆ†é…ä¸€ä¸ª AI è®­ç»ƒä»»åŠ¡</strong></p><ul><li><strong>åŒ…å·¥å¤´ï¼ˆSchedulerï¼‰</strong> å¹¶ä¸éœ€è¦ç›´æ¥ç»™ GPU å‘æ¶ˆæ¯ã€‚</li><li><strong>åŒ…å·¥å¤´</strong> åªéœ€è°ƒç”¨ä½ çš„ <code>Put(&quot;GPU_001_Assignment&quot;, &quot;{task: &#39;Training_Cat_Model&#39;, data: &#39;s3://bucket/data&#39;}&quot;)</code>ã€‚</li><li><strong>GPU 1 å·</strong> ä¸Šçš„ Agent ç¨‹åºï¼ˆå°±åƒä¸€ä¸ª Clerkï¼‰ä¸€ç›´åœ¨åå°ä¸åœåœ°è°ƒä½ çš„ <code>Get(&quot;GPU_001_Assignment&quot;)</code>ï¼ˆè¿™ç§æŠ€æœ¯å«è½®è¯¢æˆ–é•¿è½®è¯¢ï¼‰ã€‚</li><li>ä¸€æ—¦ GPU å‘ç°å†…å®¹å˜äº†ï¼Œå®ƒå°±è‡ªå·±å»ä¸‹è½½æ•°æ®å¼€å§‹å¹²æ´»ã€‚</li></ul></li><li><p><strong>åœºæ™¯ï¼šGPU åäº†æ€ä¹ˆåŠï¼Ÿ</strong></p><ul><li>GPU ä¸Šçš„ Agent å®šæœŸè°ƒä½ çš„ <code>Put(&quot;GPU_001_Status&quot;, &quot;Healthy_12:00:05&quot;)</code>ã€‚</li><li><strong>åŒ…å·¥å¤´</strong> è°ƒ <code>Get(&quot;GPU_001_Status&quot;)</code>ã€‚å¦‚æœå‘ç°æ—¶é—´å¾ˆä¹…æ²¡æ›´æ–°äº†ï¼ŒåŒ…å·¥å¤´å°±çŸ¥é“å®ƒæŒ‚äº†ï¼Œäºæ˜¯å†å‘ä¸€ä¸ª <code>Put</code> æŠŠä»»åŠ¡æŒ‡æ´¾ç»™åˆ«äººã€‚</li></ul></li></ul><h4 id="_2-ä¸ºä»€ä¹ˆåªç»™ä¸¤ä¸ªæ–¹æ³•" tabindex="-1"><a class="header-anchor" href="#_2-ä¸ºä»€ä¹ˆåªç»™ä¸¤ä¸ªæ–¹æ³•"><span>2. ä¸ºä»€ä¹ˆåªç»™ä¸¤ä¸ªæ–¹æ³•ï¼Ÿ</span></a></h4><p>å› ä¸º <strong>â€œç®€å•å³åŠ›é‡â€</strong>ã€‚<br> å¦‚æœæ¥å£å¤ªå¤æ‚ï¼ˆæ¯”å¦‚åŒ…å« <code>StartTraining()</code>, <code>StopTraining()</code>ï¼‰ï¼Œé‚£ä¹ˆä½ çš„ KV-Raft å°±åªèƒ½ç”¨äº AI è®­ç»ƒã€‚<br> ä½†å¦‚æœä½ åªæä¾› <code>Put</code> å’Œ <code>Get</code>ï¼Œä½ å°±åˆ›é€ äº†ä¸€ä¸ª<strong>é€šç”¨çš„çœŸç†ä¹‹æº</strong>ã€‚å®ƒæ—¢å¯ä»¥ç®¡ç† GPU é›†ç¾¤ï¼Œä¹Ÿå¯ä»¥ç®¡ç†é“¶è¡Œè´¦æœ¬ï¼Œè¿˜å¯ä»¥ç®¡ç†è‡ªåŠ¨é©¾é©¶æ±½è½¦çš„è°ƒåº¦ã€‚</p><hr><h3 id="ä¸‰ã€-æ€»ç»“-è¿™ç§æ¶æ„çš„-å…¨å±€è§†è§’" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€-æ€»ç»“-è¿™ç§æ¶æ„çš„-å…¨å±€è§†è§’"><span>ä¸‰ã€ æ€»ç»“ï¼šè¿™ç§æ¶æ„çš„â€œå…¨å±€è§†è§’â€</span></a></h3><ol><li><p><strong>åº•å±‚ï¼šKV-Raft (å¤§è„‘)</strong><br> è¿™ 5 å°æœºå™¨ç¼©åœ¨æ•°æ®ä¸­å¿ƒçš„ä¸€ä¸ªå°è§’è½é‡Œã€‚å®ƒä»¬è™½ç„¶åªæœ‰ 5 å°ï¼Œä½†å®ƒä»¬é€šè¿‡ Raft ç®—æ³•äº§ç”Ÿäº†ä¸€ä¸ª <strong>â€œç»Ÿä¸€çš„å¹»è§‰â€</strong>ï¼šå¤§å®¶éƒ½çœ‹åˆ°ä¸€æ¨¡ä¸€æ ·çš„ <code>Put/Get</code> è®°å½•ã€‚</p></li><li><p><strong>ä¸­é—´å±‚ï¼šClerk (ç¥ç»æœ«æ¢¢)</strong><br> åˆ†å¸ƒåœ¨å…¨çƒå„åœ°çš„ 1000 å° GPU æœºå™¨ä¸Šï¼Œéƒ½è·‘ç€ä½ å†™çš„ <code>Clerk</code> ä»£ç ã€‚å®ƒä»¬åƒè§¦è§’ä¸€æ ·ï¼Œæ—¶åˆ»è¿æ¥ç€è¿™ 5 å°æ ¸å¿ƒæœºå™¨ã€‚</p></li><li><p><strong>è¿ä½œè¿‡ç¨‹ï¼š</strong></p><ul><li>æ— è®ºåœ°ç†åˆ†å¸ƒå¤šå¹¿ï¼Œæ‰€æœ‰çš„ GPU æœºå™¨éƒ½è®¤å‡†è¿™ 5 å°æœºå™¨ã€‚</li><li>å½“ Leader å‘ç”Ÿåˆ‡æ¢ï¼Œå…¨çƒå„åœ°çš„ <code>Clerk</code> ä¼šè‡ªåŠ¨é‡å®šå‘è¯·æ±‚ã€‚</li><li><strong>åœ°ç†å¹¿åº¦</strong>ç”± <code>Clerk</code> è´Ÿè´£è¿æ¥ï¼Œ<strong>æ•°æ®çš„ä¸€è‡´æ€§</strong>ç”±ä½ çš„ 5 å°æœºå™¨è´Ÿè´£æ­»å®ˆã€‚</li></ul></li></ol><h1 id="shard-kv" tabindex="-1"><a class="header-anchor" href="#shard-kv"><span>Shard KV</span></a></h1><p>ç›®çš„æ˜¯å®ç°äº†ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡ã€<strong>å¯æ°´å¹³æ‰©å±•ï¼ˆHorizontal Scalabilityï¼‰</strong> ä¸”å…·æœ‰<strong>å¼ºä¸€è‡´æ€§</strong>çš„åˆ†å¸ƒå¼åˆ†ç‰‡é”®å€¼æ•°æ®åº“ã€‚</p><h3 id="ç›®çš„" tabindex="-1"><a class="header-anchor" href="#ç›®çš„"><span>ç›®çš„</span></a></h3><p>å¾—åˆ°çš„æ˜¯ä¸€ä¸ªèƒ½å¤Ÿ<strong>è‡ªåŠ¨è´Ÿè½½å‡è¡¡</strong>çš„æ•°æ®å­˜å‚¨ç³»ç»Ÿã€‚</p><ul><li><strong>å¯ä¼¸ç¼©æ€§</strong>ï¼šå¦‚æœä½ å‘ç°ç³»ç»Ÿå‹åŠ›å¤§ï¼Œåªéœ€å¯åŠ¨ä¸€ç»„æ–°çš„ KVServer å‰¯æœ¬ç»„ï¼Œç„¶åå‘ ShardCtrler å‘é€ä¸€ä¸ª <code>Join</code> å‘½ä»¤ã€‚ç³»ç»Ÿä¼šè‡ªåŠ¨æŠŠä¸€éƒ¨åˆ†åˆ†ç‰‡ä»æ—§æœºå™¨è¿ç§»åˆ°æ–°æœºå™¨ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯¹ç”¨æˆ·è¿‘ä¹é€æ˜ã€‚</li><li><strong>é«˜å¯ç”¨æ€§</strong>ï¼šæ¯ä¸ªå‰¯æœ¬ç»„ï¼ˆGroupï¼‰å†…éƒ¨è¿è¡Œ Raft åè®®ã€‚å³ä½¿æŸä¸ªç»„æ‰çº¿äº†ä¸€ä¸¤å°æœºå™¨ï¼Œåªè¦å¤§å¤šæ•°å­˜æ´»ï¼Œè¯¥åˆ†ç‰‡çš„æ•°æ®ä¾ç„¶å¯è¯»å†™ã€‚</li><li><strong>å¼ºä¸€è‡´æ€§</strong>ï¼šé€šè¿‡ Raft å’Œåˆ†ç‰‡è¿ç§»æ—¶çš„çŠ¶æ€åŒæ­¥ï¼Œç³»ç»Ÿä¿è¯äº†çº¿æ€§ä¸€è‡´æ€§ã€‚</li></ul><hr><h3 id="ç”¨æˆ·å¦‚ä½•ä¸æ•°æ®åº“äº¤äº’" tabindex="-1"><a class="header-anchor" href="#ç”¨æˆ·å¦‚ä½•ä¸æ•°æ®åº“äº¤äº’"><span>ç”¨æˆ·å¦‚ä½•ä¸æ•°æ®åº“äº¤äº’ï¼Ÿ</span></a></h3><p>ä½œä¸ºç»ˆç«¯ç”¨æˆ·ï¼Œä½ ä¸éœ€è¦æ‰‹åŠ¨å»è”ç³» Controllerã€‚è¿™äº›å¤æ‚çš„é€»è¾‘éƒ½è¢«å°è£…åœ¨ <code>shardkv/client.go</code> çš„ <strong><code>Clerk</code></strong> ç»“æ„ä½“ä¸­ã€‚</p><p>ä»ç”¨æˆ·çš„è§†è§’æ¥çœ‹ï¼Œä»£ç æ˜¯è¿™æ ·çš„ï¼š</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ck</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> shardkv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">MakeClerk</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ctrlers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ck</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user_1_name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Alice&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ç”¨æˆ·åªå…³å¿ƒ Key å’Œ Value</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">val</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> ck</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user_1_name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)     </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ç”¨æˆ·ä¸å…³å¿ƒæ•°æ®åœ¨å“ª</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="åº•å±‚äº¤äº’çš„å…¨è¿‡ç¨‹-clerk-å¸®ä½ åšäº†ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#åº•å±‚äº¤äº’çš„å…¨è¿‡ç¨‹-clerk-å¸®ä½ åšäº†ä»€ä¹ˆ"><span>åº•å±‚äº¤äº’çš„å…¨è¿‡ç¨‹ï¼ˆClerk å¸®ä½ åšäº†ä»€ä¹ˆï¼‰</span></a></h3><p>å½“ä½ è°ƒç”¨ <code>ck.Get(&quot;user_1_name&quot;)</code> æ—¶ï¼Œå†…éƒ¨å‘ç”Ÿäº†ä»¥ä¸‹æ­¥éª¤ï¼š</p><ol><li><p><strong>è®¡ç®—åˆ†ç‰‡ (Hashing)</strong>ï¼š<br><code>Clerk</code> è°ƒç”¨ <code>key2shard(&quot;user_1_name&quot;)</code>ï¼Œæ ¹æ® Key çš„å“ˆå¸Œå€¼ç®—å‡ºè¿™ä¸ª Key å±äºå“ªä¸ª <strong>Shard</strong>ï¼ˆæ¯”å¦‚ Shard 4ï¼‰ã€‚</p></li><li><p><strong>è·å–è·¯ç”±è¡¨ (Querying Ctrler)</strong>ï¼š</p><ul><li><code>Clerk</code> ä¼šæ£€æŸ¥æœ¬åœ°ç¼“å­˜çš„ <code>Config</code>ã€‚</li><li>å¦‚æœç¼“å­˜ä¸ºç©ºæˆ–è€…ç‰ˆæœ¬å¤ªæ—§ï¼Œ<code>Clerk</code> ä¼šç»™ <strong>ShardCtrler</strong> å‘é€ä¸€ä¸ª <code>Query(-1)</code> è¯·æ±‚ã€‚</li><li>ShardCtrler å›å¤ï¼šâ€œç°åœ¨çš„é…ç½®æ˜¯ç¬¬ 5 ç‰ˆï¼ŒShard 4 å½’ <strong>Group 102</strong> ç®¡ï¼Œè¿™ä¸ªç»„çš„æœåŠ¡å™¨åœ°å€æ˜¯ <code>[10.0.0.1, 10.0.0.2]</code>ã€‚â€</li></ul></li><li><p><strong>å®šä½æœåŠ¡å™¨ (Routing)</strong>ï¼š<br><code>Clerk</code> åœ¨æœ¬åœ°è®°å½•ä¸‹ï¼šShard 4 -&gt; Group 102ã€‚ç„¶åéšæœºé€‰æ‹© Group 102 ä¸­çš„ä¸€å°æœåŠ¡å™¨å‘é€ <code>Get</code> è¯·æ±‚ã€‚</p></li><li><p><strong>å¤„ç†é…ç½®å˜æ›´ (Error Handling)</strong>ï¼š<br> è¿™æ˜¯æœ€å…³é”®çš„ä¸€æ­¥ã€‚å¦‚æœåœ¨ä½ å‘é€è¯·æ±‚çš„åŒæ—¶ï¼Œç®¡ç†å‘˜æŠŠè¿™ä¸ªåˆ†ç‰‡ç§»åˆ°äº† Group 103ï¼š</p><ul><li>Group 102 çš„æœåŠ¡å™¨æ”¶åˆ°è¯·æ±‚åï¼Œå‘ç°è‡ªå·±å·²ç»ä¸è´Ÿè´£ Shard 4 äº†ï¼Œä¼šè¿”å›ä¸€ä¸ª <strong><code>ErrWrongGroup</code></strong> é”™è¯¯ã€‚</li><li><code>Clerk</code> æ”¶åˆ°è¿™ä¸ªé”™è¯¯åï¼Œæ„è¯†åˆ°â€œé…ç½®å˜äº†ï¼â€ï¼Œå®ƒä¼š<strong>é‡æ–°å‘ ShardCtrler å‘é€ <code>Query</code></strong> è·å–æœ€æ–°è·¯ç”±ã€‚</li><li>è·å–æ–°è·¯ç”±åï¼Œ<code>Clerk</code> è‡ªåŠ¨é‡è¯•å‘é€è¯·æ±‚åˆ°æ–°çš„ Group 103ã€‚</li><li><strong>è¿™ä¸€åˆ‡å¯¹è°ƒç”¨ <code>ck.Get</code> çš„ç”¨æˆ·æ¥è¯´æ˜¯å®Œå…¨æ— æ„Ÿçš„</strong>ã€‚</li></ul></li></ol><hr><h3 id="è§’è‰²åˆ†é…" tabindex="-1"><a class="header-anchor" href="#è§’è‰²åˆ†é…"><span>è§’è‰²åˆ†é…</span></a></h3><ul><li><strong>ShardCtrler (å¤§è„‘)</strong>ï¼šé…ç½®ä¸­å¿ƒã€‚å®ƒåªå­˜â€œåœ°å›¾â€ï¼ˆå“ªä¸ªåˆ†ç‰‡åœ¨å“ªï¼‰ï¼Œä¸å­˜å®é™…çš„ä¸šåŠ¡ Key-Value æ•°æ®ã€‚</li><li><strong>ShardKV Group (è‚Œè‚‰)</strong>ï¼šæ•°æ®ä¸­å¿ƒã€‚å®ƒå­˜å‚¨å®é™…çš„ Key-Valueã€‚å®ƒä¼šå®šæœŸå‘å¤§è„‘åŒæ­¥â€œåœ°å›¾â€ï¼Œå¹¶æ ¹æ®åœ°å›¾æŠŠæ•°æ®æ¬è¿ç»™å…¶ä»–çš„ Groupã€‚</li><li><strong>Clerk (å¯¼èˆªä»ª)</strong>ï¼šå®¢æˆ·ç«¯åº“ã€‚å®ƒè´Ÿè´£æŸ¥åœ°å›¾ã€å¸¦è·¯ã€å¹¶åœ¨è·¯ä¸é€šï¼ˆé…ç½®æ”¹å˜ï¼‰æ—¶è‡ªåŠ¨é‡æ–°æŸ¥åœ°å›¾å¹¶ç»•è·¯ã€‚</li></ul><p>å¦‚æœä½ æ˜¯ä¸€ä¸ªè¿ç»´äººå‘˜ï¼Œä½ åªéœ€è¦ç›‘æ§æœåŠ¡å™¨è´Ÿè½½ã€‚ä¸€æ—¦å‘ç° Group A è´Ÿè½½è¿‡é«˜ï¼Œä½ å°±å»å¯åŠ¨ Group Bï¼Œç„¶åç»™ ShardCtrler å‘ä¸€ä¸ª <code>Join</code>ã€‚å‰©ä¸‹çš„æ•°æ®è¿ç§»ã€è¯·æ±‚é‡å®šå‘ï¼Œå…¨é ä½ ç°åœ¨å†™çš„è¿™å¥—ä»£ç è‡ªåŠ¨å®Œæˆã€‚è¿™å°±æ˜¯<strong>è‡ªåŠ¨åŒ–è¿ç»´</strong>å’Œ<strong>å¼¹æ€§ä¼¸ç¼©</strong>çš„é­…åŠ›ã€‚</p><h2 id="ä»£ç å®ç°â€”â€”controller" tabindex="-1"><a class="header-anchor" href="#ä»£ç å®ç°â€”â€”controller"><span>ä»£ç å®ç°â€”â€”controller</span></a></h2><h2 id="ä»£ç å®ç°â€”â€”shardkv-server" tabindex="-1"><a class="header-anchor" href="#ä»£ç å®ç°â€”â€”shardkv-server"><span>ä»£ç å®ç°â€”â€”ShardKV server</span></a></h2><h3 id="shardkvç»“æ„" tabindex="-1"><a class="header-anchor" href="#shardkvç»“æ„"><span>ShardKVç»“æ„</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">type</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ShardKV</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	mu</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RWMutex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	dead</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">              </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	rf</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">      *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">         </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	applyCh</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> chan</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ApplyMsg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	makeEnd</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">string</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">labrpc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ClientEnd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	gid</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	sc</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">      *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">shardctrler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Clerk</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	maxRaftState</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	lastApplied</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	lastConfig</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    shardctrler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	currentConfig</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> shardctrler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// åˆ†ç‰‡çŠ¶æ€æœºï¼šæ¯ä¸ªåˆ†ç‰‡ç‹¬ç«‹å­˜å‚¨</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	Shards</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">shardctrler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NShards</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Shard</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// å®¢æˆ·ç«¯å»é‡ï¼šClientId -&gt; æ“ä½œä¸Šä¸‹æ–‡</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	lastOperations</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">OperationContext</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// é€šçŸ¥é€šé“ï¼šLogIndex -&gt; ç­‰å¾…è¯¥æ—¥å¿—åº”ç”¨çš„é€šé“</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	notifyChans</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">chan</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CommandResponse</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// ç¼“å­˜ä»å…¶ä»–ç»„æ¥æ”¶åˆ°çš„å¾…åº”ç”¨åˆ†ç‰‡æ•°æ®ï¼ˆRPCæ”¶åˆ°ä½†å°šæœªé€šè¿‡ Raft åº”ç”¨ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// å½“é…ç½®å˜æ›´å‘½ä»¤è¢«åº”ç”¨æ—¶ï¼Œä»è¿™é‡Œè¯»å–æ•°æ®è¿›è¡Œè¿ç§»</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	incomingShards</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ShardMigration</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // ShardID -&gt; è¿ç§»æ•°æ®</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// ç”¨äºæŒä¹…åŒ–ï¼ˆSnapshotï¼‰</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	persister</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Persister</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">type</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Shard</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    KV</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">string</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">string</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // è¯¥åˆ†ç‰‡çš„é”®å€¼å­˜å‚¨</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    State</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ShardState</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         // åˆ†ç‰‡å½“å‰çŠ¶æ€</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="å¿«ç…§å†…å®¹è®¾è®¡" tabindex="-1"><a class="header-anchor" href="#å¿«ç…§å†…å®¹è®¾è®¡"><span>å¿«ç…§å†…å®¹è®¾è®¡</span></a></h3><table><thead><tr><th>å­—æ®µ</th><th>æ˜¯å¦å¿«ç…§</th><th>åŸå› </th></tr></thead><tbody><tr><td><strong><code>Shards</code></strong></td><td>âœ… <strong>å¿…é¡»</strong></td><td>æ ¸å¿ƒä¸šåŠ¡æ•°æ®ï¼Œå­˜å‚¨æ‰€æœ‰åˆ†ç‰‡çš„KVå¯¹å’ŒçŠ¶æ€(Serving/Pullingç­‰)ã€‚é‡å¯åå¿…é¡»æ¢å¤ï¼Œå¦åˆ™æ•°æ®ä¸¢å¤±ã€‚</td></tr><tr><td><strong><code>lastOperations</code></strong></td><td>âœ… <strong>å¿…é¡»</strong></td><td>å®¢æˆ·ç«¯å»é‡è¡¨ã€‚è‹¥é‡å¯åä¸¢å¤±ï¼ŒåŒä¸€ä¸ªå®¢æˆ·ç«¯é‡å‘æ—§è¯·æ±‚ä¼šè¢«é‡å¤æ‰§è¡Œï¼Œè¿åçº¿æ€§ä¸€è‡´æ€§ã€‚</td></tr><tr><td><strong><code>currentConfig</code></strong></td><td>âœ… <strong>å¿…é¡»</strong></td><td>å½“å‰é…ç½®ç‰ˆæœ¬ã€‚å¿…é¡»çŸ¥é“å½“å‰å¤„äºå“ªä¸ªé…ç½®é˜¶æ®µï¼Œæ‰èƒ½æ­£ç¡®å¤„ç†æ–°è¯·æ±‚å’Œè¿ç§»ã€‚</td></tr><tr><td><strong><code>lastConfig</code></strong></td><td>âœ… <strong>å¿…é¡»</strong></td><td>ä¸Šä¸€ä¸ªé…ç½®ã€‚ç”¨äºå¯¹æ¯”æ£€æµ‹é…ç½®å˜æ›´ï¼Œä»¥åŠè®¡ç®—éœ€è¦è¿ç§»å“ªäº›åˆ†ç‰‡ã€‚</td></tr><tr><td><strong><code>lastApplied</code></strong></td><td>âœ… <strong>å¿…é¡»</strong></td><td>æœ€ååº”ç”¨çš„Raftæ—¥å¿—ç´¢å¼•ã€‚æ¢å¤åç”¨äºé˜²æ­¢é‡å¤åº”ç”¨å·²å¿«ç…§çš„æ—¥å¿—ã€‚</td></tr><tr><td><code>incomingShards</code></td><td>âŒ ä¸éœ€è¦</td><td>ä¸´æ—¶ç¼“å­˜ï¼Œä»…ç”¨äºæ¥æ”¶RPCæ•°æ®åã€Raftåº”ç”¨å‰çš„è¿‡æ¸¡ã€‚é‡å¯åä¸ºç©ºå³å¯ï¼Œä¸¢å¤±åå¯é€šè¿‡é‡æ–°æ‹‰å–æ¢å¤ã€‚</td></tr><tr><td><code>notifyChans</code></td><td>âŒ ä¸éœ€è¦</td><td>å†…å­˜ä¸­çš„é€šçŸ¥é€šé“ï¼Œç”¨äºRPCç­‰å¾…Raftåº”ç”¨ã€‚é‡å¯åæ— ç­‰å¾…ä¸­çš„RPCï¼Œåˆå§‹åŒ–ä¸ºç©ºmapå³å¯ã€‚</td></tr><tr><td><code>dead</code></td><td>âŒ ä¸éœ€è¦</td><td>è¿è¡Œæ—¶çŠ¶æ€ï¼ŒKill()æ—¶è®¾ç½®ï¼Œé‡å¯åé»˜è®¤ä¸º0ã€‚</td></tr><tr><td><code>sc</code> (clerk)</td><td>âŒ ä¸éœ€è¦</td><td>å¯é‡æ–°åˆ›å»ºï¼Œæ— çŠ¶æ€ã€‚</td></tr><tr><td><code>rf</code>, <code>applyCh</code></td><td>âŒ ä¸éœ€è¦</td><td>Raftå®ä¾‹å’Œé€šé“ï¼Œè¿è¡Œæ—¶é‡å»ºã€‚</td></tr></tbody></table></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/yedou37/yedou37.github.io/edit/main/src/courses/6.5840.md" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">æœ€è¿‘æ›´æ–°: </span><time class="vp-meta-info" datetime="2026-02-13T06:35:50.000Z" data-allow-mismatch>2026/2/13 06:35</time></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 137401103+yedou37@users.noreply.github.com">yedou37</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/courses/CS144.html" aria-label="CS144è®¡ç®—æœºç½‘ç»œ"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->CS144è®¡ç®—æœºç½‘ç»œ</div></a><!----></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">è®°å½•é¢è¯•å¤ä¹  & è¯¾ç¨‹å¤§ä½œä¸š</div><div class="vp-copyright">Copyright Â© 2026 yedou </div></footer></div><!--]--><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DErs339O.js" defer></script>
  </body>
</html>
