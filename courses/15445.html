<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.26" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.102" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"CMU-15445 数据库","image":[""],"dateModified":"2026-02-14T13:24:43.000Z","author":[{"@type":"Person","name":"yedou","url":"https://yedou37.github.io"}]}</script><meta property="og:url" content="https://yedou37.github.io/courses/15445.html"><meta property="og:site_name" content="Yedou's Notebook"><meta property="og:title" content="CMU-15445 数据库"><meta property="og:description" content="P1 ARC Replacement MRU (Most Recently Used) List / 最近使用列表： 作用：追踪那些最近被访问过一次的页面。 代表：体现了访问的“新近度”。一个页面刚被加载进缓存时，通常会先放在这里。 MFU (Most Frequently Used) List / 频繁使用列表： 作用：追踪那些被访问过不止一次的页面..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2026-02-14T13:24:43.000Z"><meta property="article:modified_time" content="2026-02-14T13:24:43.000Z"><link rel="icon" href="/logo.jpg"><title>CMU-15445 数据库 | Yedou's Notebook</title><meta name="description" content="P1 ARC Replacement MRU (Most Recently Used) List / 最近使用列表： 作用：追踪那些最近被访问过一次的页面。 代表：体现了访问的“新近度”。一个页面刚被加载进缓存时，通常会先放在这里。 MFU (Most Frequently Used) List / 频繁使用列表： 作用：追踪那些被访问过不止一次的页面...">
    <link rel="preload" href="/assets/style-CVnMh6PC.css" as="style"><link rel="stylesheet" href="/assets/style-CVnMh6PC.css">
    <link rel="modulepreload" href="/assets/app-TutfwjEZ.js"><link rel="modulepreload" href="/assets/15445.html-CMTb0j2X.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">跳至主要內容</a><!--]--><!--[--><div class="theme-container no-navbar external-link-icon has-toc" vp-container><!----><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/" aria-label="我的笔记库"><!---->我的笔记库<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="vp-icon" icon="fa6-solid:folder-open" sizing="both" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">基础知识概览</span><span class="vp-arrow end"></span></button><!----></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><iconify-icon class="vp-icon" icon="fa6-solid:folder-open" sizing="both" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">课程笔记概览</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/courses/15445.html" aria-label="CMU-15445 数据库"><!---->CMU-15445 数据库<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/courses/CS144.html" aria-label="CS144计算机网络"><!---->CS144计算机网络<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/courses/6.5840.html" aria-label="MIT 6.5840 分布式系统"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:share-2" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->MIT 6.5840 分布式系统<!----></a></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->CMU-15445 数据库</h1><div class="page-info"><span class="page-author-info" aria-label="作者🖊" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://yedou37.github.io" target="_blank" rel="noopener noreferrer">yedou</a></span><span property="author" content="yedou"></span></span><!----><span class="page-date-info" aria-label="写作日期📅" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2026/2/14</span><meta property="datePublished" content="2026-02-14T13:24:43.000Z"></span><!----><span class="page-reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 49 分钟</span><meta property="timeRequired" content="PT49M"></span><!----><!----></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><hr><h1 id="p1" tabindex="-1"><a class="header-anchor" href="#p1"><span>P1</span></a></h1><h2 id="arc-replacement" tabindex="-1"><a class="header-anchor" href="#arc-replacement"><span>ARC Replacement</span></a></h2><ol><li><p><strong>MRU (Most Recently Used) List / 最近使用列表</strong>：</p><ul><li><p><strong>作用</strong>：追踪那些<strong>最近被访问过一次</strong>的页面。</p></li><li><p><strong>代表</strong>：体现了访问的“新近度”。一个页面刚被加载进缓存时，通常会先放在这里。</p></li></ul></li><li><p><strong>MFU (Most Frequently Used) List / 频繁使用列表</strong>：</p><ul><li><p><strong>作用</strong>：追踪那些<strong>被访问过不止一次</strong>的页面。</p></li><li><p><strong>代表</strong>：体现了访问的“频率”。当 MRU 列表中的页面被再次访问时，它就会被移动到 MFU 列表。</p></li></ul></li><li><p><strong>MRU Ghost List / MRU 幽灵列表</strong>：</p><ul><li><p><strong>作用</strong>：这是一个“历史记录”列表，它追踪那些<strong>最近从 MRU 列表中被淘汰出去</strong>的页面的 ID。这些页面<strong>已经不在缓存（Buffer Pool）中</strong>了。</p></li><li><p><strong>目的</strong>：用来判断我们为 MRU 分配的空间是否太小了。如果一个刚被淘汰的 MRU 页面很快又被访问了（即在幽灵列表中被“击中”），说明我们应该给 MRU 列表更多的空间。</p></li></ul></li><li><p><strong>MFU Ghost List / MFU 幽灵列表</strong>：</p><ul><li><p><strong>作用</strong>：同样是历史记录，它追踪那些<strong>最近从 MFU 列表中被淘汰出去</strong>的页面的 ID。</p></li><li><p><strong>目的</strong>：用来判断我们为 MFU 分配的空间是否太小了。如果一个被淘汰的 MFU 页面很快又被访问，说明我们应该给 MFU 列表更多的空间。</p></li></ul></li></ol><p>简单来说，ARC 算法就像一个聪明的图书管理员，他把书架分成了“新书区 (MRU)”和“热门书区 (MFU)”。他还随身带了两个小本子，一个记录“刚被还回去的新书 (MRU Ghost)”，另一个记录“刚被还回去的热门书 (MFU Ghost)”。</p><ul><li><p>当有人来借书，发现这本书刚被还回去了（在“小本子”上找到了记录）：</p><ul><li><p>如果是在“新书”本子上找到的，管理员会认为“新书区”太小了，下次会把新书区扩大一点 (mru_target_size_ 增加)。</p></li><li><p>如果是在“热门书”本子上找到的，他会认为“热门区”太小了，下次会把热门区扩大一点 (mru_target_size_ 减小)。</p></li></ul></li></ul><ol><li><p>ARC 把缓存空间动态分成两部分<br> T = LRU + LFU<br> 用 p = |LRU| 表示 LRU 部分的目标大小，剩下 |T|−p 给 LFU。<br> ghost 列表（LRU-ghost、LFU-ghost）并不占内存，它们只是“历史记录”，记录哪些页最近被踢出去了。</p></li><li><p>ghost hit 的含义<br> 当 CPU 再次访问一个已经踢出去的页，却在 ghost 里找到了它，说明：<br> “这个页其实很快又被用到了，我上次把它踢掉是<strong>错误</strong>的。”<br> 这条信息非常宝贵——它直接告诉算法：<br> “踢得太多（或太少）了，要改。”</p></li><li><p>如何“改”——调整 p</p><ul><li><p>如果在 <strong>mru_ghost</strong> 里命中 ⇒ 被踢的是“最近”页 ⇒ 说明 LRU 部分给得太小，导致 LRU 页过早被逐出 ⇒ <strong>把 p 增大</strong>（多给 LRU 一点空间）。</p></li><li><p>如果在 <strong>mfu_ghost</strong> 里命中 ⇒ 被踢的是“频繁”页 ⇒ 说明 LFU 部分给得太小，导致 LFU 页过早被逐出 ⇒ <strong>把 p 减小</strong>（多给 LFU 一点空间）。</p></li></ul><p>这样下一次 Evict 时，就会按新的 p 值去选受害者，同类型的页面就能在缓存里停留更久，减少再次误杀。</p></li></ol><p>好的，我们来详细分析一下 <code>DiskScheduler</code> 的代码，并提供一个清晰的实现思路。</p><h3 id="代码解释-code-explanation" tabindex="-1"><a class="header-anchor" href="#代码解释-code-explanation"><span>代码解释 (Code Explanation)</span></a></h3><p>这部分代码定义了一个<strong>异步磁盘 I/O 调度器</strong>。在数据库中，直接在处理查询的线程（工作线程）上执行磁盘读写操作，会因为磁盘 I/O 的高延迟而阻塞该线程，导致系统吞吐量下降。</p><p><code>DiskScheduler</code> 的核心思想是<strong>解耦</strong>：将 &quot;请求 I/O&quot; 的动作和 &quot;执行 I/O&quot; 的动作分开，放到不同的线程中。</p><ol><li><p><strong><code>DiskRequest</code> 结构体</strong>:</p><ul><li>这是一个封装了单次磁盘 I/O 操作所有信息的结构体。</li><li><code>is_write_</code>: 一个布尔值，用于区分是读操作还是写操作。</li><li><code>data_</code>: 一个 <code>char*</code> 指针，指向一块内存。对于读操作，磁盘上的数据会被读到这块内存里；对于写操作，这块内存里的数据会被写到磁盘上。这通常是缓冲池（Buffer Pool）中的一个 Frame。</li><li><code>page_id_</code>: 要操作的磁盘页的 ID。</li><li><code>callback_</code>: 这是实现异步的关键。它是一个 <code>std::promise&lt;bool&gt;</code>。 <ul><li><strong>Promise/Future 模式</strong>: 当一个线程（比如 Buffer Pool Manager）需要进行磁盘 I/O 时，它会创建一个 <code>promise</code> 和一个与之关联的 <code>future</code>。它将 <code>promise</code> 放入 <code>DiskRequest</code> 中，自己保留 <code>future</code> 对象。</li><li>然后它把这个 <code>Request</code> 交给 <code>DiskScheduler</code>。</li><li>之后，该线程可以调用 <code>future.get()</code>，这个调用会<strong>阻塞</strong>，直到 <code>promise</code> 被 fulfill (即 <code>promise.set_value()</code> 被调用)。</li><li>这样，请求线程就可以在需要等待结果时才阻塞，而不是在 I/O 操作一开始就阻塞。</li></ul></li></ul></li><li><p><strong><code>DiskScheduler</code> 类</strong>:</p><ul><li><strong><code>disk_manager_</code></strong>: 一个指向 <code>DiskManager</code> 的指针。<code>DiskManager</code>是真正与物理磁盘交互的底层组件。<code>DiskScheduler</code> 只是一个调度层，最终的读写还是要委托给 <code>DiskManager</code>。</li><li><strong><code>request_queue_</code></strong>: 这是一个 <code>Channel</code>，本质上是一个线程安全的阻塞队列。 <ul><li><strong>生产者-消费者模型</strong>: <code>Schedule</code> 方法是<strong>生产者</strong>，它把 <code>DiskRequest</code> 放入队列。后台的工作线程是<strong>消费者</strong>，它从队列中取出 <code>DiskRequest</code> 并处理。</li><li><code>std::optional&lt;DiskRequest&gt;</code>: 使用 <code>optional</code> 是一个巧妙的设计。队列中存放的是 <code>DiskRequest</code>。当调度器要析构（关闭）时，它会往队列里放一个 <code>std::nullopt</code>（空值）。后台线程取到这个空值时，就知道这是个“关闭信号”，于是退出循环，线程结束。</li></ul></li><li><strong><code>background_thread_</code></strong>: 一个 <code>std::thread</code>，在 <code>DiskScheduler</code> 构造时创建。它专门运行 <code>StartWorkerThread</code> 函数，是磁盘 I/O 的实际执行者。</li><li><strong>构造函数 <code>DiskScheduler(...)</code></strong>: 创建并启动后台线程。</li><li><strong>析构函数 <code>~DiskScheduler()</code></strong>: 发送关闭信号 (<code>std::nullopt</code>) 到队列，并调用 <code>join()</code> 等待后台线程安全退出。这确保了所有排队的请求都被处理完毕（或者至少线程被干净地关闭）后，程序才继续执行。</li><li><strong><code>Schedule(...)</code></strong>: 公共接口，供其他模块（如 Buffer Pool Manager）提交 I/O 请求。</li><li><strong><code>StartWorkerThread()</code></strong>: 后台线程的入口函数，是我们需要实现的核心逻辑。</li></ul></li></ol><h3 id="工作流程-workflow" tabindex="-1"><a class="header-anchor" href="#工作流程-workflow"><span>工作流程 (Workflow)</span></a></h3><ol><li><p><strong>请求方 (e.g., Buffer Pool Manager)</strong>:<br> a. 需要从磁盘读取 page 5 到内存 <code>data_ptr</code>。<br> b. 创建一个 <code>std::promise&lt;bool&gt; p</code>。<br> c. 从 <code>p</code> 获取 <code>std::future&lt;bool&gt; f = p.get_future()</code>。<br> d. 创建一个 <code>DiskRequest</code>：<code>{is_write_: false, data_: data_ptr, page_id_: 5, callback_: std::move(p)}</code>。<br> e. 将这个 <code>DiskRequest</code> 放入一个 <code>vector</code> 中，调用 <code>disk_scheduler-&gt;Schedule(requests)</code>。<br> f. 请求方现在持有 <code>f</code>，它可以继续做别的工作，或者立即调用 <code>f.get()</code> 等待 I/O 完成。当 <code>f.get()</code> 返回时，它就知道 page 5 的数据已经成功读入 <code>data_ptr</code> 了。</p></li><li><p><strong><code>DiskScheduler</code></strong>:<br> a. <code>Schedule</code> 方法接收到 <code>vector&lt;DiskRequest&gt;</code>，它会遍历这个 vector，把每一个 <code>DiskRequest</code> 都 <code>Put</code> 进 <code>request_queue_</code>。</p></li><li><p><strong>后台线程 (<code>background_thread_</code>)</strong>:<br> a. 线程一直在一个循环中运行 <code>StartWorkerThread</code> 函数。<br> b. 在循环里，它调用 <code>request_queue_.Get()</code>。这个调用会阻塞，直到队列里有新的 <code>DiskRequest</code> 或者关闭信号。<br> c. 当它从队列里取出一个 <code>DiskRequest</code> 后：<br> i. 检查 <code>is_write_</code> 字段。<br> ii. 如果是写请求，就调用 <code>disk_manager_-&gt;WritePage(...)</code>。<br> iii. 如果是读请求，就调用 <code>disk_manager_-&gt;ReadPage(...)</code>。<br> d. 磁盘操作完成后，它通过请求中的 <code>callback_</code> (即那个 <code>std::promise</code>) 调用 <code>callback_.set_value(true)</code>。<br> e. 这个 <code>set_value</code> 操作会唤醒之前在 <code>future.get()</code> 上阻塞的请求方线程。<br> f. 后台线程回到循环的开始，继续等待下一个请求。<br> g. 如果从队列中取到的是 <code>std::nullopt</code>，则跳出循环，线程结束。</p></li></ol><h1 id="buffer-pool-manager-p2" tabindex="-1"><a class="header-anchor" href="#buffer-pool-manager-p2"><span>Buffer Pool Manager（P2）</span></a></h1><h4 id="流程一-cache-hit-页面已在内存" tabindex="-1"><a class="header-anchor" href="#流程一-cache-hit-页面已在内存"><span>流程一：Cache Hit（页面已在内存）</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>线程 T1 调用 ReadPage(page_id):</span></span>
<span class="line"><span></span></span>
<span class="line"><span>1. 获取 bpm_latch_ 锁</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2. 查 page_table_ → 命中，找到 frame_id</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. pin_count++，RecordAccess</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4. 释放 bpm_latch_ 锁</span></span>
<span class="line"><span></span></span>
<span class="line"><span>5. 获取 frame_header-&gt;io_mutex_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>6. 检查 io_done_:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>   - 如果 io_done_ == true：直接继续</span></span>
<span class="line"><span></span></span>
<span class="line"><span>   - 如果 io_done_ == false：在 io_cv_ 上等待</span></span>
<span class="line"><span></span></span>
<span class="line"><span>7. 释放 io_mutex_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>8. 获取 frame_header-&gt;rwlatch_ 的读锁</span></span>
<span class="line"><span></span></span>
<span class="line"><span>9. 返回 ReadPageGuard</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  </span></span>
<span class="line"><span></span></span>
<span class="line"><span>如果此时页面正在 I/O（io_done_ == false）：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- T1 在 io_cv_ 上等待</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- 当 I/O 完成后，io_done_ = true，io_cv_.notify_all()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- T1 被唤醒，继续执行</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>代码位置（buffer_pool_manager.cpp:365-368）：</strong></p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">unique_lock</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> io_lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">frame_header</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">io_mutex_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">frame_header</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">io_done_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  frame_header</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">io_cv_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wait</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(io_lock);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">io_lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="流程二-cache-miss-需要-i-o" tabindex="-1"><a class="header-anchor" href="#流程二-cache-miss-需要-i-o"><span>流程二：Cache Miss + 需要 I/O</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>线程 T1 调用 ReadPage(page_id):</span></span>
<span class="line"><span></span></span>
<span class="line"><span>1. 获取 bpm_latch_ 锁</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2. 查 page_table_ → 未命中</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. 从 free_frames_ 拿一个空闲 frame，或 Evict</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4. 如果 Evict 的是脏页，需要写回</span></span>
<span class="line"><span></span></span>
<span class="line"><span>5. 更新 page_table_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>6. 初始化 frame_header:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>   - pin_count = 1</span></span>
<span class="line"><span></span></span>
<span class="line"><span>   - io_done_ = false</span></span>
<span class="line"><span></span></span>
<span class="line"><span>7. 获取 frame_header-&gt;io_mutex_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>8. 把 page_id 加入 pages_in_writeback_（加 writeback_latch_）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>9. 释放 bpm_latch_ 锁</span></span>
<span class="line"><span></span></span>
<span class="line"><span>10. 如果需要写回脏页：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    - 调度写请求</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    - 等待写完成</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    - 从 pages_in_writeback_ 移除</span></span>
<span class="line"><span></span></span>
<span class="line"><span>11. 调度读请求，从磁盘读新页面</span></span>
<span class="line"><span></span></span>
<span class="line"><span>12. 等待读完成</span></span>
<span class="line"><span></span></span>
<span class="line"><span>13. 设置 io_done_ = true</span></span>
<span class="line"><span></span></span>
<span class="line"><span>14. io_cv_.notify_all() （唤醒所有等待的线程）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>15. 释放 io_mutex_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>16. 返回 ReadPageGuard</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  </span></span>
<span class="line"><span></span></span>
<span class="line"><span>此时如果有其他线程 T2 也读同一个 page_id:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- T2 获取 bpm_latch_，查 page_table_ → 命中（因为 T1 已经更新了）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- T2 pin_count++，释放 bpm_latch_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- T2 获取 io_mutex_，发现 io_done_ == false</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- T2 在 io_cv_ 上等待</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- 当 T1 完成 I/O，io_cv_.notify_all()</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- T2 被唤醒，继续执行</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>代码位置（buffer_pool_manager.cpp:398-433）：</strong></p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">unique_lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">mutex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">io_lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">frame_header</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-&gt;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">io_mutex_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">frame_header</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">io_done_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">store</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // io ongoing</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// Read the new page from disk</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">read_future</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Wait for the read to complete.</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">frame_header</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">io_done_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">store</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">frame_header</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">io_cv_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">notify_all</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">io_lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="流程三-accesstype-scan-绕过缓冲池" tabindex="-1"><a class="header-anchor" href="#流程三-accesstype-scan-绕过缓冲池"><span>流程三：AccessType::Scan（绕过缓冲池）</span></a></h4><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>线程 T1 调用 ReadPage(page_id, AccessType::Scan):</span></span>
<span class="line"><span></span></span>
<span class="line"><span>1. 检查 access_type == AccessType::Scan</span></span>
<span class="line"><span></span></span>
<span class="line"><span>2. 获取 writeback_latch_ 锁</span></span>
<span class="line"><span></span></span>
<span class="line"><span>3. 查 pages_in_writeback_:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>   - 如果 page_id 在里面，获取对应的 mutex</span></span>
<span class="line"><span></span></span>
<span class="line"><span>4. 释放 writeback_latch_ 锁</span></span>
<span class="line"><span></span></span>
<span class="line"><span>5. 如果有对应的 mutex，获取它（等待写回完成）</span></span>
<span class="line"><span></span></span>
<span class="line"><span>6. 创建临时 buffer，直接从磁盘读</span></span>
<span class="line"><span></span></span>
<span class="line"><span>7. 创建临时 FrameHeader</span></span>
<span class="line"><span></span></span>
<span class="line"><span>8. 返回特殊的 ReadPageGuard</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  </span></span>
<span class="line"><span></span></span>
<span class="line"><span>作用：</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- 全表扫描时绕过缓冲池，避免把热页面挤出</span></span>
<span class="line"><span></span></span>
<span class="line"><span>- 但仍要确保读到最新数据（等待正在进行的写回）</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>代码位置（buffer_pool_manager.cpp:454-487）：</strong></p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (access_type </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> AccessType::Scan) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 创建临时缓冲区，直接从磁盘读取</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  std::unique_lock</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">std::mutex</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> wb_latch</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">writeback_latch_);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 检查是否正在写回</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 直接从磁盘读取</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  read_future</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="四、设计亮点" tabindex="-1"><a class="header-anchor" href="#四、设计亮点"><span>四、设计亮点</span></a></h3><h4 id="_1-避免重复-i-o" tabindex="-1"><a class="header-anchor" href="#_1-避免重复-i-o"><span>1. 避免重复 I/O</span></a></h4><p>当多个线程同时访问同一个不在内存中的页面时：</p><ul><li><p>只有第一个线程真正做 I/O</p></li><li><p>其他线程在 <code>io_cv_</code> 上等待</p></li><li><p>I/O 完成后，所有等待的线程都被唤醒</p></li><li><p>避免了重复读取同一个页面</p></li></ul><h4 id="_2-细粒度锁" tabindex="-1"><a class="header-anchor" href="#_2-细粒度锁"><span>2. 细粒度锁</span></a></h4><ul><li>不是一个全局大锁，而是：</li></ul><p>- 每个 shard 有自己的 <code>bpm_latch_</code></p><p>- 每个 frame 有自己的 <code>rwlatch_</code>、<code>io_mutex_</code></p><p>- <code>writeback_latch_</code> 只保护 <code>pages_in_writeback_</code></p><ul><li>减少锁竞争，提高并发度</li></ul><h4 id="_3-条件变量的正确使用" tabindex="-1"><a class="header-anchor" href="#_3-条件变量的正确使用"><span>3. 条件变量的正确使用</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 总是用 while 循环检查条件，不是 if！</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">frame_header</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">io_done_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">load</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  frame_header</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">io_cv_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">wait</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(io_lock);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>避免虚假唤醒（Spurious Wakeup）</p></li><li><p>多线程安全</p></li></ul><h4 id="_4-sharding-分片" tabindex="-1"><a class="header-anchor" href="#_4-sharding-分片"><span>4. Sharding（分片）</span></a></h4><ul><li><p>把 Buffer Pool 分成多个 shard</p></li><li><p>每个 shard 有独立的锁</p></li><li><p>page_id 用哈希分配到不同 shard</p></li><li><p>进一步减少锁竞争</p></li></ul><h3 id="五、锁的层次结构" tabindex="-1"><a class="header-anchor" href="#五、锁的层次结构"><span>五、锁的层次结构</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span></span></span>
<span class="line"><span>BufferPoolManager</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  └── Shard 0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        ├── bpm_latch_ (mutex)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        │   ├── 保护 page_table_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        │   ├── 保护 free_frames_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        │   └── 保护 replacer_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        ├── writeback_latch_ (mutex)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        │   └── 保护 pages_in_writeback_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        └── Frame 0</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            ├── rwlatch_ (shared_mutex)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            │   ├── 读锁：多个读者</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            │   └── 写锁：独占</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            ├── io_mutex_ (mutex)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            │   └── 保护 io_done_</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            └── io_cv_ (condition_variable)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                └── 等待 I/O 完成</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        └── Frame 1</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            └── ... (same as Frame 0)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>  └── Shard 1</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        └── ... (same as Shard 0)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h1 id="p3-query-executor" tabindex="-1"><a class="header-anchor" href="#p3-query-executor"><span>P3 Query Executor</span></a></h1><ol><li><p><strong>SQL 字符串输入</strong>: 用户输入 SELECT * FROM my_table WHERE id = 1;</p></li><li><p><strong>解析 (Parse)</strong>: BusTub (在这个项目中简化了) 会将 SQL 字符串转换成一个“抽象语法树 (AST)”。</p></li><li><p><strong>绑定 (Bind)</strong>: 将 AST 中的表名、列名等标识符与数据库的元信息（Catalog）中的实际对象关联起来。</p></li><li><p><strong>计划 (Plan)</strong>: 将 AST 转换成一个<strong>逻辑计划树 (Logical Plan Tree)</strong>。树的每个节点代表一个操作，比如 SeqScanNode, FilterNode, JoinNode 等。例如，上面的查询可能会变成一个 FilterNode (过滤 id=1)，它的子节点是一个 SeqScanNode (扫描 my_table)。</p></li><li><p><strong>优化 (Optimize)</strong>: 优化器会把逻辑计划树转换成一个更高效的<strong>物理计划树 (Physical Plan Tree)</strong>。比如，如果 id 列有索引，优化器可能会把 SeqScanNode 换成 IndexScanNode。</p></li><li><p><strong>执行 (Execution)</strong>: 这是 P3 的核心工作。</p><ul><li><p>ExecutorFactory 会遍历物理计划树，为每一个 PlanNode 创建一个对应的 <strong>Executor</strong>（执行器）。比如，SeqScanPlanNode 对应 SeqScanExecutor，InsertPlanNode 对应 InsertExecutor。</p></li><li><p>这些执行器也组成一棵树，结构和物理计划树完全一样。</p></li><li><p>执行引擎从最顶层的执行器节点开始调用它的 Next() 方法。</p></li></ul></li></ol><h3 id="各个组成部分" tabindex="-1"><a class="header-anchor" href="#各个组成部分"><span>各个组成部分</span></a></h3><ol><li><p><strong>Catalog (图书馆的“总目录/索引系统”)</strong></p><ul><li><p><strong>它是什么？</strong> Catalog 是数据库的“元数据”管理器。它就像图书馆入口处的电脑查询系统或者老式的卡片目录。</p></li><li><p><strong>它知道什么？</strong> 你问它：“《数据库系统概念》这本书在哪？” 它不会直接给你书，但它会告诉你：这本书的索引号是 TP311.13-G5，它在 计算机科学 书架区。在数据库里，你问 Catalog：“students 这张表的信息是什么？” 它会告诉你：这张表的 ID (oid) 是 123，它有 id, name, age 这几列，它的物理数据存储在一个叫做 TableHeap 的对象里（相当于告诉你在哪个书架区）。</p></li><li><p><strong>它不知道什么？</strong> 它不关心书的具体内容（元组数据），也不关心书现在被谁借走了（事务/锁）。它只负责记录“有什么”和“在哪里”。</p></li><li><p><strong>关系</strong>: SeqScanExecutor 开始工作时，第一步就是拿着 plan_ 给的 table_oid 去问 Catalog，从而找到管理这张表物理存储的 TableHeap 对象。<strong>Catalog是所有查询的起点。</strong></p></li></ul></li><li><p><strong>Buffer Pool Manager (BPM) (图书馆的“图书管理员和阅览区”)</strong></p><ul><li><p><strong>它是什么？</strong> BPM 是内存和磁盘之间的桥梁。磁盘就像图书馆的“地下书库”，非常大但访问很慢。内存（RAM）就像图书馆的“阅览桌”，很小但访问超快。BPM 就是那个负责把书从书库搬到阅览桌，并在桌子满了之后决定哪些书可以搬回去的图书管理员。</p></li><li><p><strong>它的工作单位是什么？</strong> BPM 不关心一本“书”（Tuple）有多大，它只按“箱子”（<strong>Page</strong>）来搬运。一个 Page 是一个固定大小的数据块（比如 4KB），里面可能放了很多个 Tuple。</p></li><li><p><strong>它如何工作？</strong> 当 TableHeap (书架) 需要读取某个 Tuple 时，它会先计算出这个 Tuple 在哪个 Page 里。然后它会向 BPM 发出请求：“请把第 N 号箱子（Page ID）给我”。BPM 会：</p><ol><li><p>检查阅览桌（内存）上是否已经有这个箱子了。</p></li><li><p>如果有，直接把这个箱子的位置给 TableHeap。</p></li><li><p>如果没有，管理员（BPM）就去地下书库（磁盘），找到这个箱子，把它搬到阅览桌上一个空位。如果没空位，就根据某种规则（比如 LRU，最久没用的）把一个旧箱子搬回书库，再把新箱子放上来。</p></li></ol></li><li><p><strong>关系</strong>: <strong>BPM 是物理数据访问的唯一通道。</strong> 任何模块（比如TableHeap）想要读写磁盘上的数据，都必须通过 BPM。它对上层屏蔽了复杂的磁盘 I/O 操作。</p></li></ul></li><li><p><strong>Transaction Manager (图书馆的“规则和安保系统”)</strong></p><ul><li><p><strong>它是什么？</strong> 事务管理器确保数据库操作的ACID特性，尤其是并发控制（Concurrency Control）和恢复（Recovery）。它就像图书馆的安保和借阅规则系统。</p></li><li><p><strong>它如何工作？</strong></p><ul><li><p><strong>并发控制 (锁)</strong>: 假设你和另一个人同时想看同一本孤本。图书馆规定，一个人在看的时候，另一个人必须等待（加锁）。Transaction Manager (通过内部的 LockManager) 就是做这个的。当你（一个事务）要读取一个 Tuple 时，你需要先获取一个“共享锁”（S Lock，允许多人同时读）。当你要修改一个 Tuple 时，你需要获取一个“排他锁”（X Lock，只允许你一个人修改）。</p></li><li><p><strong>日志</strong>: 你在书上做的所有笔记（数据修改），图书管理员都会在一个日志本上记录下来。万一图书馆突然停电（系统崩溃），管理员可以根据这个日志本恢复所有笔记，确保数据不丢失。</p></li></ul></li><li><p><strong>关系</strong>: <strong>所有对数据的操作都必须在一个事务（Transaction）的监督下进行。</strong> SeqScanExecutor 在 Init 和 Next 中使用的 exec_ctx_-&gt;GetTransaction() 就是获取当前操作所属的事务。当 TableHeap 通过 BPM 拿到了一个 Page 准备读取时，它必须先代表当前事务去 LockManager 获取适当的锁。</p></li></ul></li></ol><h3 id="schema-模式-表的-蓝图-或-登记表模板" tabindex="-1"><a class="header-anchor" href="#schema-模式-表的-蓝图-或-登记表模板"><span>Schema (模式)：表的“蓝图”或“登记表模板”</span></a></h3><p>Schema <strong>不是数据本身，而是对数据结构的描述</strong>。</p><p>想象一下，你要在图书馆建立一个学生档案系统。在录入任何学生信息之前，你首先要设计一张空白的登记表。这张表上会规定好有哪些栏目，以及每个栏目要填什么类型的信息：</p><table><thead><tr><th></th><th></th><th></th></tr></thead><tbody><tr><td>栏目名称 (Column Name)</td><td>数据类型 (Data Type)</td><td>备注 (Constraints)</td></tr><tr><td>student_id</td><td>整数 (Integer)</td><td>唯一，4个字节长</td></tr><tr><td>student_name</td><td>字符串 (Varchar)</td><td>最长50个字符</td></tr><tr><td>gpa</td><td>小数 (Decimal)</td><td>2位小数</td></tr></tbody></table><p>这张<strong>空白的表格模板，就是 Schema</strong>。</p><p>在 BusTub 的 C++ 代码中，一个 Schema 对象就是：</p><ul><li><p>一个 Column 对象的列表（<code>std::vector&lt;Column&gt;</code>)。</p></li><li><p>每个 Column 对象包含了：</p><ul><li><p>列名 (e.g., &quot;student_id&quot;)</p></li><li><p>数据类型 (e.g., TypeId::INTEGER)</p></li><li><p>长度（如果是变长类型）</p></li><li><p>... 等其他元信息。</p></li></ul></li></ul><h4 id="schema-的作用是什么" tabindex="-1"><a class="header-anchor" href="#schema-的作用是什么"><span>Schema 的作用是什么？</span></a></h4><p>它的作用至关重要，体现在两个方面——<strong>写入</strong>和<strong>读取</strong>：</p><ol><li><p><strong>序列化 (Serialization) - 写入时</strong><br> 当你有一个 Tuple 对象（比如代表学生 Alice 的 (101, &quot;Alice&quot;, 3.9))，并想把它存到磁盘的 Page 里时，你不能直接把 C++ 对象存进去。你需要把它转换成一串紧凑的二进制字节流。<br> Schema 就是这个转换过程的<strong>规则手册</strong>：</p><ul><li><p>它告诉你 101 是个 INTEGER，应该转换成 4 个字节。</p></li><li><p>它告诉你 &quot;Alice&quot; 是个 VARCHAR，应该存下它的长度（5），然后再存下 A-l-i-c-e 这 5 个字节。</p></li><li><p>它告诉你 3.9 是个 DECIMAL，应该按特定格式转换成 8 个字节。<br> 最终，Tuple 对象 (101, &quot;Alice&quot;, 3.9) 被 Schema 指导，变成了一串类似 [bytes_for_101][bytes_for_Alice][bytes_for_3.9] 的二进制数据，存入 Page。</p></li></ul></li><li><p><strong>反序列化 (Deserialization) - 读取时</strong><br> 反过来，当 TableHeap 从 Page 里读出了一串二进制字节时，它本身是毫无意义的。TableHeap 必须拿着 Schema 这个“模板”去解析它：</p><ul><li><p>Schema 说：“前 4 个字节是一个 INTEGER”，于是 TableHeap 就把这 4 个字节翻译回整数 101。</p></li><li><p>Schema 说：“接下来是一个 VARCHAR”，于是 TableHeap 先读取长度，再读取相应数量的字节，翻译回字符串 &quot;Alice&quot;。</p></li><li><p>...以此类推。<br> 通过这个过程，一堆无意义的字节就被重新构造成了一个有结构的、你可以在 C++ 代码里操作的 Tuple 对象。</p></li></ul></li></ol><p><strong>小结：Schema 是连接逻辑 Tuple 对象和物理二进制存储的桥梁。</strong></p><hr><h3 id="tableheap-表的-物理书架集合" tabindex="-1"><a class="header-anchor" href="#tableheap-表的-物理书架集合"><span>TableHeap：表的“物理书架集合”</span></a></h3><p>TableHeap 是负责<strong>物理存储一张表所有元组（Tuples）</strong> 的模块。</p><h4 id="_1-每个表都有一个-tableheap-吗" tabindex="-1"><a class="header-anchor" href="#_1-每个表都有一个-tableheap-吗"><span>1. 每个表都有一个 TableHeap 吗？</span></a></h4><p><strong>是的，绝对是。</strong> 每个表在逻辑上是独立的，所以在物理上，BusTub 会为每张表创建一个单独的 TableHeap 实例来管理它的数据。</p><ul><li><p>students 表有一个 TableHeap 实例，管理着所有学生元组。</p></li><li><p>courses 表有另一个<strong>不同</strong>的 TableHeap 实例，管理着所有课程元组。</p></li></ul><p>Catalog 就像是总索引，它维护着一个映射关系：table_oid -&gt; TableInfo。而 TableInfo 对象里面就包含了指向该表<strong>唯一</strong>的那个 TableHeap 实例的指针。</p><h4 id="_2-tableheap-是一个怎样的结构" tabindex="-1"><a class="header-anchor" href="#_2-tableheap-是一个怎样的结构"><span>2. TableHeap 是一个怎样的结构？</span></a></h4><p>它<strong>不是</strong>一个 B+ 树或任何有序的索引结构。它的名字 &quot;Heap&quot;（堆）暗示了它的特点：<strong>数据是无序存放的</strong>。新来的数据会被塞到任何有空位的地方。</p><h2 id="火山模型" tabindex="-1"><a class="header-anchor" href="#火山模型"><span>火山模型</span></a></h2><p>想象一下，数据库的查询执行就像一个汽车装配流水线。</p><ul><li><p><strong>每个执行器 (Executor)</strong> 就像流水线上的一个<strong>工人</strong>。</p></li><li><p>每个工人只负责一个非常具体、简单的任务（装轮子、装引擎、喷漆）。</p></li><li><p><strong>元组 (Tuple)</strong> 就像流水线上正在组装的<strong>汽车底盘</strong>。</p></li><li><p>数据从流水线的开端（读取磁盘的工人）流向末端（最终打包的工人），每个工人都对它进行一步加工。</p></li></ul><p>火山模型的关键特点是，这是一个 <strong>“拉”模型 (Pull Model)</strong>。也就是说，流水线末端的工人（比如，最终要向你展示结果的那个）<strong>主动去要</strong>一个加工好的产品。这个请求会一直向流水线的前方传递，直到最开始的工人从仓库里拿出一个新的底盘。</p><p>这个“请求”的动作，就是调用子节点的 Next() 方法。</p><h3 id="例子-select" tabindex="-1"><a class="header-anchor" href="#例子-select"><span>例子 SELECT</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> name</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> FROM</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> students </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">WHERE</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> gpa </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>[ProjectionExecutor]  (只保留 name 字段)</span></span>
<span class="line"><span>                  ^</span></span>
<span class="line"><span>                  |  (调用 child-&gt;Next() 来拉取元组)</span></span>
<span class="line"><span>                  |</span></span>
<span class="line"><span>           [FilterExecutor]     (只保留 gpa &gt; 3.5 的元组)</span></span>
<span class="line"><span>                  ^</span></span>
<span class="line"><span>                  |</span></span>
<span class="line"><span>                  |</span></span>
<span class="line"><span>         [SeqScanExecutor]    (从 &quot;students&quot; 表中一条一条地读元组)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>执行流程（当客户端请求第一条结果时）：</strong></p><ol><li><p><strong>你 (客户端)</strong> 调用最顶层 ProjectionExecutor 的 Next() 方法，说：“给我一条结果”。</p></li><li><p>ProjectionExecutor 说：“好的，但我手上没有元组。我需要从我的下游（我的 child）那里拿一个。” 于是它调用 FilterExecutor 的 Next()。</p></li><li><p>FilterExecutor 说：“我也没有元组，我得从我的 child 那里拿一个。” 于是它调用 SeqScanExecutor 的 Next()。</p></li><li><p>SeqScanExecutor 是流水线的起点。它去磁盘上读取 students 表的第一行记录。假设是 (id: 1, name: &#39;Alice&#39;, gpa: 4.0)。它把这个元组准备好，然后通过 return true 把它“递给”了 FilterExecutor。</p></li><li><p>FilterExecutor 拿到了 (&#39;Alice&#39;, 4.0)。它的工作是检查 gpa &gt; 3.5。4.0 &gt; 3.5 是 true，所以这个元组通过了过滤。FilterExecutor 把它原封不动地“递给”了 ProjectionExecutor。</p></li><li><p>ProjectionExecutor 拿到了 (&#39;Alice&#39;, 4.0)。它的工作是“投影”，也就是只保留 name 字段。它会创建一个新的元组 (&#39;Alice&#39;)。</p></li><li><p>最后，ProjectionExecutor 把这个最终结果 (&#39;Alice&#39;) 返回给你（客户端）。</p></li></ol><p><strong>当客户端请求第二条结果时，会发生什么？</strong></p><p>这个过程会重复。假设 SeqScanExecutor 读取的下一条记录是 (id: 2, name: &#39;Bob&#39;, gpa: 3.0)。</p><ol><li><p>请求一路向下传到 SeqScanExecutor，它返回 (&#39;Bob&#39;, 3.0) 给 FilterExecutor。</p></li><li><p>FilterExecutor 拿到后，检查 gpa &gt; 3.5。3.0 &gt; 3.5 是 false！</p></li><li><p><strong>关键点来了</strong>：FilterExecutor 不会就此放弃。它不会把这个元组传上去，也不会返回 false（因为表里可能还有其他符合条件的元组）。它会<strong>在内部循环</strong>，再次调用 SeqScanExecutor-&gt;Next()，说：“这个不行，给我下一个”。</p></li><li><p>SeqScanExecutor 于是去读第三条记录，比如 (id: 3, name: &#39;Charlie&#39;, gpa: 3.8)。它把这个元组返回给 FilterExecutor。</p></li><li><p>FilterExecutor 检查 3.8 &gt; 3.5，true！它终于找到了一个合格的元组，于是把它向上递给 ProjectionExecutor。</p></li><li><p>ProjectionExecutor 把它变成 (&#39;Charlie&#39;)，然后返回给客户端。</p></li></ol><p>这个过程一直持续，直到 SeqScanExecutor 读完了整张表，它的 Next() 方法返回 false。这个 false 会被逐层向上传递，最终客户端就知道没有更多结果了。</p><h2 id="另一个例子-join" tabindex="-1"><a class="header-anchor" href="#另一个例子-join"><span>另一个例子 JOIN</span></a></h2><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">cname</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">FROM</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> students s </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">JOIN</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> courses c </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ON</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">student_id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>				[ProjectionExecutor]</span></span>
<span class="line"><span>                        ^</span></span>
<span class="line"><span>                        |</span></span>
<span class="line"><span>            [NestedLoopJoinExecutor]</span></span>
<span class="line"><span>                   /           \</span></span>
<span class="line"><span>                  /             \  (有两个 child)</span></span>
<span class="line"><span>                 /               \</span></span>
<span class="line"><span>       [SeqScanExecutor]     [SeqScanExecutor]</span></span>
<span class="line"><span>       (scans &quot;students&quot;)    (scans &quot;courses&quot;)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>NestedLoopJoinExecutor 的工作方式：</strong></p><p>它内部有两个循环（一个外循环，一个内循环）。</p><ol><li><p>当 JoinExecutor::Next() 第一次被调用时，它会：<br> a. 从它的<strong>左子节点</strong> (students 扫描) 调用 Next()，获取第一名学生，比如 s1 = (&#39;Alice&#39;, id: 1)。它会把 s1 存起来。<br> b. 从它的<strong>右子节点</strong> (courses 扫描) 调用 Next()，获取第一门课程，比如 c1 = (&#39;DB&#39;, student_id: 1)。<br> c. 检查 JOIN 条件 <a href="http://s1.id" target="_blank" rel="noopener noreferrer">s1.id</a> == c1.student_id (即 1 == 1)。匹配！<br> d. 它将两者合并成一个新元组 (&#39;Alice&#39;, &#39;DB&#39;)，然后返回。</p></li><li><p>当 JoinExecutor::Next() 第二次被调用时，它会：<br> a. <strong>保持左边的元组 s1 不变</strong>。<br> b. 从<strong>右子节点</strong>再次调用 Next()，获取下一门课程，比如 c2 = (&#39;OS&#39;, student_id: 2)。<br> c. 检查 JOIN 条件 <a href="http://s1.id" target="_blank" rel="noopener noreferrer">s1.id</a> == c2.student_id (即 1 == 2)。不匹配！<br> d. 它会继续从右子节点获取元组，直到找到一个匹配的，或者右边的课程全部扫描完毕。</p></li><li><p>当右边的 courses 表扫描完一遍后：<br> a. JoinExecutor 会从<strong>左子节点</strong>调用 Next()，获取<strong>第二名学生</strong>，比如 s2 = (&#39;Bob&#39;, id: 2)。<br> b. <strong>关键</strong>：它会<strong>重置</strong>右子节点的扫描，让它从头开始。<br> c. 然后重复上面的过程，用 s2 去匹配 courses 表里的每一条记录。</p></li></ol><p>这就是为什么它叫“嵌套循环连接”，火山模型通过 Next() 调用巧妙地实现了这个算法。</p><h3 id="insert-executor" tabindex="-1"><a class="header-anchor" href="#insert-executor"><span>Insert executor</span></a></h3><p>对于插入迭代器来说 只需要一个next执行一次即可<br> 所以要设置一个之后再调用他 都直接返回 要想返回插入的数量 根据要求 也是要通过元组返回给父执行器的<br> 所以使用</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> result_values;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  result_values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">emplace_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(INTEGER, inserted_count_));</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(result_values, </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  returned_flag_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="rid到底是什么" tabindex="-1"><a class="header-anchor" href="#rid到底是什么"><span>RID到底是什么</span></a></h2><p>在bustub中 RID 由 page_id 和 solt_id 构成<br> 被table heap 用来定位具体的数据</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [old_meta, old_tuple] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> table_heap</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetTuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(child_rid);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ol><li><p><strong>Table Heap 使用 RID 找到具体位置</strong></p><ul><li>根据 RID 中的 Page ID 找到对应页面</li><li>根据 Slot Number 在页面内找到具体记录</li></ul></li><li><p><strong>将数据加载到 Tuple 中</strong></p><ul><li>从磁盘/内存中的物理存储位置读取数据</li><li>将数据组织成 Tuple 格式，便于上层操作</li></ul></li></ol><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>Students 表 | id | name  | age | </span></span>
<span class="line"><span>			|----|-------|-----| </span></span>
<span class="line"><span>			| 1 | Alice  | 20 | &lt;- RID 可能是 (Page1, Slot0) </span></span>
<span class="line"><span>			| 2 | Bob    | 22 | &lt;- RID 可能是 (Page1, Slot1) </span></span>
<span class="line"><span>			| 3 | Carol  | 19 | &lt;- RID 可能是 (Page2, Slot0)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="update-executor" tabindex="-1"><a class="header-anchor" href="#update-executor"><span>Update executor</span></a></h3><h3 id="delete-executor" tabindex="-1"><a class="header-anchor" href="#delete-executor"><span>Delete executor</span></a></h3><h3 id="index-scan-executor" tabindex="-1"><a class="header-anchor" href="#index-scan-executor"><span>Index_scan_executor</span></a></h3><h3 id="seq-scan-as-index-scan" tabindex="-1"><a class="header-anchor" href="#seq-scan-as-index-scan"><span>Seq scan as Index scan</span></a></h3><p>回顾一下查询的过程<br> parser-&gt;binder-&gt;planner</p><p>直接从语法上得出的查询计划可能不够快</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>// 优化前：全表扫描 + 过滤</span></span>
<span class="line"><span>Filter { predicate=(#0.0=1) }</span></span>
<span class="line"><span>  SeqScan { table=t1 }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>// 优化后：直接索引扫描</span></span>
<span class="line"><span>IndexScan { index_oid=0, filter=(#0.0=1) }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>这个优化器的作用就是把顺序查找变成索引查找</p><h4 id="优化的种类" tabindex="-1"><a class="header-anchor" href="#优化的种类"><span>优化的种类</span></a></h4><ul><li>基于规则的优化 比如这就是一种规则 将顺序扫描转化成索引查找</li><li>基于成本的优化 可以通过估算不同查询计划产生的成本 来选择计划</li><li>动态规划</li></ul><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> Optimizer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Optimize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AbstractPlanNodeRef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">AbstractPlanNodeRef</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (force_starter_rule_) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Use starter rules when `force_starter_rule_` is set to true.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> plan;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> OptimizeMergeProjection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> OptimizeMergeFilterNLJ</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> OptimizeNLJAsIndexJoin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> OptimizeOrderByAsIndexScan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> OptimizeMergeFilterScan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> OptimizeSeqScanAsIndexScan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(p);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // By default, use user-defined rules.</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> OptimizeCustom</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(plan);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>从这个优化器的入口可以看出 bustub运用的是一种基于规则的优化 不断尝试这些优化规则 并且应用</p><h4 id="常见优化规则包括" tabindex="-1"><a class="header-anchor" href="#常见优化规则包括"><span>常见优化规则包括：</span></a></h4><ol><li><strong>谓词下推(Predicate Pushdown)</strong>：将过滤条件下推到数据源，减少中间结果</li><li><strong>投影剪枝(Projection Pruning)</strong>：只选择需要的列，避免不必要的数据传输</li><li><strong>连接重排序(Join Reordering)</strong>：调整表连接顺序以减少计算量</li><li><strong>连接算法选择</strong>：决定使用嵌套循环连接、哈希连接还是排序合并连接</li></ol><p>比如这个seqscan到indexscan的优化之前就有一部谓词下推的优化</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 优化前</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Filter { predicate</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(#</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0.0</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  SeqScan { table</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">t1 }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 经过 MergeFilterScan 优化后</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SeqScan { table</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">t1, filter</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(#</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0.0</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) }</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>以这个谓词下推代码为例</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> Optimizer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">OptimizeMergeFilterScan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AbstractPlanNodeRef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">AbstractPlanNodeRef</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">AbstractPlanNodeRef</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> children;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">child : </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetChildren</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    children</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">emplace_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">OptimizeMergeFilterScan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(child));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> optimized_plan </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CloneWithChildren</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">move</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(children));</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">optimized_plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> PlanType::Filter) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">filter_plan </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#ABB2BF;"> dynamic_cast</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> FilterPlanNode </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">optimized_plan);</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    BUSTUB_ASSERT</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">optimized_plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">children_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;must have exactly one children&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">child_plan </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">optimized_plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">children_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">child_plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> PlanType::SeqScan) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">seq_scan_plan </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#ABB2BF;"> dynamic_cast</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SeqScanPlanNode </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(child_plan);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">seq_scan_plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">filter_predicate_</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nullptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make_shared</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">SeqScanPlanNode</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">filter_plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">output_schema_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">seq_scan_plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">table_oid_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                                                 seq_scan_plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">table_name_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">filter_plan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetPredicate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> optimized_plan;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>首先递归优化所有child 使得整个优化过程是自底向上进行的</p><p>如果当前节点是Filter 那么就执行优化：<br> 如果孩子是seqscan 而且没有其他filter谓词的话 那么就返回一个新的节点<br> 相当于丢弃了原来的filter 把谓词转移到新的seqscan里了</p><h3 id="aggregation-executor" tabindex="-1"><a class="header-anchor" href="#aggregation-executor"><span>Aggregation executor</span></a></h3><h3 id="nested-loop-executor" tabindex="-1"><a class="header-anchor" href="#nested-loop-executor"><span>nested loop executor</span></a></h3><div class="language-sql line-numbers-mode" data-highlighter="shiki" data-ext="sql" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-sql"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">SELECT</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">cname</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">FROM</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> students s </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">JOIN</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> courses c </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">ON</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> s</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">id</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> c</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">student_id</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>				[ProjectionExecutor]</span></span>
<span class="line"><span>                        ^</span></span>
<span class="line"><span>                        |</span></span>
<span class="line"><span>            [NestedLoopJoinExecutor]</span></span>
<span class="line"><span>                   /           \</span></span>
<span class="line"><span>                  /             \  (有两个 child)</span></span>
<span class="line"><span>                 /               \</span></span>
<span class="line"><span>       [SeqScanExecutor]     [SeqScanExecutor]</span></span>
<span class="line"><span>       (scans &quot;students&quot;)    (scans &quot;courses&quot;)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>NestedLoopJoinExecutor 的工作方式：</strong></p><p>它内部有两个循环（一个外循环，一个内循环）。</p><ol><li><p>当 JoinExecutor::Next() 第一次被调用时，它会：<br> a. 从它的<strong>左子节点</strong> (students 扫描) 调用 Next()，获取第一名学生，比如 s1 = (&#39;Alice&#39;, id: 1)。它会把 s1 存起来。<br> b. 从它的<strong>右子节点</strong> (courses 扫描) 调用 Next()，获取第一门课程，比如 c1 = (&#39;DB&#39;, student_id: 1)。<br> c. 检查 JOIN 条件 <a href="http://s1.id" target="_blank" rel="noopener noreferrer">s1.id</a> == c1.student_id (即 1 == 1)。匹配！<br> d. 它将两者合并成一个新元组 (&#39;Alice&#39;, &#39;DB&#39;)，然后返回。</p></li><li><p>当 JoinExecutor::Next() 第二次被调用时，它会：<br> a. <strong>保持左边的元组 s1 不变</strong>。<br> b. 从<strong>右子节点</strong>再次调用 Next()，获取下一门课程，比如 c2 = (&#39;OS&#39;, student_id: 2)。<br> c. 检查 JOIN 条件 <a href="http://s1.id" target="_blank" rel="noopener noreferrer">s1.id</a> == c2.student_id (即 1 == 2)。不匹配！<br> d. 它会继续从右子节点获取元组，直到找到一个匹配的，或者右边的课程全部扫描完毕。</p></li><li><p>当右边的 courses 表扫描完一遍后：<br> a. JoinExecutor 会从<strong>左子节点</strong>调用 Next()，获取<strong>第二名学生</strong>，比如 s2 = (&#39;Bob&#39;, id: 2)。<br> b. <strong>关键</strong>：它会<strong>重置</strong>右子节点的扫描，让它从头开始。<br> c. 然后重复上面的过程，用 s2 去匹配 courses 表里的每一条记录。</p></li></ol><h3 id="external-merge-sort-executor" tabindex="-1"><a class="header-anchor" href="#external-merge-sort-executor"><span>External Merge Sort Executor</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>Phase 1: 生成有序段 (Sorted Runs)</span></span>
<span class="line"><span>+------------------+     +------------------+     +------------------+</span></span>
<span class="line"><span>| 读取一批元组      | --&gt; | 内存中排序这些元组 | --&gt; | 写入磁盘作为Run1 |</span></span>
<span class="line"><span>+------------------+     +------------------+     +------------------+</span></span>
<span class="line"><span></span></span>
<span class="line"><span>+------------------+     +------------------+     +------------------+</span></span>
<span class="line"><span>| 读取下一批元组    | --&gt; | 内存中排序这些元组 | --&gt; | 写入磁盘作为Run2 |</span></span>
<span class="line"><span>+------------------+     +------------------+     +------------------+</span></span>
<span class="line"><span></span></span>
<span class="line"><span>...</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Phase 2: 多路归并</span></span>
<span class="line"><span>+--------+  +--------+       +----------------------+</span></span>
<span class="line"><span>| Run1   |  | Run2   |  ...  |                     |</span></span>
<span class="line"><span>+--------+  +--------       +----------------------+</span></span>
<span class="line"><span>    \         /                    |</span></span>
<span class="line"><span>     \       /              +--------------+</span></span>
<span class="line"><span>      多路归并  -----------&gt; | 归并后的Run  |</span></span>
<span class="line"><span>                           +--------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> SortPage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		auto</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> AddTuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Tuple</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		auto</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GetTuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		auto</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GetSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() -&gt; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> SetSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> constexpr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GetMaxSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() -&gt; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	private:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> constexpr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SORT_PAGE_HEADER_SIZE </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> sizeof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> constexpr</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SORT_PAGE_DATA_SIZE </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> BUSTUB_PAGE_SIZE </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> SORT_PAGE_HEADER_SIZE;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		char</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> data_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[BUSTUB_PAGE_SIZE];</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		auto</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GetSizePtr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() -&gt; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			return</span><span style="--shiki-light:#A626A4;--shiki-dark:#ABB2BF;"> reinterpret_cast</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;size_t</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(data_);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		.... </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>sort page类 对于这种page类型的使用char*明确页面大小 然后使用reinterpret cast来序列化与反序列化内容<br> 同时 使用 <code>static constexpr</code> 来规定页面结构</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MergeSortRun</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	public:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">		MergeSortRun</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> AddPage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Iterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> operator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">++()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> -&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Iterator</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> operator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">*()</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> -&gt; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Tuple</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			private:</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">				page_id_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cur_page_;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> cur_idx_;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> MergeSortRun </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">run_;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				std::optional</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ReadPageGuard</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> page_guard_</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		auto</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> begin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() -&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Iterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		auto</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() -&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Iterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	private:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">page_id_t</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> pages_;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		BufferPoolManager </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">bpm_;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;template</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> k</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> MergeSortExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> MergeSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	private:</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">MergeSortRun</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> runs_;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		BufferPoolManager</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> bpm_</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;template</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> k</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> MergeSortExecutor::</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;template</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> k</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // k way merge</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> MergeSortExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">MergeSort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Tuple</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> InMemTuples;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tuple_size </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> child_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetInlinedStorageSize</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	 </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> max_tuples_per_page </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (BUSTUB_PAGE_SIZE </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> sizeof</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tuple_size;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetData</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">	InMemTuples</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(Data);	</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">InMemTuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> max_tuple_pre_page) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">sort</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">inMemTuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">begin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">inMemTuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> new_sort_page_id </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> bpm_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">NewPage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> new_sort_page </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> bpm_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">WritePage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(new_sort_page_id).</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">AsMut</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">SortPage</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple : inMemTuple) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">			new_sort_page</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">AddTuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(tuple);	</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		MergeSortRun cur_run;</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">		cur_run</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">AddPage</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">new_sort_page</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetPageId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">		runs_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">move</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(cur_run));</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">		InMemTuples</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">clear</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		//call dtor of new sort page</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}	</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">InMemTuples</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">empty</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		create last run</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">run_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">MergeSortRun</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Merged_runs;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> run_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &gt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> runs_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">				merged_runs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">move</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">run_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i]))；</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				break</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> new_run </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> MergeRuns</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">runs_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i], </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">run_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">			merger_runs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(new_run);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		runs_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">move</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(merged_runs);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>![[Pasted image 20251121131635.png]]</p><h1 id="p4-concurrency-control" tabindex="-1"><a class="header-anchor" href="#p4-concurrency-control"><span>P4 concurrency control</span></a></h1><p>隔离级别 <code>READ TIMESTAMP</code><br> 事务在开始的时候 拍摄了一个快照 在他的生命周期中 看到的内容永远是食物开始时快照中的世界</p><h3 id="补充-可能出现的异常-anomalies" tabindex="-1"><a class="header-anchor" href="#补充-可能出现的异常-anomalies"><span>补充：可能出现的异常：Anomalies</span></a></h3><h4 id="一、-读异常-read-anomalies" tabindex="-1"><a class="header-anchor" href="#一、-读异常-read-anomalies"><span>一、 读异常 (Read Anomalies)</span></a></h4><p>这些问题发生在“读取数据”时，看到的状态不一致或不正确。</p><h4 id="_1-脏读-dirty-read" tabindex="-1"><a class="header-anchor" href="#_1-脏读-dirty-read"><span>1. 脏读 (Dirty Read)</span></a></h4><ul><li><strong>现象</strong>：T2 读到了 T1 <strong>修改但未提交</strong>的数据。如果 T1 后来回滚了（Abort），T2 拿到的就是废数据。</li><li><strong>例子</strong>： <ul><li>A 原本有 100 块。</li><li>T1 把 A 改成 200（未提交）。</li><li>T2 读 A，看到 200。</li><li>T1 出错回滚，A 变回 100。</li><li>T2 拿着 200 去做后续计算，全错了。</li></ul></li><li><strong>Lab 4 处理</strong>：通过检查 Tuple 的时间戳。如果发现是临时时间戳（txn_id），且不是自己写的，绝对不读，要去 Undo Log 找上一个版本。</li></ul><h4 id="_2-不可重复读-non-repeatable-read-模糊读-fuzzy-read" tabindex="-1"><a class="header-anchor" href="#_2-不可重复读-non-repeatable-read-模糊读-fuzzy-read"><span>2. 不可重复读 (Non-repeatable Read) / 模糊读 (Fuzzy Read)</span></a></h4><ul><li><strong>现象</strong>：在一个事务内，两次读取<strong>同一行</strong>数据，结果不一样。</li><li><strong>例子</strong>： <ul><li>T1 读取 A = 10。</li><li>T2 将 A 更新为 20 并提交。</li><li>T1 再次读取 A，变成了 20。</li><li>T1 困惑：“我还在同一个事务里，怎么世界变了？”</li></ul></li><li><strong>Lab 4 处理</strong>：<strong>Snapshot Isolation (SI)</strong> 完美解决。T1 有固定的 Read TS。不管 T2 怎么改，T1 永远通过 Undo Log 重建出 Read TS 那个时刻的数据。</li></ul><h4 id="_3-幻读-phantom-read" tabindex="-1"><a class="header-anchor" href="#_3-幻读-phantom-read"><span>3. 幻读 (Phantom Read)</span></a></h4><ul><li><strong>现象</strong>：在一个事务内，执行两次<strong>范围查询</strong><code>（如 SELECT count(*) FROM user WHERE age &gt; 10）</code>，结果集的<strong>行数</strong>不一样。</li><li><strong>例子</strong>： <ul><li>T1 查 age &gt; 10，返回 5 人。</li><li>T2 插入一个新用户，age = 15，并提交。</li><li>T1 再次查 age &gt; 10，返回 6 人。</li><li>T1 困惑：“刚才明明只有 5 个，哪里冒出来的鬼影？”</li></ul></li><li><strong>Lab 4 处理</strong>：标准的 SI 其实<strong>不能</strong>完全防止幻读（虽然你看不到新插入的行，但在写操作时可能会有问题）。在 Lab 4 中，通常不强求完全解决幻读，除非要求实现 Serializable。</li></ul><h4 id="_4-读偏斜-read-skew" tabindex="-1"><a class="header-anchor" href="#_4-读偏斜-read-skew"><span>4. 读偏斜 (Read Skew)</span></a></h4><ul><li><strong>现象</strong>：这是 MVOCC 最想避免的问题。读取数据库的<strong>不一致快照</strong>。</li><li><strong>例子</strong>：账户 A=100, B=100。总和应为 200。 <ul><li>T1 读取 A=100。</li><li>T2 将 A 转账 50 给 B（A=50, B=150），提交。</li><li>T1 读取 B=150。</li><li>T1 算总账：A(100) + B(150) = 250。多了 50 块！</li></ul></li><li><strong>Lab 4 处理</strong>：有了 <strong>Commit TS</strong> 和 <strong>Read TS</strong>，T1 读 B 时会发现 B 的 Commit TS 比自己的 Read TS 新，于是回溯 Undo Log 找到 B=100 的旧版本。T1 最终读到 A=100, B=100。</li></ul><hr><h4 id="二、-写异常-write-anomalies" tabindex="-1"><a class="header-anchor" href="#二、-写异常-write-anomalies"><span>二、 写异常 (Write Anomalies)</span></a></h4><p>这些问题发生在“写入数据”时，导致数据丢失或逻辑破坏。</p><h4 id="_1-丢失更新-lost-update" tabindex="-1"><a class="header-anchor" href="#_1-丢失更新-lost-update"><span>1. 丢失更新 (Lost Update)</span></a></h4><ul><li><strong>现象</strong>：两个事务同时读写同一行，后一个写的覆盖了前一个写的。</li><li><strong>例子</strong>：计数器 X=10。 <ul><li>T1 读 X=10，计算 X+1。</li><li>T2 读 X=10，计算 X+1。</li><li>T1 写回 X=11。</li><li>T2 写回 X=11。</li><li>结果应该是 12，却变成了 11。T1 的工作白做了。</li></ul></li><li><strong>Lab 4 处理</strong>：<strong>原子检测</strong>。在 Update 时，通过 CAS (Compare-And-Swap) 或者检查版本号。如果 T2 写的时候发现版本已经变了（或者被 T1 锁住了），T2 必须 Abort（重试）。这是“乐观并发控制”的核心。</li></ul><h4 id="_2-写偏斜-write-skew-——-最隐蔽的杀手" tabindex="-1"><a class="header-anchor" href="#_2-写偏斜-write-skew-——-最隐蔽的杀手"><span>2. 写偏斜 (Write Skew) —— 最隐蔽的杀手</span></a></h4><ul><li><strong>现象</strong>：两个事务分别修改不同的对象，但破坏了这些对象之间的<strong>联合约束</strong>。</li><li><strong>例子</strong>：医院值班系统。约束是“至少要有一个医生值班”。现在 Alice 和 Bob 都在值班。 <ul><li>T1 (Alice): 查询当前值班人数 -&gt; 2人。没事，我可以请假。更新 Alice=不值班。</li><li>T2 (Bob): 查询当前值班人数 -&gt; 2人。没事，我可以请假。更新 Bob=不值班。</li><li>T1 提交。T2 提交。</li><li><strong>结果</strong>：没医生值班了！</li></ul></li><li><strong>为什么难搞</strong>：T1 改的是 Alice 的记录，T2 改的是 Bob 的记录。他们没有修改<strong>同一行</strong>，所以通常的行锁（Row Lock）或版本检测（Version Check）检测不到冲突。</li></ul><p>![[Pasted image 20251122163809.png]]<br> 对于每一个事务 都有一个开始时间戳 比如 T1在时间戳2开始 那么他只能看到 A2 B1 C2状态的元组<br> 对于每一个事务 还有一个提交时间戳 决定了事务的序列化顺序（单调递增）也可以唯一地标识已经提交的事务 比如版本链中ts = 3 就是代表事务3提交的时间<br> 在table heap中 <strong>维护一个版本链</strong></p><h3 id="几个概念" tabindex="-1"><a class="header-anchor" href="#几个概念"><span>几个概念</span></a></h3><h4 id="ts-timestamp-时间戳" tabindex="-1"><a class="header-anchor" href="#ts-timestamp-时间戳"><span><strong>TS (Timestamp / 时间戳)</strong></span></a></h4><ul><li><strong>是什么：</strong> 它不仅仅是时间，更像是一个逻辑上的“计数器”或“版本号”。</li><li><strong>作用：</strong> 用来标记数据的版本和事务的先后顺序。 <ul><li>0, 1, 2, 3... 随着事务的提交不断增加。</li></ul></li><li><strong>在事务中：</strong><ul><li>read_ts_ (读取时间戳)：事务开始时，系统当前的全局时间。事务只能看到这个时间点之前已经提交的数据（快照）。</li><li>commit_ts_ (提交时间戳)：事务结束并提交时，获取的一个新的、更大的时间戳。这标志着这个事务产生的新数据版本的“出生时间”。</li></ul></li></ul><h4 id="txn-transaction-事务" tabindex="-1"><a class="header-anchor" href="#txn-transaction-事务"><span><strong>Txn (Transaction / 事务)</strong></span></a></h4><ul><li><strong>是什么：</strong> 数据库操作的执行单元（比如 T1, T2）。</li><li><strong>结构：</strong> 每个 Txn 对象（Transaction 类）都包含： <ul><li>txn_id_: 唯一标识符。</li><li>read_ts_: 它的“视野”范围（我看的是几点钟的数据）。</li><li>commit_ts_: 它完成的时间（我把数据更新到了几点钟的版本）。</li><li>Undo Log: 用于回滚操作。</li></ul></li></ul><h4 id="watermark-水位线" tabindex="-1"><a class="header-anchor" href="#watermark-水位线"><span><strong>Watermark (水位线)</strong></span></a></h4><ul><li><strong>是什么：</strong> 它记录了<strong>当前所有正在运行的事务中，最小的 read_ts</strong>。</li><li><strong>作用：</strong> 它是<strong>垃圾回收（Garbage Collection, GC）</strong> 的依据。</li><li><strong>通俗理解：</strong> 想象大家都在看一本不断更新的历史书。 <ul><li>事务 A 在看第 100 页（read_ts=100）。</li><li>事务 B 在看第 105 页（read_ts=105）。</li><li>虽然现在书已经写到第 110 页了，但如果把第 100 页撕掉，事务 A 就没法读了。</li><li><strong>Watermark 就是 100</strong>。意思是：“第 100 页及以后的内容都有人在看，绝对不能删（不能回收旧版本）”。一旦事务 A 结束，Watermark 可能会变成 105，那么 100 到 104 之间的旧版本数据就可以被清理了。</li></ul></li></ul><h3 id="class-watermark" tabindex="-1"><a class="header-anchor" href="#class-watermark"><span>class watermark</span></a></h3><p>只有两个方法 一个是add 一个是 remove<br> 分别代表 某个在read_ts的事务开始了 那个在read_ts的事务结束了<br> 会对应在map里面记录在read_ts工作的事务有几个 如果最低的read_ts事务结束了 就提高watermark 告诉垃圾回收模块 之前的都可以回收了 因为目前所有事物的read_ts都大于等于这个时刻 所以之前的快照是没用的</p><h2 id="task2" tabindex="-1"><a class="header-anchor" href="#task2"><span>Task2</span></a></h2><p>BusTub 的存储方式是 <strong>&quot;Delta Storage&quot; (增量存储)</strong>。</p><ul><li><strong>Table Heap (堆表)</strong>：永远只存<strong>最新版本</strong>的数据（Base Tuple）</li><li><strong>Undo Log (回滚日志)</strong>：存储<strong>旧版本</strong>的数据（Delta）</li><li><strong>Version Chain (版本链)</strong>：通过链表将最新数据和旧版本日志连起来。</li></ul><p><strong>Task 2 的核心目标是：</strong> 实现“时间旅行”。<br> 既然堆表里只有“最新”的数据，如果一个老事务（Read Timestamp 较小）来读数据，它不能读最新的，它必须通过回滚日志，把数据“还原”成它那个时间点应该看到的样子</p><ol><li><p><strong>Tuple (In Table Heap)</strong></p><ul><li>这是完整的行数据。</li><li>包含 <strong>TupleMeta</strong>： <ul><li>ts_ (Timestamp): 这行数据是何时被提交的？或者被哪个活跃事务锁定的？</li><li>is_deleted_: 是否被删除了。</li></ul></li></ul></li><li><p><strong>UndoLink (The Pointer)</strong></p><ul><li>Table Heap 的每一行都有一个隐藏的指针（VersionUndoLink），指向最新的那条 Undo Log。</li><li>结构：{ prev_txn_: txn_id, prev_log_idx_: index }。这就像一个座标，告诉你在哪个事务的 Buffer 里，第几条日志是它的上一个版本。</li></ul></li><li><p><strong>Undo Log (The Delta)</strong></p><ul><li>存放在 TransactionManager (也就是事务的私有空间) 里，而不是堆表里。</li><li><strong>内容</strong>：它<strong>不是</strong>完整的 Tuple，它只包含<strong>被修改的字段</strong> (Partial Update)。</li><li><strong>结构</strong>： <ul><li>modified_fields_: 一个布尔数组，标记哪些列被修改了。</li><li>tuple_: 只有被修改列的值。</li><li>ts_: 这个旧版本原本的时间戳。</li></ul></li></ul></li></ol><h3 id="task-2-2" tabindex="-1"><a class="header-anchor" href="#task-2-2"><span>Task 2.2</span></a></h3><p>原来我们的顺序扫描执行器直接返回TableHeap中的对应RID位置的数据 但是由于READ TIMESTAMP隔离策略 堆表中的数据是最新的 可对于一个事务来说 他应该只能看到readts这个时刻的快照。 因此要返回task2.1实现的 根据undolog重建以后的tuple</p><p>TupleMeta.ts_ 是一个 int64_t（64位整数）。系统把这 64 位划分成了两个范围，通过一个巨大的常量 TXN_START_ID 来分割。<br> 可以把 ts_ 看作一个状态指示灯：</p><ul><li><strong>情况 A：已提交数据 (Committed)</strong><ul><li><strong>数值范围</strong>：0 到 TXN_START_ID - 1。</li><li><strong>含义</strong>：这是一个正常的<strong>时间戳</strong>（Read/Commit Timestamp）。</li><li><strong>解读</strong>：这行数据已经在时刻 ts_ 提交了，任何人只要读的时间戳 &gt;= ts_ 都能看到它。</li></ul></li><li><strong>情况 B：未提交数据 (Uncommitted / In-progress)</strong><ul><li><strong>数值范围</strong>：&gt;= TXN_START_ID。</li><li><strong>含义</strong>：这是一个<strong>事务 ID</strong>（加上了标志位）。</li><li><strong>解读</strong>：这行数据<strong>正在被</strong>某个活跃的事务修改，还没有提交！它是“脏”的。</li></ul></li></ul><p>TXN_START_ID 是 1 &lt;&lt; 62（或者类似的最高位标志）。<br> 当我们说 ts_ = TXN_START_ID + 5 时，意思是：</p><ul><li><strong>标志位</strong>（最高位）是 1 -&gt; 表示“正在被锁定/修改”。</li><li><strong>低位</strong> 是 5 -&gt; 表示“是被 <strong>Txn #5</strong> 锁定的”。</li></ul><p>这个任务中最重要的是重建tuple的逻辑 当我拿到一个table heap中的tuple的时候。发现他的timestamp更新一点 我就需要根据undolog去重现旧版本（read_ts）快照的时候这个tuple的样子 用于这个事务</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UndoLink</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  /* Previous version can be found in which txn */</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">  txn_id_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> prev_txn_{INVALID_TXN_ID};</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  /* The log index of the previous version in [prev_txn_](file:///root/bustub-private/src/include/concurrency/transaction.h#L58-L58) */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> prev_log_idx_{</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>其实这个结构非常简单 undolog是存放在txn自己的结构里的 一个vector 所以只需要记住前一个修改这个元组的事务是什么 并且存放在他的第几个undolog中 就可以还原这一个版本</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">struct</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> UndoLog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  /* Whether this log is a deletion marker */</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> is_deleted_;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  /* The fields modified by this undo log */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;bool&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> modified_fields_;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  /* The modified fields */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  Tuple tuple_;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  /* Timestamp of this undo log */</span></span>
<span class="line"><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">  timestamp_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ts_{INVALID_TS};</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  /* Undo log prev version */</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  UndoLink prev_version_{};</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // &lt;-- 这就是指向下一级的链接</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>对于一个UndoLog来说 他存放isdelete标记位 用于标记是否删除 这样在重建的时候 可以只修改这个标志位 可以看出 这个log里面包括了一个link结构 所以可以根据这个link 找到上一个修改这个元组的事务和他的undolog 最后直到遍历到isvalid是false 也就是 该undolog中的undolink记录的prev_txn == INVALID_TXN 的 代表我们完成了整个遍历过程</p><h2 id="一、数据库总架构" tabindex="-1"><a class="header-anchor" href="#一、数据库总架构"><span>一、数据库总架构</span></a></h2><p>BusTub是一个模块化的关系型数据库管理系统，采用分层设计架构，主要包含以下核心组件：</p><h3 id="_1-前端处理层" tabindex="-1"><a class="header-anchor" href="#_1-前端处理层"><span>1. 前端处理层</span></a></h3><ul><li><strong>Binder</strong>：负责SQL语句的解析和绑定，将SQL文本转换为抽象语法树(AST)</li><li><strong>Planner</strong>：基于AST生成初始查询执行计划</li><li><strong>Optimizer</strong>：对查询计划进行优化，生成最优执行计划</li></ul><h3 id="_2-执行引擎层" tabindex="-1"><a class="header-anchor" href="#_2-执行引擎层"><span>2. 执行引擎层</span></a></h3><ul><li><strong>Execution</strong>：执行优化后的查询计划，协调各组件完成数据操作</li><li><strong>Concurrency</strong>：提供并发控制机制，确保事务的ACID特性</li><li><strong>Recovery</strong>：实现事务恢复机制，保证系统故障时的数据一致性</li></ul><h3 id="_3-存储引擎层" tabindex="-1"><a class="header-anchor" href="#_3-存储引擎层"><span>3. 存储引擎层</span></a></h3><ul><li><strong>Storage</strong>：负责数据的物理存储和访问 <ul><li><strong>Table</strong>：表结构的实现，包括TableHeap和Tuple</li><li><strong>Index</strong>：索引结构的实现，如B+树索引、哈希表索引等</li></ul></li><li><strong>Buffer</strong>：缓冲池管理器，减少磁盘I/O，提高系统性能</li><li><strong>Catalog</strong>：元数据管理器，负责表和索引的创建、查找和管理</li></ul><h3 id="_4-基础组件层" tabindex="-1"><a class="header-anchor" href="#_4-基础组件层"><span>4. 基础组件层</span></a></h3><ul><li><strong>Common</strong>：通用工具和配置</li><li><strong>Type</strong>：数据类型系统</li><li><strong>Container</strong>：容器类实现</li><li><strong>Page</strong>：页面管理，包括表页面、索引页面等</li></ul><h2 id="二、sql执行流程" tabindex="-1"><a class="header-anchor" href="#二、sql执行流程"><span>二、SQL执行流程</span></a></h2><p>SQL语句在BusTub中的执行遵循以下步骤：</p><h3 id="_1-sql解析与绑定-binder" tabindex="-1"><a class="header-anchor" href="#_1-sql解析与绑定-binder"><span>1. SQL解析与绑定 (Binder)</span></a></h3><ul><li>接收用户输入的SQL语句</li><li>进行词法分析和语法分析，生成抽象语法树(AST)</li><li>绑定表、列等元数据信息到AST节点</li><li>进行语义检查，确保SQL语句的合法性</li></ul><h3 id="_2-查询计划生成-planner" tabindex="-1"><a class="header-anchor" href="#_2-查询计划生成-planner"><span>2. 查询计划生成 (Planner)</span></a></h3><ul><li>基于绑定后的AST生成初始查询执行计划</li><li>将SQL操作转换为一系列可执行的操作符，如扫描、连接、聚合等</li><li>构建操作符树，表示操作的执行顺序和依赖关系</li></ul><h3 id="_3-查询优化-optimizer" tabindex="-1"><a class="header-anchor" href="#_3-查询优化-optimizer"><span>3. 查询优化 (Optimizer)</span></a></h3><ul><li>对初始查询计划进行优化，生成最优执行计划</li><li>考虑多种执行策略，如全表扫描 vs 索引扫描</li><li>优化连接顺序和连接算法</li><li>应用谓词下推等优化技术</li></ul><h3 id="_4-执行计划执行-execution" tabindex="-1"><a class="header-anchor" href="#_4-执行计划执行-execution"><span>4. 执行计划执行 (Execution)</span></a></h3><ul><li>按照优化后的执行计划执行操作</li><li>调用存储引擎层的接口访问数据</li><li>处理并发控制和事务管理</li><li>收集执行结果并返回给用户</li></ul><h3 id="_5-数据访问-storage" tabindex="-1"><a class="header-anchor" href="#_5-数据访问-storage"><span>5. 数据访问 (Storage)</span></a></h3><ul><li>执行实际的数据读写操作</li><li>利用缓冲池减少磁盘I/O</li><li>管理数据的物理存储结构</li><li>维护索引结构，加速数据查找</li></ul><h2 id="三、catalog、table、tableheap的关系" tabindex="-1"><a class="header-anchor" href="#三、catalog、table、tableheap的关系"><span>三、Catalog、Table、TableHeap的关系</span></a></h2><h3 id="_1-catalog" tabindex="-1"><a class="header-anchor" href="#_1-catalog"><span>1. Catalog</span></a></h3><ul><li><strong>作用</strong>：作为元数据管理器，负责表和索引的创建、查找和管理</li><li><strong>核心数据结构</strong>： <ul><li><code>tables_</code>：映射表OID到TableInfo</li><li><code>table_names_</code>：映射表名到表OID</li><li><code>indexes_</code>：映射索引OID到IndexInfo</li><li><code>index_names_</code>：映射表名和索引名到索引OID</li></ul></li><li><strong>核心方法</strong>： <ul><li><code>CreateTable</code>：创建新表并返回表元数据</li><li><code>GetTable</code>：根据表名或OID获取表元数据</li><li><code>CreateIndex</code>：创建新索引并返回索引元数据</li><li><code>GetIndex</code>：获取索引元数据</li></ul></li></ul><h3 id="_2-tableinfo" tabindex="-1"><a class="header-anchor" href="#_2-tableinfo"><span>2. TableInfo</span></a></h3><ul><li><strong>作用</strong>：维护表的元数据信息</li><li><strong>核心成员</strong>： <ul><li><code>schema_</code>：表的模式定义</li><li><code>name_</code>：表名</li><li><code>table_</code>：指向TableHeap的唯一指针</li><li><code>oid_</code>：表的唯一标识符</li></ul></li></ul><h3 id="_3-tableheap" tabindex="-1"><a class="header-anchor" href="#_3-tableheap"><span>3. TableHeap</span></a></h3><ul><li><strong>作用</strong>：表示磁盘上的物理表，管理实际的数据存储</li><li><strong>结构</strong>： <ul><li>是一个双向链表结构的页面集合</li><li>每个页面是一个TablePage实例</li><li>管理表的所有元组数据</li></ul></li><li><strong>核心方法</strong>： <ul><li><code>InsertTuple</code>：插入新元组</li><li><code>UpdateTuple</code>：更新元组</li><li><code>GetTuple</code>：读取元组</li><li><code>MakeIterator</code>：创建表迭代器</li></ul></li></ul><h3 id="_4-关系总结" tabindex="-1"><a class="header-anchor" href="#_4-关系总结"><span>4. 关系总结</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>Catalog → TableInfo → TableHeap → TablePage → Tuple</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>Catalog管理多个TableInfo</li><li>每个TableInfo对应一个TableHeap</li><li>每个TableHeap包含多个TablePage</li><li>每个TablePage存储多个Tuple</li></ul><h2 id="四、数据在内存中的组织-slot模型" tabindex="-1"><a class="header-anchor" href="#四、数据在内存中的组织-slot模型"><span>四、数据在内存中的组织：Slot模型</span></a></h2><p>BusTub采用<strong>Slotted Page</strong>（槽式页面）模型来组织内存中的数据，具体结构如下：</p><h3 id="_1-页面布局" tabindex="-1"><a class="header-anchor" href="#_1-页面布局"><span>1. 页面布局</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>---------------------------------------------------------</span></span>
<span class="line"><span>| HEADER | ... FREE SPACE ... | ... INSERTED TUPLES ... |</span></span>
<span class="line"><span>---------------------------------------------------------</span></span>
<span class="line"><span>                              ^</span></span>
<span class="line"><span>                              free space pointer</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-头部结构-8字节" tabindex="-1"><a class="header-anchor" href="#_2-头部结构-8字节"><span>2. 头部结构 (8字节)</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>----------------------------------------------------------------------------</span></span>
<span class="line"><span>| NextPageId (4)| NumTuples(2) | NumDeletedTuples(2) |</span></span>
<span class="line"><span>----------------------------------------------------------------------------</span></span>
<span class="line"><span>----------------------------------------------------------------</span></span>
<span class="line"><span>| Tuple_1 offset+size (4) | Tuple_2 offset+size (4) | ... |</span></span>
<span class="line"><span>----------------------------------------------------------------</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_3-元组格式" tabindex="-1"><a class="header-anchor" href="#_3-元组格式"><span>3. 元组格式</span></a></h3><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>| meta | data |</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><strong>meta</strong>：元组的元数据，如可见性、删除标记等</li><li><strong>data</strong>：元组的实际数据</li></ul><h3 id="_4-slot模型特点" tabindex="-1"><a class="header-anchor" href="#_4-slot模型特点"><span>4. Slot模型特点</span></a></h3><ul><li><strong>动态空间管理</strong>：通过free space pointer管理页面中的自由空间</li><li><strong>高效元组访问</strong>：通过元组信息数组快速定位元组位置</li><li><strong>支持可变长度元组</strong>：每个元组的大小可以不同</li><li><strong>处理元组删除</strong>：通过标记删除，而非立即回收空间</li><li><strong>空间复用</strong>：删除的元组空间可以被新元组复用</li></ul><h3 id="_5-元组操作" tabindex="-1"><a class="header-anchor" href="#_5-元组操作"><span>5. 元组操作</span></a></h3><ul><li><strong>插入</strong>：从页面尾部向前分配空间，更新元组信息数组</li><li><strong>读取</strong>：根据RID（记录标识符）定位到页面和槽位，读取元组数据</li><li><strong>更新</strong>：可以原地更新（如果空间足够）或删除后插入新位置</li><li><strong>删除</strong>：标记元组为删除状态，更新NumDeletedTuples计数</li></ul><h2 id="五、执行流程示例" tabindex="-1"><a class="header-anchor" href="#五、执行流程示例"><span>五、执行流程示例</span></a></h2><p>以一个简单的SQL查询为例，展示其执行流程：</p><ol><li><p><strong>SQL语句</strong>：<code>SELECT * FROM students WHERE id = 100;</code></p></li><li><p><strong>解析与绑定</strong>：</p><ul><li>Binder解析SQL，生成AST</li><li>绑定students表和id列的元数据</li></ul></li><li><p><strong>计划生成</strong>：</p><ul><li>Planner生成初始计划：全表扫描students表，过滤id=100的记录</li></ul></li><li><p><strong>优化</strong>：</p><ul><li>Optimizer发现id列有索引，将计划优化为：使用索引查找id=100的记录</li></ul></li><li><p><strong>执行</strong>：</p><ul><li>Execution执行优化后的计划</li><li>通过Catalog获取students表的TableInfo</li><li>通过TableInfo获取TableHeap</li><li>使用索引定位到id=100的元组所在的页面和槽位</li><li>从TablePage中读取元组数据</li><li>返回查询结果给用户</li></ul></li></ol><h1 id="火山模型执行器" tabindex="-1"><a class="header-anchor" href="#火山模型执行器"><span>火山模型执行器</span></a></h1><p>火山模型（Volcano Model），也被称为<strong>迭代器模型（Iterator Model）</strong> 或<strong>管线模型（Pipeline Model）</strong>，是数据库执行引擎中最经典的模型。</p><p>理解火山模型，最核心的一句话是：<strong>“自顶向下调用，自底向上返回。”</strong></p><hr><h3 id="_1-核心概念-树状结构" tabindex="-1"><a class="header-anchor" href="#_1-核心概念-树状结构"><span>1. 核心概念：树状结构</span></a></h3><p>在一个 SQL 查询中，执行器会被组织成一棵树（Plan Tree）。</p><ul><li><strong>叶子节点</strong>：通常是数据源，比如 <code>SeqScanExecutor</code>（全表扫描）。</li><li><strong>中间节点</strong>：处理逻辑，比如 <code>FilterExecutor</code>（过滤）、<code>JoinExecutor</code>（连接）。</li><li><strong>根节点</strong>：最上层的执行器。</li></ul><p>每个执行器都必须实现两个核心接口：<code>Init()</code> 和 <code>Next()</code>。</p><hr><h3 id="_2-详解-init-准备工作" tabindex="-1"><a class="header-anchor" href="#_2-详解-init-准备工作"><span>2. 详解 <code>Init()</code>：准备工作</span></a></h3><p><code>Init()</code> 相当于 <strong>“铺设管道”</strong>。在正式开始拉取数据前，所有的初始化工作都在这里完成。</p><p>在代码中：</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> SeqScanExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 1. 从 Catalog（元数据管理器）获取表的信息</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> table_oid </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetTableOid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  table_info_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> exec_ctx_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetCatalog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetTable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(table_oid);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 2. 初始化迭代器：把“指针”指向表的开头</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  table_iterator_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make_shared</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">TableIterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">table_info_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">table_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">MakeIterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>重点：</strong> <code>Init()</code> 只执行一次。它并不读取实际的数据行，只是把扫描器摆在表的起始位置，准备开始。</p><hr><h3 id="_3-详解-next-单行处理" tabindex="-1"><a class="header-anchor" href="#_3-详解-next-单行处理"><span>3. 详解 <code>Next()</code>：单行处理</span></a></h3><p><code>Next()</code> 是火山模型的灵魂。它的规则是：<strong>每次被调用，只返回一行数据（Tuple）。</strong></p><p>如果父节点需要 100 行数据，它就会调用子节点的 <code>Next()</code> 100 次。</p><p>在<code>SeqScanExecutor::Next</code> 代码中，逻辑如下：</p><ol><li><strong>循环查找</strong>：<code>while (!table_iterator_-&gt;IsEnd())</code>。</li><li><strong>多版本并发控制 (MVCC) 处理</strong>： <ul><li>数据库不一定直接读原始数据。由于事务的存在，代码里有复杂的 <code>GetTupleAndUndoLink</code> 和 <code>ReconstructTuple</code>。</li><li>它在判断：<strong>“当前事务是否有权看到这一行数据？”</strong>。</li><li>如果数据是别人正在修改的（不可见），它会通过 <code>UndoLog</code> 重构出旧版本的数据。</li></ul></li><li><strong>谓词过滤（Filter Predicate）</strong>：<div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">filter_predicate_</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nullptr</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">filter_predicate_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Evaluate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(...)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> res_tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // 找到了符合条件的一行，立即返回</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><strong>移动指针</strong>：<code>++(*table_iterator_)</code>。</li></ol><p><strong>为什么 <code>Next</code> 里面有个 <code>while</code> 循环？</strong><br> 因为当前行可能被删除、不可见、或者不符合 <code>WHERE</code> 条件。如果当前行不合适，<code>Next</code> 不能直接返回 <code>false</code>，它必须继续往后找，直到找到第一行符合要求的记录并返回 <code>true</code>，或者直到表结束返回 <code>false</code>。</p><hr><h3 id="_4-整个执行流程是怎么跑起来的" tabindex="-1"><a class="header-anchor" href="#_4-整个执行流程是怎么跑起来的"><span>4. 整个执行流程是怎么跑起来的？</span></a></h3><p>假设有一个查询：<code>SELECT name FROM users WHERE age &gt; 18 LIMIT 2;</code></p><p>执行器树长这样：<br><code>LimitExecutor</code> -&gt; <code>ProjectionExecutor</code> -&gt; <code>FilterExecutor</code> -&gt; <code>SeqScanExecutor</code></p><p><strong>执行顺序：</strong></p><ol><li><p><strong>Init 阶段（自顶向下）</strong>：</p><ul><li><code>Limit</code> 调用 <code>Projection</code> 的 <code>Init</code>。</li><li><code>Projection</code> 调用 <code>Filter</code> 的 <code>Init</code>。</li><li><code>Filter</code> 调用 <code>SeqScan</code> 的 <code>Init</code>。</li><li>此时，所有执行器都准备好了，<code>SeqScan</code> 的迭代器指向了表的第一行。</li></ul></li><li><p><strong>Next 阶段（数据流自底向上）</strong>：</p><ul><li><code>Limit</code> 向 <code>Projection</code> 要一行数据。</li><li><code>Projection</code> 向 <code>Filter</code> 要一行数据。</li><li><code>Filter</code> 向 <code>SeqScan</code> 要一行数据。</li><li><code>SeqScan</code> 从磁盘/内存读出 <strong>Row 1</strong>，交给 <code>Filter</code>。</li><li><code>Filter</code> 检查 <code>age &gt; 18</code>： <ul><li>如果不符合，<code>Filter</code> 会再次调用 <code>SeqScan.Next()</code> 获取 <strong>Row 2</strong>。</li><li>如果符合，返回给 <code>Projection</code>。</li></ul></li><li><code>Projection</code> 裁剪掉不需要的列，只留 <code>name</code>，返回给 <code>Limit</code>。</li><li><code>Limit</code> 计数 +1。</li></ul></li><li><p><strong>循环</strong>：</p><ul><li><code>Limit</code> 发现还没攒够 2 行，于是重复上述过程。</li><li>一旦 <code>Limit</code> 拿到了 2 行，它在下一次被调用时会直接返回 <code>false</code>，整棵树停止运行。</li></ul></li></ol><hr><h3 id="_5-火山模型的优缺点" tabindex="-1"><a class="header-anchor" href="#_5-火山模型的优缺点"><span>5. 火山模型的优缺点</span></a></h3><p><strong>优点：</strong></p><ol><li><strong>内存占用低</strong>：内存里通常只存一行数据。即使表有 100G，也可以一行行处理。</li><li><strong>灵活性高</strong>：每个执行器只关心自己的逻辑（Filter 只管过滤，Limit 只管计数），互相解耦。</li><li><strong>支持流式处理</strong>：不需要等所有数据处理完就可以开始产生结果。</li></ol><p><strong>缺点（BusTub 中可能会遇到的）：</strong></p><ol><li><strong>虚函数调用开销</strong>：每一行数据都要触发多次 <code>Next()</code> 虚函数调用。对于简单查询，这种开销占 CPU 的很大比例。</li><li><strong>CPU 缓存不友好</strong>：每次只处理一行，无法利用 CPU 的 SIMD 指令或高速缓存预取。</li></ol><h2 id="具体执行器实现" tabindex="-1"><a class="header-anchor" href="#具体执行器实现"><span>具体执行器实现</span></a></h2><h3 id="_1-顺序扫描执行器-seqscanexecutor" tabindex="-1"><a class="header-anchor" href="#_1-顺序扫描执行器-seqscanexecutor"><span>1. 顺序扫描执行器 (SeqScanExecutor)</span></a></h3><h4 id="init方法" tabindex="-1"><a class="header-anchor" href="#init方法"><span>Init方法</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> SeqScanExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> table_oid </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetTableOid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  table_info_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> exec_ctx_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetCatalog</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetTable</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(table_oid);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (table_info_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nullptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    throw</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Exception</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(ExceptionType::INVALID, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;table_oid is invalid&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  table_iterator_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make_shared</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">TableIterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">table_info_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">table_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">MakeIterator</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>功能</strong>：</p><ul><li>获取表的OID</li><li>从Catalog中获取表信息</li><li>初始化表迭代器，准备遍历表中的元组</li></ul><h4 id="next方法" tabindex="-1"><a class="header-anchor" href="#next方法"><span>Next方法</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> SeqScanExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Tuple</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RID</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">txn </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> exec_ctx_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetTransaction</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">txn_mgr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> exec_ctx_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetTransactionManager</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> read_ts </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> txn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetReadTs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">table_iterator_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">IsEnd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> rid_val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> table_iterator_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetRID</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [meta, tpl, undo_link] </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GetTupleAndUndoLink</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(txn_mgr, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">table_info_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">table_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), rid_val);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    std::optional</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Tuple</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> res_tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::nullopt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> is_own_modification </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">meta</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ts_</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &gt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> TXN_START_ID </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">meta</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ts_</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> ^</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> TXN_START_ID) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> txn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetTransactionId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">meta</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ts_</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> read_ts </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">||</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> is_own_modification) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">meta</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">is_deleted_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        res_tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> tpl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        res_tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::nullopt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> undo_logs </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> CollectUndoLogs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">table_iterator_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetRID</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(), meta, tpl, undo_link, txn, txn_mgr);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">undo_logs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">has_value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        res_tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ReconstructTuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">table_info_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">schema_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, tpl, meta, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">undo_logs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        res_tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::nullopt;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    ++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">table_iterator_);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">res_tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">has_value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">filter_predicate_</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> ==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nullptr</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> ||</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">          plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">filter_predicate_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Evaluate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">res_tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()), </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">table_info_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">schema_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">).</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">GetAs</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;bool&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> res_tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">rid </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> rid_val;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>功能</strong>：</p><ul><li>获取当前事务和事务管理器</li><li>遍历表中的元组，直到找到符合条件的元组或遍历结束</li><li>处理事务可见性，确保只返回符合隔离级别的元组</li><li>应用过滤条件（如果有）</li><li>返回符合条件的元组和RID</li></ul><h3 id="_2-过滤执行器-filterexecutor" tabindex="-1"><a class="header-anchor" href="#_2-过滤执行器-filterexecutor"><span>2. 过滤执行器 (FilterExecutor)</span></a></h3><h4 id="init方法-1" tabindex="-1"><a class="header-anchor" href="#init方法-1"><span>Init方法</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> FilterExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Initialize the child executor</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  child_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>功能</strong>：</p><ul><li>初始化子执行器</li></ul><h4 id="next方法-1" tabindex="-1"><a class="header-anchor" href="#next方法-1"><span>Next方法</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> FilterExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Tuple</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RID</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> filter_expr </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetPredicate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Get the next tuple</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> status </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> child_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(tuple, rid);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">status) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> value </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> filter_expr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Evaluate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(tuple, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">child_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">IsNull</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">GetAs</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;bool&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>功能</strong>：</p><ul><li>从子执行器获取元组</li><li>应用过滤条件</li><li>只返回满足过滤条件的元组</li></ul><h3 id="_3-投影执行器-projectionexecutor" tabindex="-1"><a class="header-anchor" href="#_3-投影执行器-projectionexecutor"><span>3. 投影执行器 (ProjectionExecutor)</span></a></h3><h4 id="init方法-2" tabindex="-1"><a class="header-anchor" href="#init方法-2"><span>Init方法</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> ProjectionExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Initialize the child executor</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  child_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>功能</strong>：</p><ul><li>初始化子执行器</li></ul><h4 id="next方法-2" tabindex="-1"><a class="header-anchor" href="#next方法-2"><span>Next方法</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> ProjectionExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Tuple</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RID</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  Tuple child_tuple{};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Get the next tuple</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> status </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> child_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">child_tuple, rid);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">status) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Compute expressions</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> values{};</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">reserve</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetColumnCount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">expr : </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetExpressions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">expr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Evaluate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">child_tuple, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">child_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Tuple{values, </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>功能</strong>：</p><ul><li>从子执行器获取元组</li><li>计算投影表达式的值</li><li>构建并返回投影后的新元组</li></ul><h3 id="_4-哈希连接执行器-hashjoinexecutor" tabindex="-1"><a class="header-anchor" href="#_4-哈希连接执行器-hashjoinexecutor"><span>4. 哈希连接执行器 (HashJoinExecutor)</span></a></h3><h4 id="init方法-3" tabindex="-1"><a class="header-anchor" href="#init方法-3"><span>Init方法</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> HashJoinExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  left_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  right_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Build phase: read left table and build hash table</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  Tuple tuple;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  RID rid;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">left_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple, </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">rid)) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Calculate join key</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> values;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">expr : </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">LeftJoinKeyExpressions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">      values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">expr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Evaluate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">left_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    AggregateKey join_key{values};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Insert into hash table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">ht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">find</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(join_key) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">      ht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">insert</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">({join_key, std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">vector</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;()});</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    ht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[join_key].</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(tuple);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Reset state</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  current_right_tuple_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nullptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  right_idx_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  left_idx_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  left_ht_iterator_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">begin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  left_unmatched_idx_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>功能</strong>：</p><ul><li>初始化左右子执行器</li><li><strong>构建哈希表</strong>：遍历左表所有元组，计算连接键，插入哈希表</li><li>重置状态变量</li></ul><h4 id="next方法-3" tabindex="-1"><a class="header-anchor" href="#next方法-3"><span>Next方法</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> HashJoinExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Tuple</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RID</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Schema </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">left_schema </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">left_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Schema </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">right_schema </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">right_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Schema </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">output_schema </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // If we&#39;re currently processing a right tuple</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (current_right_tuple_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nullptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // Compute right table join key</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> values;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">expr : </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">RightJoinKeyExpressions</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">expr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Evaluate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(current_right_tuple_, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">right_schema));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      AggregateKey join_key{values};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // Look for matching entries in hash table</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> it </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">find</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(join_key);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (it </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Tuple</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">left_tuples </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> it</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // Still have unprocessed left tuples</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (left_idx_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> left_tuples</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">left_tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> left_tuples</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[left_idx_];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // Mark left tuple as matched (for LEFT JOIN)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetJoinType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> JoinType::LEFT) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            matched_left_tuples_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">insert</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">left_tuple);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // Construct output tuple</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> output_values;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> left_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetColumnCount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            output_values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">left_tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(left_schema, i));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> right_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetColumnCount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">            output_values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">current_right_tuple_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(right_schema, i));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(output_values, output_schema);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          left_idx_</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      } </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetJoinType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> JoinType::LEFT) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // For LEFT JOIN, when there&#39;s no matching left tuple, we skip this right tuple</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        current_right_tuple_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nullptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        left_idx_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // Done processing current right tuple</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      current_right_tuple_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> nullptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      left_idx_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Get next right table tuple</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    Tuple new_tuple;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    RID new_rid;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">right_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">new_tuple, </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">new_rid)) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // Right table fully processed</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // For left join, process unmatched left tuples</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetJoinType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> JoinType::LEFT) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // Iterate through all hash table entries</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (left_ht_iterator_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Tuple</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">left_tuples </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> left_ht_iterator_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // Iterate through all left tuples for this key</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (left_unmatched_idx_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> left_tuples</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> Tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">left_tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> left_tuples</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[left_unmatched_idx_];</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">            if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">matched_left_tuples_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">find</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">left_tuple) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> matched_left_tuples_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">end</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">              std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> output_values;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">              for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> left_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetColumnCount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                output_values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">left_tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(left_schema, i));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">              }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">              for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">uint32_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> right_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetColumnCount</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">                output_values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">ValueFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetNullValueByType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">right_schema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetColumn</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(i).</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()));</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">              }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">              *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(output_values, output_schema);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">              left_unmatched_idx_</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">              return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">            left_unmatched_idx_</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">          ++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">left_ht_iterator_;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">          left_unmatched_idx_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">      }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">      return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // Process the new right tuple</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    right_tuple_buffer_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(new_tuple);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    current_right_tuple_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">right_tuple_buffer_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    right_idx_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> right_tuple_buffer_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">size</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    left_idx_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>功能</strong>：</p><ul><li><strong>探测阶段</strong>：遍历右表元组，计算连接键，在哈希表中查找匹配项</li><li>构建连接后的元组</li><li>处理左外连接的情况，返回未匹配的左表元组</li></ul><h3 id="_5-聚合执行器-aggregationexecutor" tabindex="-1"><a class="header-anchor" href="#_5-聚合执行器-aggregationexecutor"><span>5. 聚合执行器 (AggregationExecutor)</span></a></h3><h4 id="init方法-4" tabindex="-1"><a class="header-anchor" href="#init方法-4"><span>Init方法</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> AggregationExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  child_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Init</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Clear the hash table before re-populating</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">  aht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Clear</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> has_result </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Build the aggregation hash table</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  Tuple tuple;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  RID rid;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  while</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">child_executor_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple, </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">rid)) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> agg_key </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> MakeAggregateKey</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> agg_val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> MakeAggregateValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    aht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">InsertCombine</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(agg_key, agg_val);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    has_result </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // Handle special case for empty input</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // If there is no group by and no data, we need to add a default aggregation result</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">has_result </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> plan_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetGroupBys</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">().</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">empty</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    aht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">InsertDefaultAggregation</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  aht_iterator_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> aht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Begin</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>功能</strong>：</p><ul><li>初始化子执行器</li><li>清空并重新构建聚合哈希表</li><li>处理空输入的特殊情况</li><li>初始化聚合结果迭代器</li></ul><h4 id="next方法-4" tabindex="-1"><a class="header-anchor" href="#next方法-4"><span>Next方法</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> AggregationExecutor</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Next</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Tuple</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RID</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rid</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 检查是否还有聚合结果</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (aht_iterator_ </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">==</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> aht_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">End</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 构造结果元组</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Value</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> values;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 添加GROUP BY列的值</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">agg_key </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> aht_iterator_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">key_val : </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">agg_key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">group_bys_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(key_val);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 添加聚合列的值</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">agg_val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> aht_iterator_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">val : </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">agg_val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">aggregates_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">    values</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">push_back</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(val);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  *</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">tuple </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> Tuple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(values, </span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetOutputSchema</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">());</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  ++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">aht_iterator_;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>功能</strong>：</p><ul><li>遍历聚合哈希表中的结果</li><li>构建并返回聚合后的元组</li></ul><h1 id="执行优化器" tabindex="-1"><a class="header-anchor" href="#执行优化器"><span>执行优化器</span></a></h1><h3 id="_1-投影合并优化-optimizemergeprojection" tabindex="-1"><a class="header-anchor" href="#_1-投影合并优化-optimizemergeprojection"><span>1.投影合并优化 (OptimizeMergeProjection)</span></a></h3><ul><li>工作原理 ：合并连续的、执行相同投影操作的投影节点</li><li>优化条件 ：列类型相同，投影表达式为直接列引用</li><li>应用场景 ： SELECT * 查询、重命名列的查询</li></ul><h3 id="_2-过滤条件合并到嵌套循环连接-optimizemergefilternlj" tabindex="-1"><a class="header-anchor" href="#_2-过滤条件合并到嵌套循环连接-optimizemergefilternlj"><span>2. 过滤条件合并到嵌套循环连接 (OptimizeMergeFilterNLJ)</span></a></h3><ul><li>工作原理 ：将过滤条件合并到嵌套循环连接中</li><li>优化条件 ：过滤节点的子节点是嵌套循环连接，且连接谓词为恒真</li><li>应用场景 ：交叉连接后跟随过滤的查询</li></ul><h3 id="_3-嵌套循环连接转哈希连接-optimizenljashashjoin" tabindex="-1"><a class="header-anchor" href="#_3-嵌套循环连接转哈希连接-optimizenljashashjoin"><span>3. 嵌套循环连接转哈希连接 (OptimizeNLJAsHashJoin)</span></a></h3><ul><li>工作原理 ：将嵌套循环连接转换为哈希连接</li><li>优化条件 ：连接类型为INNER或LEFT，存在等值连接条件</li><li>应用场景 ：等值连接查询</li></ul><h3 id="_4-嵌套循环连接转索引连接-optimizenljasindexjoin" tabindex="-1"><a class="header-anchor" href="#_4-嵌套循环连接转索引连接-optimizenljasindexjoin"><span>4. 嵌套循环连接转索引连接 (OptimizeNLJAsIndexJoin)</span></a></h3><ul><li>工作原理 ：利用索引加速连接操作</li><li>优化条件 ：连接条件为等值比较，右表有索引</li><li>应用场景 ：连接列上有索引的查询</li></ul><h3 id="_5-消除恒真过滤条件-optimizeeliminatetruefilter" tabindex="-1"><a class="header-anchor" href="#_5-消除恒真过滤条件-optimizeeliminatetruefilter"><span>5. 消除恒真过滤条件 (OptimizeEliminateTrueFilter)</span></a></h3><ul><li>工作原理 ：移除总是为真的过滤条件</li><li>优化条件 ：过滤条件为恒真（如 1=1 ）</li><li>应用场景 ：包含冗余条件的查询</li></ul><h3 id="_6-过滤条件合并到扫描操作-optimizemergefilterscan" tabindex="-1"><a class="header-anchor" href="#_6-过滤条件合并到扫描操作-optimizemergefilterscan"><span>6. 过滤条件合并到扫描操作 (OptimizeMergeFilterScan)</span></a></h3><ul><li>工作原理 ：将过滤条件合并到顺序扫描中</li><li>优化条件 ：过滤节点的子节点是顺序扫描，且无过滤条件</li><li>应用场景 ：带WHERE子句的查询</li></ul><h3 id="_7-排序操作转索引扫描-optimizeorderbyasindexscan" tabindex="-1"><a class="header-anchor" href="#_7-排序操作转索引扫描-optimizeorderbyasindexscan"><span>7. 排序操作转索引扫描 (OptimizeOrderByAsIndexScan)</span></a></h3><ul><li>工作原理 ：利用索引的有序性避免显式排序</li><li>优化条件 ：排序为升序，排序列上有索引</li><li>应用场景 ：带ORDER BY子句的查询</li></ul><h3 id="_8-顺序扫描转索引扫描-optimizeseqscanasindexscan" tabindex="-1"><a class="header-anchor" href="#_8-顺序扫描转索引扫描-optimizeseqscanasindexscan"><span>8. 顺序扫描转索引扫描 (OptimizeSeqScanAsIndexScan)</span></a></h3><ul><li>工作原理 ：利用索引加速等值查询</li><li>优化条件 ：存在等值过滤条件，对应列有索引</li><li>应用场景 ：带等值条件的查询</li></ul><h3 id="_9-列剪枝优化-optimizecolumnpruning" tabindex="-1"><a class="header-anchor" href="#_9-列剪枝优化-optimizecolumnpruning"><span>9. 列剪枝优化 (OptimizeColumnPruning)</span></a></h3><ul><li>工作原理 ：移除不需要的列，减少数据传输</li><li>优化条件 ：执行计划中包含投影节点</li><li>应用场景 ：只需要部分列的查询</li></ul><h3 id="_10-排序-限制转topn优化-optimizesortlimitastopn" tabindex="-1"><a class="header-anchor" href="#_10-排序-限制转topn优化-optimizesortlimitastopn"><span>10. 排序+限制转TopN优化 (OptimizeSortLimitAsTopN)</span></a></h3><ul><li>工作原理 ：将排序+限制转换为TopN操作</li><li>优化条件 ：限制节点的子节点是排序节点</li><li>应用场景 ：带ORDER BY和LIMIT的查询</li></ul></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/yedou37/yedou37.github.io/edit/main/src/courses/15445.md" aria-label="在 GitHub 上编辑此页" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在 GitHub 上编辑此页<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">最近更新: </span><time class="vp-meta-info" datetime="2026-02-14T13:24:43.000Z" data-allow-mismatch>2026/2/14 13:24</time></div><div class="contributors"><span class="vp-meta-label">贡献者: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 137401103+yedou37@users.noreply.github.com">yedou37</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><!----><a class="route-link auto-link next" href="/courses/CS144.html" aria-label="CS144计算机网络"><div class="hint">下一页<span class="arrow end"></span></div><div class="link">CS144计算机网络<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">记录面试复习 & 课程大作业</div><div class="vp-copyright">Copyright © 2026 yedou </div></footer></div><!--]--><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-TutfwjEZ.js" defer></script>
  </body>
</html>
