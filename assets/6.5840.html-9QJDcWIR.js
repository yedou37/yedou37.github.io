import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,b as n,o as l}from"./app-FKoXLo0T.js";const e={};function t(p,s){return l(),a("div",null,[...s[0]||(s[0]=[n(`<hr><h1 id="mapreduce" tabindex="-1"><a class="header-anchor" href="#mapreduce"><span>MapReduce</span></a></h1><p>要把大象装冰箱（处理 PB 级数据），分三步：</p><ol><li><strong>Split (切分):</strong> 把大文件切成无数个 64MB 的小块 (Input Splits)。</li><li><strong>Map (映射):</strong> 把小块转化成 &lt;Key, Value&gt; 对。</li><li><strong>Reduce (归约):</strong> 把相同 Key 的数据聚在一起处理。</li></ol><ul><li><p><strong>场景：</strong> 统计单词频率 (Word Count)。</p></li><li><p><strong>Map 阶段：</strong></p><ul><li>Worker A 读文件 1，发现 &quot;Apple&quot;，输出 &lt;Apple, 1&gt;。</li><li>Worker B 读文件 2，发现 &quot;Apple&quot;，输出 &lt;Apple, 1&gt;。</li><li><strong>问题：</strong> 这两个 &lt;Apple, 1&gt; 分散在不同机器上，Reduce 怎么求和？</li></ul></li><li><p><strong>Partitioning (分区):</strong></p><ul><li>系统预先规定：hash(&quot;Apple&quot;) % nReduce。假设结果是 0。</li><li>所有 Worker 都知道：只要遇到 &quot;Apple&quot;，就扔进 <strong>0 号桶</strong>。</li><li>只要遇到 &quot;Banana&quot;，就扔进 <strong>1 号桶</strong>。</li></ul></li><li><p><strong>Shuffle 阶段：</strong></p><ul><li>Reduce Worker 0 启动时，它会去<strong>所有</strong> Map Worker 那里，把 <strong>0 号桶</strong> 的数据全部拉过来。</li><li>这样，所有的 &quot;Apple&quot; 最终都会汇聚到 Reduce Worker 0 手里。</li></ul></li><li><p><strong>Coordinator (以前叫 Master):</strong></p><ul><li><strong>数量：只有 1 个进程。</strong></li><li><strong>身份：</strong> 总包工头、大管家。</li><li><strong>职责：</strong> 它不干累活（不读写数据），只负责<strong>分配任务</strong>、<strong>记账</strong>（谁在干什么、干完没有）和<strong>计时</strong>（谁超时了）。</li></ul></li><li><p><strong>Worker:</strong></p><ul><li><strong>数量：N 个进程 (由你决定)。</strong></li><li>在测试脚本中，通常会启动 3~5 个 Worker 进程并发跑。</li><li><strong>身份：</strong> 通用打工人。</li><li><strong>职责：</strong> 也就是你写的 worker.go。它启动后会是个死循环，不断问 Coordinator：“老板，现在有啥活？” <ul><li>如果处于 Map 阶段，Coordinator 会给它派 Map 任务。</li><li>如果 Map 阶段全结束了，Coordinator 会给它派 Reduce 任务。</li><li><strong>Worker 自己不知道也不关心现在的阶段，它只听命行事。</strong></li></ul></li></ul></li></ul><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>[ 只有 1 个进程 ]</span></span>
<span class="line"><span>      +-----------------+</span></span>
<span class="line"><span>      |   Coordinator   | &lt;---- 保存着任务表 (Excel)</span></span>
<span class="line"><span>      +-----------------+       1. Map任务状态: [Done, Idle, InProgress...]</span></span>
<span class="line"><span>         ^   ^   ^   |          2. Reduce任务状态: [Idle, Idle...]</span></span>
<span class="line"><span>         :   :   :   |</span></span>
<span class="line"><span>(RPC调用):   :   :   | (RPC回复: &quot;去做 Map任务 #3&quot;)</span></span>
<span class="line"><span>&quot;求派活&quot; :   :   :   |</span></span>
<span class="line"><span>         :   :   :   v</span></span>
<span class="line"><span>      +-----------+   +-----------+   +-----------+</span></span>
<span class="line"><span>      | Worker A  |   | Worker B  |   | Worker C  |  &lt;--- N 个进程</span></span>
<span class="line"><span>      +-----------+   +-----------+   +-----------+</span></span>
<span class="line"><span>            |               |               |</span></span>
<span class="line"><span>   (1) 读取输入文件     (1) 读取输入    (可能是闲置</span></span>
<span class="line"><span>       pg-xx.txt        pg-yy.txt      或正在处理)</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>      [执行 MapF]      [执行 MapF]</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>   (2) 生成中间文件     (2) 生成中间文件</span></span>
<span class="line"><span>       mr-3-0          mr-4-0</span></span>
<span class="line"><span>       mr-3-1          mr-4-1</span></span>
<span class="line"><span>       ...             ...</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>            +---------------+</span></span>
<span class="line"><span>                    |</span></span>
<span class="line"><span>      -------------------------------------</span></span>
<span class="line"><span>      |    W A I T   (同步屏障)           |  &lt;--- Map全部做完才能进下一步</span></span>
<span class="line"><span>      -------------------------------------</span></span>
<span class="line"><span>                    |</span></span>
<span class="line"><span>      +-----------+   +-----------+</span></span>
<span class="line"><span>      | Worker A  |   | Worker B  |  &lt;--- 还是那批人，现在转职做 Reduce</span></span>
<span class="line"><span>      +-----------+   +-----------+</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>   (3) 读取中间文件     (3) 读取中间文件</span></span>
<span class="line"><span>       所有 mr-*-0      所有 mr-*-1</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>      [执行 ReduceF]   [执行 ReduceF]</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>   (4) 写最终结果       (4) 写最终结果</span></span>
<span class="line"><span>       mr-out-0         mr-out-1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="对于worker-既要执行map-reduce-任务-也要向coordinator发送心跳包" tabindex="-1"><a class="header-anchor" href="#对于worker-既要执行map-reduce-任务-也要向coordinator发送心跳包"><span>对于worker 既要执行map reduce 任务 也要向coordinator发送心跳包</span></a></h3><h4 id="使用两个goruntimes" tabindex="-1"><a class="header-anchor" href="#使用两个goruntimes"><span>使用两个goruntimes</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 创建一个channel用于通知心跳goroutine任务已完成</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	doneChan</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> make</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">chan</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 启动心跳goroutine</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	go</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			case</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">doneChan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				// worker退出</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				return</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			case</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">After</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">): </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 每秒发送一次心跳</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">				SendHeartbeat</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>单独一个线程 定时发送心跳包 如果收到doneChan的话就退出 这个chennel是原来的线程与心跳包线程进行通信的通道</p><h3 id="并行map-reduce的结果总是小于线性-map-reduce" tabindex="-1"><a class="header-anchor" href="#并行map-reduce的结果总是小于线性-map-reduce"><span>并行map reduce的结果总是小于线性 map reduce</span></a></h3><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yet </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">365</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yet </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">383</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21617</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22072</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yielded </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">9</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yielded </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">12</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21623</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">a22079</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yoked </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21625</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22081</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yonder </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">31</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yonder </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">33</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21627</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21630</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22083</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">22086</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> you </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6270</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> young </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">321</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> younger </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">31</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youngest </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> you </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">7005</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> young </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">365</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> younger </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">36</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youngest </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">28</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21632</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22088</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> your </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1305</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> your </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1477</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21634</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21637</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22090</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">22093</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yours </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourself </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">155</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourselves </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">11</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youth </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">61</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yours </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">34</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourself </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">172</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourselves </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">14</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youth </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">105</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21650</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22106</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>虽然我最初在所有coordinator的方法上都加了大锁 但是还是出现了数据丢失的问题 可以看出：结果数据均小于应有的数字</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			// worker is not busy ask for a task</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">			RequestTask</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">worker)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">has_work_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">				time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				continue</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">is_reduce_task_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">										// map task</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				file, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> os</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Open</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> err </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nil {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Fatalf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cannot open %v&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				content, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ioutil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ReadAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(file)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> err </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nil {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Fatalf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cannot read %v&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">				file</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				//fmt.Println(string(content[0:20]))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">				kva</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> mapf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">string</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(content))</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">				TaskDone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">worker)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">can_write_files_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">					// abort all tasks</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">					//log.Println(&quot;abort&quot;)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">					continue</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				// write to files</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				//log.Println(&quot;mid write to files&quot;)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">				ofiles</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> []*os.File{}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nReduce_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">); i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">					file_name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;mr-mid-&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> strconv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Itoa</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_id_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;-&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> strconv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Itoa</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(i)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">					ofile, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> os</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Create</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(file_name)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">					ofiles </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> append</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(ofiles, ofile)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> _, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> range kva { </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					fmt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Fprintf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">ofiles</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ihash</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">%</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nReduce_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)], </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;%v %v</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				} 	</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> _, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">ofile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> range ofiles {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					ofile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>目前为了实现abort逻辑 我选择了 先完成map或者reduce任务 然后通知coordinator 如果coordinator认定了这个worker就是应该完成操作的worker（不是之前被放弃的——任务已经分配给别人了）那么就能写文件 但是这里出现了静态条件 对于coordinator 他认为任务完成了 但是其实文件还没有真正被写完 如果这个时候进入reduce 那么就会读取还没有完全写完的脏数据 导致最后统计结果偏小</p><p><strong>Worker 告诉 Coordinator &quot;我做完了&quot; 和 Worker &quot;实际把数据落盘&quot; 之间的时间差</strong> 导致了<strong>时序错乱</strong></p><h4 id="解决方法-使用原子文件重命名" tabindex="-1"><a class="header-anchor" href="#解决方法-使用原子文件重命名"><span>解决方法 使用原子文件重命名</span></a></h4><p>os.Rename(&quot;tmp-mr-out-1&quot;, &quot;mr-out-1&quot;) (这是一个原子瞬间动作)<br><strong>只要 Coordinator 认为任务完成了，磁盘上的文件就一定是完整的</strong></p><h3 id="如果这个worker-突然崩溃了" tabindex="-1"><a class="header-anchor" href="#如果这个worker-突然崩溃了"><span>如果这个worker 突然崩溃了</span></a></h3><p>假如一个分布式节点突然断电 如果原来是直接写在结果文件中的 那么会留下一个损坏的文件</p><h4 id="解决方法-还是原子文件重命名" tabindex="-1"><a class="header-anchor" href="#解决方法-还是原子文件重命名"><span>解决方法 还是原子文件重命名</span></a></h4><ol><li><strong>崩溃发生在写临时文件时</strong>： <ul><li>如果 Worker 在写入 mr-mid-tmp-xxx 的过程中挂掉了（断电、网络断开、进程崩溃）。</li><li>磁盘上只会留下一个写了一半的<strong>垃圾文件</strong>（Garbage/Partial File）。</li><li>但是，最终的文件名 mr-mid-X-Y <strong>根本就没有被创建</strong>（或者如果之前有旧的，也没被碰过）。</li><li>Coordinator 发现这个 Worker 超时（不再发送心跳），就会把任务重新分配给另一个 Worker。</li><li>新的 Worker 会重新创建一个<strong>新的</strong>临时文件开始写。</li><li><strong>结论</strong>：系统状态是干净的，没有脏数据污染最终结果。</li></ul></li><li><strong>崩溃发生在重命名那一瞬间</strong>： <ul><li>在操作系统（尤其是 POSIX 标准的文件系统）中，Rename 是<strong>原子</strong>的。</li><li>这意味着：要么改名成功，文件瞬间变成最终文件；要么完全没发生，文件还是临时文件名。</li><li><strong>绝对不会出现</strong>“改名改了一半”或者“文件损坏”的情况。</li><li>这就像一个<strong>开关</strong>，只有 0 和 1，没有中间状态。</li></ul></li></ol><h3 id="这就是所谓的-commit-point-提交点" tabindex="-1"><a class="header-anchor" href="#这就是所谓的-commit-point-提交点"><span>这就是所谓的“Commit Point”（提交点）</span></a></h3><p>在 MapReduce Worker 代码中，os.Rename 就相当于数据库事务中的 <strong>COMMIT</strong> 命令：</p><ul><li><strong>Rename 之前</strong>：所有的计算和 IO 都是“草稿”，随时可以扔掉，对外界（Coordinator 和 Reducer）不可见。</li><li><strong>Rename 之后</strong>：数据瞬间生效，对外界可见。</li></ul><h4 id="如果worker1被抛弃了-新指派的worker2完成了工作-这时worker1又完成了怎么办" tabindex="-1"><a class="header-anchor" href="#如果worker1被抛弃了-新指派的worker2完成了工作-这时worker1又完成了怎么办"><span>如果worker1被抛弃了 新指派的worker2完成了工作 这时worker1又完成了怎么办</span></a></h4><p>paper中写道</p><blockquote><p>We rely on atomic commits of map and reduce task outputs to achieve this property. Each in-progress task writes its output to private temporary files. A reduce task produces one such file, and a map task produces R such files (one per reduce task). When a map task completes, the worker sends a message to the master and includes the names of the R temporary files in the message. If the master receives a completion message for an already completed map task, it <strong>ignores</strong> the message. Otherwise, it records the names of R files in a master data structure. When a reduce task completes, the reduce worker atomically renames its temporary output file to the final output file. If the same reduce task is executed on multiple machines, <strong>multiple rename calls will be executed for the same final output file. We rely on the atomic rename operation provided by the underlying file system</strong> to guarantee that the final file system state contains just the data produced by one execution of the reduce task.</p></blockquote><p>对于map 系统记录下第一个发出done的worker创建的那些文件 忽略后面的<br> 对于reduce每次都会先创建临时文件 然后进行原子重命名 操作系统保证了最后的结果是一次操作的输出</p><h3 id="coordinator的幂等性-和-map-reduce方法的确定性" tabindex="-1"><a class="header-anchor" href="#coordinator的幂等性-和-map-reduce方法的确定性"><span>coordinator的幂等性 和 map reduce方法的确定性</span></a></h3><p>Coordinator 检查 Task X 的状态。发现已经是 Completed 了，于是<strong>什么都不做</strong>（或者仅返回一个确认，但不修改内部状态）。</p><ul><li><p>公式表达：<code>HandleDone(Task X) = HandleDone(HandleDone(Task X))</code><br> 对于 map 和 reduce 方法来说 不包含随机数 每次执行的结果一定是一样的</p></li><li><p>所以就可以把一个任务分配给多个worker执行 不会影响最后结果</p></li></ul><blockquote><p>Google 的实现指出，如果你的函数是不确定的（比如包含随机数），MapReduce 框架只能保证输出结果是“某一次”执行的结果，但无法保证多次运行结果一致（弱一致性）。但在标准使用场景下，我们都假设函数是确定性的，这样就可以放心地让 Straggler 和 Backup Worker 互相覆盖文件，而不用担心数据错乱</p></blockquote><h1 id="raft" tabindex="-1"><a class="header-anchor" href="#raft"><span>RAFT</span></a></h1><h2 id="如何保持强一致性——prevlogidx-prevlogterm" tabindex="-1"><a class="header-anchor" href="#如何保持强一致性——prevlogidx-prevlogterm"><span>如何保持强一致性——PrevLogIdx PrevLogTerm</span></a></h2><p>可以把 <code>PrevLogIndex</code> 和 <code>PrevLogTerm</code> 想象成<strong>拼图的接口</strong>或者<strong>拉链的锁扣</strong>。</p><h3 id="通俗解释-拉链原理" tabindex="-1"><a class="header-anchor" href="#通俗解释-拉链原理"><span>通俗解释：拉链原理</span></a></h3><p>假设 Leader 要给 Follower 发送第 100 号日志。Leader 不能直接扔过去说：“这是第 100 号，你存下”。<br> 因为 Follower 可能比较卡，它的日志才存到第 80 号。如果它直接存下第 100 号，中间就缺了 19 条，这就完蛋了。</p><p>所以，Leader 在发第 100 号日志时，必须带上第 99 号的信息作为“验证码”：</p><ul><li><strong>PrevLogIndex (前一条日志的索引)</strong>: 99</li><li><strong>PrevLogTerm (前一条日志的任期)</strong>: 比如 Term 5</li></ul><p>Leader 对 Follower 说：“我要给你发第 100 号日志。但在接收之前，请你检查一下你那里有没有第 99 号日志，且它的任期是不是 Term 5？”</p><ul><li><strong>情况 A (匹配)</strong>：Follower 看了一眼，自己确实有第 99 号，也是 Term 5。于是回复：“匹配成功，我收下第 100 号。”（拉链拉上了）。</li><li><strong>情况 B (缺失)</strong>：Follower 发现自己只有第 80 号。它回复：“拒绝，我没有第 99 号。” Leader 收到拒绝后，下次就会试着发第 81 号（带上第 80 号做验证）。</li><li><strong>情况 C (冲突)</strong>：Follower 有第 99 号，但是是 Term 4（旧 Leader 留下的垃圾数据）。它回复：“拒绝，我有第 99 号，但Term不对。” Leader 收到后，知道这里数据不一致，下次会强行覆盖它。</li></ul><hr><h3 id="图解" tabindex="-1"><a class="header-anchor" href="#图解"><span>图解</span></a></h3><p>假设现在的状态如下：</p><p><strong>Leader 的日志：</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Index: 1  2  3  4  5</span></span>
<span class="line"><span>Term:  1  1  2  3  3</span></span>
<span class="line"><span>       ^  ^  ^  ^  ^</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Leader 想要发送 Index=4 和 Index=5 的日志给 Follower。<br> 此时，<code>AppendEntries</code> RPC 参数会是：</p><ul><li><strong>Entries</strong>: <code>[Log(Index:4, Term:3), Log(Index:5, Term:3)]</code></li><li><strong>PrevLogIndex</strong>: 3 (新日志的前一条)</li><li><strong>PrevLogTerm</strong>: 2 (Index 3 处的任期)</li></ul><p><strong>场景 1：Follower 是健康的</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Follower A 日志:</span></span>
<span class="line"><span>Index: 1  2  3</span></span>
<span class="line"><span>Term:  1  1  2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Follower A 收到 RPC：</p><ol><li>看 <code>PrevLogIndex</code> (3)。我有 Index 3 吗？有。</li><li>看 <code>PrevLogTerm</code> (2)。我 Index 3 的 Term 是 2 吗？是。</li><li><strong>成功</strong>。把新的日志 4 和 5 接在后面。</li></ol><p><strong>场景 2：Follower 落后了 (缺失)</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Follower B 日志:</span></span>
<span class="line"><span>Index: 1  2</span></span>
<span class="line"><span>Term:  1  1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Follower B 收到 RPC：</p><ol><li>看 <code>PrevLogIndex</code> (3)。我有 Index 3 吗？<strong>没有！</strong></li><li><strong>失败</strong>。返回 <code>Success = false</code>。</li><li>Leader 收到失败，会将 <code>nextIndex</code> 减小，下次改为发送 Index 3（带上 PrevLogIndex: 2）。</li></ol><p><strong>场景 3：Follower 此时有脏数据 (冲突)</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Follower C 日志:</span></span>
<span class="line"><span>Index: 1  2  3</span></span>
<span class="line"><span>Term:  1  1  1  &lt;-- 注意这里是 1，Leader 期望是 2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Follower C 收到 RPC：</p><ol><li>看 <code>PrevLogIndex</code> (3)。我有 Index 3 吗？有。</li><li>看 <code>PrevLogTerm</code> (2)。我 Index 3 的 Term 是 2 吗？<strong>不是，我是 1。</strong></li><li><strong>失败</strong>。返回 <code>Success = false</code>。</li><li>这表示 Follower 的 Index 3 是错的，Leader 之后会一步步回退，最终把这个 Term 1 的错误日志覆盖掉。</li></ol><hr><h3 id="代码实现逻辑" tabindex="-1"><a class="header-anchor" href="#代码实现逻辑"><span>代码实现逻辑</span></a></h3><h4 id="为什么需要-index-0-dummy-entry" tabindex="-1"><a class="header-anchor" href="#为什么需要-index-0-dummy-entry"><span>为什么需要 Index 0 (Dummy Entry)？</span></a></h4><p>为了方便处理 <code>PrevLogIndex</code>，我们通常在 <code>rf.log</code> 初始化时放一个空的日志占位。<br><code>rf.log[0] = LogEntry{Term: 0}</code><br> 这样，如果 Leader 要发第一条真的日志（Index 1），它的 <code>PrevLogIndex</code> 就是 0，<code>PrevLogTerm</code> 就是 0。你就不用写一堆 <code>if index == 0</code> 的特殊判断逻辑了。</p><h4 id="leader-端怎么计算-发送方" tabindex="-1"><a class="header-anchor" href="#leader-端怎么计算-发送方"><span>Leader 端怎么计算？ (发送方)</span></a></h4><p>Leader 维护了 <code>nextIndex[]</code>，表示下一个要发给某个 Peer 的日志索引。</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 假设要发给 server p</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nextIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nextIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// PrevLogIndex 就是我们要发的这一批的前一个</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> nextIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 要发的日志切片</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entries</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nextIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AppendEntriesArgs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    PrevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:  </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:      </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ... 其他字段</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="follower-端怎么检查-接收方" tabindex="-1"><a class="header-anchor" href="#follower-端怎么检查-接收方"><span>Follower 端怎么检查？ (接收方)</span></a></h4><p>这是 <code>AppendEntries</code> 中最关键的逻辑：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rf </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">AppendEntries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">AppendEntriesArgs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">reply</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">AppendEntriesReply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 1. Term 检查</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { ... }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 2. 一致性检查 (Consistency Check)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 情况 A: 我连这个位置的日志都没有 (日志太短)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 情况 B: 我有这个位置的日志，但是 Term 不匹配</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 优化：3C 会在这里做冲突优化</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 3. 到了这里，说明前面都匹配上了！</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 即使 entries 是空的（心跳），也说明至少到 PrevLogIndex 位置是一致的。</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 4. 处理日志追加和冲突覆盖 (Log Truncation and Append)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 遍历 args.Entries，找到第一个不匹配的位置，删除它及之后的所有，然后把新的接上去。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ... (后续实现)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>PrevLogIndex</strong>: 这次要传的新货之前，最后那条旧货的编号。</li><li><strong>PrevLogTerm</strong>: 那条旧货的生产批次。</li><li><strong>作用</strong>: 只有旧货对上了，才允许接新货。这是 Raft 保证所有节点日志最终一模一样的根本原因（数学归纳法）。</li></ul><h2 id="持久化与提交" tabindex="-1"><a class="header-anchor" href="#持久化与提交"><span>持久化与提交</span></a></h2><p>持久化是一个节点自己的行为 作用是将  <code>currentTerm</code>、<code>voteFor</code> 和 <code>log[]</code> 存储到磁盘中 防止断电 或者用于断电后的恢复</p><p>提交则是达成共识以后 交给上层的kv server进行执行 提交的信息是不能改变的 但是持久化的信息可能被新的leader覆盖掉</p><p><strong>一定要先持久化再回复RPC</strong><br><strong>提交的前提是半数以上的节点完成了持久化 而不是完成了日志的一致</strong></p><h2 id="lastapplied-和-lastcommited的区别" tabindex="-1"><a class="header-anchor" href="#lastapplied-和-lastcommited的区别"><span>LastApplied 和 LastCommited的区别</span></a></h2><p>applied是上层kvserver最后应用到状态机的日志 也就是上一次被放进apply chan的那个日志</p><p>而last commit是最后一个在raft内部达成一致的日志条目</p><p>从这里可以看出 commit条目一定至少大于等于applied的条目（只有达成共识的日志才会被应用到kv中）</p><p>raft中专门有一个协程<code>applier</code>用来查看commit是否前进了 他会对apply落后的每个条目创建一个apply msg 放入apply chan 让上层的kvserver进行处理</p><h1 id="kvraft-实战" tabindex="-1"><a class="header-anchor" href="#kvraft-实战"><span>KVRAFT 实战</span></a></h1><h2 id="clerk-client" tabindex="-1"><a class="header-anchor" href="#clerk-client"><span>Clerk/Client</span></a></h2><p>这个部分只需要完成向kvserver发送的RPC构建<br> 需要注意的是</p><ul><li>需要向所有可能的server进行询问 直到找到leader kvserver才行 可用性方面是raft保证的</li><li>需要维护clinet id 和 seq no 来保证各种操作的线性一致性和幂等性（如果服务器发现seqno已经过时了 就不会在他的状态机上应用了）</li></ul><h2 id="kvserver" tabindex="-1"><a class="header-anchor" href="#kvserver"><span>KVserver</span></a></h2><p>KVserver 实际上是一个执行者 本质上就是维护了一个内存里的map 然后能够接受三种指令 GET PUT APPEND<br> 而raft不理解这个指令 他眼里只有字节流日志 并且他保证这个日志在所有机器中达成共识<br> 一旦raft把这个日志成功复制给半数节点 他就会通过apply channel告诉KVserver 你可以执行这个指令了</p><p>如果不通过 Raft 给指令，而是 KVServer 收到请求直接改 map：</p><ul><li>Server 1 收到 Put(a, 1)，改了 map。</li><li>Server 2 没收到，它的 map 还是旧的。<br><strong>结果</strong>：两个服务器的状态不一样了，分布式系统崩溃。<br> 通过 Raft 给指令的逻辑是：</li><li>客户端找 Server 1 说：我想 Put(a, 1)。</li><li>Server 1 不敢直接改 map，它先问 Raft：把这个记在账本上行不行？</li><li>Raft 告诉 Server 1、2、3：大家都记好了，Index 100 是 Put(a, 1)。</li><li>Server 1、2、3 的 applyLoop 都从 Raft 那里拿到了这条指令。</li><li>大家同时改 map。<br><strong>结果</strong>：全世界的 map 永远保持同步。</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>节点 1                     节点 2                     节点 3</span></span>
<span class="line"><span>+--------------+          +--------------+          +--------------+</span></span>
<span class="line"><span>|   KVServer   |          |   KVServer   |          |   KVServer   |</span></span>
<span class="line"><span>+--------------+          +--------------+          +--------------+</span></span>
<span class="line"><span>|     Raft     | &lt;------&gt; |     Raft     | &lt;------&gt; |     Raft     |</span></span>
<span class="line"><span>+--------------+          +--------------+          +--------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>只有 Leader 身份的 KVServer 会处理 Client 的请求。</strong></p><ul><li><strong>Client 的视角</strong>：Client 会轮询服务器。如果它向一个 Follower 发送请求，这个 KVServer 会看一眼它内部的 Raft 状态，说：“我不是 Leader，你去问节点 X”。</li><li><strong>写操作 (Put/Append)</strong>：必须由 Leader 提交到 Raft 日志，等半数以上节点确认后才能修改数据库。</li><li><strong>读操作 (Get)</strong>：为了保证读到的是最新的，Leader 也需要把 Get 作为一个日志走一遍 Raft 流程（或者使用更高级的 Read Index 机制），确保它在执行读的一刻依然是 Leader。</li></ul><h3 id="kvserver-和-raft-的交互流程" tabindex="-1"><a class="header-anchor" href="#kvserver-和-raft-的交互流程"><span>KVServer 和 Raft 的交互流程</span></a></h3><p>这是一个典型的“异步转同步”的过程，分为四个步骤：</p><ol><li><strong>提议 (Proposal)</strong>： <ul><li>Client 调用 Put(key, val)。</li><li>KVServer 收到后，调用 rf.Start(op)。</li><li>Raft 说：“好，我把它记在我的日志第 100 号位置了，但我还没确定它能不能生效。”</li></ul></li><li><strong>复制 (Replication)</strong>： <ul><li>Leader 的 Raft 开始疯狂给其他节点的 Raft 发消息：“大家快把这行字记在第 100 号位置！”</li></ul></li><li><strong>提交与应用 (Commit &amp; Apply)</strong>： <ul><li>当半数以上节点记好了，Leader 的 Raft 就会认为第 100 号日志已提交。</li><li><strong>关键点</strong>：Raft 通过 applyCh 告诉 KVServer：“第 100 号日志现在安全了，你可以执行它了。”</li></ul></li><li><strong>响应 (Reply)</strong>： <ul><li>KVServer 的 applier 协程从 applyCh 拿到消息，修改 kv.db。</li><li>KVServer 找到正在等 100 号索引的那个 RPC Handler，通过 waitCh 喊一声：“喂！做好了！”</li><li>RPC Handler 回复 Client：“成功！”</li></ul></li></ol><h3 id="分布式系统最难的就是-出事的时候-。" tabindex="-1"><a class="header-anchor" href="#分布式系统最难的就是-出事的时候-。"><span>分布式系统最难的就是“出事的时候”。</span></a></h3><h4 id="情况-a-leader-突然断网-宕机了" tabindex="-1"><a class="header-anchor" href="#情况-a-leader-突然断网-宕机了"><span>情况 A：Leader 突然断网/宕机了</span></a></h4><ul><li><strong>Raft 层</strong>：其他节点会发现 Leader 消失了，自动选出新 Leader。</li><li><strong>KVServer 层</strong>：旧 Leader 的 Handler 还在等 waitCh。由于它不再是 Leader，它的 Raft 永远不会在 applyCh 里返回那个索引。Handler 会<strong>超时</strong>（这就是你代码里 time.After 的作用），并告诉 Client：“出事了，你去问别人吧。”</li></ul><h4 id="情况-b-网络分区-脑裂" tabindex="-1"><a class="header-anchor" href="#情况-b-网络分区-脑裂"><span>情况 B：网络分区（脑裂）</span></a></h4><ul><li>假设有 5 个节点，节点 1 和 2 被隔离了。节点 1 觉得自己还是 Leader。</li><li>Client 向节点 1 发请求。节点 1 调用 rf.Start()。</li><li>但是！由于它只能联络到节点 2，凑不够 3 票（半数），这个日志永远无法 <strong>Commit</strong>。</li><li>Client 会一直等，直到超时。这保证了<strong>数据不会在错误的分区里被修改</strong>。</li></ul><h4 id="情况-c-旧指令延迟到达" tabindex="-1"><a class="header-anchor" href="#情况-c-旧指令延迟到达"><span>情况 C：旧指令延迟到达</span></a></h4><ul><li>如果一个 Append 指令因为网络延迟，在 10 秒后才到达。</li><li>KVServer 会检查 lastApplied 表。如果发现这个客户端的序列号（SeqNo）已经处理过了，它就会<strong>直接丢弃</strong>这个操作，不修改数据库，但会返回 OK（幂等性）。</li></ul><h3 id="全部流程" tabindex="-1"><a class="header-anchor" href="#全部流程"><span>全部流程</span></a></h3><ol><li><strong>Client -&gt; KVServer (RPC Handler)</strong>: <ul><li><code>Handler</code> 创建 <code>Op{Type: Append, Key: &quot;a&quot;, Val: &quot;1&quot;, ClerkId: 88, SeqNo: 5}</code>。</li><li>调用 <code>index, term, isLeader := rf.Start(op)</code>。</li><li><code>Handler</code> 创建 <code>ch := make(chan Op, 1)</code> 并存入 <code>waitChs[index]</code>。</li></ul></li><li><strong>KVServer -&gt; Raft (Log Replication)</strong>: <ul><li>Raft 在集群间同步这条日志。</li><li>此时 <code>Handler</code> 正在 <code>select { case &lt;-ch: ... }</code> 处阻塞。</li></ul></li><li><strong>Raft -&gt; KVServer (Applier Loop)</strong>: <ul><li>Raft 达成共识，把 <code>ApplyMsg{CommandIndex: 100, Command: Op{...}}</code> 塞入 <code>applyCh</code></li><li><code>Applier</code> 协程读到这条消息。</li></ul></li><li><strong>KVServer 内部状态更新</strong>: <ul><li><code>Applier</code> 检查 <code>lastApplied[88]</code>。如果当前记录的序号小于 5，则执行 <code>db[&quot;a&quot;] += &quot;1&quot;</code>。</li><li>执行完后，<code>Applier</code> 查找 <code>waitChs[100]</code>。</li><li><strong>关键动作</strong>：<code>Applier</code> 把 <code>Op</code> 发进 <code>ch</code>。</li></ul></li><li><strong>KVServer -&gt; Client (RPC Response)</strong>: <ul><li><code>Handler</code> 被唤醒，收到 <code>Op</code>。</li><li>检查收到的 <code>Op</code> 是否还是 <code>ClerkId=88, SeqNo=5</code>（防止 Index 100 已经被新 Leader 的其他命令覆盖）。</li><li>校验通过，给 Client 回复 <code>OK</code>。</li></ul></li></ol><hr><h4 id="为什么要这样设计通信" tabindex="-1"><a class="header-anchor" href="#为什么要这样设计通信"><span>为什么要这样设计通信？</span></a></h4><p>这种设计完美解决了分布式环境下的三个地雷：</p><ol><li><strong>解耦 (Decoupling)</strong>：<br> KVServer 不需要知道 Raft 是怎么同步日志的，它只需要给 Raft 一个任务，然后等 Raft 的回执。</li><li><strong>线性化 (Linearizability)</strong>：<br> 因为 <code>Applier</code> 是单线程（一个协程）处理 <code>applyCh</code> 的，这保证了所有节点执行指令的<strong>顺序完全一致</strong>。即便有 100 个 Handler 同时在跑，最终改数据库的顺序也只取决于 Raft 日志的顺序。</li><li><strong>安全性 (Safety)</strong>：<br> 即使 Leader 在同步过程中挂了，由于 Handler 校验了 <code>ClerkId</code> 和 <code>SeqNo</code>，它能敏锐地发现：“Raft 确实返回了 Index 100 的结果，但那个结果不是我之前要存的‘1’，而是别人存的‘2’。” 这样它就不会给客户端返回错误的成功信息。</li></ol><h1 id="raft-kv-在现实生活中是怎么被使用的" tabindex="-1"><a class="header-anchor" href="#raft-kv-在现实生活中是怎么被使用的"><span>RAFT KV 在现实生活中是怎么被使用的</span></a></h1><p>假设我有五台机器 下面管理了上千个GPU机器 用来训练模型</p><p>KV RAFT其实只对外提供两个接口 一个是PUT 一个是GET 但是他能保证</p><ul><li>线性一致性：只要有一个PUT成功了 剩下任何人 在任何地方 调用GET 一定能够得到这个一样的值</li><li>高可用性：这五个管理者如果有三个可用 就能够正常进行服务</li><li>持久性与唯一性</li></ul><h3 id="一、-这-5-台机器-kv-raft-在地理上分布在哪里" tabindex="-1"><a class="header-anchor" href="#一、-这-5-台机器-kv-raft-在地理上分布在哪里"><span>一、 这 5 台机器（KV-Raft）在地理上分布在哪里？</span></a></h3><p>在现实世界中，这 5 台机器的物理位置取决于你对 <strong>“容灾”</strong> 的要求。</p><ol><li><p><strong>同机房分布（LAN）</strong>：</p><ul><li>放在一个机房的 5 个不同机架上。</li><li><strong>优点</strong>：速度极快，延迟 &lt; 1ms。</li><li><strong>缺点</strong>：如果整个机房着火或断电，系统就彻底挂了。</li></ul></li><li><p><strong>跨可用区分布（Multi-AZ）</strong>：</p><ul><li>在同一个城市（比如北京），分布在 3 个不同的数据中心（机房 A、B、C）。</li><li><strong>优点</strong>：能抵御单个机房级别的故障。</li><li><strong>这种最常见</strong>（比如 AWS 或阿里云的典型架构）。</li></ul></li><li><p><strong>跨地域/全球分布（Geo-Distributed）</strong>：</p><ul><li>比如 1 台在纽约，1 台在伦敦，1 台在东京，2 台在新加坡。</li><li><strong>优点</strong>：能抵御战争、地震等区域性灾难。</li><li><strong>缺点</strong>：非常慢！因为光速限制，Raft 达成共识（多数派确认）可能需要几百毫秒。Google 的 <strong>Spanner</strong> 数据库就是这种架构。</li></ul></li></ol><hr><h3 id="二、-只有-put-和-get-怎么管理几千台-gpu" tabindex="-1"><a class="header-anchor" href="#二、-只有-put-和-get-怎么管理几千台-gpu"><span>二、 只有 <code>Put</code> 和 <code>Get</code>，怎么管理几千台 GPU？</span></a></h3><p>这听起来不可思议，但<strong>全世界最复杂的集群管理系统（如 Kubernetes）正是这么干的。</strong></p><p>Kubernetes 底层用的是 <strong>etcd</strong>，而 etcd 本质上和现在写的 <strong>KV-Raft</strong> 几乎一模一样。</p><h4 id="_1-它是如何通过两个方法管理集群的" tabindex="-1"><a class="header-anchor" href="#_1-它是如何通过两个方法管理集群的"><span>1. 它是如何通过两个方法管理集群的？</span></a></h4><p>秘诀在于：<strong>所有的管理指令，在本质上都是“状态的变化”。</strong></p><ul><li><p><strong>场景：给 GPU 1 号分配一个 AI 训练任务</strong></p><ul><li><strong>包工头（Scheduler）</strong> 并不需要直接给 GPU 发消息。</li><li><strong>包工头</strong> 只需调用你的 <code>Put(&quot;GPU_001_Assignment&quot;, &quot;{task: &#39;Training_Cat_Model&#39;, data: &#39;s3://bucket/data&#39;}&quot;)</code>。</li><li><strong>GPU 1 号</strong> 上的 Agent 程序（就像一个 Clerk）一直在后台不停地调你的 <code>Get(&quot;GPU_001_Assignment&quot;)</code>（这种技术叫轮询或长轮询）。</li><li>一旦 GPU 发现内容变了，它就自己去下载数据开始干活。</li></ul></li><li><p><strong>场景：GPU 坏了怎么办？</strong></p><ul><li>GPU 上的 Agent 定期调你的 <code>Put(&quot;GPU_001_Status&quot;, &quot;Healthy_12:00:05&quot;)</code>。</li><li><strong>包工头</strong> 调 <code>Get(&quot;GPU_001_Status&quot;)</code>。如果发现时间很久没更新了，包工头就知道它挂了，于是再发一个 <code>Put</code> 把任务指派给别人。</li></ul></li></ul><h4 id="_2-为什么只给两个方法" tabindex="-1"><a class="header-anchor" href="#_2-为什么只给两个方法"><span>2. 为什么只给两个方法？</span></a></h4><p>因为 <strong>“简单即力量”</strong>。<br> 如果接口太复杂（比如包含 <code>StartTraining()</code>, <code>StopTraining()</code>），那么你的 KV-Raft 就只能用于 AI 训练。<br> 但如果你只提供 <code>Put</code> 和 <code>Get</code>，你就创造了一个<strong>通用的真理之源</strong>。它既可以管理 GPU 集群，也可以管理银行账本，还可以管理自动驾驶汽车的调度。</p><hr><h3 id="三、-总结-这种架构的-全局视角" tabindex="-1"><a class="header-anchor" href="#三、-总结-这种架构的-全局视角"><span>三、 总结：这种架构的“全局视角”</span></a></h3><ol><li><p><strong>底层：KV-Raft (大脑)</strong><br> 这 5 台机器缩在数据中心的一个小角落里。它们虽然只有 5 台，但它们通过 Raft 算法产生了一个 <strong>“统一的幻觉”</strong>：大家都看到一模一样的 <code>Put/Get</code> 记录。</p></li><li><p><strong>中间层：Clerk (神经末梢)</strong><br> 分布在全球各地的 1000 台 GPU 机器上，都跑着你写的 <code>Clerk</code> 代码。它们像触角一样，时刻连接着这 5 台核心机器。</p></li><li><p><strong>运作过程：</strong></p><ul><li>无论地理分布多广，所有的 GPU 机器都认准这 5 台机器。</li><li>当 Leader 发生切换，全球各地的 <code>Clerk</code> 会自动重定向请求。</li><li><strong>地理广度</strong>由 <code>Clerk</code> 负责连接，<strong>数据的一致性</strong>由你的 5 台机器负责死守。</li></ul></li></ol>`,127)])])}const k=i(e,[["render",t]]),d=JSON.parse(`{"path":"/courses/6.5840.html","title":"MIT 6.5840 分布式系统","lang":"zh-CN","frontmatter":{"title":"MIT 6.5840 分布式系统","icon":"share-2","description":"MapReduce 要把大象装冰箱（处理 PB 级数据），分三步： Split (切分): 把大文件切成无数个 64MB 的小块 (Input Splits)。 Map (映射): 把小块转化成 <Key, Value> 对。 Reduce (归约): 把相同 Key 的数据聚在一起处理。 场景： 统计单词频率 (Word Count)。 Map 阶段...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"MIT 6.5840 分布式系统\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2026-01-28T11:39:40.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"yedou\\",\\"url\\":\\"https://yedou37.github.io\\"}]}"],["meta",{"property":"og:url","content":"https://yedou37.github.io/courses/6.5840.html"}],["meta",{"property":"og:site_name","content":"Yedou's Notebook"}],["meta",{"property":"og:title","content":"MIT 6.5840 分布式系统"}],["meta",{"property":"og:description","content":"MapReduce 要把大象装冰箱（处理 PB 级数据），分三步： Split (切分): 把大文件切成无数个 64MB 的小块 (Input Splits)。 Map (映射): 把小块转化成 <Key, Value> 对。 Reduce (归约): 把相同 Key 的数据聚在一起处理。 场景： 统计单词频率 (Word Count)。 Map 阶段..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-01-28T11:39:40.000Z"}],["meta",{"property":"article:modified_time","content":"2026-01-28T11:39:40.000Z"}]]},"git":{"createdTime":1769599712000,"updatedTime":1769600380000,"contributors":[{"name":"yedou37","username":"yedou37","email":"137401103+yedou37@users.noreply.github.com","commits":3,"url":"https://github.com/yedou37"}]},"readingTime":{"minutes":20,"words":5999},"filePathRelative":"courses/6.5840.md","autoDesc":true}`);export{k as comp,d as data};
