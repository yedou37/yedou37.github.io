import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as a,b as n,o as l}from"./app-D4DhlKIb.js";const t={};function e(h,s){return l(),a("div",null,[...s[0]||(s[0]=[n(`<hr><h1 id="mapreduce" tabindex="-1"><a class="header-anchor" href="#mapreduce"><span>MapReduce</span></a></h1><p>要把大象装冰箱（处理 PB 级数据），分三步：</p><ol><li><strong>Split (切分):</strong> 把大文件切成无数个 64MB 的小块 (Input Splits)。</li><li><strong>Map (映射):</strong> 把小块转化成 &lt;Key, Value&gt; 对。</li><li><strong>Reduce (归约):</strong> 把相同 Key 的数据聚在一起处理。</li></ol><ul><li><p><strong>场景：</strong> 统计单词频率 (Word Count)。</p></li><li><p><strong>Map 阶段：</strong></p><ul><li>Worker A 读文件 1，发现 &quot;Apple&quot;，输出 &lt;Apple, 1&gt;。</li><li>Worker B 读文件 2，发现 &quot;Apple&quot;，输出 &lt;Apple, 1&gt;。</li><li><strong>问题：</strong> 这两个 &lt;Apple, 1&gt; 分散在不同机器上，Reduce 怎么求和？</li></ul></li><li><p><strong>Partitioning (分区):</strong></p><ul><li>系统预先规定：hash(&quot;Apple&quot;) % nReduce。假设结果是 0。</li><li>所有 Worker 都知道：只要遇到 &quot;Apple&quot;，就扔进 <strong>0 号桶</strong>。</li><li>只要遇到 &quot;Banana&quot;，就扔进 <strong>1 号桶</strong>。</li></ul></li><li><p><strong>Shuffle 阶段：</strong></p><ul><li>Reduce Worker 0 启动时，它会去<strong>所有</strong> Map Worker 那里，把 <strong>0 号桶</strong> 的数据全部拉过来。</li><li>这样，所有的 &quot;Apple&quot; 最终都会汇聚到 Reduce Worker 0 手里。</li></ul></li><li><p><strong>Coordinator (以前叫 Master):</strong></p><ul><li><strong>数量：只有 1 个进程。</strong></li><li><strong>身份：</strong> 总包工头、大管家。</li><li><strong>职责：</strong> 它不干累活（不读写数据），只负责<strong>分配任务</strong>、<strong>记账</strong>（谁在干什么、干完没有）和<strong>计时</strong>（谁超时了）。</li></ul></li><li><p><strong>Worker:</strong></p><ul><li><strong>数量：N 个进程 (由你决定)。</strong></li><li>在测试脚本中，通常会启动 3~5 个 Worker 进程并发跑。</li><li><strong>身份：</strong> 通用打工人。</li><li><strong>职责：</strong> 也就是你写的 worker.go。它启动后会是个死循环，不断问 Coordinator：“老板，现在有啥活？” <ul><li>如果处于 Map 阶段，Coordinator 会给它派 Map 任务。</li><li>如果 Map 阶段全结束了，Coordinator 会给它派 Reduce 任务。</li><li><strong>Worker 自己不知道也不关心现在的阶段，它只听命行事。</strong></li></ul></li></ul></li></ul><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>[ 只有 1 个进程 ]</span></span>
<span class="line"><span>      +-----------------+</span></span>
<span class="line"><span>      |   Coordinator   | &lt;---- 保存着任务表 (Excel)</span></span>
<span class="line"><span>      +-----------------+       1. Map任务状态: [Done, Idle, InProgress...]</span></span>
<span class="line"><span>         ^   ^   ^   |          2. Reduce任务状态: [Idle, Idle...]</span></span>
<span class="line"><span>         :   :   :   |</span></span>
<span class="line"><span>(RPC调用):   :   :   | (RPC回复: &quot;去做 Map任务 #3&quot;)</span></span>
<span class="line"><span>&quot;求派活&quot; :   :   :   |</span></span>
<span class="line"><span>         :   :   :   v</span></span>
<span class="line"><span>      +-----------+   +-----------+   +-----------+</span></span>
<span class="line"><span>      | Worker A  |   | Worker B  |   | Worker C  |  &lt;--- N 个进程</span></span>
<span class="line"><span>      +-----------+   +-----------+   +-----------+</span></span>
<span class="line"><span>            |               |               |</span></span>
<span class="line"><span>   (1) 读取输入文件     (1) 读取输入    (可能是闲置</span></span>
<span class="line"><span>       pg-xx.txt        pg-yy.txt      或正在处理)</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>      [执行 MapF]      [执行 MapF]</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>   (2) 生成中间文件     (2) 生成中间文件</span></span>
<span class="line"><span>       mr-3-0          mr-4-0</span></span>
<span class="line"><span>       mr-3-1          mr-4-1</span></span>
<span class="line"><span>       ...             ...</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>            +---------------+</span></span>
<span class="line"><span>                    |</span></span>
<span class="line"><span>      -------------------------------------</span></span>
<span class="line"><span>      |    W A I T   (同步屏障)           |  &lt;--- Map全部做完才能进下一步</span></span>
<span class="line"><span>      -------------------------------------</span></span>
<span class="line"><span>                    |</span></span>
<span class="line"><span>      +-----------+   +-----------+</span></span>
<span class="line"><span>      | Worker A  |   | Worker B  |  &lt;--- 还是那批人，现在转职做 Reduce</span></span>
<span class="line"><span>      +-----------+   +-----------+</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>   (3) 读取中间文件     (3) 读取中间文件</span></span>
<span class="line"><span>       所有 mr-*-0      所有 mr-*-1</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>      [执行 ReduceF]   [执行 ReduceF]</span></span>
<span class="line"><span>            |               |</span></span>
<span class="line"><span>   (4) 写最终结果       (4) 写最终结果</span></span>
<span class="line"><span>       mr-out-0         mr-out-1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="对于worker-既要执行map-reduce-任务-也要向coordinator发送心跳包" tabindex="-1"><a class="header-anchor" href="#对于worker-既要执行map-reduce-任务-也要向coordinator发送心跳包"><span>对于worker 既要执行map reduce 任务 也要向coordinator发送心跳包</span></a></h3><h4 id="使用两个goruntimes" tabindex="-1"><a class="header-anchor" href="#使用两个goruntimes"><span>使用两个goruntimes</span></a></h4><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 创建一个channel用于通知心跳goroutine任务已完成</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	doneChan</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> make</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">chan</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> bool</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 启动心跳goroutine</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	go</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			select</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			case</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">doneChan</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				// worker退出</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				return</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			case</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;-</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">After</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">): </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 每秒发送一次心跳</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">				SendHeartbeat</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}()</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>单独一个线程 定时发送心跳包 如果收到doneChan的话就退出 这个chennel是原来的线程与心跳包线程进行通信的通道</p><h3 id="并行map-reduce的结果总是小于线性-map-reduce" tabindex="-1"><a class="header-anchor" href="#并行map-reduce的结果总是小于线性-map-reduce"><span>并行map reduce的结果总是小于线性 map reduce</span></a></h3><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yet </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">365</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yet </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">383</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21617</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22072</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yielded </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">9</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yielded </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">12</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21623</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">a22079</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yoked </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21625</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22081</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yonder </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">31</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yonder </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">33</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21627</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21630</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22083</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">22086</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> you </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">6270</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> young </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">321</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> younger </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">31</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youngest </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> you </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">7005</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> young </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">365</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> younger </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">36</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youngest </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">28</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21632</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22088</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> your </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1305</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> your </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1477</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21634</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21637</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22090</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">22093</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yours </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">32</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourself </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">155</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourselves </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">11</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youth </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">61</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yours </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">34</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourself </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">172</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> yourselves </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">14</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> youth </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">105</span></span>
<span class="line"><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">21650</span><span style="--shiki-light:#986801;--shiki-dark:#E06C75;">c22106</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>虽然我最初在所有coordinator的方法上都加了大锁 但是还是出现了数据丢失的问题 可以看出：结果数据均小于应有的数字</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			// worker is not busy ask for a task</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">			RequestTask</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">worker)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">has_work_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">				time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Second</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				continue</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> !</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">is_reduce_task_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">										// map task</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				file, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> os</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Open</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> err </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nil {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Fatalf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cannot open %v&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				content, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">err</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> ioutil</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ReadAll</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(file)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> err </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">!=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> nil {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Fatalf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;cannot read %v&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">				file</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				//fmt.Println(string(content[0:20]))</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">				kva</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> mapf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_file_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">string</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(content))</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">				TaskDone</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">worker)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">!</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">can_write_files_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">					// abort all tasks</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">					//log.Println(&quot;abort&quot;)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">					continue</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				// write to files</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				//log.Println(&quot;mid write to files&quot;)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">				ofiles</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> []*os.File{}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				for</span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nReduce_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">); i</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">++</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">					file_name</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;mr-mid-&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> strconv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Itoa</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">map_id_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">))</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;-&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> strconv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Itoa</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(i)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">					ofile, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;"> os</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Create</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(file_name)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">					ofiles </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> append</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(ofiles, ofile)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> _, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> range kva { </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					fmt</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Fprintf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">ofiles</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ihash</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">%</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">worker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nReduce_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)], </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;%v %v</span><span style="--shiki-light:#0184BC;--shiki-dark:#56B6C2;">\\n</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Key</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">k</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				} 	</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				for</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> _, </span><span style="--shiki-light:#383A42;--shiki-dark:#E06C75;">ofile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> :</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> range ofiles {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">					ofile</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Close</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">				}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>目前为了实现abort逻辑 我选择了 先完成map或者reduce任务 然后通知coordinator 如果coordinator认定了这个worker就是应该完成操作的worker（不是之前被放弃的——任务已经分配给别人了）那么就能写文件 但是这里出现了竞态条件 对于coordinator 他认为任务完成了 但是其实文件还没有真正被写完 如果这个时候进入reduce 那么就会读取还没有完全写完的脏数据 导致最后统计结果偏小</p><p><strong>Worker 告诉 Coordinator &quot;我做完了&quot; 和 Worker &quot;实际把数据落盘&quot; 之间的时间差</strong> 导致了<strong>时序错乱</strong></p><h4 id="解决方法-使用原子文件重命名" tabindex="-1"><a class="header-anchor" href="#解决方法-使用原子文件重命名"><span>解决方法 使用原子文件重命名</span></a></h4><p>os.Rename(&quot;tmp-mr-out-1&quot;, &quot;mr-out-1&quot;) (这是一个原子瞬间动作)<br><strong>只要 Coordinator 认为任务完成了，磁盘上的文件就一定是完整的</strong></p><h3 id="如果这个worker-突然崩溃了" tabindex="-1"><a class="header-anchor" href="#如果这个worker-突然崩溃了"><span>如果这个worker 突然崩溃了</span></a></h3><p>假如一个分布式节点突然断电 如果原来是直接写在结果文件中的 那么会留下一个损坏的文件</p><h4 id="解决方法-还是原子文件重命名" tabindex="-1"><a class="header-anchor" href="#解决方法-还是原子文件重命名"><span>解决方法 还是原子文件重命名</span></a></h4><ol><li><strong>崩溃发生在写临时文件时</strong>： <ul><li>如果 Worker 在写入 mr-mid-tmp-xxx 的过程中挂掉了（断电、网络断开、进程崩溃）。</li><li>磁盘上只会留下一个写了一半的<strong>垃圾文件</strong>（Garbage/Partial File）。</li><li>但是，最终的文件名 mr-mid-X-Y <strong>根本就没有被创建</strong>（或者如果之前有旧的，也没被碰过）。</li><li>Coordinator 发现这个 Worker 超时（不再发送心跳），就会把任务重新分配给另一个 Worker。</li><li>新的 Worker 会重新创建一个<strong>新的</strong>临时文件开始写。</li><li><strong>结论</strong>：系统状态是干净的，没有脏数据污染最终结果。</li></ul></li><li><strong>崩溃发生在重命名那一瞬间</strong>： <ul><li>在操作系统（尤其是 POSIX 标准的文件系统）中，Rename 是<strong>原子</strong>的。</li><li>这意味着：要么改名成功，文件瞬间变成最终文件；要么完全没发生，文件还是临时文件名。</li><li><strong>绝对不会出现</strong>“改名改了一半”或者“文件损坏”的情况。</li><li>这就像一个<strong>开关</strong>，只有 0 和 1，没有中间状态。</li></ul></li></ol><h3 id="这就是所谓的-commit-point-提交点" tabindex="-1"><a class="header-anchor" href="#这就是所谓的-commit-point-提交点"><span>这就是所谓的“Commit Point”（提交点）</span></a></h3><p>在 MapReduce Worker 代码中，os.Rename 就相当于数据库事务中的 <strong>COMMIT</strong> 命令：</p><ul><li><strong>Rename 之前</strong>：所有的计算和 IO 都是“草稿”，随时可以扔掉，对外界（Coordinator 和 Reducer）不可见。</li><li><strong>Rename 之后</strong>：数据瞬间生效，对外界可见。</li></ul><h4 id="如果worker1被抛弃了-新指派的worker2完成了工作-这时worker1又完成了怎么办" tabindex="-1"><a class="header-anchor" href="#如果worker1被抛弃了-新指派的worker2完成了工作-这时worker1又完成了怎么办"><span>如果worker1被抛弃了 新指派的worker2完成了工作 这时worker1又完成了怎么办</span></a></h4><p>paper中写道</p><blockquote><p>We rely on atomic commits of map and reduce task outputs to achieve this property. Each in-progress task writes its output to private temporary files. A reduce task produces one such file, and a map task produces R such files (one per reduce task). When a map task completes, the worker sends a message to the master and includes the names of the R temporary files in the message. If the master receives a completion message for an already completed map task, it <strong>ignores</strong> the message. Otherwise, it records the names of R files in a master data structure. When a reduce task completes, the reduce worker atomically renames its temporary output file to the final output file. If the same reduce task is executed on multiple machines, <strong>multiple rename calls will be executed for the same final output file. We rely on the atomic rename operation provided by the underlying file system</strong> to guarantee that the final file system state contains just the data produced by one execution of the reduce task.</p></blockquote><p>对于map 系统记录下第一个发出done的worker创建的那些文件 忽略后面的<br> 对于reduce每次都会先创建临时文件 然后进行原子重命名 操作系统保证了最后的结果是一次操作的输出</p><h3 id="coordinator的幂等性-和-map-reduce方法的确定性" tabindex="-1"><a class="header-anchor" href="#coordinator的幂等性-和-map-reduce方法的确定性"><span>coordinator的幂等性 和 map reduce方法的确定性</span></a></h3><p>Coordinator 检查 Task X 的状态。发现已经是 Completed 了，于是<strong>什么都不做</strong>（或者仅返回一个确认，但不修改内部状态）。</p><ul><li><p>公式表达：<code>HandleDone(Task X) = HandleDone(HandleDone(Task X))</code><br> 对于 map 和 reduce 方法来说 不包含随机数 每次执行的结果一定是一样的</p></li><li><p>所以就可以把一个任务分配给多个worker执行 不会影响最后结果</p></li></ul><blockquote><p>Google 的实现指出，如果你的函数是不确定的（比如包含随机数），MapReduce 框架只能保证输出结果是“某一次”执行的结果，但无法保证多次运行结果一致（弱一致性）。但在标准使用场景下，我们都假设函数是确定性的，这样就可以放心地让 Straggler 和 Backup Worker 互相覆盖文件，而不用担心数据错乱</p></blockquote><h1 id="raft" tabindex="-1"><a class="header-anchor" href="#raft"><span>RAFT</span></a></h1><h2 id="cap" tabindex="-1"><a class="header-anchor" href="#cap"><span>CAP</span></a></h2><p>在 CAP 定理中，Raft 是一个典型的 <strong>CP 系统</strong>：它优先保证一致性，在无法达成共识时，宁可牺牲可用性（A）。</p><h3 id="raft-是如何维持-cap-的" tabindex="-1"><a class="header-anchor" href="#raft-是如何维持-cap-的"><span>Raft 是如何维持 CAP 的？</span></a></h3><h4 id="_1-强一致性-consistency" tabindex="-1"><a class="header-anchor" href="#_1-强一致性-consistency"><span>1. 强一致性 (Consistency)</span></a></h4><p>Raft 保证的是 <strong>线性一致性（Linearizability）</strong>，就像只有一台机器在工作一样：</p><ul><li><strong>日志匹配原则</strong>：如果两个节点的日志在某个位置 Index 和 Term 都相同，那么它们之前的日志也一定相同。</li><li><strong>选举约束</strong>：不包含最新已提交日志的节点根本当不上 Leader。</li><li><strong>过半数原则</strong>：任何一个已提交的日志，必然存在于过半数节点上。而任何两个“过半数”集合必有交集。这保证了新 Leader 选举时一定能看到旧 Leader 提交过的痕迹。</li></ul><h4 id="_2-分区容错性-partition-tolerance" tabindex="-1"><a class="header-anchor" href="#_2-分区容错性-partition-tolerance"><span>2. 分区容错性 (Partition Tolerance)</span></a></h4><p>Raft 天生就是为了应对网络分区设计的：</p><ul><li><strong>脑裂处理</strong>：如果 5 个节点被切成了 3 个（分区 A）和 2 个（分区 B）。 <ul><li>分区 B 凑不够 3 票，选不出 Leader，无法工作。</li><li>分区 A 能选出 Leader，继续工作。</li><li>当网络恢复，分区 B 的节点发现分区 A 的 Term 更高，会立刻放弃抵抗，同步分区 A 的日志。</li></ul></li><li><strong>网络隔离</strong>：即使消息丢了、延迟了、乱序了，Raft 的序列号（Index）和任期（Term）都能确保数据最终对齐。</li></ul><h4 id="_3-可用性-availability-——-raft-牺牲了它" tabindex="-1"><a class="header-anchor" href="#_3-可用性-availability-——-raft-牺牲了它"><span>3. 可用性 (Availability) —— Raft 牺牲了它</span></a></h4><p>Raft 在某些情况下会<strong>暂时不可用</strong>，以保全数据的一致性：</p><ul><li><strong>选举空窗期</strong>：当 Leader 挂了，到新 Leader 选出来的几十毫秒内，系统无法处理请求。</li><li><strong>少数派分区</strong>：如果你所在的网络分区凑不够半数，系统会直接报错，拒绝服务。</li><li><strong>这就是为什么说 Raft 是 CP 而不是 AP。</strong> 它坚信：<strong>“宁可不给结果，也绝不给错的结果。”</strong></li></ul><h3 id="什么时候使用ap-什么时候使用cp" tabindex="-1"><a class="header-anchor" href="#什么时候使用ap-什么时候使用cp"><span>什么时候使用AP 什么时候使用CP</span></a></h3><h4 id="a-使用-cp-的场景-一致性至上" tabindex="-1"><a class="header-anchor" href="#a-使用-cp-的场景-一致性至上"><span>A. 使用 CP 的场景（一致性至上）</span></a></h4><p>如果你觉得“宁可系统暂时不可用，也绝对不能给错数据”，就选 CP。</p><ul><li><strong>金融/支付</strong>：你的银行余额。如果因为断网导致你明明花了钱但余额没减，银行就亏死了。</li><li><strong>分布式锁/配置中心</strong>：如 <strong>etcd (Kubernetes 的大脑)</strong>、<strong>ZooKeeper</strong>。如果两个节点同时抢到了同一个锁，或者读到了不同的配置，系统会发生逻辑灾难。</li><li><strong>数据库元数据</strong>：TiDB 等分布式数据库的索引信息。</li></ul><h4 id="b-使用-ap-的场景-可用性至上" tabindex="-1"><a class="header-anchor" href="#b-使用-ap-的场景-可用性至上"><span>B. 使用 AP 的场景（可用性至上）</span></a></h4><p>如果你觉得“系统必须秒回，数据旧一点点没关系”，就选 AP。</p><ul><li><strong>社交媒体</strong>：你在微博发个状态，由于网络分区，你的朋友晚了 5 秒才看到，或者点赞数暂时少显示了几个。这完全没问题，但如果微博因为断网直接打不开，用户就会跑光。</li><li><strong>购物车/推荐系统</strong>：亚马逊发现，如果结账系统因为一致性检查慢了 1 毫秒，就会损失数百万美元。所以他们允许购物车数据暂时不一致，等联网后再合并。</li><li><strong>缓存系统</strong>：如 CDN、DNS。你修改了域名解析，全球生效需要时间（不一致），但这比整个互联网搜不到该域名要好得多。</li></ul><hr><h2 id="base" tabindex="-1"><a class="header-anchor" href="#base"><span>BASE</span></a></h2><p>BASE 是三个短语的缩写：<strong>B</strong>asically <strong>A</strong>vailable（基本可用）、<strong>S</strong>oft state（软状态）、<strong>E</strong>ventually consistent（最终一致性）。</p><hr><h3 id="_1-basically-available-基本可用" tabindex="-1"><a class="header-anchor" href="#_1-basically-available-基本可用"><span>1. Basically Available（基本可用）</span></a></h3><p>当系统出现不可预知的故障时，允许损失部分可用性，<strong>保证核心功能可用</strong>。这是一种“弃车保帅”的策略。</p><ul><li><strong>响应时间上的损失：</strong> 正常情况下订单处理 10ms，压力大或部分节点故障时，增加到 1s。虽然变慢了，但还能下单。</li><li><strong>功能上的损失：</strong> 电商大促时，为了保护下单流程，系统可能会关闭“查看历史订单”或“评论”功能，或者将原本实时的库存显示改为“有货/无货”这种模糊描述。</li></ul><h3 id="_2-soft-state-软状态" tabindex="-1"><a class="header-anchor" href="#_2-soft-state-软状态"><span>2. Soft state（软状态）</span></a></h3><p>软状态是指允许系统中的数据存在<strong>中间状态</strong>，并认为该中间状态的存在不会影响系统的整体可用性。</p><ul><li><strong>数据同步的滞后：</strong> 在强一致性（ACID）中，状态转换是瞬间完成的（从“未支付”直接变“已支付”）。</li><li><strong>例子：</strong> 在 BASE 模型下，当你付完钱，订单状态可能在几秒钟内处于“支付处理中”。这个“处理中”就是软状态，它反映了不同节点间异步同步数据的过程。</li></ul><h3 id="_3-eventually-consistent-最终一致性" tabindex="-1"><a class="header-anchor" href="#_3-eventually-consistent-最终一致性"><span>3. Eventually consistent（最终一致性）</span></a></h3><p>这是 BASE 的核心。系统不需要在任何时刻都保证数据的强一致性，但必须保证在经过一段时间（通常很短）后，数据最终能达到一致的状态。</p><ul><li><strong>不追求“实时同步”：</strong> 只要没有新的更新操作，最终所有的访问都能得到最新的值。</li><li><strong>修正机制：</strong> 最终一致性是通过重试、异步校准、对账等手段实现的。</li><li><strong>例子：</strong> 你在朋友圈发了张照片，你的朋友 A 立刻看到了，朋友 B 可能过了 2 秒才刷出来。虽然那 2 秒内不一致，但最终你们看到的内容是一样的。</li></ul><hr><h2 id="raft-的工作流程" tabindex="-1"><a class="header-anchor" href="#raft-的工作流程"><span>RAFT 的工作流程</span></a></h2><h3 id="第一阶段-初始化与选举-寻找权威" tabindex="-1"><a class="header-anchor" href="#第一阶段-初始化与选举-寻找权威"><span>第一阶段：初始化与选举（寻找权威）</span></a></h3><p>所有节点启动时都是 <strong>Follower</strong>。</p><ol><li><strong>心跳超时</strong>：每个节点都有一个随机的闹钟。谁的闹钟先响，谁就变身 <strong>Candidate</strong>。</li></ol><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rf </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ticker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">killed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		state</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">state</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> state</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> StateLeader</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			go</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">BroadCastAppendEntries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Millisecond</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			elapsed</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Since</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastActiveTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">electionTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> elapsed</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				go</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">startElection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Millisecond</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果是leader 就发送心跳包（其实是复制log 但是空的依然会发送）</p><ol start="2"><li><strong>拉票（RequestVote）</strong>：Candidate 给所有人发邮件：“我是任期（Term）X，请投我一票。”</li><li><strong>投票规则（C 的保证）</strong>： <ul><li>一个任期内只能投一张票。</li><li><strong>最重要</strong>：如果你的日志还没我新（Term 小或长度短），我绝不投给你。这保证了 <strong>Leader 一定拥有所有可能已经提交的日志</strong>。</li></ul></li></ol><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	upToDate</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LastLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lastTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LastLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lastTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LastLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> lastIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//  Term 代表了“权威性”的代际。一个拥有更高 Term 日志的节点，意味着它经历了更晚近的选举周期。即使它的 Index 较短，它也可能包含了已经被提交（Commit）的最完整数据。</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">voteFor</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ||</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">voteFor</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">CandidateId</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> upToDate</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">resetElectionTimerLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">//  只有当你**真的授予了选票**，才能重置计时器。如果不给票也重置，攻击者可以通过发假投票请求让全集群永远无法选出 Leader（心跳被抑制）。</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">voteFor</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">CandidateId</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">persist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Vote</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Vote</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><strong>成为 Leader</strong>：拿到超过半数（Majority）的票，正式上位。</li></ol><hr><h3 id="第二阶段-日志复制-达成共识" tabindex="-1"><a class="header-anchor" href="#第二阶段-日志复制-达成共识"><span>第二阶段：日志复制（达成共识）</span></a></h3><p>一旦有了 Leader，系统开始处理请求。</p><ol><li><strong>接收指令</strong>：Leader 收到命令，先在自己的日志里写一笔，状态是“未提交”。</li><li><strong>分发（AppendEntries）</strong>：Leader 把这行日志发给所有 Follower。</li><li><strong>一致性检查（C 的核心）</strong>： <ul><li>Leader 发送第 10 号日志时，会带上第 9 号日志的信息（Index 9, Term 2）。</li><li>Follower 检查自己的第 9 号日志。如果不匹配，Follower 会拒绝。</li><li>Leader 会不断往前退，直到找到双方一致的地方，然后把 Follower 后面不一致的部分全部<strong>覆盖</strong>掉。<strong>（Leader 永远是对的）</strong>。</li></ul></li></ol><h5 id="情况一-越过快照边界-保护逻辑" tabindex="-1"><a class="header-anchor" href="#情况一-越过快照边界-保护逻辑"><span>情况一：越过快照边界（保护逻辑）</span></a></h5><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastIncludedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastIncludedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>场景描述</strong>：Leader 试图同步一段非常旧的日志，其 <code>PrevLogIndex</code> 指向的位置已经在 Follower 的快照（Snapshot）里了。</li><li><strong>为什么会发生</strong>：网络延迟。Leader 发出的 <code>AppendEntries</code> RPC 在路上堵了很久，当它到达时，Follower 已经完成了垃圾回收，把旧日志做成了快照并删除了。</li><li><strong>逻辑详解</strong>： <ul><li>Follower 无法检查快照里的日志 Term（因为已经删了），所以不能回复 <code>Success</code>。</li><li><strong>应对方案</strong>：告诉 Leader，我现在的日志最早是从 <code>lastIncludedIndex + 1</code> 开始的。Leader 收到后会意识到：“哦，你太旧了，AE 同步已经跟不上了，我得给你发 <code>InstallSnapshot</code> RPC 了。”</li></ul></li></ul><hr><h5 id="情况二-follower-日志太短-日志缺失" tabindex="-1"><a class="header-anchor" href="#情况二-follower-日志太短-日志缺失"><span>情况二：Follower 日志太短（日志缺失）</span></a></h5><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLenLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLenLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>场景描述</strong>：Leader 认为 Follower 应该有 100 条日志，所以从 101 条开始发（<code>PrevLogIndex=100</code>）。但 Follower 实际只有 50 条日志。</li><li><strong>核心逻辑</strong>： <ul><li>不一致的原因是**“空隙”**（Gap）。</li><li><strong>快速回退（Optimization）</strong>：如果不加这段，Leader 只能一次次减 1（从 100 试到 99, 98... 直到 50），效率极低。</li><li><strong>解决策略</strong>：Follower 直接告诉 Leader：“我根本没这么长，我现在的末尾是 50。你下次直接从 51（<code>GetLogLenLocked() + 1</code>）开始试吧。”</li><li><code>ConflictTerm = -1</code> 是一个约定，告诉 Leader：冲突不是因为任期不对，而是因为我<strong>日志太短了</strong>。</li></ul></li></ul><hr><h5 id="情况三-任期冲突-经典不一致" tabindex="-1"><a class="header-anchor" href="#情况三-任期冲突-经典不一致"><span>情况三：任期冲突（经典不一致）</span></a></h5><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    index</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastIncludedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &amp;&amp;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">index</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">-</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        index</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">--</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ConflictIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> index</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>场景描述</strong>：这是最经典的 Raft 冲突。Leader 和 Follower 在 <code>PrevLogIndex</code> 处都有日志，但<strong>任期号不同</strong>。这说明 Follower 这里的日志是来自某个“被废黜”的旧 Leader 的。</li><li><strong>逻辑详解</strong>： <ol><li><strong>记录冲突任期</strong>：Follower 说：“我这里 <code>Index=100</code> 的地方任期是 2，而你说是 3，咱俩对不上。”（<code>reply.ConflictTerm = 2</code>）。</li><li><strong>寻找该任期的起点</strong>：Follower 往回找，发现任期 2 的日志是从 <code>Index=80</code> 开始的。</li><li><strong>快速跳过整个任期</strong>：Follower 告诉 Leader：“我这里整个任期 2 估计都是错的，你下次直接从 <code>Index=80</code> 试试看。”</li></ol></li><li><strong>为什么这么做</strong>：在 Raft 中，如果一个 Index 处的 Term 不匹配，那么这个 Term 之后的所有日志一定都是错的。直接跳过一整个 Term 远比一条条回退快得多。</li></ul><h5 id="最后进行覆盖和追加" tabindex="-1"><a class="header-anchor" href="#最后进行覆盖和追加"><span>最后进行覆盖和追加</span></a></h5><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 2. 如果通过检查，处理日志覆盖和追加</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entry</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> range</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		index</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> index</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLenLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">+</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			// 如果已有的日志和新的冲突了，才删除后面的</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 为什么不直接用 rf.log = append(rf.log[:rf.GetLogLocked(index)], args.Entries[i:]...) 这种写法？也就是，**为什么必须先判断 Term 是否不匹配，如果不匹配才截断？** 如果我收到一个已经处理过的旧 RPC 包，直接截断会导致什么问题？</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// - 假设 Leader 发送了 RPC-1（Index 10-11）和 RPC-2（Index 12-13）。RPC-2 先到，Follower 存下了 10-13。然后 RPC-1 后到。 **后果：** 如果你无脑截断 rf.log[:10] 然后追加 RPC-1 里的 10-11，那么 Follower 已经存好的 12-13 就会**丢失**。</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> entry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">				rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[:</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">index</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)]</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">				rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> append</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entry</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			// 如果 Term 相同 继续往后看下一条</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">			// 超出本地长度了，直接追加剩下所有的</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> append</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:]...)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">persist</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 3. 更新 commitIndex</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LeaderCommit</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">commitedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">		// 论文原文：commitIndex = min(leaderCommit, index of last new entry)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		lastNewEntryIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> +</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">commitedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> min</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">LeaderCommit</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastNewEntryIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>幂等性</strong> ：通过判断 Term 是否冲突来决定是否截断日志。这样即便 RPC 请求发生乱序、重传或重叠，Follower 也能保证日志的一致性，不会因为处理旧的 RPC 包而意外删除了已经接收到的、更靠后的正确日志</p><ol start="4"><li><strong>达成共识</strong>：Leader 收到过半数的成功回复。</li></ol><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rf </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">UpdateCommitIndexLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() { </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLenLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(); </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">commitedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">--</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			count</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> p</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> range</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">peers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">					if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> p</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">me</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">continue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> }</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">					if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">matchIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">] </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">&gt;=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">						count</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">++</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">					}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> count</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">peers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">				rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">commitedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">				break</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}			</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 每次收到成功复制日志的回复都会调用这个 遍历所有follower的match index 超过半数旧把他commit</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>注意这里判断了要commit的日志term和当前term 这是论文中figure8的情况 leader永远不能直接commit低于当前term的任何条目 只能等到高term有一条被commit了 才被顺带commit</p><hr><h3 id="第三阶段-提交与安全-不可逆转" tabindex="-1"><a class="header-anchor" href="#第三阶段-提交与安全-不可逆转"><span>第三阶段：提交与安全（不可逆转）</span></a></h3><ol><li><strong>提交（Commit）</strong>：Leader 发现过半数都记好了，把 <code>commitIndex</code> 推高。</li><li><strong>告知</strong>：Leader 在下次心跳中告诉大家：“第 10 号已经提交了。”</li><li><strong>Figure 8 约束</strong>：Leader 只能通过提交当前任期的日志来顺带提交旧日志。</li></ol><hr><h2 id="如何保持强一致性——prevlogidx-prevlogterm" tabindex="-1"><a class="header-anchor" href="#如何保持强一致性——prevlogidx-prevlogterm"><span>如何保持强一致性——PrevLogIdx PrevLogTerm</span></a></h2><p>可以把 <code>PrevLogIndex</code> 和 <code>PrevLogTerm</code> 想象成<strong>拼图的接口</strong>或者<strong>拉链的锁扣</strong>。</p><h3 id="通俗解释-拉链原理" tabindex="-1"><a class="header-anchor" href="#通俗解释-拉链原理"><span>通俗解释：拉链原理</span></a></h3><p>假设 Leader 要给 Follower 发送第 100 号日志。Leader 不能直接扔过去说：“这是第 100 号，你存下”。<br> 因为 Follower 可能比较卡，它的日志才存到第 80 号。如果它直接存下第 100 号，中间就缺了 19 条，这就完蛋了。</p><p>所以，Leader 在发第 100 号日志时，必须带上第 99 号的信息作为“验证码”：</p><ul><li><strong>PrevLogIndex (前一条日志的索引)</strong>: 99</li><li><strong>PrevLogTerm (前一条日志的任期)</strong>: 比如 Term 5</li></ul><p>Leader 对 Follower 说：“我要给你发第 100 号日志。但在接收之前，请你检查一下你那里有没有第 99 号日志，且它的任期是不是 Term 5？”</p><ul><li><strong>情况 A (匹配)</strong>：Follower 看了一眼，自己确实有第 99 号，也是 Term 5。于是回复：“匹配成功，我收下第 100 号。”（拉链拉上了）。</li><li><strong>情况 B (缺失)</strong>：Follower 发现自己只有第 80 号。它回复：“拒绝，我没有第 99 号。” Leader 收到拒绝后，下次就会试着发第 81 号（带上第 80 号做验证）。</li><li><strong>情况 C (冲突)</strong>：Follower 有第 99 号，但是是 Term 4（旧 Leader 留下的垃圾数据）。它回复：“拒绝，我有第 99 号，但Term不对。” Leader 收到后，知道这里数据不一致，下次会强行覆盖它。</li></ul><hr><h3 id="图解" tabindex="-1"><a class="header-anchor" href="#图解"><span>图解</span></a></h3><p>假设现在的状态如下：</p><p><strong>Leader 的日志：</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Index: 1  2  3  4  5</span></span>
<span class="line"><span>Term:  1  1  2  3  3</span></span>
<span class="line"><span>       ^  ^  ^  ^  ^</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Leader 想要发送 Index=4 和 Index=5 的日志给 Follower。<br> 此时，<code>AppendEntries</code> RPC 参数会是：</p><ul><li><strong>Entries</strong>: <code>[Log(Index:4, Term:3), Log(Index:5, Term:3)]</code></li><li><strong>PrevLogIndex</strong>: 3 (新日志的前一条)</li><li><strong>PrevLogTerm</strong>: 2 (Index 3 处的任期)</li></ul><p><strong>场景 1：Follower 是健康的</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Follower A 日志:</span></span>
<span class="line"><span>Index: 1  2  3</span></span>
<span class="line"><span>Term:  1  1  2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Follower A 收到 RPC：</p><ol><li>看 <code>PrevLogIndex</code> (3)。我有 Index 3 吗？有。</li><li>看 <code>PrevLogTerm</code> (2)。我 Index 3 的 Term 是 2 吗？是。</li><li><strong>成功</strong>。把新的日志 4 和 5 接在后面。</li></ol><p><strong>场景 2：Follower 落后了 (缺失)</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Follower B 日志:</span></span>
<span class="line"><span>Index: 1  2</span></span>
<span class="line"><span>Term:  1  1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Follower B 收到 RPC：</p><ol><li>看 <code>PrevLogIndex</code> (3)。我有 Index 3 吗？<strong>没有！</strong></li><li><strong>失败</strong>。返回 <code>Success = false</code>。</li><li>Leader 收到失败，会将 <code>nextIndex</code> 减小，下次改为发送 Index 3（带上 PrevLogIndex: 2）。</li></ol><p><strong>场景 3：Follower 此时有脏数据 (冲突)</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Follower C 日志:</span></span>
<span class="line"><span>Index: 1  2  3</span></span>
<span class="line"><span>Term:  1  1  1  &lt;-- 注意这里是 1，Leader 期望是 2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Follower C 收到 RPC：</p><ol><li>看 <code>PrevLogIndex</code> (3)。我有 Index 3 吗？有。</li><li>看 <code>PrevLogTerm</code> (2)。我 Index 3 的 Term 是 2 吗？<strong>不是，我是 1。</strong></li><li><strong>失败</strong>。返回 <code>Success = false</code>。</li><li>这表示 Follower 的 Index 3 是错的，Leader 之后会一步步回退，最终把这个 Term 1 的错误日志覆盖掉。</li></ol><hr><h3 id="代码实现逻辑" tabindex="-1"><a class="header-anchor" href="#代码实现逻辑"><span>代码实现逻辑</span></a></h3><h4 id="为什么需要-index-0-dummy-entry" tabindex="-1"><a class="header-anchor" href="#为什么需要-index-0-dummy-entry"><span>为什么需要 Index 0 (Dummy Entry)？</span></a></h4><p>为了方便处理 <code>PrevLogIndex</code>，我们通常在 <code>rf.log</code> 初始化时放一个空的日志占位。<br><code>rf.log[0] = LogEntry{Term: 0}</code><br> 这样，如果 Leader 要发第一条真的日志（Index 1），它的 <code>PrevLogIndex</code> 就是 0，<code>PrevLogTerm</code> 就是 0。你就不用写一堆 <code>if index == 0</code> 的特殊判断逻辑了。</p><h4 id="leader-端怎么计算-发送方" tabindex="-1"><a class="header-anchor" href="#leader-端怎么计算-发送方"><span>Leader 端怎么计算？ (发送方)</span></a></h4><p>Leader 维护了 <code>nextIndex[]</code>，表示下一个要发给某个 Peer 的日志索引。</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 假设要发给 server p</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nextIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nextIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// PrevLogIndex 就是我们要发的这一批的前一个</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> nextIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> -</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 1</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 要发的日志切片</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entries</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">nextIdx</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> AppendEntriesArgs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">{</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">: </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    PrevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:  </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">prevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    Entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">:      </span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">entries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">,</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ... 其他字段</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="follower-端怎么检查-接收方" tabindex="-1"><a class="header-anchor" href="#follower-端怎么检查-接收方"><span>Follower 端怎么检查？ (接收方)</span></a></h4><p>这是 <code>AppendEntries</code> 中最关键的逻辑：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rf </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">AppendEntries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">AppendEntriesArgs</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">reply</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">AppendEntriesReply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 1. Term 检查</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &lt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { ... }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 2. 一致性检查 (Consistency Check)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 情况 A: 我连这个位置的日志都没有 (日志太短)</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;=</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 情况 B: 我有这个位置的日志，但是 Term 不匹配</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> args</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">PrevLogTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // 优化：3C 会在这里做冲突优化</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 3. 到了这里，说明前面都匹配上了！</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 即使 entries 是空的（心跳），也说明至少到 PrevLogIndex 位置是一致的。</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 4. 处理日志追加和冲突覆盖 (Log Truncation and Append)</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 遍历 args.Entries，找到第一个不匹配的位置，删除它及之后的所有，然后把新的接上去。</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // ... (后续实现)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    reply</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Success</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> true</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>PrevLogIndex</strong>: 这次要传的新货之前，最后那条旧货的编号。</li><li><strong>PrevLogTerm</strong>: 那条旧货的生产批次。</li><li><strong>作用</strong>: 只有旧货对上了，才允许接新货。这是 Raft 保证所有节点日志最终一模一样的根本原因（数学归纳法）。</li></ul><h2 id="持久化与提交" tabindex="-1"><a class="header-anchor" href="#持久化与提交"><span>持久化与提交</span></a></h2><p>持久化是一个节点自己的行为 作用是将  <code>currentTerm</code>、<code>voteFor</code> 和 <code>log[]</code> 存储到磁盘中 防止断电 或者用于断电后的恢复</p><p>提交则是达成共识以后 交给上层的kv server进行执行 提交的信息是不能改变的 但是持久化的信息可能被新的leader覆盖掉</p><p><strong>一定要先持久化再回复RPC</strong><br><strong>提交的前提是半数以上的节点完成了持久化 而不是完成了日志的一致</strong></p><h2 id="lastapplied-和-lastcommited的区别" tabindex="-1"><a class="header-anchor" href="#lastapplied-和-lastcommited的区别"><span>LastApplied 和 LastCommited的区别</span></a></h2><p>applied是上层kvserver最后应用到状态机的日志 也就是上一次被放进apply chan的那个日志</p><p>而last commit是最后一个在raft内部达成一致的日志条目</p><p>从这里可以看出 commit条目一定至少大于等于applied的条目（只有达成共识的日志才会被应用到kv中）</p><p>raft中专门有一个协程<code>applier</code>用来查看commit是否前进了 他会对apply落后的每个条目创建一个apply msg 放入apply chan 让上层的kvserver进行处理</p><h2 id="新当选的leader不能commit旧term的日志" tabindex="-1"><a class="header-anchor" href="#新当选的leader不能commit旧term的日志"><span>新当选的Leader不能commit旧Term的日志</span></a></h2><p>如果用一句话作为技术定义，那就是：<strong>Raft 只有当前任期的日志可以触发副本数统计（Counting replicas），而旧任期的日志只能通过“日志匹配原则（Log Matching Property）”被动地被带动提交。</strong></p><h3 id="_1-绝不-数数" tabindex="-1"><a class="header-anchor" href="#_1-绝不-数数"><span>1. 绝不“数数”</span></a></h3><p>Leader 即使看到某条<strong>旧任期</strong>的日志已经存在于 99% 的节点上，他也绝对<strong>不能</strong>把自己的 <code>commitIndex</code> 移动到那里。</p><h3 id="_2-绝不-违约" tabindex="-1"><a class="header-anchor" href="#_2-绝不-违约"><span>2. 绝不“违约”</span></a></h3><p>Leader 必须等到有一条<strong>当前任期</strong>的日志被过半数节点确认。</p><ul><li>比如 Leader 现在是 Term 4，他在同步一条 Term 2 的旧日志。</li><li>他必须等到老板发来新指令，他在本子上记下 <code>(Index: 10, Term: 4)</code>。</li><li>只有当这条 <code>(Index: 10, Term: 4)</code> 到了过半数节点，他才能宣布 Index 10 及其之前的所有日志（包括那条 Term 2）全部生效。</li></ul><h3 id="_3-为什么必须是-当前任期" tabindex="-1"><a class="header-anchor" href="#_3-为什么必须是-当前任期"><span>3. 为什么必须是“当前任期”？</span></a></h3><p>因为<strong>只有当前任期的日志能够代表这个 Leader 的“权威”</strong>。</p><ul><li>高任期的日志（Term 4）天生就有“压制”低任期（Term 2, Term 3）的能力。</li><li>一旦 Term 4 的日志在过半数节点上扎了根，任何任期小于 4 的节点都不可能再当选 Leader 了。</li><li>这时候再宣布之前的日志生效，才是真正的安全。</li></ul><hr><h3 id="面试官可能会追问-如果一直没有新请求怎么办" tabindex="-1"><a class="header-anchor" href="#面试官可能会追问-如果一直没有新请求怎么办"><span>面试官可能会追问：“如果一直没有新请求怎么办？”</span></a></h3><p>这是一个好坑。如果老板（Client）一直不发新请求，那旧任期的日志是不是永远没法提交了？</p><p><strong>答案是：No-op 日志。</strong><br> 在很多生产级别的 Raft 实现（比如 etcd）中，Leader 当选后的第一件事就是先发一条不带内容的 <strong>No-op（空指令）日志</strong>。</p><ul><li>这条 No-op 日志的任期是当前任期。</li><li>它一旦过半提交，就能立刻把之前所有任期的旧账全部“冲正”并提交。</li><li>这就解决了“没有新业务请求时，旧账无法提交”的问题。</li></ul><hr><h3 id="代码" tabindex="-1"><a class="header-anchor" href="#代码"><span>代码</span></a></h3><p>在 <code>UpdateCommitIndexLocked</code> 函数里，这行逻辑就是 Figure 8 的灵魂：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// i 是正在尝试更新的 commitIndex 候选值</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">log</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetLogLocked</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)].</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Term</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">currentTerm</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// &lt;--- 就是这一行！</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // 只有当前任期的日志才敢去数副本数</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> count</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> len</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">peers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">/</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 2</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">        rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">commitedIndex</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> =</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> i</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="raft中遇到的问题" tabindex="-1"><a class="header-anchor" href="#raft中遇到的问题"><span>RAFT中遇到的问题</span></a></h2><h3 id="在ticker中不能开启协程进行选举——election-storm" tabindex="-1"><a class="header-anchor" href="#在ticker中不能开启协程进行选举——election-storm"><span>在ticker中不能开启协程进行选举——election storm</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> (</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;">rf </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">ticker</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	for</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">killed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;">==</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> false</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		state</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">state</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">		rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">		if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> state</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> ==</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> StateLeader</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			go</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">BroadCastAppendEntries</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Millisecond</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		} </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Lock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			elapsed</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Since</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">lastActiveTime</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">electionTimeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">mu</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Unlock</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">			if</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> elapsed</span><span style="--shiki-light:#383A42;--shiki-dark:#56B6C2;"> &gt;</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> timeout</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">				// go rf.startElection() &lt;- 不正确</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">				rf</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">startElection</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">			}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">			time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Sleep</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">10</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> time</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">Millisecond</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">		}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>如果协程调度出现问题 导致没有及时归零计时器 就会有达到超时时间并且开一个选举协程（term++）<br> 又一次超时的时候又会触发选举导致term被抬升的很高（不会影响一致性但是会严重影响可用性）</p><h3 id="何时重置超时计时器" tabindex="-1"><a class="header-anchor" href="#何时重置超时计时器"><span>何时重置超时计时器</span></a></h3><blockquote><p>“在实现 <code>RequestVote</code> 时，<strong>重置计时器的时机必须非常谨慎</strong>。</p><p>只有在<strong>真正授予选票</strong>时重置，是为了防止恶意节点通过无效请求抑制正常选举。</p><p>此外，为了防止日志落后的节点仅仅靠高 Term 干扰集群稳定性，虽然标准 Raft 规定只要看到高 Term 就转为 Follower，但在实际工程中，我们通常会配合 <strong>Pre-Vote</strong> 机制。即：节点在转为 Follower 前，会先确认 Candidate 是否真的有资格（日志够新）以及当前集群是否真的丢失了 Leader。这保证了集群的稳定性（Stability）。”</p></blockquote><h3 id="单个分区中的节点抬高term——pre-vote解决" tabindex="-1"><a class="header-anchor" href="#单个分区中的节点抬高term——pre-vote解决"><span>单个分区中的节点抬高Term——pre-vote解决</span></a></h3><ul><li><strong>场景</strong>：节点 A 被网络分区隔离了。它在自己的小黑屋里不断超时，Term 一直增加到了 100。</li><li><strong>动作</strong>：隔离解除，节点 A 回归。它发起的 <code>RequestVote(Term=100)</code> 到达了正在正常工作的 Leader（Term=10）。</li><li><strong>反应</strong>：Leader 看到 Term 100，大吃一惊，立刻变回 Follower。但 Leader 发现 A 的日志太旧，不给它投票。</li><li><strong>陷阱</strong>：此时，旧 Leader 变成了 Follower，且<strong>没有重置计时器</strong>。这意味着旧 Leader 会在很短的时间内（因为它之前的计时器已经在跑了）发生超时，再次发起 Term 101 的选举。</li></ul><p><strong>结果</strong>：这个落后节点虽然没当上 Leader，但它像个“搅屎棍”一样，仅仅靠一个高 Term 就把现有的 Leader 给踢下来了，导致集群发生了一次无意义的震荡。</p><hr><p>为了解决上述“搅屎棍”问题，工业级的 Raft（如 etcd）引入了 <strong>Pre-Vote</strong> 机制：</p><ol><li>当一个 Candidate 想发起选举时，它先发一个 <strong>Pre-Vote</strong>（不增加自己的 Term）。</li><li>大家收到 Pre-Vote 后，检查： <ul><li>你的日志够新吗？</li><li><strong>我最近是不是刚收到过 Leader 的心跳？</strong>（如果我最近收到了心跳，说明集群有活着的 Leader，我直接拒绝你的预投票）。</li></ul></li><li>只有 Candidate 拿到大多数人的 Pre-Vote 许可，它才正式增加 <code>currentTerm</code> 并发起真正的 <code>RequestVote</code>。</li></ol><p><strong>为什么这能解决问题？</strong></p><ul><li>那个落后节点 A 回归时，它发出的 Pre-Vote 会被大家拒绝（因为大家能连上 Leader），A 甚至没有机会把大家的 <code>currentTerm</code> 顶上去。</li></ul><h1 id="kvraft-实战" tabindex="-1"><a class="header-anchor" href="#kvraft-实战"><span>KVRAFT 实战</span></a></h1><h2 id="clerk-client" tabindex="-1"><a class="header-anchor" href="#clerk-client"><span>Clerk/Client</span></a></h2><p>这个部分只需要完成向kvserver发送的RPC构建<br> 需要注意的是</p><ul><li>需要向所有可能的server进行询问 直到找到leader kvserver才行 可用性方面是raft保证的</li><li>需要维护clinet id 和 seq no 来保证各种操作的线性一致性和幂等性（如果服务器发现seqno已经过时了 就不会在他的状态机上应用了）</li></ul><h2 id="kvserver" tabindex="-1"><a class="header-anchor" href="#kvserver"><span>KVserver</span></a></h2><p>KVserver 实际上是一个执行者 本质上就是维护了一个内存里的map 然后能够接受三种指令 GET PUT APPEND<br> 而raft不理解这个指令 他眼里只有字节流日志 并且他保证这个日志在所有机器中达成共识<br> 一旦raft把这个日志成功复制给半数节点 他就会通过apply channel告诉KVserver 你可以执行这个指令了</p><p>如果不通过 Raft 给指令，而是 KVServer 收到请求直接改 map：</p><ul><li>Server 1 收到 Put(a, 1)，改了 map。</li><li>Server 2 没收到，它的 map 还是旧的。<br><strong>结果</strong>：两个服务器的状态不一样了，分布式系统崩溃。<br> 通过 Raft 给指令的逻辑是：</li><li>客户端找 Server 1 说：我想 Put(a, 1)。</li><li>Server 1 不敢直接改 map，它先问 Raft：把这个记在账本上行不行？</li><li>Raft 告诉 Server 1、2、3：大家都记好了，Index 100 是 Put(a, 1)。</li><li>Server 1、2、3 的 applyLoop 都从 Raft 那里拿到了这条指令。</li><li>大家同时改 map。<br><strong>结果</strong>：全世界的 map 永远保持同步。</li></ul><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>节点 1                     节点 2                     节点 3</span></span>
<span class="line"><span>+--------------+          +--------------+          +--------------+</span></span>
<span class="line"><span>|   KVServer   |          |   KVServer   |          |   KVServer   |</span></span>
<span class="line"><span>+--------------+          +--------------+          +--------------+</span></span>
<span class="line"><span>|     Raft     | &lt;------&gt; |     Raft     | &lt;------&gt; |     Raft     |</span></span>
<span class="line"><span>+--------------+          +--------------+          +--------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>只有 Leader 身份的 KVServer 会处理 Client 的请求。</strong></p><ul><li><strong>Client 的视角</strong>：Client 会轮询服务器。如果它向一个 Follower 发送请求，这个 KVServer 会看一眼它内部的 Raft 状态，说：“我不是 Leader，你去问节点 X”。</li><li><strong>写操作 (Put/Append)</strong>：必须由 Leader 提交到 Raft 日志，等半数以上节点确认后才能修改数据库。</li><li><strong>读操作 (Get)</strong>：为了保证读到的是最新的，Leader 也需要把 Get 作为一个日志走一遍 Raft 流程（或者使用更高级的 Read Index 机制），确保它在执行读的一刻依然是 Leader。</li></ul><h3 id="kvserver-和-raft-的交互流程" tabindex="-1"><a class="header-anchor" href="#kvserver-和-raft-的交互流程"><span>KVServer 和 Raft 的交互流程</span></a></h3><p>这是一个典型的“异步转同步”的过程，分为四个步骤：</p><ol><li><strong>提议 (Proposal)</strong>： <ul><li>Client 调用 Put(key, val)。</li><li>KVServer 收到后，调用 rf.Start(op)。</li><li>Raft 说：“好，我把它记在我的日志第 100 号位置了，但我还没确定它能不能生效。”</li></ul></li><li><strong>复制 (Replication)</strong>： <ul><li>Leader 的 Raft 开始疯狂给其他节点的 Raft 发消息：“大家快把这行字记在第 100 号位置！”</li></ul></li><li><strong>提交与应用 (Commit &amp; Apply)</strong>： <ul><li>当半数以上节点记好了，Leader 的 Raft 就会认为第 100 号日志已提交。</li><li><strong>关键点</strong>：Raft 通过 applyCh 告诉 KVServer：“第 100 号日志现在安全了，你可以执行它了。”</li></ul></li><li><strong>响应 (Reply)</strong>： <ul><li>KVServer 的 applier 协程从 applyCh 拿到消息，修改 kv.db。</li><li>KVServer 找到正在等 100 号索引的那个 RPC Handler，通过 waitCh 喊一声：“喂！做好了！”</li><li>RPC Handler 回复 Client：“成功！”</li></ul></li></ol><h3 id="分布式系统最难的就是-出事的时候-。" tabindex="-1"><a class="header-anchor" href="#分布式系统最难的就是-出事的时候-。"><span>分布式系统最难的就是“出事的时候”。</span></a></h3><h4 id="情况-a-leader-突然断网-宕机了" tabindex="-1"><a class="header-anchor" href="#情况-a-leader-突然断网-宕机了"><span>情况 A：Leader 突然断网/宕机了</span></a></h4><ul><li><strong>Raft 层</strong>：其他节点会发现 Leader 消失了，自动选出新 Leader。</li><li><strong>KVServer 层</strong>：旧 Leader 的 Handler 还在等 waitCh。由于它不再是 Leader，它的 Raft 永远不会在 applyCh 里返回那个索引。Handler 会<strong>超时</strong>（这就是你代码里 time.After 的作用），并告诉 Client：“出事了，你去问别人吧。”</li></ul><h4 id="情况-b-网络分区-脑裂" tabindex="-1"><a class="header-anchor" href="#情况-b-网络分区-脑裂"><span>情况 B：网络分区（脑裂）</span></a></h4><ul><li>假设有 5 个节点，节点 1 和 2 被隔离了。节点 1 觉得自己还是 Leader。</li><li>Client 向节点 1 发请求。节点 1 调用 rf.Start()。</li><li>但是！由于它只能联络到节点 2，凑不够 3 票（半数），这个日志永远无法 <strong>Commit</strong>。</li><li>Client 会一直等，直到超时。这保证了<strong>数据不会在错误的分区里被修改</strong>。</li></ul><h4 id="情况-c-旧指令延迟到达" tabindex="-1"><a class="header-anchor" href="#情况-c-旧指令延迟到达"><span>情况 C：旧指令延迟到达</span></a></h4><ul><li>如果一个 Append 指令因为网络延迟，在 10 秒后才到达。</li><li>KVServer 会检查 lastApplied 表。如果发现这个客户端的序列号（SeqNo）已经处理过了，它就会<strong>直接丢弃</strong>这个操作，不修改数据库，但会返回 OK（幂等性）。</li></ul><h3 id="全部流程" tabindex="-1"><a class="header-anchor" href="#全部流程"><span>全部流程</span></a></h3><ol><li><strong>Client -&gt; KVServer (RPC Handler)</strong>: <ul><li><code>Handler</code> 创建 <code>Op{Type: Append, Key: &quot;a&quot;, Val: &quot;1&quot;, ClerkId: 88, SeqNo: 5}</code>。</li><li>调用 <code>index, term, isLeader := rf.Start(op)</code>。</li><li><code>Handler</code> 创建 <code>ch := make(chan Op, 1)</code> 并存入 <code>waitChs[index]</code>。</li></ul></li><li><strong>KVServer -&gt; Raft (Log Replication)</strong>: <ul><li>Raft 在集群间同步这条日志。</li><li>此时 <code>Handler</code> 正在 <code>select { case &lt;-ch: ... }</code> 处阻塞。</li></ul></li><li><strong>Raft -&gt; KVServer (Applier Loop)</strong>: <ul><li>Raft 达成共识，把 <code>ApplyMsg{CommandIndex: 100, Command: Op{...}}</code> 塞入 <code>applyCh</code></li><li><code>Applier</code> 协程读到这条消息。</li></ul></li><li><strong>KVServer 内部状态更新</strong>: <ul><li><code>Applier</code> 检查 <code>lastApplied[88]</code>。如果当前记录的序号小于 5，则执行 <code>db[&quot;a&quot;] += &quot;1&quot;</code>。</li><li>执行完后，<code>Applier</code> 查找 <code>waitChs[100]</code>。</li><li><strong>关键动作</strong>：<code>Applier</code> 把 <code>Op</code> 发进 <code>ch</code>。</li></ul></li><li><strong>KVServer -&gt; Client (RPC Response)</strong>: <ul><li><code>Handler</code> 被唤醒，收到 <code>Op</code>。</li><li>检查收到的 <code>Op</code> 是否还是 <code>ClerkId=88, SeqNo=5</code>（防止 Index 100 已经被新 Leader 的其他命令覆盖）。</li><li>校验通过，给 Client 回复 <code>OK</code>。</li></ul></li></ol><hr><h4 id="为什么要这样设计通信" tabindex="-1"><a class="header-anchor" href="#为什么要这样设计通信"><span>为什么要这样设计通信？</span></a></h4><p>这种设计完美解决了分布式环境下的三个地雷：</p><ol><li><strong>解耦 (Decoupling)</strong>：<br> KVServer 不需要知道 Raft 是怎么同步日志的，它只需要给 Raft 一个任务，然后等 Raft 的回执。</li><li><strong>线性化 (Linearizability)</strong>：<br> 因为 <code>Applier</code> 是单线程（一个协程）处理 <code>applyCh</code> 的，这保证了所有节点执行指令的<strong>顺序完全一致</strong>。即便有 100 个 Handler 同时在跑，最终改数据库的顺序也只取决于 Raft 日志的顺序。</li><li><strong>安全性 (Safety)</strong>：<br> 即使 Leader 在同步过程中挂了，由于 Handler 校验了 <code>ClerkId</code> 和 <code>SeqNo</code>，它能敏锐地发现：“Raft 确实返回了 Index 100 的结果，但那个结果不是我之前要存的‘1’，而是别人存的‘2’。” 这样它就不会给客户端返回错误的成功信息。</li></ol><h1 id="raft-kv-在现实生活中是怎么被使用的" tabindex="-1"><a class="header-anchor" href="#raft-kv-在现实生活中是怎么被使用的"><span>RAFT KV 在现实生活中是怎么被使用的</span></a></h1><p>假设我有五台机器 下面管理了上千个GPU机器 用来训练模型</p><p>KV RAFT其实只对外提供两个接口 一个是PUT 一个是GET 但是他能保证</p><ul><li>线性一致性：只要有一个PUT成功了 剩下任何人 在任何地方 调用GET 一定能够得到这个一样的值</li><li>高可用性：这五个管理者如果有三个可用 就能够正常进行服务</li><li>持久性与唯一性</li></ul><h3 id="一、-这-5-台机器-kv-raft-在地理上分布在哪里" tabindex="-1"><a class="header-anchor" href="#一、-这-5-台机器-kv-raft-在地理上分布在哪里"><span>一、 这 5 台机器（KV-Raft）在地理上分布在哪里？</span></a></h3><p>在现实世界中，这 5 台机器的物理位置取决于你对 <strong>“容灾”</strong> 的要求。</p><ol><li><p><strong>同机房分布（LAN）</strong>：</p><ul><li>放在一个机房的 5 个不同机架上。</li><li><strong>优点</strong>：速度极快，延迟 &lt; 1ms。</li><li><strong>缺点</strong>：如果整个机房着火或断电，系统就彻底挂了。</li></ul></li><li><p><strong>跨可用区分布（Multi-AZ）</strong>：</p><ul><li>在同一个城市（比如北京），分布在 3 个不同的数据中心（机房 A、B、C）。</li><li><strong>优点</strong>：能抵御单个机房级别的故障。</li><li><strong>这种最常见</strong>（比如 AWS 或阿里云的典型架构）。</li></ul></li><li><p><strong>跨地域/全球分布（Geo-Distributed）</strong>：</p><ul><li>比如 1 台在纽约，1 台在伦敦，1 台在东京，2 台在新加坡。</li><li><strong>优点</strong>：能抵御战争、地震等区域性灾难。</li><li><strong>缺点</strong>：非常慢！因为光速限制，Raft 达成共识（多数派确认）可能需要几百毫秒。Google 的 <strong>Spanner</strong> 数据库就是这种架构。</li></ul></li></ol><hr><h3 id="二、-只有-put-和-get-怎么管理几千台-gpu" tabindex="-1"><a class="header-anchor" href="#二、-只有-put-和-get-怎么管理几千台-gpu"><span>二、 只有 <code>Put</code> 和 <code>Get</code>，怎么管理几千台 GPU？</span></a></h3><p>这听起来不可思议，但<strong>全世界最复杂的集群管理系统（如 Kubernetes）正是这么干的。</strong></p><p>Kubernetes 底层用的是 <strong>etcd</strong>，而 etcd 本质上和现在写的 <strong>KV-Raft</strong> 几乎一模一样。</p><h4 id="_1-它是如何通过两个方法管理集群的" tabindex="-1"><a class="header-anchor" href="#_1-它是如何通过两个方法管理集群的"><span>1. 它是如何通过两个方法管理集群的？</span></a></h4><p>秘诀在于：<strong>所有的管理指令，在本质上都是“状态的变化”。</strong></p><ul><li><p><strong>场景：给 GPU 1 号分配一个 AI 训练任务</strong></p><ul><li><strong>包工头（Scheduler）</strong> 并不需要直接给 GPU 发消息。</li><li><strong>包工头</strong> 只需调用你的 <code>Put(&quot;GPU_001_Assignment&quot;, &quot;{task: &#39;Training_Cat_Model&#39;, data: &#39;s3://bucket/data&#39;}&quot;)</code>。</li><li><strong>GPU 1 号</strong> 上的 Agent 程序（就像一个 Clerk）一直在后台不停地调你的 <code>Get(&quot;GPU_001_Assignment&quot;)</code>（这种技术叫轮询或长轮询）。</li><li>一旦 GPU 发现内容变了，它就自己去下载数据开始干活。</li></ul></li><li><p><strong>场景：GPU 坏了怎么办？</strong></p><ul><li>GPU 上的 Agent 定期调你的 <code>Put(&quot;GPU_001_Status&quot;, &quot;Healthy_12:00:05&quot;)</code>。</li><li><strong>包工头</strong> 调 <code>Get(&quot;GPU_001_Status&quot;)</code>。如果发现时间很久没更新了，包工头就知道它挂了，于是再发一个 <code>Put</code> 把任务指派给别人。</li></ul></li></ul><h4 id="_2-为什么只给两个方法" tabindex="-1"><a class="header-anchor" href="#_2-为什么只给两个方法"><span>2. 为什么只给两个方法？</span></a></h4><p>因为 <strong>“简单即力量”</strong>。<br> 如果接口太复杂（比如包含 <code>StartTraining()</code>, <code>StopTraining()</code>），那么你的 KV-Raft 就只能用于 AI 训练。<br> 但如果你只提供 <code>Put</code> 和 <code>Get</code>，你就创造了一个<strong>通用的真理之源</strong>。它既可以管理 GPU 集群，也可以管理银行账本，还可以管理自动驾驶汽车的调度。</p><hr><h3 id="三、-总结-这种架构的-全局视角" tabindex="-1"><a class="header-anchor" href="#三、-总结-这种架构的-全局视角"><span>三、 总结：这种架构的“全局视角”</span></a></h3><ol><li><p><strong>底层：KV-Raft (大脑)</strong><br> 这 5 台机器缩在数据中心的一个小角落里。它们虽然只有 5 台，但它们通过 Raft 算法产生了一个 <strong>“统一的幻觉”</strong>：大家都看到一模一样的 <code>Put/Get</code> 记录。</p></li><li><p><strong>中间层：Clerk (神经末梢)</strong><br> 分布在全球各地的 1000 台 GPU 机器上，都跑着你写的 <code>Clerk</code> 代码。它们像触角一样，时刻连接着这 5 台核心机器。</p></li><li><p><strong>运作过程：</strong></p><ul><li>无论地理分布多广，所有的 GPU 机器都认准这 5 台机器。</li><li>当 Leader 发生切换，全球各地的 <code>Clerk</code> 会自动重定向请求。</li><li><strong>地理广度</strong>由 <code>Clerk</code> 负责连接，<strong>数据的一致性</strong>由你的 5 台机器负责死守。</li></ul></li></ol><h1 id="shard-kv" tabindex="-1"><a class="header-anchor" href="#shard-kv"><span>Shard KV</span></a></h1><p>目的是实现了一个功能完备、<strong>可水平扩展（Horizontal Scalability）</strong> 且具有<strong>强一致性</strong>的分布式分片键值数据库。</p><h3 id="目的" tabindex="-1"><a class="header-anchor" href="#目的"><span>目的</span></a></h3><p>得到的是一个能够<strong>自动负载均衡</strong>的数据存储系统。</p><ul><li><strong>可伸缩性</strong>：如果你发现系统压力大，只需启动一组新的 KVServer 副本组，然后向 ShardCtrler 发送一个 <code>Join</code> 命令。系统会自动把一部分分片从旧机器迁移到新机器，整个过程对用户近乎透明。</li><li><strong>高可用性</strong>：每个副本组（Group）内部运行 Raft 协议。即使某个组掉线了一两台机器，只要大多数存活，该分片的数据依然可读写。</li><li><strong>强一致性</strong>：通过 Raft 和分片迁移时的状态同步，系统保证了线性一致性。</li></ul><hr><h3 id="用户如何与数据库交互" tabindex="-1"><a class="header-anchor" href="#用户如何与数据库交互"><span>用户如何与数据库交互？</span></a></h3><p>作为终端用户，你不需要手动去联系 Controller。这些复杂的逻辑都被封装在 <code>shardkv/client.go</code> 的 <strong><code>Clerk</code></strong> 结构体中。</p><p>从用户的视角来看，代码是这样的：</p><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ck</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> shardkv</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">MakeClerk</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ctrlers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">ck</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Put</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user_1_name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;Alice&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)  </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 用户只关心 Key 和 Value</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">val</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> :=</span><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;"> ck</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">Get</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;user_1_name&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">)     </span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 用户不关心数据在哪</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="底层交互的全过程-clerk-帮你做了什么" tabindex="-1"><a class="header-anchor" href="#底层交互的全过程-clerk-帮你做了什么"><span>底层交互的全过程（Clerk 帮你做了什么）</span></a></h3><p>当你调用 <code>ck.Get(&quot;user_1_name&quot;)</code> 时，内部发生了以下步骤：</p><ol><li><p><strong>计算分片 (Hashing)</strong>：<br><code>Clerk</code> 调用 <code>key2shard(&quot;user_1_name&quot;)</code>，根据 Key 的哈希值算出这个 Key 属于哪个 <strong>Shard</strong>（比如 Shard 4）。</p></li><li><p><strong>获取路由表 (Querying Ctrler)</strong>：</p><ul><li><code>Clerk</code> 会检查本地缓存的 <code>Config</code>。</li><li>如果缓存为空或者版本太旧，<code>Clerk</code> 会给 <strong>ShardCtrler</strong> 发送一个 <code>Query(-1)</code> 请求。</li><li>ShardCtrler 回复：“现在的配置是第 5 版，Shard 4 归 <strong>Group 102</strong> 管，这个组的服务器地址是 <code>[10.0.0.1, 10.0.0.2]</code>。”</li></ul></li><li><p><strong>定位服务器 (Routing)</strong>：<br><code>Clerk</code> 在本地记录下：Shard 4 -&gt; Group 102。然后随机选择 Group 102 中的一台服务器发送 <code>Get</code> 请求。</p></li><li><p><strong>处理配置变更 (Error Handling)</strong>：<br> 这是最关键的一步。如果在你发送请求的同时，管理员把这个分片移到了 Group 103：</p><ul><li>Group 102 的服务器收到请求后，发现自己已经不负责 Shard 4 了，会返回一个 <strong><code>ErrWrongGroup</code></strong> 错误。</li><li><code>Clerk</code> 收到这个错误后，意识到“配置变了！”，它会<strong>重新向 ShardCtrler 发送 <code>Query</code></strong> 获取最新路由。</li><li>获取新路由后，<code>Clerk</code> 自动重试发送请求到新的 Group 103。</li><li><strong>这一切对调用 <code>ck.Get</code> 的用户来说是完全无感的</strong>。</li></ul></li></ol><hr><h3 id="角色分配" tabindex="-1"><a class="header-anchor" href="#角色分配"><span>角色分配</span></a></h3><ul><li><strong>ShardCtrler (大脑)</strong>：配置中心。它只存“地图”（哪个分片在哪），不存实际的业务 Key-Value 数据。</li><li><strong>ShardKV Group (肌肉)</strong>：数据中心。它存储实际的 Key-Value。它会定期向大脑同步“地图”，并根据地图把数据搬运给其他的 Group。</li><li><strong>Clerk (导航仪)</strong>：客户端库。它负责查地图、带路、并在路不通（配置改变）时自动重新查地图并绕路。</li></ul><p>如果你是一个运维人员，你只需要监控服务器负载。一旦发现 Group A 负载过高，你就去启动 Group B，然后给 ShardCtrler 发一个 <code>Join</code>。剩下的数据迁移、请求重定向，全靠你现在写的这套代码自动完成。这就是<strong>自动化运维</strong>和<strong>弹性伸缩</strong>的魅力。</p><h2 id="代码实现——controller" tabindex="-1"><a class="header-anchor" href="#代码实现——controller"><span>代码实现——controller</span></a></h2><h2 id="代码实现——shardkv-server" tabindex="-1"><a class="header-anchor" href="#代码实现——shardkv-server"><span>代码实现——ShardKV server</span></a></h2><h3 id="shardkv结构" tabindex="-1"><a class="header-anchor" href="#shardkv结构"><span>ShardKV结构</span></a></h3><div class="language-go line-numbers-mode" data-highlighter="shiki" data-ext="go" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-go"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">type</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ShardKV</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	mu</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">      sync</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">RWMutex</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">       </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	dead</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int32</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">              </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	rf</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">      *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">         </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	applyCh</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> chan</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ApplyMsg</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	makeEnd</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">string</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) </span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">labrpc</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ClientEnd</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	gid</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">     int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">                            </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	sc</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">      *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">shardctrler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Clerk</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">             </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	maxRaftState</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	lastApplied</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">  int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	lastConfig</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">    shardctrler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	currentConfig</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> shardctrler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Config</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 分片状态机：每个分片独立存储</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	Shards</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> [</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">shardctrler</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">NShards</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Shard</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">  </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 客户端去重：ClientId -&gt; 操作上下文</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	lastOperations</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int64</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">OperationContext</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 通知通道：LogIndex -&gt; 等待该日志应用的通道</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	notifyChans</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">chan</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">CommandResponse</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 缓存从其他组接收到的待应用分片数据（RPC收到但尚未通过 Raft 应用）</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 当配置变更命令被应用时，从这里读取数据进行迁移</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	incomingShards</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;">*</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">ShardMigration</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // ShardID -&gt; 迁移数据</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">	</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// 用于持久化（Snapshot）</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">	persister</span><span style="--shiki-light:#383A42;--shiki-dark:#C678DD;"> *</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">raft</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Persister</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">type</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Shard</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> struct</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    KV</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    map</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">[</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">string</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">]</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">string</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // 该分片的键值存储</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E06C75;">    State</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ShardState</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">         // 分片当前状态</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="快照内容设计" tabindex="-1"><a class="header-anchor" href="#快照内容设计"><span>快照内容设计</span></a></h3><table><thead><tr><th>字段</th><th>是否快照</th><th>原因</th></tr></thead><tbody><tr><td><strong><code>Shards</code></strong></td><td>✅ <strong>必须</strong></td><td>核心业务数据，存储所有分片的KV对和状态(Serving/Pulling等)。重启后必须恢复，否则数据丢失。</td></tr><tr><td><strong><code>lastOperations</code></strong></td><td>✅ <strong>必须</strong></td><td>客户端去重表。若重启后丢失，同一个客户端重发旧请求会被重复执行，违反线性一致性。</td></tr><tr><td><strong><code>currentConfig</code></strong></td><td>✅ <strong>必须</strong></td><td>当前配置版本。必须知道当前处于哪个配置阶段，才能正确处理新请求和迁移。</td></tr><tr><td><strong><code>lastConfig</code></strong></td><td>✅ <strong>必须</strong></td><td>上一个配置。用于对比检测配置变更，以及计算需要迁移哪些分片。</td></tr><tr><td><strong><code>lastApplied</code></strong></td><td>✅ <strong>必须</strong></td><td>最后应用的Raft日志索引。恢复后用于防止重复应用已快照的日志。</td></tr><tr><td><code>incomingShards</code></td><td>❌ 不需要</td><td>临时缓存，仅用于接收RPC数据后、Raft应用前的过渡。重启后为空即可，丢失后可通过重新拉取恢复。</td></tr><tr><td><code>notifyChans</code></td><td>❌ 不需要</td><td>内存中的通知通道，用于RPC等待Raft应用。重启后无等待中的RPC，初始化为空map即可。</td></tr><tr><td><code>dead</code></td><td>❌ 不需要</td><td>运行时状态，Kill()时设置，重启后默认为0。</td></tr><tr><td><code>sc</code> (clerk)</td><td>❌ 不需要</td><td>可重新创建，无状态。</td></tr><tr><td><code>rf</code>, <code>applyCh</code></td><td>❌ 不需要</td><td>Raft实例和通道，运行时重建。</td></tr></tbody></table>`,250)])])}const r=i(t,[["render",e]]),d=JSON.parse(`{"path":"/courses/6.5840.html","title":"MIT 6.5840 分布式系统","lang":"zh-CN","frontmatter":{"title":"MIT 6.5840 分布式系统","icon":"share-2","description":"MapReduce 要把大象装冰箱（处理 PB 级数据），分三步： Split (切分): 把大文件切成无数个 64MB 的小块 (Input Splits)。 Map (映射): 把小块转化成 <Key, Value> 对。 Reduce (归约): 把相同 Key 的数据聚在一起处理。 场景： 统计单词频率 (Word Count)。 Map 阶段...","head":[["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"MIT 6.5840 分布式系统\\",\\"image\\":[\\"\\"],\\"dateModified\\":\\"2026-02-13T06:35:50.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"yedou\\",\\"url\\":\\"https://yedou37.github.io\\"}]}"],["meta",{"property":"og:url","content":"https://yedou37.github.io/courses/6.5840.html"}],["meta",{"property":"og:site_name","content":"Yedou's Notebook"}],["meta",{"property":"og:title","content":"MIT 6.5840 分布式系统"}],["meta",{"property":"og:description","content":"MapReduce 要把大象装冰箱（处理 PB 级数据），分三步： Split (切分): 把大文件切成无数个 64MB 的小块 (Input Splits)。 Map (映射): 把小块转化成 <Key, Value> 对。 Reduce (归约): 把相同 Key 的数据聚在一起处理。 场景： 统计单词频率 (Word Count)。 Map 阶段..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2026-02-13T06:35:50.000Z"}],["meta",{"property":"article:modified_time","content":"2026-02-13T06:35:50.000Z"}]]},"git":{"createdTime":1769599712000,"updatedTime":1770964550000,"contributors":[{"name":"yedou37","username":"yedou37","email":"137401103+yedou37@users.noreply.github.com","commits":8,"url":"https://github.com/yedou37"}]},"readingTime":{"minutes":39.06,"words":11717},"filePathRelative":"courses/6.5840.md","autoDesc":true}`);export{r as comp,d as data};
