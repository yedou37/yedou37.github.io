<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.26" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.102" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme="dark"] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"cppçŸ¥è¯†","image":[""],"dateModified":"2026-02-13T13:37:57.000Z","author":[{"@type":"Person","name":"yedou","url":"https://yedou37.github.io"}]}</script><meta property="og:url" content="https://yedou37.github.io/interview/cpp.html"><meta property="og:site_name" content="Yedou's Notebook"><meta property="og:title" content="cppçŸ¥è¯†"><meta property="og:description" content="thread_local å…³é”®å­— ç±»ï¼ˆClassï¼‰æ²¡æœ‰çº¿ç¨‹ï¼Œåªæœ‰æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰æœ‰çº¿ç¨‹ã€‚ é”™è¯¯ç†è§£ï¼šæ¯ä¸€ä¸ª FileDescriptor å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ æ­£ç¡®ç†è§£ï¼šä½ çš„ç¨‹åºå¯èƒ½å¯åŠ¨äº† 10 ä¸ªçº¿ç¨‹ï¼Œè¿™ 10 ä¸ªçº¿ç¨‹å¯èƒ½ä¼šæ“ä½œåŒä¸€ä¸ª FileDescriptor å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ“ä½œ 1000 ä¸ªä¸åŒçš„ FileDescriptor å¯¹è±¡ã€‚ static ..."><meta property="og:type" content="article"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2026-02-13T13:37:57.000Z"><meta property="article:modified_time" content="2026-02-13T13:37:57.000Z"><link rel="icon" href="/logo.jpg"><title>cppçŸ¥è¯† | Yedou's Notebook</title><meta name="description" content="thread_local å…³é”®å­— ç±»ï¼ˆClassï¼‰æ²¡æœ‰çº¿ç¨‹ï¼Œåªæœ‰æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰æœ‰çº¿ç¨‹ã€‚ é”™è¯¯ç†è§£ï¼šæ¯ä¸€ä¸ª FileDescriptor å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹ æ­£ç¡®ç†è§£ï¼šä½ çš„ç¨‹åºå¯èƒ½å¯åŠ¨äº† 10 ä¸ªçº¿ç¨‹ï¼Œè¿™ 10 ä¸ªçº¿ç¨‹å¯èƒ½ä¼šæ“ä½œåŒä¸€ä¸ª FileDescriptor å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ“ä½œ 1000 ä¸ªä¸åŒçš„ FileDescriptor å¯¹è±¡ã€‚ static ...">
    <link rel="preload" href="/assets/style-CVnMh6PC.css" as="style"><link rel="stylesheet" href="/assets/style-CVnMh6PC.css">
    <link rel="modulepreload" href="/assets/app-DErs339O.js"><link rel="modulepreload" href="/assets/cpp.html-BvbMhLku.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><!--[--><div class="theme-container no-navbar external-link-icon has-toc" vp-container><!----><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar" vp-sidebar><!----><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/" aria-label="æˆ‘çš„ç¬”è®°åº“"><!---->æˆ‘çš„ç¬”è®°åº“<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><iconify-icon class="vp-icon" icon="fa6-solid:folder-open" sizing="both" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">åŸºç¡€çŸ¥è¯†æ¦‚è§ˆ</span><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/interview/cpp.html" aria-label="cppçŸ¥è¯†"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:code-xml" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->cppçŸ¥è¯†<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/interview/Leetcode.html" aria-label="Leetcode"><!---->Leetcode<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/interview/OS.html" aria-label="OS"><!---->OS<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/interview/network.html" aria-label="è®¡ç®—æœºç½‘ç»œ"><!--[--><iconify-icon class="vp-icon" icon="fa6-solid:network-wired" sizing="both" width="1em" height="1em"></iconify-icon><!--]-->è®¡ç®—æœºç½‘ç»œ<!----></a></li></ul></section></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable" type="button"><iconify-icon class="vp-icon" icon="fa6-solid:folder-open" sizing="both" width="1em" height="1em"></iconify-icon><span class="vp-sidebar-title">è¯¾ç¨‹ç¬”è®°æ¦‚è§ˆ</span><span class="vp-arrow end"></span></button><!----></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><iconify-icon class="vp-icon" icon="fa6-solid:code-xml" sizing="height" height="1em"></iconify-icon>cppçŸ¥è¯†</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="page-author-item" href="https://yedou37.github.io" target="_blank" rel="noopener noreferrer">yedou</a></span><span property="author" content="yedou"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span data-allow-mismatch="text">2026/1/26</span><meta property="datePublished" content="2026-01-26T09:00:21.000Z"></span><!----><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 33 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT33M"></span><!----><!----></div><hr></div><!----><div class="" vp-content><!----><div id="markdown-content"><hr><h1 id="thread-local-å…³é”®å­—" tabindex="-1"><a class="header-anchor" href="#thread-local-å…³é”®å­—"><span>thread_local å…³é”®å­—</span></a></h1><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">size_t</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> write</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">cosnt</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> StringViewRange</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto&amp;&amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> buffers</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> thread_local</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::vector</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">iovec</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> iovecs;</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">	// buffer -&gt; iovecs</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">	return</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> write</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(iovecs, total_size);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>[çº¿ç¨‹ A çš„å†…å­˜è§†è§’]</span></span>
<span class="line"><span>+---------------------+</span></span>
<span class="line"><span>| å¯„å­˜å™¨ fs           | ---&gt; æŒ‡å‘ TLS åŒºåŸŸ</span></span>
<span class="line"><span>+---------------------+</span></span>
<span class="line"><span>| TLS åŒºåŸŸ (Thread Local Storage)</span></span>
<span class="line"><span>| [ iovecs_A (24å­—èŠ‚) ] --------+</span></span>
<span class="line"><span>+---------------------+         | æŒ‡é’ˆæŒ‡å‘</span></span>
<span class="line"><span>                                v</span></span>
<span class="line"><span>                      +--------------------------+</span></span>
<span class="line"><span>                      | å † (Heap)                |</span></span>
<span class="line"><span>                      | [ iovec, iovec, ... ]    | &lt;--- è¿™é‡Œçš„å†…å­˜è¢«åå¤åˆ©ç”¨</span></span>
<span class="line"><span>                      +--------------------------+</span></span>
<span class="line"><span></span></span>
<span class="line"><span>-------------------------------------------------------</span></span>
<span class="line"><span></span></span>
<span class="line"><span>[çº¿ç¨‹ B çš„å†…å­˜è§†è§’]</span></span>
<span class="line"><span>+---------------------+</span></span>
<span class="line"><span>| å¯„å­˜å™¨ fs           | ---&gt; æŒ‡å‘ çº¿ç¨‹ B è‡ªå·±çš„ TLS</span></span>
<span class="line"><span>+---------------------+</span></span>
<span class="line"><span>| TLS åŒºåŸŸ</span></span>
<span class="line"><span>| [ iovecs_B (24å­—èŠ‚) ] --------+</span></span>
<span class="line"><span>+---------------------+         | æŒ‡é’ˆæŒ‡å‘ä¸åŒçš„å †åœ°å€</span></span>
<span class="line"><span>                                v</span></span>
<span class="line"><span>                      +--------------------------+</span></span>
<span class="line"><span>                      | å † (Heap)                |</span></span>
<span class="line"><span>                      | [ iovec, iovec, ... ]    |</span></span>
<span class="line"><span>                      +--------------------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç±»ï¼ˆClassï¼‰æ²¡æœ‰çº¿ç¨‹ï¼Œåªæœ‰æ“ä½œç³»ç»Ÿï¼ˆOSï¼‰æœ‰çº¿ç¨‹ã€‚</strong></p><ul><li><p><strong>é”™è¯¯ç†è§£</strong>ï¼šæ¯ä¸€ä¸ªÂ FileDescriptorÂ å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹</p></li><li><p><strong>æ­£ç¡®ç†è§£</strong>ï¼šä½ çš„ç¨‹åºå¯èƒ½å¯åŠ¨äº† 10 ä¸ªçº¿ç¨‹ï¼Œè¿™ 10 ä¸ªçº¿ç¨‹å¯èƒ½ä¼šæ“ä½œåŒä¸€ä¸ªÂ FileDescriptorÂ å¯¹è±¡ï¼Œä¹Ÿå¯èƒ½æ“ä½œ 1000 ä¸ªä¸åŒçš„Â FileDescriptorÂ å¯¹è±¡ã€‚<br><strong>static thread_localÂ çš„å«ä¹‰æ˜¯ï¼š</strong><br> ä¸ç®¡ä½ åˆ›å»ºäº†å¤šå°‘ä¸ªÂ FileDescriptorÂ å¯¹è±¡ï¼ˆå“ªæ€• 1 ä¸‡ä¸ªï¼‰ï¼Œ<strong>åªè¦å®ƒä»¬æ˜¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼ˆThread Aï¼‰é‡Œè¿è¡Œçš„Â writeÂ å‡½æ•°ï¼Œå®ƒä»¬å°±å…±äº«åŒä¸€ä¸ªÂ iovecsÂ å˜é‡ã€‚</strong></p></li><li><p><strong>åœºæ™¯ 1</strong>ï¼šçº¿ç¨‹ A é‡Œçš„Â socket1Â è°ƒäº†Â writeï¼Œæ¥ç€Â socket2Â ä¹Ÿè°ƒäº†Â writeã€‚</p><ul><li>ç»“æœï¼šsocket2Â ä¼š<strong>å¤ç”¨</strong>Â socket1Â åˆšåˆšç”¨è¿‡çš„é‚£å—å†…å­˜ï¼ˆå‰ææ˜¯Â socket1Â ç”¨å®Œå vector è¢« clear äº†ï¼Œä½† capacity è¿˜åœ¨ï¼‰ã€‚æ•ˆç‡æé«˜ï¼</li></ul></li><li><p><strong>åœºæ™¯ 2</strong>ï¼šçº¿ç¨‹ A é‡Œçš„Â socket1Â å’Œçº¿ç¨‹ B é‡Œçš„Â socket1Â åŒæ—¶è°ƒÂ writeã€‚</p><ul><li>ç»“æœï¼šçº¿ç¨‹ A ç”¨çš„æ˜¯Â iovecs_Aï¼Œçº¿ç¨‹ B ç”¨çš„æ˜¯Â iovecs_Bã€‚äº’ä¸å¹²æ‰°ï¼Œä¸éœ€è¦åŠ é”ã€‚</li></ul></li><li><p><strong>å‡ºç”Ÿï¼ˆæ„é€ ï¼‰</strong>ï¼š</p><ul><li>å½“<strong>æŸä¸ªçº¿ç¨‹ç¬¬ä¸€æ¬¡</strong>è¿è¡Œåˆ°Â writeÂ å‡½æ•°å†…éƒ¨çš„é‚£ä¸€è¡Œä»£ç æ—¶ï¼Œè¿™ä¸ªçº¿ç¨‹ä¸“å±çš„Â iovecsÂ è¢«æ„é€ ã€‚</li><li>å¦‚æœä½ æœ‰ 10 ä¸ªçº¿ç¨‹ï¼Œä½†åªæœ‰ 3 ä¸ªçº¿ç¨‹è°ƒç”¨è¿‡Â writeï¼Œé‚£å°±åªæœ‰ 3 ä¸ªÂ iovecsÂ è¢«åˆ›å»ºã€‚</li></ul></li><li><p><strong>å­˜æ´»</strong>ï¼š</p><ul><li>åªè¦è¿™ä¸ª<strong>çº¿ç¨‹</strong>è¿˜æ´»ç€ï¼Œè¿™ä¸ªå˜é‡å°±ä¸€ç›´æ´»ç€ï¼ˆä¿ç•™ç€å †å†…å­˜ï¼‰ã€‚</li><li>å®ƒ<strong>ä¸éšå¯¹è±¡çš„é”€æ¯è€Œé”€æ¯</strong>ã€‚å³ä½¿ä½ æŠŠæ‰€æœ‰çš„Â FileDescriptorÂ å¯¹è±¡éƒ½ææ„äº†ï¼Œåªè¦çº¿ç¨‹è¿˜åœ¨ï¼Œè¿™ä¸ªÂ iovecsÂ ä¾ç„¶å ç€å†…å­˜ç­‰å¾…ä¸‹ä¸€æ¬¡å¬å”¤ã€‚</li></ul></li><li><p><strong>æ­»äº¡ï¼ˆææ„ï¼‰</strong>ï¼š</p><ul><li>å½“<strong>çº¿ç¨‹é€€å‡ºï¼ˆThread Exitï¼‰</strong> æ—¶ã€‚</li><li>C++ è¿è¡Œæ—¶ç¯å¢ƒä¼šè‡ªåŠ¨éå†è¯¥çº¿ç¨‹æ‰€æœ‰çš„Â thread_localÂ å˜é‡ï¼Œè°ƒç”¨å®ƒä»¬çš„ææ„å‡½æ•°ï¼Œä»è€Œé‡Šæ”¾é‚£å—å †å†…å­˜ï¼Œæœ€åæ¸…ç† TLS é‡Œçš„å¤´ä¿¡æ¯ã€‚</li></ul></li></ul><h3 id="static-æ˜¯ä»€ä¹ˆæ„æ€-åœ¨å‡½æ•°å†…éƒ¨" tabindex="-1"><a class="header-anchor" href="#static-æ˜¯ä»€ä¹ˆæ„æ€-åœ¨å‡½æ•°å†…éƒ¨"><span>staticÂ æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿï¼ˆåœ¨å‡½æ•°å†…éƒ¨ï¼‰</span></a></h3><p>å½“Â staticÂ ç”¨äºå‡½æ•°å†…éƒ¨çš„å±€éƒ¨å˜é‡æ—¶ï¼Œå®ƒæ”¹å˜çš„æ˜¯å˜é‡çš„Â <strong>ç”Ÿå‘½å‘¨æœŸï¼ˆLifecycleï¼‰</strong>Â å’ŒÂ <strong>å­˜å‚¨ä½ç½®</strong>ã€‚</p><ul><li><strong>æ™®é€šå±€éƒ¨å˜é‡</strong>Â (int a = 0;) <ul><li><strong>å­˜å‚¨ä½ç½®</strong>ï¼šæ ˆï¼ˆStackï¼‰ã€‚</li><li><strong>ç”Ÿå‘½å‘¨æœŸ</strong>ï¼šå‡½æ•°è¢«è°ƒç”¨æ—¶åˆ›å»ºï¼Œå‡½æ•°è¿”å›æ—¶é”€æ¯ã€‚ä¸‹æ¬¡è°ƒç”¨æ—¶æ˜¯å…¨æ–°çš„ã€‚</li><li><strong>æ¯”å–»</strong>ï¼šä¾¿åˆ©è´´ã€‚ç”¨å®Œå°±æ’•äº†æ‰”æ‰ã€‚</li></ul></li><li><strong>é™æ€å±€éƒ¨å˜é‡</strong>Â (static int a = 0;)ï¼š <ul><li><strong>å­˜å‚¨ä½ç½®</strong>ï¼šæ•°æ®æ®µï¼ˆData Segment / BSSï¼‰ã€‚</li><li><strong>ç”Ÿå‘½å‘¨æœŸ</strong>ï¼š<strong>æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸé—´</strong>ã€‚å®ƒåœ¨ç¨‹åºç¬¬ä¸€æ¬¡è¿è¡Œåˆ°è¿™è¡Œä»£ç æ—¶åˆå§‹åŒ–ï¼Œç›´åˆ°ç¨‹åºç»“æŸæ‰é”€æ¯ã€‚</li><li><strong>æ¯”å–»</strong>ï¼šå¢™ä¸Šçš„ç™½æ¿ã€‚ä½ å†™äº†å­—ï¼Œç¦»å¼€æˆ¿é—´å†å›æ¥ï¼Œå­—è¿˜åœ¨é‚£é‡Œã€‚</li></ul></li></ul><hr><h3 id="thread-local-æ˜¯ä»€ä¹ˆæ„æ€" tabindex="-1"><a class="header-anchor" href="#thread-local-æ˜¯ä»€ä¹ˆæ„æ€"><span>thread_localÂ æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</span></a></h3><p>å®ƒæ”¹å˜çš„æ˜¯å˜é‡çš„Â <strong>å®ä¾‹æ•°é‡</strong>Â å’ŒÂ <strong>å½’å±æƒ</strong>ã€‚</p><ul><li><strong>æ²¡æœ‰ thread_local</strong>ï¼š <ul><li>å…¨å±€åªæœ‰ä¸€ä»½ï¼ˆå¦‚æœæ˜¯ staticï¼‰ã€‚æ‰€æœ‰çº¿ç¨‹çœ‹åˆ°çš„éƒ½æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œæ”¹çš„ä¹Ÿæ˜¯åŒä¸€ä¸ªã€‚</li><li><strong>åæœ</strong>ï¼šå¤šçº¿ç¨‹åŒæ—¶æ”¹ä¼šæ‰“æ¶ï¼ˆData Raceï¼‰ï¼Œå¿…é¡»åŠ é”ã€‚</li></ul></li><li><strong>æœ‰ thread_local</strong>ï¼š <ul><li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä»½ç‹¬ç«‹çš„æ‹·è´ã€‚</li><li><strong>ç”Ÿå‘½å‘¨æœŸ</strong>ï¼š<strong>ä¸çº¿ç¨‹ç»‘å®š</strong>ã€‚çº¿ç¨‹å¯åŠ¨ï¼ˆæˆ–ç¬¬ä¸€æ¬¡ä½¿ç”¨ï¼‰æ—¶åˆ›å»ºï¼Œçº¿ç¨‹ç»“æŸæ—¶é”€æ¯ã€‚</li></ul></li></ul><hr><h1 id="std-unique-ptr-std-make-unique" tabindex="-1"><a class="header-anchor" href="#std-unique-ptr-std-make-unique"><span><code>std::unique_ptr&lt;&gt; std::make_unique&lt;&gt;()</code></span></a></h1><ol><li><strong><code>std::unique_ptr</code>Â (éœ¸é“æ€»è£)</strong>ï¼š <ul><li>å®ƒæ˜¯<strong>ç®¡ç†è€…</strong>ã€‚</li><li>å®ƒçš„åº§å³é“­æ˜¯ï¼šâ€œ<strong>è¿™å—å†…å­˜æ˜¯æˆ‘çš„ï¼Œåªèƒ½æ˜¯æˆ‘çš„ï¼Œè°ä¹Ÿåˆ«æƒ³å¤åˆ¶ï¼Œä½†æˆ‘æ­»äº†è¿™å—å†…å­˜ä¹Ÿåˆ«æƒ³æ´»ã€‚</strong>â€</li><li>å®ƒé€šè¿‡ RAIIï¼ˆèµ„æºè·å–å³åˆå§‹åŒ–ï¼‰æœºåˆ¶ï¼Œä¿è¯å‡ºäº†ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾å†…å­˜ã€‚</li></ul></li><li><strong><code>std::make_unique</code>Â (ä¸“å±å·¥å‚)</strong>ï¼š <ul><li>å®ƒæ˜¯<strong>ç”Ÿäº§è€…</strong>ã€‚</li><li>å®ƒçš„ä½œç”¨æ˜¯ï¼šâ€œ<strong>åˆ«è‡ªå·±çæŠ˜è…¾å»Â newÂ äº†ï¼ŒæŠŠè¦æ±‚å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¸®ä½ é€ å¥½æ‰“åŒ…é€ç»™ä½ ã€‚</strong>â€</li><li>å®ƒæ˜¯ C++14 å¼•å…¥çš„è¾…åŠ©å‡½æ•°ï¼Œç”¨æ¥ç”ŸæˆÂ <code>unique_ptr</code>ã€‚<br> ç‹¬å æ‰€æœ‰æƒ-&gt;ä¸èƒ½æ‹·è´ åªèƒ½ç§»åŠ¨<br> é›¶å¼€é”€</li></ul></li></ol><ul><li>unique_ptrÂ å†…éƒ¨åªå­˜äº†ä¸€ä¸ªè£¸æŒ‡é’ˆã€‚</li><li>å¦‚æœä½ ä¸ä½¿ç”¨è‡ªå®šä¹‰åˆ é™¤å™¨ï¼ˆDeleterï¼‰ï¼Œå®ƒçš„å¤§å°å’ŒÂ int*Â å®Œå…¨ä¸€æ ·ï¼ˆ64ä½ç³»ç»Ÿä¸‹å°±æ˜¯ 8 å­—èŠ‚ï¼‰ã€‚</li><li>å®ƒçš„è§£å¼•ç”¨æ“ä½œÂ *ptrÂ å’ŒÂ ptr-&gt;Â ä¼šè¢«ç¼–è¯‘å™¨ä¼˜åŒ–æˆå’Œè£¸æŒ‡é’ˆä¸€æ¨¡ä¸€æ ·çš„æ±‡ç¼–æŒ‡ä»¤</li></ul><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">process</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unique_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()), std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unique_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">()));</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>C++ ç¼–è¯‘å™¨åœ¨ç¼–è¯‘è¿™è¡Œä»£ç æ—¶ï¼Œæ‰§è¡Œé¡ºåºæ˜¯ä¸ç¡®å®šçš„ï¼ˆUnspecified Evaluation Orderï¼‰ã€‚å®ƒå¯èƒ½è¿™æ ·æ‰§è¡Œï¼š</p><ol><li>new A()Â åˆ†é…æˆåŠŸã€‚</li><li><strong>æ‰§è¡ŒÂ new B()Â â€”â€” æ­¤æ—¶å†…å­˜ä¸è¶³æŠ›å‡ºå¼‚å¸¸ï¼</strong></li><li><code>std::unique_ptr&lt;A&gt;</code>Â çš„æ„é€ å‡½æ•°è¿˜æ²¡æ¥å¾—åŠæ‰§è¡Œã€‚</li><li><strong>ç»“æœ</strong>ï¼šAÂ çš„æŒ‡é’ˆä¸¢å¤±äº†ï¼Œæ²¡äººè´Ÿè´£Â deleteÂ å®ƒï¼Œ<strong>å†…å­˜æ³„æ¼</strong>ã€‚</li></ol><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">process</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;">std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make_unique</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(), std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">make_unique</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;());</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>make_uniqueÂ å†…éƒ¨å°è£…äº†Â newÂ å’ŒÂ unique_ptrÂ çš„æ„é€ ã€‚å®ƒæ˜¯ä¸€ä¸ªå®Œæ•´çš„å‡½æ•°è°ƒç”¨ã€‚<br> è¿™æ„å‘³ç€æ­¥éª¤å˜æˆäº†ï¼š</p><ol><li>å®Œæ•´æ‰§è¡ŒÂ <code>make_unique&lt;A&gt;()</code>ï¼ˆåˆ†é…+åŒ…è£…ï¼‰ã€‚æˆåŠŸåè¿”å›ä¸€ä¸ªå¯¹è±¡ã€‚</li><li>å®Œæ•´æ‰§è¡ŒÂ <code>make_unique&lt;B&gt;()</code>ã€‚</li><li><strong>å¦‚æœ B å¤±è´¥äº†ï¼ŒA å·²ç»æ˜¯ä¸€ä¸ªæ™ºèƒ½æŒ‡é’ˆå¯¹è±¡äº†ï¼Œå®ƒä¼šè‡ªåŠ¨ææ„é‡Šæ”¾å†…å­˜ã€‚</strong></li><li><strong>ç»“è®ºï¼šé›¶æ³„æ¼é£é™©ã€‚</strong></li></ol><h1 id="ä½¿ç”¨å·¥å‚å‡½æ•°" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨å·¥å‚å‡½æ•°"><span>ä½¿ç”¨å·¥å‚å‡½æ•°</span></a></h1><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// æ–¹å¼1ï¼šä¸ä½¿ç”¨å·¥å‚å‡½æ•°ï¼ˆå¤æ‚ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    Value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">TypeId</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int32_t</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">type_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(type), </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">value_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(value) {}</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    Value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">TypeId</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">string</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">type_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(type) {</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // å¤æ‚çš„å­—ç¬¦ä¸²å¤„ç†é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // å†…å­˜ç®¡ç†é€»è¾‘</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // ...</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    Value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">TypeId</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">bool</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">type_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(type), </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">value_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#ABB2BF;">static_cast</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int8_t&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(value)) {}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ä½¿ç”¨æ—¶éœ€è¦è®°ä½å¤æ‚çš„æ„é€ æ–¹å¼</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Value</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> int_val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(TypeId::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">INTEGER</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Value</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> bool_val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(TypeId::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">BOOLEAN</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">static_cast</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int8_t</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">));</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">  // éœ€è¦æ‰‹åŠ¨è½¬æ¢</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// æ–¹å¼2ï¼šä½¿ç”¨å·¥å‚å‡½æ•°ï¼ˆç®€æ´ï¼‰</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> ValueFactory</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> inline</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GetIntegerValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int32_t</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {TypeId::INTEGER, value};</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> inline</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> auto</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GetBooleanValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">bool</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) -&gt; </span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">Value</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {TypeId::BOOLEAN, </span><span style="--shiki-light:#A626A4;--shiki-dark:#ABB2BF;">static_cast</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;int8_t&gt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(value)};</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ä½¿ç”¨æ—¶éå¸¸ç®€å•ç›´è§‚</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Value int_val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ValueFactory::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetIntegerValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">42</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">Value bool_val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ValueFactory::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">GetBooleanValue</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å·¥å‚å‡½æ•°ä¸€èˆ¬éƒ½ä½¿ç”¨static å› ä¸ºè¿™æ ·å‡½æ•°åªå±äºè¿™ä¸ªå·¥å‚ç±»æœ¬èº« ä¸éœ€è¦å®ä¾‹åŒ–ä¸€ä¸ªValueFactoryå¯¹è±¡ èƒ½å¤Ÿç›´æ¥é€šè¿‡è¿™ä¸ªç±»åè¿›è¡Œè°ƒç”¨ è€Œä¸”å¯ä»¥åœ¨å…¨å±€èŒƒå›´å†…è¿›è¡Œè®¿é—®<br> ä¼˜ç‚¹</p><ul><li>èƒ½å¤Ÿç»Ÿä¸€æ¥å£</li><li>æ˜“äºæ‰©å±• å¦‚æœéœ€è¦æ”¯æŒæ–°çš„ç±»åˆ«çš„è¯ ç›´æ¥åœ¨å·¥å‚ä¸­æ·»åŠ æ–°æ–¹æ³•å³å¯</li><li>éšè—å¤æ‚åº¦</li></ul><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">protected:</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">string</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> type</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">type_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(type), </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">x_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x), </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">y_</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(y) {}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">unique_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CreatePlayer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> player </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unique_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;player&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, x, y));</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        player</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setHealth</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        player</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setSpeed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">5</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> player;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">unique_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CreateEnemy</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> enemy </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unique_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;enemy&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, x, y));</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        enemy</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setHealth</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        enemy</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setSpeed</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">3</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        enemy</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setAggressive</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> enemy;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    static</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">unique_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CreateItem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> y</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">string</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&amp;</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> itemType</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> item </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> std::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">unique_ptr</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;">GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">&gt;(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> GameObject</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;item&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, x, y));</span></span>
<span class="line"><span style="--shiki-light:#E45649;--shiki-dark:#E5C07B;">        item</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">-&gt;</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">setItemProperties</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(itemType);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">        return</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> item;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// ä½¿ç”¨</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> player </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> GameObject::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CreatePlayer</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> enemy </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> GameObject::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CreateEnemy</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> potion </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> GameObject::</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">CreateItem</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">50</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;">&quot;health_potion&quot;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¾‹å¦‚è¿™é‡Œéƒ½æ˜¯åˆ›å»ºæ¸¸æˆä¸­çš„å¯¹è±¡ å¯ä»¥ä½¿ç”¨å·¥å‚å‡½æ•° æ›´åŠ ç®€å•ç›´è§‚åœ°è¿›è¡Œæ„é€ </p><h1 id="top-k" tabindex="-1"><a class="header-anchor" href="#top-k"><span>TOP-K</span></a></h1><hr><h3 id="_1-åœºæ™¯ä¸€-å•æœºå†…å­˜å¤„ç†-static-data-fit-in-memory" tabindex="-1"><a class="header-anchor" href="#_1-åœºæ™¯ä¸€-å•æœºå†…å­˜å¤„ç†-static-data-fit-in-memory"><span>1. åœºæ™¯ä¸€ï¼šå•æœºå†…å­˜å¤„ç†ï¼ˆStatic Data, Fit in Memoryï¼‰</span></a></h3><p>å‡è®¾ç»™ä½ ä¸€ä¸ªåŒ…å« <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> ä¸ªæ•´æ•°çš„æ•°ç»„ï¼Œå†…å­˜æ”¾å¾—ä¸‹ï¼Œæ‰¾å‡ºæœ€å¤§çš„ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ªã€‚</p><h4 id="æ–¹æ³•-a-å…¨é‡æ’åº-naive-approach" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•-a-å…¨é‡æ’åº-naive-approach"><span>æ–¹æ³• Aï¼šå…¨é‡æ’åº (Naive Approach)</span></a></h4><ul><li><strong>åšæ³•</strong>ï¼šä½¿ç”¨ <code>std::sort</code> (QuickSort/MergeSort) å°†æ•°ç»„å®Œå…¨æ’åºï¼Œç„¶åå–å‰ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ªã€‚</li><li><strong>å¤æ‚åº¦</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>log</mi><mo>â¡</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N \log N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>ã€‚</li><li><strong>è¯„ä»·</strong>ï¼š<strong>æœ€å·®</strong>ã€‚å½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> å¾ˆå¤§è€Œ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> å¾ˆå°æ—¶ï¼ˆä¾‹å¦‚ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>=</mo><mn>1000</mn><mtext>ä¸‡</mtext><mo separator="true">,</mo><mi>K</mi><mo>=</mo><mn>10</mn></mrow><annotation encoding="application/x-tex">N=1000ä¸‡, K=10</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"></span><span class="mord">1000</span><span class="mord cjk_fallback">ä¸‡</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6444em;"></span><span class="mord">10</span></span></span></span>ï¼‰ï¼Œåšäº†å¤§é‡æ— ç”¨åŠŸã€‚</li></ul><h4 id="æ–¹æ³•-b-æœ€å°å †-min-heap-â€”â€”-å·¥ç¨‹é¦–é€‰" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•-b-æœ€å°å †-min-heap-â€”â€”-å·¥ç¨‹é¦–é€‰"><span>æ–¹æ³• Bï¼šæœ€å°å † (Min-Heap) â€”â€” <strong>å·¥ç¨‹é¦–é€‰</strong></span></a></h4><ul><li><strong>åšæ³•</strong>ï¼š <ol><li>ç»´æŠ¤ä¸€ä¸ªå¤§å°ä¸º <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> çš„<strong>å°é¡¶å †</strong>ã€‚</li><li>éå†æ•°ç»„ï¼Œå°†å…ƒç´ å‹å…¥å †ã€‚</li><li>å¦‚æœå †çš„å¤§å°è¶…è¿‡ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>ï¼Œå¼¹å‡ºå †é¡¶ï¼ˆå³å †ä¸­æœ€å°çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯å½“å‰ Top K é‡Œæœ€å¼±çš„é‚£ä¸ªï¼‰ã€‚</li><li>æœ€ç»ˆå †é‡Œå‰©ä¸‹çš„å°±æ˜¯æœ€å¤§çš„ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ªã€‚</li></ol></li><li><strong>å¤æ‚åº¦</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>log</mi><mo>â¡</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N \log K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span>ã€‚</li><li><strong>è¯„ä»·</strong>ï¼š<strong>æœ€é€šç”¨ã€æœ€ç¨³å¥</strong>ã€‚ç‰¹åˆ«æ˜¯å½“ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>â‰ª</mo><mi>N</mi></mrow><annotation encoding="application/x-tex">K \ll N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7224em;vertical-align:-0.0391em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">â‰ª</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> æ—¶ï¼Œæ•ˆç‡æé«˜ã€‚ä½ ä¼˜åŒ–åçš„ä»£ç ç”¨çš„å°±æ˜¯è¿™ä¸ªã€‚</li></ul><h4 id="æ–¹æ³•-c-å¿«é€Ÿé€‰æ‹©-quick-select-â€”â€”-å¹³å‡æœ€å¿«" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•-c-å¿«é€Ÿé€‰æ‹©-quick-select-â€”â€”-å¹³å‡æœ€å¿«"><span>æ–¹æ³• Cï¼šå¿«é€Ÿé€‰æ‹© (Quick Select) â€”â€” <strong>å¹³å‡æœ€å¿«</strong></span></a></h4><ul><li><strong>åšæ³•</strong>ï¼šåŸºäºå¿«é€Ÿæ’åºï¼ˆQuick Sortï¼‰çš„ Partition æ€æƒ³ã€‚ <ol><li>éšæœºé€‰ä¸€ä¸ª Pivotï¼Œå°†æ•°ç»„åˆ†ä¸ºâ€œæ¯” Pivot å¤§â€å’Œâ€œæ¯” Pivot å°â€ä¸¤éƒ¨åˆ†ã€‚</li><li>çœ‹ Pivot çš„ä½ç½®ï¼š <ul><li>å¦‚æœ Pivot æ­£å¥½åœ¨ç¬¬ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ªä½ç½®ï¼Œé‚£ä¹ˆå®ƒå·¦è¾¹çš„å°±æ˜¯ Top Kã€‚</li><li>å¦‚æœ Pivot åœ¨ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¹‹åï¼Œé€’å½’å¤„ç†å·¦è¾¹ã€‚</li><li>å¦‚æœ Pivot åœ¨ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¹‹å‰ï¼Œé€’å½’å¤„ç†å³è¾¹ã€‚</li></ul></li></ol></li><li><strong>å¤æ‚åº¦</strong>ï¼šå¹³å‡ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>ï¼Œæœ€å <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>N</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span>ã€‚</li><li><strong>è¯„ä»·</strong>ï¼š<strong>ç†è®ºæœ€å¿«</strong>ï¼Œä½†ä¿®æ”¹äº†åŸæ•°ç»„ï¼Œä¸”ä¸ç¨³å®šã€‚C++ æ ‡å‡†åº“ä¸­æœ‰ <code>std::nth_element</code> å°±æ˜¯è¿™ä¸ªå®ç°ã€‚</li></ul><hr><h3 id="_2-åœºæ™¯äºŒ-æµ·é‡æ•°æ®-æµå¼æ•°æ®-streaming-data" tabindex="-1"><a class="header-anchor" href="#_2-åœºæ™¯äºŒ-æµ·é‡æ•°æ®-æµå¼æ•°æ®-streaming-data"><span>2. åœºæ™¯äºŒï¼šæµ·é‡æ•°æ®/æµå¼æ•°æ®ï¼ˆStreaming Dataï¼‰</span></a></h3><p>å‡è®¾æ•°æ®æ˜¯å®æ—¶æµè¿›æ¥çš„ï¼ˆåƒç½‘ç»œåŒ…ã€æ—¥å¿—ï¼‰ï¼Œæˆ–è€…æ•°æ®åœ¨ç£ç›˜ä¸Šï¼Œå†…å­˜æ”¾ä¸ä¸‹ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> ä¸ªå…ƒç´ ã€‚</p><ul><li><strong>é™åˆ¶</strong>ï¼šæ— æ³•å°†æ‰€æœ‰æ•°æ®åŠ è½½åˆ°å†…å­˜ï¼Œæ— æ³•ä½¿ç”¨ Quick Selectã€‚</li><li><strong>å”¯ä¸€è§£æ³•ï¼šæœ€å°å † (Min-Heap)</strong>ã€‚ <ul><li><strong>åŸç†</strong>ï¼šä¸ç®¡ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span> æœ‰å¤šå¤§ï¼ˆ1TB ç”šè‡³æ— ç©·å¤§ï¼‰ï¼Œå†…å­˜ä¸­åªéœ€è¦ç»´æŠ¤ä¸€ä¸ª <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> å¤§å°çš„å †ã€‚</li><li><strong>ç©ºé—´å¤æ‚åº¦</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span>ã€‚</li></ul></li><li><strong>åº”ç”¨</strong>ï¼šå®æ—¶çƒ­æœæ¦œã€DDOS æ”»å‡»æ£€æµ‹ï¼ˆæµé‡æœ€å¤§çš„ K ä¸ª IPï¼‰ã€‚</li></ul><hr><h3 id="_3-åœºæ™¯ä¸‰-åˆ†å¸ƒå¼å¤§æ•°æ®-distributed-big-data" tabindex="-1"><a class="header-anchor" href="#_3-åœºæ™¯ä¸‰-åˆ†å¸ƒå¼å¤§æ•°æ®-distributed-big-data"><span>3. åœºæ™¯ä¸‰ï¼šåˆ†å¸ƒå¼å¤§æ•°æ®ï¼ˆDistributed / Big Dataï¼‰</span></a></h3><p>å‡è®¾æœ‰ 10 äº¿è¡Œæ•°æ®ï¼Œåˆ†å¸ƒåœ¨ 1000 å°æœºå™¨ä¸Šï¼Œè¦æ‰¾å…¨å±€ Top-Kã€‚</p><ul><li><strong>é™åˆ¶</strong>ï¼šå•æœºç®—ä¸åŠ¨ï¼Œç½‘ç»œå¸¦å®½æœ‰é™ã€‚</li><li><strong>è§£æ³•ï¼šåˆ†æ²»æ³• (MapReduce æ€æƒ³)</strong><ol><li><strong>Map é˜¶æ®µ</strong>ï¼šæ¯å°æœºå™¨åœ¨æœ¬åœ°æ•°æ®ä¸Šè®¡ç®—<strong>å±€éƒ¨ Top-K</strong>ï¼ˆä½¿ç”¨å †ï¼‰ã€‚</li><li><strong>Reduce é˜¶æ®µ</strong>ï¼šæ¯å°æœºå™¨å°†è¿™ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ªå…ƒç´ å‘é€ç»™ä¸€å°ä¸­å¿ƒæœºå™¨ï¼ˆæˆ–è€…ä¸‹ä¸€å±‚èšåˆèŠ‚ç‚¹ï¼‰ã€‚</li><li><strong>Merge é˜¶æ®µ</strong>ï¼šä¸­å¿ƒæœºå™¨æ”¶é›†åˆ° <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1000</mn><mo>Ã—</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">1000 \times K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">1000</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">Ã—</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ªå…ƒç´ ï¼Œå†åšä¸€æ¬¡ Top-Kï¼Œå¾—åˆ°å…¨å±€ Top-Kã€‚</li></ol></li><li><strong>å…³é”®ç‚¹</strong>ï¼šä¼ è¾“çš„æ•°æ®é‡éå¸¸å°ï¼ˆåªæœ‰ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span>ï¼‰ï¼Œè€Œä¸æ˜¯ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span></span></span></span>ã€‚</li></ul><hr><h3 id="_4-åœºæ™¯å››-ç»Ÿè®¡-é¢‘ç‡-æœ€é«˜çš„-top-k-heavy-hitters" tabindex="-1"><a class="header-anchor" href="#_4-åœºæ™¯å››-ç»Ÿè®¡-é¢‘ç‡-æœ€é«˜çš„-top-k-heavy-hitters"><span>4. åœºæ™¯å››ï¼šç»Ÿè®¡â€œé¢‘ç‡â€æœ€é«˜çš„ Top-K (Heavy Hitters)</span></a></h3><p>ä¸Šé¢çš„åœºæ™¯éƒ½æ˜¯åŸºäºå…ƒç´ çš„å€¼ï¼ˆValueï¼‰æ’åºã€‚å¦‚æœé—®é¢˜æ˜¯ï¼š<strong>â€œåœ¨ä¸€ä¸ª 100GB çš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œæ‰¾å‡ºå‡ºç°æ¬¡æ•°æœ€å¤šçš„ 10 ä¸ª IP åœ°å€â€</strong>ã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªéš¾ç‚¹ï¼Œå› ä¸ºä½ ä¸ä»…è¦æ’åºï¼Œè¿˜è¦å…ˆ<strong>ç»Ÿè®¡è®¡æ•°</strong>ã€‚</p><h4 id="æ–¹æ³•-a-hash-map-heap-ç²¾ç¡®è§£" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•-a-hash-map-heap-ç²¾ç¡®è§£"><span>æ–¹æ³• Aï¼šHash Map + Heap (ç²¾ç¡®è§£)</span></a></h4><ul><li><strong>åšæ³•</strong>ï¼šç”¨ Hash Map ç»Ÿè®¡æ‰€æœ‰ IP çš„å‡ºç°æ¬¡æ•°ï¼Œç„¶åæŠŠ (IP, Count) æ‰”è¿›å †é‡Œæ±‚ Top-Kã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼šå¦‚æœæœ‰ 10 äº¿ä¸ªä¸åŒçš„ IPï¼ŒHash Map å†…å­˜ä¼šçˆ†ç‚¸ã€‚</li></ul><h4 id="æ–¹æ³•-b-hash-åˆ†ç‰‡-ç²¾ç¡®è§£-åˆ†å¸ƒå¼" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•-b-hash-åˆ†ç‰‡-ç²¾ç¡®è§£-åˆ†å¸ƒå¼"><span>æ–¹æ³• Bï¼šHash åˆ†ç‰‡ (ç²¾ç¡®è§£ï¼Œåˆ†å¸ƒå¼)</span></a></h4><ul><li><strong>åšæ³•</strong>ï¼š <ol><li>æŠŠ IP æŒ‰ç…§ <code>hash(IP) % 1024</code> åˆ†å‘åˆ° 1024 ä¸ªå°æ–‡ä»¶ä¸­ã€‚</li><li>è¿™æ ·ç›¸åŒçš„ IP è‚¯å®šåœ¨åŒä¸€ä¸ªæ–‡ä»¶é‡Œã€‚</li><li>åˆ†åˆ«åŠ è½½æ¯ä¸ªå°æ–‡ä»¶åˆ°å†…å­˜ï¼Œç”¨ Hash Map ç»Ÿè®¡å¹¶æ±‚å±€éƒ¨ Top-Kã€‚</li><li>æœ€åå½’å¹¶ã€‚</li></ol></li></ul><h4 id="æ–¹æ³•-c-count-min-sketch-misra-gries-è¿‘ä¼¼è§£" tabindex="-1"><a class="header-anchor" href="#æ–¹æ³•-c-count-min-sketch-misra-gries-è¿‘ä¼¼è§£"><span>æ–¹æ³• Cï¼šCount-Min Sketch / Misra-Gries (è¿‘ä¼¼è§£)</span></a></h4><ul><li><strong>åœºæ™¯</strong>ï¼šå…è®¸ä¸€ç‚¹ç‚¹è¯¯å·®ï¼Œä½†å¿…é¡»æçœå†…å­˜ï¼ˆæ¯”å¦‚è·¯ç”±å™¨ç¡¬ä»¶ï¼‰ã€‚</li><li><strong>åšæ³•</strong>ï¼šä½¿ç”¨æ¦‚ç‡æ•°æ®ç»“æ„ï¼ˆå¦‚ Count-Min Sketchï¼‰ã€‚ <ul><li>ç”¨å¤šä¸ª Hash å‡½æ•°å°†å…ƒç´ æ˜ å°„åˆ°äºŒç»´æ•°ç»„ä¸­è¿›è¡Œè®¡æ•°ã€‚</li><li>ä¸éœ€è¦å­˜å‚¨ IP æœ¬èº«ï¼Œåªå­˜å‚¨è®¡æ•°å€¼ã€‚</li><li><strong>ä¼˜ç‚¹</strong>ï¼šç”¨æå°çš„ç©ºé—´ï¼ˆå‡ KBï¼‰å°±èƒ½ç»Ÿè®¡æµ·é‡æ•°æ®ã€‚</li></ul></li></ul><hr><h3 id="_5-æ•°æ®åº“ä¸­çš„-top-k-ä¼˜åŒ–" tabindex="-1"><a class="header-anchor" href="#_5-æ•°æ®åº“ä¸­çš„-top-k-ä¼˜åŒ–"><span>5. æ•°æ®åº“ä¸­çš„ Top-K ä¼˜åŒ–</span></a></h3><p><code>SELECT * FROM table ORDER BY col LIMIT K</code>ã€‚</p><p>æ•°æ®åº“ä¼˜åŒ–å™¨é€šå¸¸ä¼šæŒ‰ä»¥ä¸‹é¡ºåºå°è¯•ï¼š</p><ol><li><p><strong>åˆ©ç”¨ç´¢å¼• (Index Scan)</strong>ï¼š</p><ul><li>å¦‚æœåœ¨ <code>col</code> ä¸Šæœ‰ B+ æ ‘ç´¢å¼•ï¼Œç´¢å¼•æœ¬èº«å°±æ˜¯æœ‰åºçš„ã€‚</li><li>æ•°æ®åº“åªéœ€è¦è¯»ç´¢å¼•çš„æœ€å·¦è¾¹ï¼ˆæˆ–æœ€å³è¾¹ï¼‰çš„ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> ä¸ªæ¡ç›®ã€‚</li><li><strong>å¤æ‚åº¦</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span>ã€‚è¿™æ˜¯æé€Ÿæ¨¡å¼ã€‚</li></ul></li><li><p>**Top-N Heap Sortï¼š</p><ul><li>å¦‚æœæ²¡ç´¢å¼•ï¼Œå¿…é¡»å…¨è¡¨æ‰«æã€‚</li><li>åœ¨æ‰«æè¿‡ç¨‹ä¸­ç»´æŠ¤ä¸€ä¸ªå¤§å°ä¸º <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> çš„å †ã€‚</li><li><strong>å¤æ‚åº¦</strong>ï¼š<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>log</mi><mo>â¡</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N \log K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span>ã€‚</li></ul></li><li><p><strong>å…¨é‡æ’åº (External Sort)</strong>ï¼š</p><ul><li>å¦‚æœ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span></span></span></span> éå¸¸å¤§ï¼ˆæ¯”å¦‚ <code>LIMIT 1000000</code>ï¼‰ï¼Œå †å¤ªå¤§å†…å­˜æ”¾ä¸ä¸‹ã€‚</li><li>é€€åŒ–ä¸ºå¤–éƒ¨å½’å¹¶æ’åºã€‚</li></ul></li></ol><h3 id="æ€»ç»“è¡¨" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“è¡¨"><span>æ€»ç»“è¡¨</span></a></h3><table><thead><tr><th style="text-align:left;">åœºæ™¯</th><th style="text-align:left;">æœ€ä½³ç­–ç•¥</th><th style="text-align:left;">å¤æ‚åº¦</th><th style="text-align:left;">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:left;"><strong>å†…å­˜å……è¶³ï¼Œé™æ€æ•°æ®</strong></td><td style="text-align:left;"><strong>Quick Select</strong></td><td style="text-align:left;"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span></td><td style="text-align:left;">ä¼šä¿®æ”¹åŸæ•°ç»„</td></tr><tr><td style="text-align:left;"><strong>å†…å­˜å……è¶³ï¼Œä¸€èˆ¬é€šç”¨</strong></td><td style="text-align:left;"><strong>Min-Heap</strong></td><td style="text-align:left;"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>log</mi><mo>â¡</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N \log K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span></td><td style="text-align:left;">ä¸æ”¹åŸæ•°ç»„ï¼Œç¨³å®š</td></tr><tr><td style="text-align:left;"><strong>æµå¼æ•°æ® (Streaming)</strong></td><td style="text-align:left;"><strong>Min-Heap</strong></td><td style="text-align:left;"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>N</mi><mi>log</mi><mo>â¡</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(N \log K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span></td><td style="text-align:left;">ç©ºé—´ä»…éœ€ <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>K</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(K)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mclose">)</span></span></span></span></td></tr><tr><td style="text-align:left;"><strong>æµ·é‡æ•°æ® (åˆ†å¸ƒå¼)</strong></td><td style="text-align:left;"><strong>åˆ†æ²» + å½’å¹¶</strong></td><td style="text-align:left;">-</td><td style="text-align:left;">MapReduce ç»å…¸æ¡ˆä¾‹</td></tr><tr><td style="text-align:left;"><strong>é«˜é¢‘è¯ç»Ÿè®¡ (ç²¾ç¡®)</strong></td><td style="text-align:left;"><strong>Hashåˆ†ç‰‡ + Heap</strong></td><td style="text-align:left;">-</td><td style="text-align:left;">è§£å†³ Map å†…å­˜çˆ†ç‚¸é—®é¢˜</td></tr><tr><td style="text-align:left;"><strong>é«˜é¢‘è¯ç»Ÿè®¡ (è¿‘ä¼¼)</strong></td><td style="text-align:left;"><strong>Count-Min Sketch</strong></td><td style="text-align:left;"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord">1</span><span class="mclose">)</span></span></span></span> ç©ºé—´</td><td style="text-align:left;">ç‰ºç‰²ç²¾åº¦æ¢ç©ºé—´</td></tr></tbody></table><h1 id="é¡¶å±‚const-ä¸åº•å±‚const" tabindex="-1"><a class="header-anchor" href="#é¡¶å±‚const-ä¸åº•å±‚const"><span>é¡¶å±‚const ä¸åº•å±‚const</span></a></h1><h3 id="_1-åŸºæœ¬å®šä¹‰" tabindex="-1"><a class="header-anchor" href="#_1-åŸºæœ¬å®šä¹‰"><span>1. åŸºæœ¬å®šä¹‰</span></a></h3><h4 id="é¡¶å±‚-const-top-level-const" tabindex="-1"><a class="header-anchor" href="#é¡¶å±‚-const-top-level-const"><span>é¡¶å±‚ const (Top-level const)</span></a></h4><p><strong>é¡¶å±‚ const è¡¨ç¤ºå¯¹è±¡æœ¬èº«æ˜¯ä¸€ä¸ªå¸¸é‡ã€‚</strong> ä¸€æ—¦åˆå§‹åŒ–ï¼Œè¯¥å˜é‡çš„å€¼å°±ä¸èƒ½å†æ”¹å˜ã€‚</p><ul><li>é€‚ç”¨äºä»»ä½•å¯¹è±¡ç±»å‹ï¼ˆå¦‚ <code>int</code>ã€<code>double</code>ã€ç±»å¯¹è±¡ã€æŒ‡é’ˆæœ¬èº«ç­‰ï¼‰ã€‚</li></ul><h4 id="åº•å±‚-const-low-level-const" tabindex="-1"><a class="header-anchor" href="#åº•å±‚-const-low-level-const"><span>åº•å±‚ const (Low-level const)</span></a></h4><p><strong>åº•å±‚ const ä¸æŒ‡é’ˆå’Œå¼•ç”¨ç­‰å¤åˆç±»å‹æœ‰å…³ã€‚</strong> å®ƒè¡¨ç¤º<strong>æ‰€æŒ‡çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå¸¸é‡</strong>ï¼Œä½†å˜é‡æœ¬èº«ï¼ˆå¦‚æœæ˜¯æŒ‡é’ˆï¼‰æ˜¯å¯ä»¥æŒ‡å‘å…¶ä»–åœ°æ–¹çš„ã€‚</p><hr><h3 id="_2-æŒ‡é’ˆä¸­çš„åŒºåˆ«-æœ€å®¹æ˜“æ··æ·†çš„åœ°æ–¹" tabindex="-1"><a class="header-anchor" href="#_2-æŒ‡é’ˆä¸­çš„åŒºåˆ«-æœ€å®¹æ˜“æ··æ·†çš„åœ°æ–¹"><span>2. æŒ‡é’ˆä¸­çš„åŒºåˆ«ï¼ˆæœ€å®¹æ˜“æ··æ·†çš„åœ°æ–¹ï¼‰</span></a></h3><p>æŒ‡é’ˆæ—¢å¯ä»¥æ˜¯é¡¶å±‚ constï¼Œä¹Ÿå¯ä»¥æ˜¯åº•å±‚ constï¼Œæˆ–è€…ä¸¤è€…éƒ½æ˜¯ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// --- é¡¶å±‚ const ---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p1 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">i;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // p1 æ˜¯é¡¶å±‚ constã€‚p1 çš„å€¼ï¼ˆåœ°å€ï¼‰ä¸èƒ½å˜ï¼Œä½†å¯ä»¥é€šè¿‡ p1 ä¿®æ”¹ iã€‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ci </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 42</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // ci æ˜¯é¡¶å±‚ constã€‚ci çš„å€¼ä¸èƒ½å˜ã€‚</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// --- åº•å±‚ const ---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">i;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // p2 æ˜¯åº•å±‚ constã€‚ä¸èƒ½é€šè¿‡ p2 ä¿®æ”¹ iï¼Œä½† p2 å¯ä»¥æŒ‡å‘åˆ«å¤„ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;">&amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> r </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ci;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // æ‰€æœ‰çš„å¼•ç”¨ const éƒ½æ˜¯åº•å±‚ constï¼Œå› ä¸ºå¼•ç”¨æœ¬èº«ä¸æ˜¯å¯¹è±¡ï¼Œä¸å¯æ”¹å˜ç»‘å®šã€‚</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// --- ä¸¤è€…å…¼æœ‰ ---</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int*</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p3 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p2;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // å·¦è¾¹çš„ const æ˜¯åº•å±‚ï¼Œå³è¾¹çš„ const æ˜¯é¡¶å±‚ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                          // p3 æ—¢ä¸èƒ½æŒ‡å‘åˆ«å¤„ï¼Œä¹Ÿä¸èƒ½é€šè¿‡å®ƒä¿®æ”¹æ‰€æŒ‡çš„å€¼ã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>åˆ¤æ–­å°æŠ€å·§ï¼š</strong><br> ä»¥æ˜Ÿå· <code>*</code> ä¸ºåˆ†ç•Œçº¿ï¼š</p><ul><li>å¦‚æœ <code>const</code> åœ¨ <code>*</code> <strong>å³è¾¹</strong>ï¼šæ˜¯<strong>é¡¶å±‚</strong> constï¼ˆä¿®é¥°æŒ‡é’ˆå˜é‡æœ¬èº«ï¼‰ã€‚</li><li>å¦‚æœ <code>const</code> åœ¨ <code>*</code> <strong>å·¦è¾¹</strong>ï¼šæ˜¯<strong>åº•å±‚</strong> constï¼ˆä¿®é¥°æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®ï¼‰ã€‚</li></ul><hr><h3 id="_3-æ ¸å¿ƒåŒºåˆ«ä¸å½±å“" tabindex="-1"><a class="header-anchor" href="#_3-æ ¸å¿ƒåŒºåˆ«ä¸å½±å“"><span>3. æ ¸å¿ƒåŒºåˆ«ä¸å½±å“</span></a></h3><p>è¿™ä¸¤è€…çš„åŒºåˆ«ä¸»è¦ä½“ç°åœ¨<strong>æ‰§è¡Œæ‹·è´æ“ä½œ</strong>æ—¶ï¼š</p><h4 id="_1-é¡¶å±‚-const-çš„æ‹·è´-ä¸å—å½±å“" tabindex="-1"><a class="header-anchor" href="#_1-é¡¶å±‚-const-çš„æ‹·è´-ä¸å—å½±å“"><span>(1) é¡¶å±‚ const çš„æ‹·è´ï¼šä¸å—å½±å“</span></a></h4><p>å½“æ‰§è¡Œæ‹·è´æ“ä½œæ—¶ï¼Œé¡¶å±‚ const ä¼šè¢«å¿½ç•¥ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ci </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 42</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">; </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">i </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ci;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">            // æ­£ç¡®ï¼šci æ˜¯é¡¶å±‚ constï¼Œæ‹·è´æ—¶å¿½ç•¥å®ƒçš„å¸¸é‡å±æ€§ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> const</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p1 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">i;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p1;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">      // æ­£ç¡®ï¼šp1 æ˜¯é¡¶å±‚ constï¼Œæ‹·è´ p1 çš„å€¼ï¼ˆåœ°å€ï¼‰æ²¡é—®é¢˜ã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="_2-åº•å±‚-const-çš„æ‹·è´-ä¸¥æ ¼é™åˆ¶" tabindex="-1"><a class="header-anchor" href="#_2-åº•å±‚-const-çš„æ‹·è´-ä¸¥æ ¼é™åˆ¶"><span>(2) åº•å±‚ const çš„æ‹·è´ï¼šä¸¥æ ¼é™åˆ¶</span></a></h4><p>å½“æ‰§è¡Œæ‹·è´æ“ä½œæ—¶ï¼Œæ‹·å…¥å’Œæ‹·å‡ºçš„å¯¹è±¡å¿…é¡»å…·æœ‰<strong>ç›¸åŒçš„åº•å±‚ const èµ„æ ¼</strong>ï¼Œæˆ–è€…èƒ½å¤Ÿè¿›è¡Œç±»å‹è½¬æ¢ï¼ˆé€šå¸¸æ˜¯ <strong>é const èƒ½å¤Ÿè½¬åŒ–ä¸º const</strong>ï¼Œåä¹‹ä¸è¡Œï¼‰ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">i;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // p2 æ˜¯åº•å±‚ const</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p3 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p2;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">          // é”™è¯¯ï¼šp2 æœ‰åº•å±‚ constï¼Œè€Œ p3 æ²¡æœ‰ã€‚</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">                       // å¦‚æœå…è®¸ï¼Œä½ å°±èƒ½é€šè¿‡ p3 ä¿®æ”¹ p2 æœ¬æ¥ä¿æŠ¤çš„æ•°æ®ã€‚</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p4 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p2;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // æ­£ç¡®ï¼šä¸¤è€…éƒ½æ˜¯åº•å±‚ constã€‚</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p5 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">i;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">p2 </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p5;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">               // æ­£ç¡®ï¼šint* å¯ä»¥è½¬åŒ–ä¸º const int*ã€‚</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_4-ä¸ºä»€ä¹ˆéœ€è¦åŒºåˆ†å®ƒä»¬" tabindex="-1"><a class="header-anchor" href="#_4-ä¸ºä»€ä¹ˆéœ€è¦åŒºåˆ†å®ƒä»¬"><span>4. ä¸ºä»€ä¹ˆéœ€è¦åŒºåˆ†å®ƒä»¬ï¼Ÿ</span></a></h3><ol><li><p><strong>å‡½æ•°æ¨¡æ¿ä¸ <code>auto</code>ï¼š</strong></p><ul><li><code>auto</code> å…³é”®å­—åœ¨æ¨å¯¼ç±»å‹æ—¶ï¼Œé€šå¸¸ä¼š<strong>å¿½ç•¥é¡¶å±‚ const</strong>ï¼Œä½†ä¼š<strong>ä¿ç•™åº•å±‚ const</strong>ã€‚</li></ul><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ci </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 42</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> ci;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">       // a æ˜¯ intï¼ˆé¡¶å±‚ const è¢«å¿½ç•¥ï¼‰</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int*</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#A626A4;--shiki-dark:#56B6C2;"> &amp;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">ci;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">auto</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> b </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">=</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> p;</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">        // b æ˜¯ const int*ï¼ˆåº•å±‚ const è¢«ä¿ç•™ï¼‰</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>å‡½æ•°é‡è½½ï¼š</strong></p><ul><li>å¯¹äºé¡¶å±‚ constï¼Œç¼–è¯‘å™¨æ— æ³•åŒºåˆ†å½¢å‚ã€‚</li><li>å¯¹äºåº•å±‚ constï¼ˆæŒ‡é’ˆæˆ–å¼•ç”¨çš„æŒ‡å‘å¯¹è±¡æ˜¯å¦ä¸º constï¼‰ï¼Œç¼–è¯‘å™¨å¯ä»¥åŒºåˆ†ã€‚</li></ul><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {}       </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> func</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> i</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {}</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // é”™è¯¯ï¼šé‡å¤å®šä¹‰ï¼ˆé¡¶å±‚ const ä¸æ„æˆé‡è½½ï¼‰</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> move</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int*</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {}      </span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">void</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> move</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">const</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int*</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> p</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) {}</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // æ­£ç¡®ï¼šåº•å±‚ const å¯ä»¥æ„æˆé‡è½½</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p><strong>å¼ºåˆ¶ç±»å‹è½¬æ¢ï¼š</strong><br><code>const_cast</code> åªèƒ½æ”¹å˜è¿ç®—å¯¹è±¡çš„<strong>åº•å±‚ const</strong> å±æ€§ã€‚</p></li></ol><h1 id="ç±»å‹è½¬æ¢ç¬¦" tabindex="-1"><a class="header-anchor" href="#ç±»å‹è½¬æ¢ç¬¦"><span>ç±»å‹è½¬æ¢ç¬¦</span></a></h1><ol><li><p><strong>static_cast</strong>ï¼š</p><ul><li><p><strong>æœ€å¸¸ç”¨</strong>ã€‚ç”¨äºè‰¯æ€§è½¬æ¢ï¼ˆå¦‚Â intÂ è½¬Â floatï¼Œæ‰¾å›å­˜åœ¨è™šç»§æ‰¿å…³ç³»çš„çˆ¶å­ç±»æŒ‡é’ˆç­‰ï¼‰ã€‚</p></li><li><p><strong>æ³¨æ„</strong>ï¼šå®ƒåœ¨ç¼–è¯‘æ—¶å®Œæˆï¼Œæ²¡æœ‰è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥ï¼ˆå¯¹äºä¸‹è¡Œè½¬æ¢æ˜¯ä¸å®‰å…¨çš„ï¼‰ã€‚</p></li></ul></li><li><p><strong>dynamic_cast</strong>ï¼š</p><ul><li><p>ä¸“é—¨ç”¨äº<strong>å«æœ‰è™šå‡½æ•°çš„ç±»å±‚æ¬¡ç»“æ„</strong>ä¸­çš„å®‰å…¨è½¬æ¢ï¼ˆä¸‹è¡Œè½¬æ¢ï¼‰ã€‚</p></li><li><p><strong>ç‰¹ç‚¹</strong>ï¼šåœ¨è¿è¡Œæ—¶æ£€æŸ¥ã€‚å¦‚æœè½¬æ¢å¤±è´¥ï¼Œå¯¹äºæŒ‡é’ˆè¿”å›Â nullptrï¼Œå¯¹äºå¼•ç”¨æŠ›å‡ºå¼‚å¸¸ã€‚</p></li></ul></li><li><p><strong>reinterpret_cast</strong>ï¼š</p><ul><li><p>æœ€å±é™©ã€‚å®ƒè¿›è¡Œåº•å±‚çš„ä½æ¨¡å¼é‡æ–°è§£é‡Šï¼ˆå¦‚å°†ä¸€ä¸ªÂ int*Â å¼ºåˆ¶è½¬ä¸ºÂ char*ï¼‰ã€‚</p></li><li><p>æ²¡æœ‰é€»è¾‘è½¬æ¢ï¼Œåªæ˜¯å‘Šè¯‰ç¼–è¯‘å™¨â€œæŠŠè¿™å—å†…å­˜å½“æˆå¦ä¸€ç§ç±»å‹çœ‹â€ã€‚</p></li></ul></li><li><p><strong>const_cast</strong>ï¼š</p><ul><li><strong>å”¯ä¸€</strong>èƒ½å»æ‰æˆ–åŠ ä¸ŠÂ constÂ æˆ–Â volatileÂ å±æ€§çš„è½¬æ¢ç¬¦ã€‚</li></ul></li></ol><h1 id="vptr-vtable-ä¸-å¤šç»§æ‰¿æƒ…å†µä¸‹çš„è™šå‡½æ•°è¡¨" tabindex="-1"><a class="header-anchor" href="#vptr-vtable-ä¸-å¤šç»§æ‰¿æƒ…å†µä¸‹çš„è™šå‡½æ•°è¡¨"><span>vptr vtable ä¸ å¤šç»§æ‰¿æƒ…å†µä¸‹çš„è™šå‡½æ•°è¡¨</span></a></h1><p>åœ¨C++ä¸­ï¼Œè¿è¡Œæ—¶å¤šæ€ï¼ˆRuntime Polymorphismï¼‰æ˜¯é€šè¿‡<strong>è™šå‡½æ•°ï¼ˆVirtual Functionï¼‰</strong>ã€<strong>è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰</strong> å’Œ<strong>è™šæŒ‡é’ˆï¼ˆvptrï¼‰</strong> å…±åŒå®ç°çš„ã€‚è¿™ç§æœºåˆ¶å…è®¸ç¨‹åºåœ¨è¿è¡Œæ—¶æ ¹æ®å¯¹è±¡çš„å®é™…ç±»å‹ï¼ˆDynamic Typeï¼‰è€Œéå£°æ˜ç±»å‹ï¼ˆStatic Typeï¼‰æ¥å†³å®šè°ƒç”¨å“ªä¸ªå‡½æ•°ã€‚</p><hr><h3 id="_1-è™šå‡½æ•°è¡¨-vtable-å¤šæ€çš„åœ°å›¾" tabindex="-1"><a class="header-anchor" href="#_1-è™šå‡½æ•°è¡¨-vtable-å¤šæ€çš„åœ°å›¾"><span>1. è™šå‡½æ•°è¡¨ (vtable)ï¼šå¤šæ€çš„åœ°å›¾</span></a></h3><p><strong>è™šå‡½æ•°è¡¨</strong>æ˜¯ä¸€ä¸ªç”±ç¼–è¯‘å™¨ä¸ºæ¯ä¸€ä¸ª<strong>åŒ…å«è™šå‡½æ•°çš„ç±»</strong>ç»´æŠ¤çš„é™æ€æ•°ç»„ï¼ˆé€šå¸¸å­˜å‚¨åœ¨åªè¯»æ•°æ®æ®µï¼‰ã€‚</p><ul><li><strong>ç»“æ„</strong>ï¼š <ul><li><p>vtable æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª<strong>å‡½æ•°æŒ‡é’ˆæ•°ç»„</strong>ã€‚</p></li><li><p>æ•°ç»„çš„æ¯ä¸ªæ¡ç›®å­˜å‚¨ç€è¯¥ç±»è™šå‡½æ•°çš„å…¥å£åœ°å€ã€‚</p></li><li><p>é€šå¸¸ï¼Œvtable çš„å¤´éƒ¨ï¼ˆç´¢å¼•ä¸º -1 æˆ– -2 çš„ä½ç½®ï¼‰è¿˜ä¼šåŒ…å« <strong>RTTIï¼ˆè¿è¡Œæ—¶ç±»å‹ä¿¡æ¯ï¼‰</strong>ï¼Œå¦‚ <code>type_info</code>ï¼Œç”¨äº <code>dynamic_cast</code> å’Œ <code>typeid</code> çš„è¯†åˆ«ã€‚</p><ul><li>åœ¨å•ç»§æ‰¿ä¸­ï¼Œå¯¹è±¡åªæœ‰ä¸€ä¸ªÂ vptrã€‚ä½†åœ¨<strong>å¤šé‡ç»§æ‰¿</strong>ä¸­ï¼Œä¸ºäº†å…¼å®¹ä¸åŒçš„åŸºç±»æŒ‡é’ˆï¼Œå­ç±»å¯¹è±¡ä¼šæœ‰<strong>å¤šä¸ªÂ vptr</strong>ã€‚</li></ul><p>ChildÂ å¯¹è±¡çš„å†…å­˜å¸ƒå±€å¤§è‡´å¦‚ä¸‹ï¼ˆ64ä½ç³»ç»Ÿï¼‰ï¼š</p><ol><li><p><strong>[0-7 å­—èŠ‚]</strong>ï¼švptr_Motherï¼ˆæŒ‡å‘ Child ä¸“é—¨ä¸º Mother å‡†å¤‡çš„è™šè¡¨ï¼‰</p></li><li><p><strong>[8-11 å­—èŠ‚]</strong>ï¼šMother::m_data</p></li><li><p><strong>[16-23 å­—èŠ‚]</strong>ï¼švptr_Fatherï¼ˆæŒ‡å‘ Child ä¸“é—¨ä¸º Father å‡†å¤‡çš„è™šè¡¨ï¼‰</p></li><li><p><strong>[24-27 å­—èŠ‚]</strong>ï¼šFather::f_data</p></li><li><p><strong>[28-31 å­—èŠ‚]</strong>ï¼šChild::c_data</p></li></ol><p><code>Child* c2 = dynamic_cast&lt;Child*&gt;(f);</code><br> è¿è¡Œæ—¶åº“æ‹¿åˆ°Â fÂ æ—¶ï¼Œå®ƒåªçŸ¥é“Â fÂ ç°åœ¨æŒ‡å‘çš„æ˜¯æŸä¸ªåŒ…å«Â vptr_FatherÂ çš„å†…å­˜å—ã€‚å¦‚æœå®ƒæƒ³çŸ¥é“è¿™ä¸ªå¯¹è±¡çš„<strong>çœŸå®å®Œæ•´ç±»å‹</strong>ï¼Œå®ƒå¿…é¡»æ‰¾åˆ°å¯¹è±¡çš„<strong>æœ€å¼€å¤´</strong>ï¼ˆä¹Ÿå°±æ˜¯Â MotherÂ å¼€å§‹çš„åœ°æ–¹ï¼‰ï¼Œå› ä¸ºåªæœ‰åœ¨é‚£é‡Œæ‰èƒ½æ‰¾åˆ°Â ChildÂ ç±»çš„å®Œæ•´ RTTIï¼ˆtype_infoï¼‰ã€‚</p></li></ul></li></ul><ul><li><p>è§£å†³åŠæ³•ï¼šoffset-to-top</p><p>åœ¨Â vptr_FatherÂ æŒ‡å‘çš„é‚£ä¸ªè™šè¡¨ä¸­ï¼Œç´¢å¼•ä¸ºÂ <strong>-2</strong>Â çš„ä½ç½®å­˜äº†ä¸€ä¸ªå€¼ï¼š<strong>-16</strong>ã€‚</p><ol><li><p>dynamic_castÂ è®¿é—®Â fÂ æŒ‡å‘çš„Â vptr_Fatherã€‚</p></li><li><p>æŸ¥é˜…è™šè¡¨ç´¢å¼•Â -2Â çš„ä½ç½®ï¼Œå‘ç°Â offset-to-topÂ æ˜¯Â -16ã€‚</p></li><li><p>å®ƒå°†Â fÂ çš„åœ°å€åŠ ä¸ŠÂ -16ï¼Œç¬é—´<strong>æ‰¾å›äº†å¯¹è±¡çš„çœŸæ­£å¤´éƒ¨</strong>ã€‚</p></li><li><p>åœ¨å¤´éƒ¨è·å–Â ChildÂ çš„Â type_infoï¼Œä»è€Œç¡®è®¤è¿™ä¸ªå¯¹è±¡ç¡®å®æ˜¯ä¸€ä¸ªÂ Childã€‚<br> åœ¨å¤šé‡ç»§æ‰¿ä¸‹ï¼ŒChildÂ ç±»å®é™…ä¸Šæ‹¥æœ‰ä¸€ä¸ªâ€œç»„åˆè™šè¡¨â€ï¼Œå®ƒå¯ä»¥è¢«æ‹†åˆ†æˆå¤šä¸ªéƒ¨åˆ†ä¾›ä¸åŒçš„åŸºç±»æŒ‡é’ˆä½¿ç”¨ã€‚</p></li></ol><p>å¯¹äºÂ Child : public Mother, public Fatherï¼š</p><p>A. Mother å¯¹åº”çš„è™šè¡¨éƒ¨åˆ†ï¼ˆä¸»è™šè¡¨ Primary Vtableï¼‰ï¼š</p><ul><li><p><strong>ç´¢å¼• -2 (offset-to-top)</strong>:Â 0Â ï¼ˆå› ä¸º Mother åœ¨ Child çš„æœ€å¼€å¤´ï¼Œåç§»é‡ä¸º 0ï¼‰ã€‚</p></li><li><p><strong>ç´¢å¼• -1 (typeinfo ptr)</strong>: æŒ‡å‘Â ChildÂ çš„Â type_infoã€‚</p></li><li><p><strong>ç´¢å¼• 0, 1...</strong>:Â Child::cook()Â ç­‰è™šå‡½æ•°åœ°å€ã€‚</p></li></ul><p>B. Father å¯¹åº”çš„è™šè¡¨éƒ¨åˆ†ï¼ˆæ¬¡è™šè¡¨ Secondary Vtableï¼‰ï¼š</p><ul><li><p><strong>ç´¢å¼• -2 (offset-to-top)</strong>:Â -16Â ï¼ˆå‘Šè¯‰ç¨‹åºï¼šå¦‚æœä½ æƒ³å›å¯¹è±¡å¤´ï¼Œè¯·å‡ 16 å­—èŠ‚ï¼‰ã€‚</p></li><li><p><strong>ç´¢å¼• -1 (typeinfo ptr)</strong>:Â <strong>åŒæ ·æŒ‡å‘Â ChildÂ çš„Â type_info</strong>ã€‚</p></li><li><p><strong>ç´¢å¼• 0, 1...</strong>:Â Child::drive()Â ç­‰è™šå‡½æ•°åœ°å€ã€‚</p></li></ul><p>ä¸ºä»€ä¹ˆéƒ½è¦å­˜Â type_infoï¼Ÿ</p><p>å› ä¸ºç¼–è¯‘å™¨æ— æ³•é¢„çŸ¥ä½ ä¼šä»å“ªä¸ªåŸºç±»æŒ‡é’ˆå‘èµ·Â dynamic_castã€‚</p><ul><li><p>å¦‚æœä½ æ‰‹æŒÂ Mother*ï¼Œä½ ä¼šé€šè¿‡Â MotherÂ çš„è™šè¡¨çœ‹åˆ°å®ƒæ˜¯Â Childã€‚</p></li><li><p>å¦‚æœä½ æ‰‹æŒÂ Father*ï¼Œä½ ä¼šé€šè¿‡Â FatherÂ çš„è™šè¡¨çœ‹åˆ°å®ƒæ˜¯Â Childã€‚<br> æ‰€ä»¥ï¼Œ<strong>æ‰€æœ‰</strong>å…³è”åˆ°è¿™ä¸ªç±»çš„è™šè¡¨éƒ¨åˆ†ï¼Œå…¶ç´¢å¼•Â -1Â å¿…é¡»ä¸€è‡´æŒ‡å‘è¯¥ç±»çš„çœŸå®ç±»å‹ä¿¡æ¯ã€‚</p></li></ul></li></ul><ul><li><strong>ç”Ÿæˆæ—¶æœº</strong>ï¼š <ul><li><strong>ç¼–è¯‘æœŸ</strong>ã€‚ç¼–è¯‘å™¨åœ¨ç¼–è¯‘æ¯ä¸ªç±»æ—¶ï¼Œå¦‚æœå‘ç°ç±»ä¸­æœ‰è™šå‡½æ•°ï¼Œå°±ä¼šä¸ºè¯¥ç±»ç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ vtableã€‚</li></ul></li><li><strong>å­˜å‚¨ä½ç½®</strong>ï¼š <ul><li>å­˜å‚¨åœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„<strong>åªè¯»æ•°æ®æ®µï¼ˆ.rodata æˆ– .textï¼‰</strong>ã€‚å®ƒä¸å ç”¨å¯¹è±¡çš„å†…å­˜ç©ºé—´ï¼Œè€Œæ˜¯æ‰€æœ‰è¯¥ç±»çš„å®ä¾‹å…±ç”¨åŒä¸€ä¸ª vtableã€‚</li></ul></li><li><strong>ç±»å±‚æ¬¡ç»“æ„ä¸­çš„å…³ç³»</strong>ï¼š <ul><li><strong>åŸºç±»</strong>ï¼šæ‹¥æœ‰è‡ªå·±çš„ vtableï¼Œè®°å½•å…¶è™šå‡½æ•°åœ°å€ã€‚</li><li><strong>æ´¾ç”Ÿç±»</strong>ï¼šä¹Ÿä¼šæ‹¥æœ‰è‡ªå·±çš„ vtableã€‚ <ul><li>å¦‚æœæ´¾ç”Ÿç±»<strong>é‡å†™ï¼ˆOverrideï¼‰</strong> äº†åŸºç±»çš„è™šå‡½æ•°ï¼Œæ´¾ç”Ÿç±» vtable ä¸­å¯¹åº”çš„æ¡ç›®ä¼šè¢«æ›¿æ¢ä¸ºæ´¾ç”Ÿç±»å‡½æ•°çš„åœ°å€ã€‚</li><li>å¦‚æœæ´¾ç”Ÿç±»<strong>æ²¡æœ‰é‡å†™</strong>ï¼Œåˆ™æ¡ç›®ä¿ç•™åŸºç±»å‡½æ•°çš„åœ°å€ã€‚</li><li>å¦‚æœæ´¾ç”Ÿç±»<strong>å®šä¹‰äº†æ–°çš„è™šå‡½æ•°</strong>ï¼Œè¿™äº›å‡½æ•°çš„åœ°å€ä¼šè¢«è¿½åŠ åˆ° vtable çš„æœ«å°¾ã€‚</li></ul></li></ul></li></ul><hr><h3 id="_2-è™šæŒ‡é’ˆ-vptr-è¿æ¥å¯¹è±¡ä¸åœ°å›¾çš„æ¡¥æ¢" tabindex="-1"><a class="header-anchor" href="#_2-è™šæŒ‡é’ˆ-vptr-è¿æ¥å¯¹è±¡ä¸åœ°å›¾çš„æ¡¥æ¢"><span>2. è™šæŒ‡é’ˆ (vptr)ï¼šè¿æ¥å¯¹è±¡ä¸åœ°å›¾çš„æ¡¥æ¢</span></a></h3><p><strong>è™šæŒ‡é’ˆ</strong>æ˜¯ç¼–è¯‘å™¨éšå¼æ·»åŠ åˆ°å¯¹è±¡å®ä¾‹ä¸­çš„ä¸€ä¸ªæŒ‡é’ˆã€‚</p><ul><li><strong>å­˜åœ¨æ–¹å¼</strong>ï¼š <ul><li>å½“ä¸€ä¸ªç±»æ‹¥æœ‰è™šå‡½æ•°æ—¶ï¼Œç¼–è¯‘å™¨ä¼šä¸ºè¯¥ç±»çš„æ¯ä¸ªå¯¹è±¡å¢åŠ ä¸€ä¸ªéšè—çš„æŒ‡é’ˆæˆå‘˜ï¼ˆé€šå¸¸å‘½åä¸º <code>__vptr</code>ï¼‰ã€‚</li><li>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œ<code>vptr</code> é€šå¸¸ä½äºå¯¹è±¡å†…å­˜å¸ƒå±€çš„<strong>æœ€å‰é¢</strong>ï¼ˆOffset 0ï¼‰ã€‚</li></ul></li><li><strong>åˆå§‹åŒ–è¿‡ç¨‹</strong>ï¼š <ul><li><strong>æ„é€ å‡½æ•°æ‰§è¡Œæ—¶åˆå§‹åŒ–</strong>ã€‚</li><li>å½“åˆ›å»ºä¸€ä¸ªæ´¾ç”Ÿç±»å¯¹è±¡æ—¶ï¼š <ol><li>é¦–å…ˆè°ƒç”¨åŸºç±»æ„é€ å‡½æ•°ã€‚æ­¤æ—¶ <code>vptr</code> æŒ‡å‘<strong>åŸºç±»</strong>çš„ vtableã€‚</li><li>ç„¶åæ‰§è¡Œæ´¾ç”Ÿç±»æ„é€ å‡½æ•°ã€‚æ­¤æ—¶ <code>vptr</code> è¢«æ›´æ–°ï¼ŒæŒ‡å‘<strong>æ´¾ç”Ÿç±»</strong>çš„ vtableã€‚</li></ol></li><li><em>æ³¨æ„ï¼šè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆåœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨è™šå‡½æ•°æ— æ³•å®ç°å¤šæ€çš„åŸå› â€”â€”æ­¤æ—¶å¯¹è±¡å°šæœªå®Œå…¨æ„é€ ï¼Œ<code>vptr</code> ä»æŒ‡å‘å½“å‰æ„é€ å±‚çš„ vtableã€‚</em></li></ul></li><li><strong>ä½œç”¨</strong>ï¼š <ul><li>å®ƒæ˜¯å¯¹è±¡å®ä¾‹ä¸ç±» vtable ä¹‹é—´çš„çº½å¸¦ã€‚é€šè¿‡ <code>vptr</code>ï¼Œè¿è¡Œæ—¶ç³»ç»Ÿèƒ½å¤Ÿæ‰¾åˆ°è¯¥å¯¹è±¡å¯¹åº”çš„ vtableï¼Œè¿›è€Œæ‰¾åˆ°æ­£ç¡®çš„å‡½æ•°åœ°å€ã€‚</li></ul></li></ul><hr><h3 id="_3-åŠ¨æ€ç»‘å®šçš„æŸ¥æ‰¾è¿‡ç¨‹-ååŒå·¥ä½œåŸç†" tabindex="-1"><a class="header-anchor" href="#_3-åŠ¨æ€ç»‘å®šçš„æŸ¥æ‰¾è¿‡ç¨‹-ååŒå·¥ä½œåŸç†"><span>3. åŠ¨æ€ç»‘å®šçš„æŸ¥æ‰¾è¿‡ç¨‹ï¼šååŒå·¥ä½œåŸç†</span></a></h3><p>å½“æ‰§è¡Œç±»ä¼¼ <code>base_ptr-&gt;virtual_func()</code> çš„ä»£ç æ—¶ï¼Œç¼–è¯‘å™¨å¹¶ä¸ä¼šç”Ÿæˆä¸€ä¸ªç›´æ¥è·³è½¬åˆ°æŸä¸ªå‡½æ•°åœ°å€çš„æŒ‡ä»¤ï¼Œè€Œæ˜¯ç”Ÿæˆä¸€æ®µ<strong>æŸ¥æ‰¾ä»£ç </strong>ã€‚</p><h4 id="æŸ¥æ‰¾æ­¥éª¤-æ±‡ç¼–é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#æŸ¥æ‰¾æ­¥éª¤-æ±‡ç¼–é€»è¾‘"><span>æŸ¥æ‰¾æ­¥éª¤ï¼ˆæ±‡ç¼–é€»è¾‘ï¼‰ï¼š</span></a></h4><ol><li><strong>è·å– vptr</strong>ï¼šç¨‹åºè®¿é—® <code>base_ptr</code> æ‰€æŒ‡å‘çš„å¯¹è±¡ï¼Œå–å‡ºè¯¥å¯¹è±¡èµ·å§‹ä½ç½®å­˜å‚¨çš„ <code>vptr</code>ã€‚</li><li><strong>å®šä½ vtable</strong>ï¼šé€šè¿‡ <code>vptr</code> æ‰¾åˆ°è¯¥å¯¹è±¡æ‰€å±ç±»çš„è™šå‡½æ•°è¡¨ï¼ˆvtableï¼‰ã€‚</li><li><strong>ç´¢å¼•åç§»</strong>ï¼šç¼–è¯‘å™¨åœ¨ç¼–è¯‘é˜¶æ®µå·²ç»ç¡®å®šäº† <code>virtual_func</code> åœ¨ vtable ä¸­çš„<strong>åç§»é‡ï¼ˆIndexï¼‰</strong>ã€‚ä¾‹å¦‚ï¼Œå¦‚æœ <code>virtual_func</code> æ˜¯ç±»ä¸­å®šä¹‰çš„ç¬¬ä¸€ä¸ªè™šå‡½æ•°ï¼Œé‚£ä¹ˆå®ƒå°±åœ¨ç´¢å¼• 0 çš„ä½ç½®ã€‚</li><li><strong>é—´æ¥è·³è½¬</strong>ï¼šç¨‹åºå–å‡º vtable ä¸­å¯¹åº”ç´¢å¼•å¤„çš„å‡½æ•°æŒ‡é’ˆï¼Œå¹¶è·³è½¬åˆ°è¯¥åœ°å€æ‰§è¡Œã€‚</li></ol><h4 id="ä¸ºä»€ä¹ˆèƒ½ç¡®ä¿æ­£ç¡®æ€§" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆèƒ½ç¡®ä¿æ­£ç¡®æ€§"><span>ä¸ºä»€ä¹ˆèƒ½ç¡®ä¿æ­£ç¡®æ€§ï¼Ÿ</span></a></h4><ul><li><strong>é™æ€ä¸åŠ¨æ€çš„åˆ†å·¥</strong>ï¼š <ul><li><strong>ç¼–è¯‘å™¨ï¼ˆé™æ€ï¼‰</strong>ï¼šå†³å®šå‡½æ•°åœ¨ vtable ä¸­çš„â€œæ§½ä½â€ï¼ˆIndexï¼‰ã€‚æ— è®ºåŸºç±»è¿˜æ˜¯æ´¾ç”Ÿç±»ï¼ŒåŒä¸€ä¸ªè™šå‡½æ•°åœ¨ vtable ä¸­çš„ç´¢å¼•æ˜¯ä¸€è‡´çš„ã€‚</li><li><strong>è¿è¡Œæ—¶ï¼ˆåŠ¨æ€ï¼‰</strong>ï¼šé€šè¿‡ <code>vptr</code> æ‰¾åˆ°â€œå…·ä½“çš„åœ°å›¾â€ï¼ˆvtableï¼‰ã€‚å¦‚æœæ˜¯æ´¾ç”Ÿç±»å¯¹è±¡ï¼Œ<code>vptr</code> æŒ‡å‘æ´¾ç”Ÿç±»çš„è¡¨ï¼Œè¡¨é‡Œç´¢å¼• N çš„ä½ç½®å­˜æ”¾çš„æ˜¯æ´¾ç”Ÿç±»é‡å†™åçš„åœ°å€ã€‚</li></ul></li><li><strong>å®ä¾‹ç‹¬ç«‹æ€§</strong>ï¼šæ¯ä¸ªå¯¹è±¡å®ä¾‹éƒ½æœ‰ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ã€‚å³ä½¿æ˜¯ä¸¤ä¸ªä¸åŒçš„æ´¾ç”Ÿç±»å¯¹è±¡ï¼ˆä¾‹å¦‚ <code>Dog</code> å’Œ <code>Cat</code> éƒ½ç»§æ‰¿è‡ª <code>Animal</code>ï¼‰ï¼Œå®ƒä»¬å„è‡ªçš„ <code>vptr</code> ä¼šåˆ†åˆ«æŒ‡å‘ <code>Dog::vtable</code> å’Œ <code>Cat::vtable</code>ã€‚</li></ul><h3 id="æ€»ç»“å›¾ç¤º" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“å›¾ç¤º"><span>æ€»ç»“å›¾ç¤º</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>å¯¹è±¡å†…å­˜å¸ƒå±€ (Derived object)      æ´¾ç”Ÿç±»è™šå‡½æ•°è¡¨ (Derived vtable)</span></span>
<span class="line"><span>+-----------------------+        +--------------------------+</span></span>
<span class="line"><span>| vptr (æŒ‡å‘ vtable) ----|------&gt; | [0]: RTTI / type_info     |</span></span>
<span class="line"><span>+-----------------------+        +--------------------------+</span></span>
<span class="line"><span>| æˆå‘˜å˜é‡ A             |        | [1]: Derived::func1()    | (é‡å†™äº†åŸºç±»)</span></span>
<span class="line"><span>+-----------------------+        +--------------------------+</span></span>
<span class="line"><span>| æˆå‘˜å˜é‡ B             |        | [2]: Base::func2()       | (ç»§æ‰¿è‡ªåŸºç±»)</span></span>
<span class="line"><span>+-----------------------+        +--------------------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>ç»“è®º</strong>ï¼šC++ çš„å¤šæ€æ€§æ˜¯ä»¥<strong>ç©ºé—´æ¢æ—¶é—´</strong>çš„ç­–ç•¥ã€‚å®ƒå¢åŠ äº†ä¸€ä¸ªæŒ‡é’ˆçš„å†…å­˜å¼€é”€ï¼ˆvptrï¼‰å’Œä¸€å¼ è¡¨ï¼ˆvtableï¼‰çš„å­˜å‚¨å¼€é”€ï¼Œå¹¶é€šè¿‡ä¸¤æ¬¡è§£å¼•ç”¨ï¼ˆä¸€æ¬¡æ‰¾ vtableï¼Œä¸€æ¬¡æ‰¾å‡½æ•°ï¼‰çš„å¾®å°æ—¶é—´ä»£ä»·ï¼Œå®ç°äº†å¼ºå¤§çš„è¿è¡Œæ—¶çµæ´»æ€§ã€‚</p><h1 id="rtti" tabindex="-1"><a class="header-anchor" href="#rtti"><span>RTTI</span></a></h1><p>ç®€å•ä¸€å¥è¯ï¼š<strong>RTTI æ˜¯ä¸€å¥—ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„â€œç±»æè¿°ä¿¡æ¯â€ç»“æ„ä½“ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®å®åœ¨åœ¨å­˜åœ¨çš„åªè¯»æ•°æ®ï¼Œå­˜å‚¨åœ¨å¯æ‰§è¡Œæ–‡ä»¶çš„åªè¯»æ•°æ®æ®µï¼ˆ.rodataï¼‰ä¸­ã€‚</strong></p><p>ä¸‹é¢æ˜¯è¯¦ç»†çš„æ‹†è§£ï¼š</p><hr><h3 id="_1-rtti-æ˜¯ä»€ä¹ˆ-æ˜¯ä¸€ä¸ªé¢å¤–çš„ç»“æ„å—" tabindex="-1"><a class="header-anchor" href="#_1-rtti-æ˜¯ä»€ä¹ˆ-æ˜¯ä¸€ä¸ªé¢å¤–çš„ç»“æ„å—"><span>1. RTTI æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯ä¸€ä¸ªé¢å¤–çš„ç»“æ„å—ï¼Ÿ</span></a></h3><p><strong>æ˜¯çš„ï¼Œå®ƒæ˜¯ä¸€ç»„ç»“æ„ä½“ã€‚</strong></p><p>è™½ç„¶ C++ æ ‡å‡†åªè§„å®šäº† <code>std::type_info</code> ç±»ï¼Œä½†å„å¤§ç¼–è¯‘å™¨ï¼ˆå¦‚ GCC/Clang ä½¿ç”¨çš„ Itanium ABIï¼‰ä¸ºäº†å®ç° <code>dynamic_cast</code> åœ¨å¤æ‚çš„ç»§æ‰¿æ ‘é‡Œâ€œå¯¼èˆªâ€ï¼Œå®ç°äº†ä¸€å¥—éå¸¸è¯¦ç»†çš„ç»“æ„ä½“å±‚æ¬¡ï¼š</p><ul><li><strong><code>__class_type_info</code></strong>ï¼šæœ€åŸºç¡€çš„ç±»ï¼Œä¸åŒ…å«ç»§æ‰¿å…³ç³»ã€‚</li><li><strong><code>__si_class_type_info</code></strong>ï¼šå•ç»§æ‰¿ç±»çš„ RTTIã€‚å®ƒé‡Œé¢åŒ…å«ä¸€ä¸ªæŒ‡å‘åŸºç±» RTTI çš„æŒ‡é’ˆã€‚</li><li><strong><code>__vmi_class_type_info</code></strong>ï¼ˆVirtual Multiple Inheritanceï¼‰ï¼šæœ€å¤æ‚çš„ã€‚å®ƒè®°å½•äº†ï¼š <ul><li>æœ‰å¤šå°‘ä¸ªåŸºç±»ã€‚</li><li>æ¯ä¸ªåŸºç±»çš„ RTTI æŒ‡é’ˆã€‚</li><li>æ¯ä¸ªåŸºç±»ç›¸å¯¹äºå­ç±»å¤´éƒ¨çš„<strong>åç§»é‡</strong>ã€‚</li><li>åŸºç±»æ˜¯ <code>public</code> è¿˜æ˜¯ <code>private</code> ç»§æ‰¿ï¼Œæ˜¯å¦æ˜¯ <code>virtual</code> ç»§æ‰¿ã€‚</li></ul></li></ul><p><strong>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ <code>dynamic_cast</code> èƒ½åœ¨è¿è¡Œæ—¶çŸ¥é“å¦‚ä½•ä» <code>Father</code> è·³å› <code>Child</code>ï¼š</strong> å®ƒä¸æ˜¯é çŒœï¼Œè€Œæ˜¯é è¯»å–è¿™äº›åƒâ€œå®¶è°±â€ä¸€æ ·çš„ç»“æ„ä½“ã€‚</p><hr><h3 id="_2-rtti-å­˜åœ¨å“ªé‡Œ" tabindex="-1"><a class="header-anchor" href="#_2-rtti-å­˜åœ¨å“ªé‡Œ"><span>2. RTTI å­˜åœ¨å“ªé‡Œï¼Ÿ</span></a></h3><p>åœ¨å†…å­˜å¸ƒå±€ä¸­ï¼Œå®ƒå±äº<strong>é™æ€åªè¯»æ•°æ®</strong>ã€‚</p><ul><li><strong>ç‰©ç†ä½ç½®</strong>ï¼šåœ¨ ELF æ–‡ä»¶ï¼ˆLinuxï¼‰æˆ– PE æ–‡ä»¶ï¼ˆWindowsï¼‰çš„ <strong><code>.rodata</code></strong>ï¼ˆRead-Only Dataï¼‰æ®µï¼Œæˆ–è€…æ˜¯ <strong><code>.data.rel.ro</code></strong>ï¼ˆéœ€è¦é‡å®šä½çš„åªè¯»æ•°æ®æ®µï¼‰ã€‚</li><li><strong>é€»è¾‘è¿æ¥</strong>ï¼šè™šè¡¨ï¼ˆVTableï¼‰ä¸­ç´¢å¼•ä¸º <code>-1</code> çš„ä½ç½®ï¼ˆä¹Ÿå°±æ˜¯ <code>vptr</code> æ‰€æŒ‡åœ°å€çš„å‰ 8 ä¸ªå­—èŠ‚ï¼‰å­˜å‚¨äº†ä¸€ä¸ª<strong>åœ°å€</strong>ï¼Œè¿™ä¸ªåœ°å€æŒ‡å‘äº†è¿™ä¸ª RTTI ç»“æ„ä½“ã€‚</li></ul><p><strong>ç›´è§‚å›¾ç¤ºï¼š</strong></p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>[ å†…å­˜åœ°å€ ]    [ æ•°æ®å†…å®¹ ]</span></span>
<span class="line"><span>0x1000         [ offset-to-top ]  (è™šè¡¨å¼€å§‹)</span></span>
<span class="line"><span>0x1008         [ RTTI æŒ‡é’ˆ      ] --------+</span></span>
<span class="line"><span>0x1010 (vptr-&gt;)[ è™šå‡½æ•°1 åœ°å€    ]         |</span></span>
<span class="line"><span>                                         |</span></span>
<span class="line"><span>0x2000 (RTTI)  [ Child Type Info ] &lt;------+ (ä½äº .rodata)</span></span>
<span class="line"><span>0x2010         [ &quot;5Child&quot; (ç±»å) ]</span></span>
<span class="line"><span>0x2020         [ åŸºç±» RTTI æŒ‡é’ˆ   ] ----&gt; [ Father Type Info ]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="_3-ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„" tabindex="-1"><a class="header-anchor" href="#_3-ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„"><span>3. ä»€ä¹ˆæ—¶å€™åˆ›å»ºçš„ï¼Ÿ</span></a></h3><p><strong>åœ¨ç¼–è¯‘é˜¶æ®µï¼ˆCompile Timeï¼‰ç¡®å®šï¼Œåœ¨é“¾æ¥é˜¶æ®µï¼ˆLink Timeï¼‰åˆå¹¶ã€‚</strong></p><ol><li><strong>ç¼–è¯‘æ—¶</strong>ï¼šå½“ç¼–è¯‘å™¨å‘ç°ä¸€ä¸ªç±»åŒ…å«è™šå‡½æ•°ï¼ˆå³å®ƒæ˜¯â€œå¤šæ€ç±»â€ï¼‰æ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨ä¸ºè¯¥ç±»ç”Ÿæˆä¸¤æ ·ä¸œè¥¿ï¼š <ul><li><strong>è™šè¡¨ï¼ˆVTableï¼‰</strong>ã€‚</li><li><strong>RTTI ç»“æ„ä½“</strong>ï¼ˆåŒ…å«ç±»åå­—ç¬¦ä¸²ã€åŸºç±»æŒ‡é’ˆç­‰ï¼‰ã€‚</li></ul></li><li><strong>é“¾æ¥æ—¶</strong>ï¼šç”±äºä¸€ä¸ªç±»å¯èƒ½åœ¨å¤šä¸ª <code>.cpp</code> æ–‡ä»¶ä¸­è¢«å¼•ç”¨ï¼Œç¼–è¯‘å™¨ä¼šåœ¨æ¯ä¸ªç›®æ ‡æ–‡ä»¶é‡Œéƒ½ç”Ÿæˆä¸€ä»½ RTTIã€‚é“¾æ¥å™¨ï¼ˆldï¼‰è´Ÿè´£æŠŠé‡å¤çš„ RTTI åˆå¹¶ï¼Œç¡®ä¿åœ¨æ•´ä¸ªç¨‹åºè¿è¡ŒæœŸé—´ï¼ŒåŒä¸€ä¸ªç±»åªæœ‰ä¸€ä¸ªå”¯ä¸€çš„ RTTI å®ä¾‹ï¼ˆè¿™æ ·æ‰èƒ½ä¿è¯ <code>typeid(a) == typeid(b)</code> æˆç«‹ï¼‰ã€‚</li></ol><hr><h3 id="_4-ä¸ºä»€ä¹ˆè¦å¼ºè°ƒ-å¤šæ€ç±»-æ‰æœ‰-rtti" tabindex="-1"><a class="header-anchor" href="#_4-ä¸ºä»€ä¹ˆè¦å¼ºè°ƒ-å¤šæ€ç±»-æ‰æœ‰-rtti"><span>4. ä¸ºä»€ä¹ˆè¦å¼ºè°ƒâ€œå¤šæ€ç±»â€æ‰æœ‰ RTTIï¼Ÿ</span></a></h3><p>å¦‚æœä½ å®šä¹‰ä¸€ä¸ªæ™®é€šçš„ç±»ï¼š</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Simple</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> x; };</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>ç¼–è¯‘å™¨<strong>ä¸ä¼š</strong>ä¸ºå®ƒç”Ÿæˆè™šè¡¨ï¼Œä¹Ÿ<strong>ä¸ä¼š</strong>ä¸ºå®ƒç”Ÿæˆ RTTI ç»“æ„ã€‚</p><ul><li>å¦‚æœä½ å¯¹å®ƒè°ƒç”¨ <code>typeid</code>ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥åœ¨ç¼–è¯‘æ—¶ç¡¬ç¼–ç è¿”å›ä¸€ä¸ªé™æ€çš„ç»“æœã€‚</li><li>å¦‚æœä½ å¯¹å®ƒç”¨ <code>dynamic_cast</code>ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥æŠ¥é”™ï¼Œå› ä¸ºå®ƒæ ¹æœ¬æ²¡åœ°æ–¹å»æŸ¥â€œå®¶è°±â€ã€‚</li></ul><p><strong>åªæœ‰å½“ä½ å†™äº† <code>virtual</code>ï¼Œç¼–è¯‘å™¨æ‰ä¼šå¼€å¯è¿™å¥—â€œé­”æ³•â€æ”¯æŒã€‚</strong></p><hr><ol><li><strong>ç‰©ç†æœ¬è´¨</strong>ï¼šå®ƒæ˜¯ç¼–è¯‘å™¨åœ¨ <code>.rodata</code> æ®µç”Ÿæˆçš„ä¸€ç»„æè¿°ç±»ç»§æ‰¿å…³ç³»çš„å¸¸é‡ç»“æ„ä½“ï¼ˆå¦‚ <code>__vmi_class_type_info</code>ï¼‰ã€‚</li><li><strong>è¿æ¥æ–¹å¼</strong>ï¼šå®ƒé€šè¿‡è™šè¡¨ï¼ˆVTableï¼‰ä¸­è´Ÿç´¢å¼•ä½ç½®çš„æŒ‡é’ˆä¸å¯¹è±¡å®ä¾‹ç›¸è¿ã€‚</li><li><strong>æ ¸å¿ƒä½œç”¨</strong>ï¼š <ul><li><strong>èº«ä»½è¯†åˆ«</strong>ï¼šæ”¯æŒ <code>typeid</code> è¿ç®—ã€‚</li><li><strong>è·¯å¾„å¯¼èˆª</strong>ï¼šä¸º <code>dynamic_cast</code> æä¾›åœ¨å¤šé‡ç»§æ‰¿å’Œè™šç»§æ‰¿æ ‘ä¸­è¿›è¡Œåœ°å€åç§»è®¡ç®—çš„â€œåœ°å›¾â€ã€‚</li></ul></li><li><strong>å¼€é”€é™åˆ¶</strong>ï¼šå®ƒåªé’ˆå¯¹å¤šæ€ç±»ï¼ˆå«æœ‰è™šå‡½æ•°çš„ç±»ï¼‰ç”Ÿæˆã€‚è™½ç„¶å¯ä»¥é€šè¿‡ç¼–è¯‘é€‰é¡¹ï¼ˆå¦‚ <code>-fno-rtti</code>ï¼‰å…³é—­å®ƒä»¥èŠ‚çœç©ºé—´ï¼ˆåµŒå…¥å¼å¸¸ç”¨ï¼‰ï¼Œä½†è¿™æ ·ä¼šå¯¼è‡´ <code>dynamic_cast</code> æ— æ³•ä½¿ç”¨ã€‚</li></ol><p><strong>ä¸€å¥è¯ï¼šRTTI å°±æ˜¯ C++ ç±»çš„â€œè¿è¡Œæ—¶æˆ·å£æœ¬â€ã€‚</strong></p><h1 id="ç©ºç±»çš„å¤§å°" tabindex="-1"><a class="header-anchor" href="#ç©ºç±»çš„å¤§å°"><span>ç©ºç±»çš„å¤§å°</span></a></h1><h4 id="æƒ…å†µ-a-çœŸæ­£çš„ç©ºç±»-æ— ä»»ä½•æˆå‘˜-æ— è™šå‡½æ•°" tabindex="-1"><a class="header-anchor" href="#æƒ…å†µ-a-çœŸæ­£çš„ç©ºç±»-æ— ä»»ä½•æˆå‘˜-æ— è™šå‡½æ•°"><span>æƒ…å†µ Aï¼šçœŸæ­£çš„ç©ºç±»ï¼ˆæ— ä»»ä½•æˆå‘˜ï¼Œæ— è™šå‡½æ•°ï¼‰</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> Empty</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li><strong>å¤§å°ï¼š1 å­—èŠ‚</strong>ã€‚</li><li><strong>åŸå› </strong>ï¼šC++ è¦æ±‚æ¯ä¸ªå¯¹è±¡åœ¨å†…å­˜ä¸­å¿…é¡»æœ‰å”¯ä¸€çš„åœ°å€ã€‚å¦‚æœå¤§å°ä¸º 0ï¼Œé‚£ä¹ˆ <code>Empty a[10]</code> ä¸­æ‰€æœ‰å…ƒç´ çš„åœ°å€éƒ½ä¸€æ ·ï¼Œæ— æ³•åŒºåˆ†ã€‚å› æ­¤ç¼–è¯‘å™¨ä¼šæ’å…¥ä¸€ä¸ªâ€œå ä½ç¬¦â€å­—èŠ‚ã€‚</li><li><strong>ä¾‹å¤–ï¼ˆç©ºåŸºç±»ä¼˜åŒ– EBCOï¼‰</strong>ï¼šå¦‚æœè¿™ä¸ªç±»è¢«ç»§æ‰¿ï¼ˆä¾‹å¦‚ <code>class Derived : public Empty { int x; };</code>ï¼‰ï¼Œæ´¾ç”Ÿç±»çš„å¤§å°é€šå¸¸æ˜¯ 4 å­—èŠ‚ï¼Œç¼–è¯‘å™¨ä¼šä¼˜åŒ–æ‰åŸºç±»çš„é‚£ä¸ª 1 å­—èŠ‚ã€‚</li></ul><h4 id="æƒ…å†µ-b-å¸¦æœ‰è™šå‡½æ•°çš„-ç©º-ç±»" tabindex="-1"><a class="header-anchor" href="#æƒ…å†µ-b-å¸¦æœ‰è™šå‡½æ•°çš„-ç©º-ç±»"><span>æƒ…å†µ Bï¼šå¸¦æœ‰è™šå‡½æ•°çš„â€œç©ºâ€ç±»</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> VirtualEmpty</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    virtual</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> ~VirtualEmpty</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {}</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><strong>å¤§å°ï¼š8 å­—èŠ‚</strong>ï¼ˆåœ¨ 64 ä½ç³»ç»Ÿä¸Šï¼‰ã€‚</li><li><strong>åŸå› </strong>ï¼šä¸€æ—¦ç±»é‡Œæœ‰äº†è™šå‡½æ•°ï¼Œç¼–è¯‘å™¨å°±ä¼šä¸ºå®ƒç”Ÿæˆ <code>vtable</code>ã€‚ä¸ºäº†è®©å¯¹è±¡èƒ½æ‰¾åˆ°è¿™ä¸ªè¡¨ï¼Œæ¯ä¸ªå¯¹è±¡å®ä¾‹å¿…é¡»åŒ…å«ä¸€ä¸ª <strong><code>vptr</code>ï¼ˆè™šå‡½æ•°æŒ‡é’ˆï¼‰</strong>ã€‚åœ¨ 64 ä½ç¯å¢ƒä¸‹ï¼ŒæŒ‡é’ˆçš„å¤§å°æ˜¯ 8 å­—èŠ‚ã€‚</li></ul><hr><h3 id="å›¾ç¤º" tabindex="-1"><a class="header-anchor" href="#å›¾ç¤º"><span>å›¾ç¤º</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>Memory Layout of a Virtual Class Object:</span></span>
<span class="line"><span>+-------------------+</span></span>
<span class="line"><span>|      vptr         | ----+   [vtable]</span></span>
<span class="line"><span>+-------------------+     |   +-----------------------+</span></span>
<span class="line"><span>|   member data     |     |   | offset-to-top (-2)    |  &lt;-- ç”¨äºæ‰¾å¯¹è±¡å¤´</span></span>
<span class="line"><span>+-------------------+     |   +-----------------------+</span></span>
<span class="line"><span>                          |   | typeinfo ptr  (-1)    |  &lt;-- ç”¨äº dynamic_cast</span></span>
<span class="line"><span>                          +-&gt; +-----------------------+</span></span>
<span class="line"><span>                              | virtual_func_1 (0)    |  &lt;-- æ­£å¸¸çš„è™šå‡½æ•°è°ƒç”¨</span></span>
<span class="line"><span>                              +-----------------------+</span></span>
<span class="line"><span>                              | virtual_func_2 (1)    |</span></span>
<span class="line"><span>                              +-----------------------+</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>â€œä¸ºä»€ä¹ˆææ„å‡½æ•°é€šå¸¸è¦å£°æ˜ä¸º <code>virtual</code>ï¼Ÿâ€<br><strong>ç­”æ¡ˆï¼š</strong> è¿™æ ·å¯ä»¥ç¡®ä¿å½“é€šè¿‡åŸºç±»æŒ‡é’ˆåˆ é™¤æ´¾ç”Ÿç±»å¯¹è±¡æ—¶ï¼Œç¨‹åºèƒ½é€šè¿‡ <code>vtable</code> æ‰¾åˆ°æ´¾ç”Ÿç±»çš„ææ„å‡½æ•°ï¼Œä»è€Œæ­£ç¡®é‡Šæ”¾æ´¾ç”Ÿç±»ç‰¹æœ‰çš„èµ„æºï¼Œé˜²æ­¢å†…å­˜æ³„æ¼ã€‚</p><h1 id="è±å½¢ç»§æ‰¿ä¸è™šç»§æ‰¿" tabindex="-1"><a class="header-anchor" href="#è±å½¢ç»§æ‰¿ä¸è™šç»§æ‰¿"><span>è±å½¢ç»§æ‰¿ä¸è™šç»§æ‰¿</span></a></h1><p><strong>è™šç»§æ‰¿ï¼ˆVirtual Inheritanceï¼‰</strong> æ˜¯ C++ ä¸­ä¸ºäº†è§£å†³å¤šé‡ç»§æ‰¿ä¸­è‘—åçš„**â€œè±å½¢ç»§æ‰¿â€ï¼ˆDiamond Problemï¼‰**é—®é¢˜è€Œå¼•å…¥çš„ä¸€ç§æœºåˆ¶ã€‚</p><p>ç®€å•æ¥è¯´ï¼Œå®ƒçš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼š<strong>ç¡®ä¿åœ¨å¤æ‚çš„ç»§æ‰¿ç½‘ç»œä¸­ï¼Œæœ€é¡¶å±‚çš„åŸºç±»åœ¨å­ç±»å¯¹è±¡ä¸­åªä¿ç•™ä¸€ä»½å®ä¾‹ã€‚</strong></p><hr><h3 id="ä¸€ã€-è™šç»§æ‰¿è§£å†³çš„é—®é¢˜-è±å½¢ç»§æ‰¿" tabindex="-1"><a class="header-anchor" href="#ä¸€ã€-è™šç»§æ‰¿è§£å†³çš„é—®é¢˜-è±å½¢ç»§æ‰¿"><span>ä¸€ã€ è™šç»§æ‰¿è§£å†³çš„é—®é¢˜ï¼šè±å½¢ç»§æ‰¿</span></a></h3><p>æƒ³è±¡è¿™æ ·ä¸€ä¸ªç»§æ‰¿å…³ç³»ï¼š</p><ol><li><strong>ç±» A</strong>ï¼ˆåŸºç±»ï¼‰ï¼šæœ‰ä¸€ä¸ªæˆå‘˜å˜é‡ <code>int a;</code></li><li><strong>ç±» B</strong> ç»§æ‰¿è‡ª Aã€‚</li><li><strong>ç±» C</strong> ç»§æ‰¿è‡ª Aã€‚</li><li><strong>ç±» D</strong> åŒæ—¶ç»§æ‰¿è‡ª B å’Œ Cã€‚</li></ol><h4 id="_1-å¦‚æœä¸ä½¿ç”¨è™šç»§æ‰¿-æ™®é€šç»§æ‰¿" tabindex="-1"><a class="header-anchor" href="#_1-å¦‚æœä¸ä½¿ç”¨è™šç»§æ‰¿-æ™®é€šç»§æ‰¿"><span>1. å¦‚æœä¸ä½¿ç”¨è™šç»§æ‰¿ï¼ˆæ™®é€šç»§æ‰¿ï¼‰ï¼š</span></a></h4><p>åœ¨ <code>D</code> ç±»çš„å¯¹è±¡å†…å­˜å¸ƒå±€ä¸­ï¼Œä¼šå­˜åœ¨<strong>ä¸¤ä»½</strong> <code>A</code> çš„æ‹·è´ï¼š</p><ul><li>ä¸€ä»½æ¥è‡ª <code>D -&gt; B -&gt; A</code></li><li>ä¸€ä»½æ¥è‡ª <code>D -&gt; C -&gt; A</code></li></ul><p><strong>è¿™ä¼šå¯¼è‡´ä¸¤ä¸ªä¸¥é‡é—®é¢˜ï¼š</strong></p><ul><li><strong>æ•°æ®å†—ä½™</strong>ï¼šå¯¹è±¡ <code>D</code> å†…éƒ¨å­˜äº†ä¸¤ä¸ª <code>a</code> å˜é‡ï¼Œç™½ç™½æµªè´¹å†…å­˜ã€‚</li><li><strong>äºŒä¹‰æ€§ï¼ˆAmbiguityï¼‰</strong>ï¼šå½“ä½ é€šè¿‡ <code>D</code> çš„å¯¹è±¡è®¿é—® <code>a</code> æ—¶ï¼ˆä¾‹å¦‚ <code>d.a = 10;</code>ï¼‰ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ã€‚å› ä¸ºå®ƒä¸çŸ¥é“ä½ æ˜¯æƒ³æ”¹ <code>B</code> è·¯å¾„ä¸‹çš„ <code>a</code> è¿˜æ˜¯ <code>C</code> è·¯å¾„ä¸‹çš„ <code>a</code>ã€‚ä½ å¿…é¡»å†™æˆ <code>d.B::a</code> è¿™ç§ä¸‘é™‹çš„ä»£ç ã€‚</li></ul><h4 id="_2-å¦‚æœä½¿ç”¨è™šç»§æ‰¿" tabindex="-1"><a class="header-anchor" href="#_2-å¦‚æœä½¿ç”¨è™šç»§æ‰¿"><span>2. å¦‚æœä½¿ç”¨è™šç»§æ‰¿ï¼š</span></a></h4><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> a; };</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">virtual</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { ... };</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // è™šç»§æ‰¿</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> C</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">virtual</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { ... };</span><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;"> // è™šç»§æ‰¿</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> D</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> C</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> { ... };</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ­¤æ—¶ï¼Œ<code>D</code> å¯¹è±¡ä¸­<strong>åªæœ‰ä¸€ä»½</strong> <code>A</code> çš„æˆå‘˜ã€‚æ— è®ºä» <code>B</code> è·¯å¾„è¿˜æ˜¯ <code>C</code> è·¯å¾„å»è®¿é—®ï¼Œæ“ä½œçš„éƒ½æ˜¯åŒä¸€ä¸ª <code>a</code>ã€‚</p><hr><h3 id="äºŒã€-è™šç»§æ‰¿çš„-åº•å±‚é­”æ³•-å®ƒæ˜¯å¦‚ä½•å®ç°çš„" tabindex="-1"><a class="header-anchor" href="#äºŒã€-è™šç»§æ‰¿çš„-åº•å±‚é­”æ³•-å®ƒæ˜¯å¦‚ä½•å®ç°çš„"><span>äºŒã€ è™šç»§æ‰¿çš„â€œåº•å±‚é­”æ³•â€ï¼šå®ƒæ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</span></a></h3><p>è™šç»§æ‰¿çš„å®ç°æ¯”æ™®é€šç»§æ‰¿å¤æ‚å¾—å¤šï¼Œå› ä¸ºå®ƒæ‰“ç ´äº†â€œåŸºç±»å¿…é¡»æ’åœ¨æ´¾ç”Ÿç±»å‰é¢â€çš„å¸¸è§„å¸ƒå±€ã€‚</p><h4 id="_1-å†…å­˜å¸ƒå±€çš„æ”¹å˜" tabindex="-1"><a class="header-anchor" href="#_1-å†…å­˜å¸ƒå±€çš„æ”¹å˜"><span>1. å†…å­˜å¸ƒå±€çš„æ”¹å˜</span></a></h4><p>åœ¨æ™®é€šç»§æ‰¿ä¸­ï¼Œå­ç±»å¯¹è±¡åªæ˜¯ç®€å•åœ°æŠŠåŸºç±»æˆå‘˜â€œè´´â€åœ¨è‡ªå·±æˆå‘˜çš„å‰é¢ã€‚<br> ä½†åœ¨<strong>è™šç»§æ‰¿</strong>ä¸­ï¼Œè™šåŸºç±»ï¼ˆå³ Aï¼‰çš„ä½ç½®æ˜¯<strong>ä¸å›ºå®š</strong>çš„ã€‚å®ƒé€šå¸¸è¢«æ”¾åœ¨æ•´ä¸ªå¯¹è±¡å†…å­˜çš„æœ€æœ«å°¾ã€‚</p><h4 id="_2-å…³é”®ç»„ä»¶-vbase-offset-è™šåŸºç±»åç§»é‡" tabindex="-1"><a class="header-anchor" href="#_2-å…³é”®ç»„ä»¶-vbase-offset-è™šåŸºç±»åç§»é‡"><span>2. å…³é”®ç»„ä»¶ï¼šVBase Offsetï¼ˆè™šåŸºç±»åç§»é‡ï¼‰</span></a></h4><p>æ—¢ç„¶ <code>A</code> çš„ä½ç½®ä¸å›ºå®šï¼Œé‚£ä¹ˆ <code>B</code> å’Œ <code>C</code> åœ¨è¿è¡Œæ—¶æ€ä¹ˆæ‰¾åˆ° <code>A</code> å‘¢ï¼Ÿ</p><p>è¿˜è®°å¾—æˆ‘ä»¬ä¹‹å‰èŠè¿‡çš„ <strong>è™šè¡¨ï¼ˆVTableï¼‰</strong> å—ï¼Ÿåœ¨è™šç»§æ‰¿ä¸‹ï¼Œè™šè¡¨é‡Œåˆå¤šäº†ä¸€ä¸ªé‡è¦çš„å­—æ®µï¼š<strong>VBase Offset</strong>ã€‚</p><ul><li><strong>B çš„è™šè¡¨</strong>é‡Œä¼šå¤šå‡ºä¸€é¡¹ï¼šè®°å½•â€œä» B çš„èµ·å§‹åœ°å€åˆ° A çš„èµ·å§‹åœ°å€éœ€è¦åç§»å¤šå°‘å­—èŠ‚â€ã€‚</li><li>å½“ä½ åœ¨ä»£ç é‡Œå†™ <code>B* ptr = &amp;d; ptr-&gt;a = 5;</code> æ—¶ï¼Œç¼–è¯‘å™¨ä¼šç”Ÿæˆè¿™æ ·çš„ä»£ç ï¼š <ol><li>æŸ¥ <code>ptr</code> æŒ‡å‘çš„è™šè¡¨ã€‚</li><li>æ‰¾åˆ° <strong>VBase Offset</strong>ã€‚</li><li>æ ¹æ®åç§»é‡æ‰¾åˆ° <code>A</code> çš„çœŸå®ä½ç½®ï¼Œå†ä¿®æ”¹ <code>a</code>ã€‚</li></ol></li></ul><hr><h3 id="ä¸‰ã€-è™šç»§æ‰¿ä¸‹çš„å¯¹è±¡å¸ƒå±€ç¤ºæ„å›¾-64ä½ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#ä¸‰ã€-è™šç»§æ‰¿ä¸‹çš„å¯¹è±¡å¸ƒå±€ç¤ºæ„å›¾-64ä½ç³»ç»Ÿ"><span>ä¸‰ã€ è™šç»§æ‰¿ä¸‹çš„å¯¹è±¡å¸ƒå±€ç¤ºæ„å›¾ï¼ˆ64ä½ç³»ç»Ÿï¼‰</span></a></h3><p>å‡è®¾ <code>D</code> ç»§æ‰¿è‡ªè™šåŸºç±» <code>B</code> å’Œ <code>C</code>ï¼š</p><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>[ Child D å¯¹è±¡çš„èµ·å§‹ ]</span></span>
<span class="line"><span>0-7   å­—èŠ‚: vptr_B (æŒ‡å‘ DasB çš„è™šè¡¨)</span></span>
<span class="line"><span>8-15  å­—èŠ‚: B çš„æˆå‘˜å˜é‡</span></span>
<span class="line"><span>16-23 å­—èŠ‚: vptr_C (æŒ‡å‘ DasC çš„è™šè¡¨)</span></span>
<span class="line"><span>24-31 å­—èŠ‚: C çš„æˆå‘˜å˜é‡</span></span>
<span class="line"><span>32-39 å­—èŠ‚: D çš„æˆå‘˜å˜é‡</span></span>
<span class="line"><span>40-47 å­—èŠ‚: [ è™šåŸºç±» A çš„æˆå‘˜ ]  &lt;-- è¢«æŒªåˆ°äº†æœ€åï¼Œä¸”å…¨å®¶å…±äº«è¿™ä¸€ä»½</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>åœ¨ B çš„è™šè¡¨é‡Œï¼š</strong></p><ul><li><code>offset-to-top</code>: 0</li><li><code>vbase_offset</code>: <strong>40</strong> (å‘Šè¯‰ Bï¼ŒA åœ¨ 40 å­—èŠ‚åçš„ä½ç½®)</li></ul><p><strong>åœ¨ C çš„è™šè¡¨é‡Œï¼š</strong></p><ul><li><code>offset-to-top</code>: -16</li><li><code>vbase_offset</code>: <strong>24</strong> (16+24=40ï¼ŒåŒæ ·æŒ‡å‘ A)</li></ul><blockquote><p>è™šè¡¨æ˜¯â€œç±»â€çš„å±æ€§ï¼Œè€Œä¸æ˜¯â€œåŸºç±»â€çš„å±æ€§<br> åœ¨å†…å­˜ä¸­ï¼Œclass Bã€class CÂ å’ŒÂ class DÂ æ˜¯ä¸‰ä¸ªå®Œå…¨ä¸åŒçš„ç±»ã€‚</p></blockquote><ul><li><strong>class BÂ çš„è™šè¡¨</strong>ï¼šè®°å½•çš„æ˜¯â€œå½“æˆ‘æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ B å¯¹è±¡æ—¶ï¼Œæˆ‘è¯¥æ€ä¹ˆæ´»â€ã€‚</li><li><strong>class CÂ çš„è™šè¡¨</strong>ï¼šè®°å½•çš„æ˜¯â€œå½“æˆ‘æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„ C å¯¹è±¡æ—¶ï¼Œæˆ‘è¯¥æ€ä¹ˆæ´»â€ã€‚</li><li><strong>class DÂ çš„è™šè¡¨ç»„</strong>ï¼šè®°å½•çš„æ˜¯â€œ<strong>å½“æˆ‘æ˜¯ D çš„æ—¶å€™ï¼Œæˆ‘çš„ B éƒ¨åˆ†ã€C éƒ¨åˆ†å’Œ A éƒ¨åˆ†è¯¥æ€ä¹ˆé…åˆå·¥ä½œ</strong>â€ã€‚</li></ul><p>æ‰€ä»¥ï¼ŒDÂ å¯¹è±¡é‡Œçš„Â vptr_BÂ æŒ‡å‘çš„ç»å¯¹ä¸æ˜¯Â class BÂ å®šä¹‰çš„é‚£ä¸ªåŸå§‹è™šè¡¨ï¼Œè€Œæ˜¯æŒ‡å‘Â <strong>class DÂ ä¸“é—¨ä¸ºè‡ªå·±çš„Â BÂ åˆ†æ”¯å®šåˆ¶çš„è™šè¡¨</strong>ã€‚</p><hr><blockquote><p>æ‰€ä»¥æœ‰å¤šä¸ªvptrçš„åŸå› å°±æ˜¯è¦èƒ½å¤Ÿåœ¨é€šè¿‡ABC (å„ä¸ªçˆ¶ç±») çš„æŒ‡é’ˆè®¿é—®çš„æ—¶å€™èƒ½å¤Ÿç›´æ¥æ‰¾åˆ°vptr è€Œä¸”èƒ½å¤Ÿç›´æ¥æ‰¾åˆ°RTII æ‰€ä»¥å¯ä»¥æŒæœ‰çˆ¶ç±»æŒ‡é’ˆè¿›è¡Œdycast</p></blockquote><hr><h3 id="å››ã€-è™šç»§æ‰¿çš„ä»£ä»·" tabindex="-1"><a class="header-anchor" href="#å››ã€-è™šç»§æ‰¿çš„ä»£ä»·"><span>å››ã€ è™šç»§æ‰¿çš„ä»£ä»·</span></a></h3><p>è™½ç„¶è™šç»§æ‰¿è§£å†³äº†è±å½¢ç»§æ‰¿ï¼Œä½†å®ƒä¸æ˜¯å…è´¹çš„åˆé¤ï¼š</p><ol><li><strong>æ€§èƒ½å¼€é”€</strong>ï¼šæ™®é€šç»§æ‰¿è®¿é—®åŸºç±»æˆå‘˜æ˜¯â€œç›´æ¥å¯»å€â€ï¼Œè™šç»§æ‰¿æ˜¯â€œé—´æ¥å¯»å€â€ï¼ˆéœ€è¦æŸ¥è¡¨æ‹¿åç§»é‡ï¼‰ï¼Œé€Ÿåº¦ç¨æ…¢ã€‚</li><li><strong>å†…å­˜å¼€é”€</strong>ï¼šæ¯ä¸ªè™šç»§æ‰¿çš„å­ç±»å¯¹è±¡éƒ½éœ€è¦é¢å¤–çš„ <code>vptr</code>ï¼ˆå¦‚æœåŸæœ¬æ²¡æœ‰ï¼‰ï¼Œä¸”è™šè¡¨ä½“ç§¯å˜å¤§ã€‚</li><li><strong>åˆå§‹åŒ–è´£ä»»</strong>ï¼šåœ¨è™šç»§æ‰¿ä¸­ï¼Œè™šåŸºç±» <code>A</code> ä¸å†ç”±ç›´æ¥æ´¾ç”Ÿç±» <code>B</code> æˆ– <code>C</code> åˆå§‹åŒ–ï¼Œè€Œæ˜¯ç”±<strong>æœ€ç»ˆæ´¾ç”Ÿç±» <code>D</code></strong> è´Ÿè´£åˆå§‹åŒ–ã€‚è¿™æ„å‘³ç€ <code>D</code> çš„æ„é€ å‡½æ•°å¿…é¡»æ˜¾å¼è°ƒç”¨ <code>A</code> çš„æ„é€ å‡½æ•°ã€‚ï¼ˆå¦‚æœæ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°çš„è¯ï¼‰</li></ol><blockquote><p><strong>åº”ç”¨åœºæ™¯</strong>ï¼šæœ€è‘—åçš„ä¾‹å­æ˜¯æ ‡å‡†åº“ä¸­çš„Â <strong>iostream</strong>ã€‚å®ƒç»§æ‰¿è‡ªÂ istreamÂ å’ŒÂ ostreamï¼Œè€Œè¿™ä¸¤è€…åˆå…±åŒè™šç»§æ‰¿è‡ªÂ iosã€‚å¦‚æœæ²¡æœ‰è™šç»§æ‰¿ï¼ŒcoutÂ å°±ä¼šæœ‰ä¸¤ä»½æ–‡ä»¶çŠ¶æ€ä¿¡æ¯ã€‚</p></blockquote><h2 id="è™šåŸºç±»çš„æ„é€ " tabindex="-1"><a class="header-anchor" href="#è™šåŸºç±»çš„æ„é€ "><span>è™šåŸºç±»çš„æ„é€ </span></a></h2><h3 id="ä¸ºä»€ä¹ˆå¿…é¡»ç”±-d-åˆå§‹åŒ–" tabindex="-1"><a class="header-anchor" href="#ä¸ºä»€ä¹ˆå¿…é¡»ç”±-d-åˆå§‹åŒ–"><span>ä¸ºä»€ä¹ˆå¿…é¡»ç”± D åˆå§‹åŒ–ï¼Ÿ</span></a></h3><p>å¦‚æœç”± B å’Œ C å„è‡ªè´Ÿè´£åˆå§‹åŒ– Aï¼Œé‚£ä¹ˆåœ¨åˆ›å»º D çš„å¯¹è±¡æ—¶ï¼ŒA å°±ä¼šè¢«åˆå§‹åŒ–<strong>ä¸¤æ¬¡</strong>ï¼ˆä¸€æ¬¡ç”± B çš„è·¯å¾„ï¼Œä¸€æ¬¡ç”± C çš„è·¯å¾„ï¼‰ã€‚è¿™è¿èƒŒäº†è™šç»§æ‰¿â€œåœ¨å†…å­˜ä¸­åªæœ‰ä¸€ä»½ A å®ä¾‹â€çš„åˆè¡·ã€‚</p><p>å› æ­¤ï¼ŒC++ è§„å®šï¼š<strong>è™šåŸºç±»ç”±â€œæœ€åº•å±‚â€çš„æ´¾ç”Ÿç±»ï¼ˆMost Derived Classï¼‰è´Ÿè´£åˆå§‹åŒ–ï¼Œä¸­é—´è·¯å¾„ä¸Šçš„æ„é€ å‡½æ•°å¯¹è™šåŸºç±»çš„è°ƒç”¨ä¼šè¢«è‡ªåŠ¨å¿½ç•¥ã€‚</strong></p><hr><h3 id="ä»£ç ç¤ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ä»£ç ç¤ºä¾‹"><span>ä»£ç ç¤ºä¾‹</span></a></h3><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼ŒåŸºç±» <code>A</code> æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œå¿…é¡»ä¼ ä¸€ä¸ª <code>int</code> å‚æ•°ã€‚</p><div class="language-cpp line-numbers-mode" data-highlighter="shiki" data-ext="cpp" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-cpp"><span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">#include</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &lt;iostream&gt;</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">using</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> namespace</span><span style="--shiki-light:#383A42;--shiki-dark:#E5C07B;"> std</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 1. è™šåŸºç±»</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    int</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> val;</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">val</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;A æ„é€ å‡½æ•°è¢«è°ƒç”¨ï¼Œval = &quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> val </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 2. è™šç»§æ‰¿ A çš„ç±» B</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">virtual</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // B çš„æ„é€ å‡½æ•°è¯•å›¾æŠŠ x ä¼ ç»™ A</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;B æ„é€ å‡½æ•°è¢«è°ƒç”¨&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 3. è™šç»§æ‰¿ A çš„ç±» C</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> C</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">virtual</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // C çš„æ„é€ å‡½æ•°ä¹Ÿè¯•å›¾æŠŠ x ä¼ ç»™ A</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    C</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x) {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;C æ„é€ å‡½æ•°è¢«è°ƒç”¨&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">// 4. æœ€ç»ˆæ´¾ç”Ÿç±» D</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">class</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> D</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> : </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#C18401;--shiki-dark:#E5C07B;"> C</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">public:</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å…³é”®ç‚¹ï¼šD å¿…é¡»æ˜¾å¼è°ƒç”¨ A çš„æ„é€ å‡½æ•°</span></span>
<span class="line"><span style="--shiki-light:#A0A1A7;--shiki-light-font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic;">    // å³ä½¿ B å’Œ C éƒ½å†™äº† A(x)ï¼Œé‚£äº›è°ƒç”¨åœ¨åˆ›å»º D å¯¹è±¡æ—¶éƒ½ä¼šè¢«å±è”½</span></span>
<span class="line"><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">    D</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#383A42;--shiki-light-font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic;"> x</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">) : </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">A</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x), </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">B</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x), </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">C</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(x) { </span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">        cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;D æ„é€ å‡½æ•°è¢«è°ƒç”¨&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">int</span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;"> main</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">() {</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    cout </span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">&lt;&lt;</span><span style="--shiki-light:#50A14F;--shiki-dark:#98C379;"> &quot;--- å¼€å§‹åˆ›å»º D å¯¹è±¡ ---&quot;</span><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;"> &lt;&lt;</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;"> endl;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">    D </span><span style="--shiki-light:#4078F2;--shiki-dark:#61AFEF;">obj</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;">100</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#A626A4;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#986801;--shiki-dark:#D19A66;"> 0</span><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#383A42;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="è¿è¡Œç»“æœ" tabindex="-1"><a class="header-anchor" href="#è¿è¡Œç»“æœ"><span>è¿è¡Œç»“æœ</span></a></h3><div class="language-text line-numbers-mode" data-highlighter="shiki" data-ext="text" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-text"><span class="line"><span>--- å¼€å§‹åˆ›å»º D å¯¹è±¡ ---</span></span>
<span class="line"><span>A æ„é€ å‡½æ•°è¢«è°ƒç”¨ï¼Œval = 100</span></span>
<span class="line"><span>B æ„é€ å‡½æ•°è¢«è°ƒç”¨</span></span>
<span class="line"><span>C æ„é€ å‡½æ•°è¢«è°ƒç”¨</span></span>
<span class="line"><span>D æ„é€ å‡½æ•°è¢«è°ƒç”¨</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><hr><h3 id="æ·±åº¦è§£æ" tabindex="-1"><a class="header-anchor" href="#æ·±åº¦è§£æ"><span>æ·±åº¦è§£æ</span></a></h3><h4 id="_1-å¦‚æœ-d-ä¸æ˜¾å¼è°ƒç”¨-a-x-ä¼šæ€æ ·" tabindex="-1"><a class="header-anchor" href="#_1-å¦‚æœ-d-ä¸æ˜¾å¼è°ƒç”¨-a-x-ä¼šæ€æ ·"><span>1. å¦‚æœ D ä¸æ˜¾å¼è°ƒç”¨ A(x) ä¼šæ€æ ·ï¼Ÿ</span></a></h4><p>å¦‚æœ <code>A</code> <strong>æ²¡æœ‰</strong>é»˜è®¤æ„é€ å‡½æ•°ï¼ˆæ— å‚æ„é€ å‡½æ•°ï¼‰ï¼Œè€Œ <code>D</code> çš„æ„é€ å‡½æ•°é‡Œæ²¡å†™ <code>A(x)</code>ï¼Œç¼–è¯‘å™¨ä¼šç›´æ¥æŠ¥é”™ï¼š</p><blockquote><p><code>error: no matching function for call to &#39;A::A()&#39;</code></p></blockquote><p>å› ä¸ºç¼–è¯‘å™¨è®¤ä¸º D æ—¢ç„¶æ˜¯â€œæœ€ç»ˆè´Ÿè´£äººâ€ï¼Œå®ƒå°±å¿…é¡»è´Ÿè´£æŠŠ A ç›–èµ·æ¥ã€‚å¦‚æœ D æ²¡äº¤ä»£æ€ä¹ˆç›– Aï¼Œç¼–è¯‘å™¨ä¸ä¼šå»æ±‚åŠ© B æˆ– Cã€‚</p><h4 id="_2-å¦‚æœ-a-æœ‰é»˜è®¤æ„é€ å‡½æ•°-d-æ²¡å†™-a-x-ä¼šæ€æ ·" tabindex="-1"><a class="header-anchor" href="#_2-å¦‚æœ-a-æœ‰é»˜è®¤æ„é€ å‡½æ•°-d-æ²¡å†™-a-x-ä¼šæ€æ ·"><span>2. å¦‚æœ A æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼ŒD æ²¡å†™ A(x) ä¼šæ€æ ·ï¼Ÿ</span></a></h4><p>å¦‚æœ <code>A</code> æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œè€Œ <code>D</code> æ²¡å†™ <code>A(x)</code>ï¼Œé‚£ä¹ˆï¼š</p><ol><li><code>D</code> ä¼šè°ƒç”¨ <code>A</code> çš„<strong>é»˜è®¤æ„é€ å‡½æ•°</strong>ã€‚</li><li><code>B</code> å’Œ <code>C</code> æ„é€ å‡½æ•°ä¸­å¯¹ <code>A(x)</code> çš„è°ƒç”¨<strong>ä¾ç„¶ä¼šè¢«å¿½ç•¥</strong>ã€‚</li><li>ç»“æœå°±æ˜¯ <code>obj.val</code> å¯èƒ½æ˜¯ä¸ªéšæœºå€¼æˆ–é»˜è®¤å€¼ï¼Œè€Œä¸æ˜¯ä½ æƒ³è¦çš„ 100ã€‚</li></ol><h4 id="_3-æ„é€ é¡ºåºæ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#_3-æ„é€ é¡ºåºæ˜¯ä»€ä¹ˆ"><span>3. æ„é€ é¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h4><p>æ— è®º D çš„åˆå§‹åŒ–åˆ—è¡¨é‡Œ <code>A(x)</code> å†™åœ¨ä»€ä¹ˆä½ç½®ï¼ˆå³ä¾¿å†™åœ¨ B å’Œ C åé¢ï¼‰ï¼Œ<strong>è™šåŸºç±» A æ°¸è¿œæ˜¯ç¬¬ä¸€ä¸ªè¢«æ„é€ çš„</strong>ã€‚</p><h3 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“"><span>æ€»ç»“</span></a></h3><p>â€œåœ¨è™šç»§æ‰¿ä¸­ï¼Œä¸ºäº†ä¿è¯è™šåŸºç±»åœ¨å†…å­˜ä¸­åªæœ‰å”¯ä¸€å¤‡ä»½ï¼ŒC++ è§„å®šè™šåŸºç±»çš„åˆå§‹åŒ–è´£ä»»ç”±æ•´ä¸ªç»§æ‰¿é“¾ä¸­æœ€åº•å±‚çš„ç±»æ‰¿æ‹…ã€‚ä¸­é—´ç±»çš„æ„é€ å‡½æ•°åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­å¯¹è™šåŸºç±»çš„è°ƒç”¨ä¼šåœ¨è¿è¡Œæ—¶è¢«å±è”½ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœè™šåŸºç±»æ²¡æœ‰é»˜è®¤æ„é€ å‡½æ•°ï¼Œæœ€åº•å±‚çš„ç±»å¿…é¡»åœ¨åˆå§‹åŒ–åˆ—è¡¨ä¸­æ˜¾å¼è°ƒç”¨è™šåŸºç±»çš„æ„é€ å‡½æ•°ï¼Œå¦åˆ™æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚â€</p><h2 id="è±å½¢ç»§æ‰¿-æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#è±å½¢ç»§æ‰¿-æ€»ç»“"><span>è±å½¢ç»§æ‰¿ æ€»ç»“</span></a></h2><hr><h3 id="_1-åŸºç¡€å®šä¹‰ä¸æ ¸å¿ƒçŸ›ç›¾" tabindex="-1"><a class="header-anchor" href="#_1-åŸºç¡€å®šä¹‰ä¸æ ¸å¿ƒçŸ›ç›¾"><span>1. åŸºç¡€å®šä¹‰ä¸æ ¸å¿ƒçŸ›ç›¾</span></a></h3><ul><li><strong>ç»“æ„æè¿°</strong>ï¼šç±» A ä¸ºåŸºç±»ï¼ŒB å’Œ C åˆ†åˆ«è™šæ‹Ÿç»§æ‰¿è‡ª Aï¼Œæœ€å D åŒæ—¶ç»§æ‰¿ B å’Œ Cã€‚</li><li><strong>ä¸¤å¤§é—®é¢˜ï¼ˆä¸ä½¿ç”¨è™šç»§æ‰¿æ—¶ï¼‰</strong>ï¼š <ol><li><strong>æ•°æ®å†—ä½™</strong>ï¼šD å¯¹è±¡å†…éƒ¨åŒ…å«ä¸¤ä»½ A çš„æˆå‘˜ï¼Œæµªè´¹å†…å­˜ã€‚</li><li><strong>è®¿é—®äºŒä¹‰æ€§</strong>ï¼šé€šè¿‡ D è®¿é—® A çš„æˆå‘˜æ—¶ï¼Œç¼–è¯‘å™¨æ— æ³•ç¡®å®šæ˜¯èµ° B è·¯å¾„è¿˜æ˜¯ C è·¯å¾„ã€‚</li></ol></li></ul><h3 id="_2-è§£å†³æ–¹æ¡ˆ-è™šæ‹Ÿç»§æ‰¿-virtual-inheritance" tabindex="-1"><a class="header-anchor" href="#_2-è§£å†³æ–¹æ¡ˆ-è™šæ‹Ÿç»§æ‰¿-virtual-inheritance"><span>2. è§£å†³æ–¹æ¡ˆï¼šè™šæ‹Ÿç»§æ‰¿ï¼ˆVirtual Inheritanceï¼‰</span></a></h3><ul><li><strong>è¯­æ³•</strong>ï¼š<code>class B : virtual public A</code>ã€‚</li><li><strong>æ ¸å¿ƒä½œç”¨</strong>ï¼šç¡®ä¿åœ¨æ•´ä¸ªç»§æ‰¿ä½“ç³»ä¸­ï¼Œè™šåŸºç±» A çš„å­å¯¹è±¡åœ¨æœ€ç»ˆæ´¾ç”Ÿç±» D ä¸­<strong>åªæœ‰ä¸€ä»½å…±äº«çš„å®ä¾‹</strong>ã€‚</li></ul><h3 id="_3-å¯¹è±¡å†…å­˜å¸ƒå±€-æ ¸å¿ƒåº•å±‚é€»è¾‘" tabindex="-1"><a class="header-anchor" href="#_3-å¯¹è±¡å†…å­˜å¸ƒå±€-æ ¸å¿ƒåº•å±‚é€»è¾‘"><span>3. å¯¹è±¡å†…å­˜å¸ƒå±€ï¼ˆæ ¸å¿ƒåº•å±‚é€»è¾‘ï¼‰</span></a></h3><p>åœ¨ç°ä»£ç¼–è¯‘å™¨ï¼ˆå¦‚ GCC/Clangï¼‰ä¸­ï¼ŒD å¯¹è±¡çš„å†…å­˜å¸ƒå±€å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li><strong>B å­å¯¹è±¡éƒ¨åˆ†</strong>ï¼šåŒ…å« <code>vptr_B</code>ï¼ˆD çš„ä¸»è™šæŒ‡é’ˆï¼Œå¤ç”¨ B çš„ä½ç½®ï¼‰å’Œ B çš„æˆå‘˜ã€‚</li><li><strong>C å­å¯¹è±¡éƒ¨åˆ†</strong>ï¼šåŒ…å« <code>vptr_C</code>ï¼ˆæ¬¡è™šæŒ‡é’ˆï¼‰å’Œ C çš„æˆå‘˜ã€‚</li><li><strong>D è‡ªå·±çš„æˆå‘˜</strong>ï¼šD æ–°å¢çš„å˜é‡ã€‚</li><li><strong>å…±äº«è™šåŸºç±» A éƒ¨åˆ†</strong>ï¼šè¢«æŒªåˆ°äº†å¯¹è±¡æœ«å°¾ï¼ŒåŒ…å« <code>vptr_A</code> å’Œ A çš„æˆå‘˜ã€‚ï¼ˆg++ä¸­è™šåŸºç±»å…±äº«ä¸»è™šè¡¨æŒ‡é’ˆ ä¼šä¼˜åŒ–æ‰ï¼‰</li></ol><h3 id="_4-è™šè¡¨ä¸è™šæŒ‡é’ˆ-vptr-vtable" tabindex="-1"><a class="header-anchor" href="#_4-è™šè¡¨ä¸è™šæŒ‡é’ˆ-vptr-vtable"><span>4. è™šè¡¨ä¸è™šæŒ‡é’ˆï¼ˆvptr &amp; vtableï¼‰</span></a></h3><ul><li><strong>è™šè¡¨ä¸ªæ•°</strong>ï¼šD å¯¹è±¡é€šå¸¸æœ‰ <strong>3 ä¸ªè™šæŒ‡é’ˆï¼ˆvptrï¼‰</strong>ï¼Œåˆ†åˆ«æŒ‡å‘ 3 ä¸ªä¸º D å®šåˆ¶çš„â€œå­è™šè¡¨â€ã€‚</li><li><strong>ä¸ºä»€ä¹ˆä¸åˆå¹¶æˆä¸€ä¸ª vptrï¼Ÿ</strong><ol><li><strong>æŒ‡é’ˆå…¼å®¹æ€§</strong>ï¼šå¿…é¡»ä¿è¯ <code>B*</code>ã€<code>C*</code> å’Œ <code>A*</code> æŒ‡å‘ D æ—¶ï¼Œå„è‡ªçœ‹åˆ°çš„å†…å­˜å¸ƒå±€ä¸å…¶åŸºç±»åŸå§‹å¸ƒå±€ä¸€è‡´ï¼ˆå¼€å¤´éƒ½æ˜¯ vptrï¼‰ã€‚</li><li><strong>ç´¢å¼•ä¸€è‡´æ€§</strong>ï¼šä¸åŒåŸºç±»çš„è™šå‡½æ•°åœ¨è™šè¡¨ä¸­çš„ç´¢å¼•å¯èƒ½å†²çªï¼Œå¿…é¡»åˆ†å¼€ã€‚</li></ol></li><li><strong>Thunk æŠ€æœ¯</strong>ï¼šåœ¨ <code>D-as-C</code> æˆ– <code>D-as-A</code> çš„è™šè¡¨ä¸­ï¼Œè‹¥è°ƒç”¨äº† D é‡å†™çš„å‡½æ•°ï¼Œè™šè¡¨å­˜çš„æ˜¯ Thunk åœ°å€ã€‚å…¶ä½œç”¨æ˜¯ï¼š<strong>ä¿®æ­£ <code>this</code> æŒ‡é’ˆçš„åç§»é‡</strong>ï¼Œä½¿å…¶ä»å­å¯¹è±¡ä½ç½®è·³å› D çš„èµ·å§‹ä½ç½®ï¼Œå†è·³è½¬åˆ°çœŸå®çš„å‡½æ•°ä»£ç ã€‚</li></ul><h3 id="_5-rtti-ä¸æŒ‡é’ˆè½¬æ¢" tabindex="-1"><a class="header-anchor" href="#_5-rtti-ä¸æŒ‡é’ˆè½¬æ¢"><span>5. RTTI ä¸æŒ‡é’ˆè½¬æ¢</span></a></h3><ul><li><strong>RTTI å½’å±</strong>ï¼šD å¯¹è±¡ä¸­æ‰€æœ‰çš„å­è™šè¡¨ï¼Œå…¶ RTTI æŒ‡é’ˆæœ€ç»ˆéƒ½æŒ‡å‘ <strong>D çš„ç±»å‹ä¿¡æ¯</strong>ã€‚</li><li><strong>dynamic_cast</strong>ï¼šä¾èµ– vptr æ‰¾åˆ°è™šè¡¨ï¼Œå†é€šè¿‡è™šè¡¨ä¸­çš„ RTTI å’Œ <code>offset-to-top</code>ï¼ˆåˆ°é¡¶éƒ¨çš„åç§»é‡ï¼‰ä¿¡æ¯ï¼Œå®ç°å®‰å…¨çš„ä¸Šä¸‹è¡Œè½¬æ¢ã€‚</li><li><strong>æ„é€ æœŸåˆ‡æ¢</strong>ï¼šåœ¨æ„é€  Aã€Bã€C æ—¶ï¼Œvptr ä¼šç»å†ä» A åˆ° B/C å†åˆ° D çš„â€œèº«ä»½åˆ‡æ¢â€ï¼Œå› æ­¤æ„é€ å‡½æ•°å†…è°ƒç”¨ <code>typeid</code> è¿”å›çš„æ˜¯å½“å‰æ„é€ ç±»çš„ç±»å‹ã€‚</li></ul><h3 id="_6-åˆå§‹åŒ–è§„åˆ™-åˆå§‹åŒ–åˆ—è¡¨" tabindex="-1"><a class="header-anchor" href="#_6-åˆå§‹åŒ–è§„åˆ™-åˆå§‹åŒ–åˆ—è¡¨"><span>6. åˆå§‹åŒ–è§„åˆ™ï¼ˆåˆå§‹åŒ–åˆ—è¡¨ï¼‰</span></a></h3><ul><li><strong>å”¯ä¸€åˆå§‹åŒ–æƒ</strong>ï¼šè™šåŸºç±» A ç”±<strong>æœ€åº•å±‚æ´¾ç”Ÿç±» D</strong> è´Ÿè´£åˆå§‹åŒ–ã€‚</li><li><strong>å±è”½æœºåˆ¶</strong>ï¼šå³ä¾¿ B å’Œ C çš„åˆå§‹åŒ–åˆ—è¡¨ä¸­å†™äº† A çš„æ„é€ å‡½æ•°ï¼Œå½“æ„é€  D æ—¶ï¼ŒB å’Œ C å¯¹ A çš„è°ƒç”¨ä¼šè¢«<strong>å¿½ç•¥</strong>ã€‚</li><li><strong>æ‰§è¡Œé¡ºåº</strong>ï¼š <ol><li>æœ€å…ˆæ‰§è¡Œè™šåŸºç±» <strong>A</strong> çš„æ„é€ ã€‚</li><li>æŒ‰å£°æ˜é¡ºåºæ‰§è¡Œ <strong>B</strong>ã€<strong>C</strong> çš„æ„é€ ã€‚</li><li>æœ€åæ‰§è¡Œ <strong>D</strong>ã€‚<br><em>ï¼ˆææ„é¡ºåºä¸ä¹‹å®Œå…¨ç›¸åï¼‰</em></li></ol></li></ul><h3 id="_7-æ€§èƒ½æƒè¡¡-trade-offs" tabindex="-1"><a class="header-anchor" href="#_7-æ€§èƒ½æƒè¡¡-trade-offs"><span>7. æ€§èƒ½æƒè¡¡ï¼ˆTrade-offsï¼‰</span></a></h3><ul><li><strong>ä¼˜ç‚¹</strong>ï¼šå½»åº•è§£å†³äº†è±å½¢ç»§æ‰¿çš„å†—ä½™å’ŒäºŒä¹‰æ€§ã€‚</li><li><strong>ç¼ºç‚¹</strong>ï¼š <ol><li><strong>å¯¹è±¡å˜å¤§</strong>ï¼šå¤šäº†é¢å¤–çš„ vptr å’Œè™šè¡¨åç§»ä¿¡æ¯ã€‚</li><li><strong>è®¿é—®å˜æ…¢</strong>ï¼šè®¿é—®è™šåŸºç±»æˆå‘˜éœ€è¦é€šè¿‡è™šè¡¨åšä¸€æ¬¡é—´æ¥å¯»å€ï¼ˆOffset æŸ¥æ‰¾ï¼‰ã€‚</li><li><strong>å¤æ‚æ€§å¢åŠ </strong>ï¼šå†…å­˜å¸ƒå±€å¤æ‚ï¼Œè°ƒè¯•éš¾åº¦é«˜ã€‚</li></ol></li></ul><hr><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" style="--shiki-light:#383A42;--shiki-dark:#abb2bf;--shiki-light-bg:#FAFAFA;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes one-light one-dark-pro vp-code"><code class="language-"><span class="line"><span>D å¯¹è±¡ï¼ˆå¤§å°ï¼š48 bytesï¼‰</span></span>
<span class="line"><span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ offset 0x00</span></span>
<span class="line"><span>â”‚ B å­å¯¹è±¡ï¼ˆ16 bytesï¼‰</span></span>
<span class="line"><span>â”‚   [0x00..0x07] vptr_B-in-D   â† æŒ‡å‘ D çš„ vtableï¼ˆB è§†å›¾ï¼‰</span></span>
<span class="line"><span>â”‚   [0x08..0x0B] int b = 2</span></span>
<span class="line"><span>â”‚   [0x0C..0x0F] padding</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ offset 0x10</span></span>
<span class="line"><span>â”‚ C å­å¯¹è±¡ï¼ˆ16 bytesï¼‰</span></span>
<span class="line"><span>â”‚   [0x10..0x17] vptr_C-in-D   â† æŒ‡å‘ D çš„ vtableï¼ˆC è§†å›¾ï¼‰</span></span>
<span class="line"><span>â”‚   [0x18..0x1B] int c = 3</span></span>
<span class="line"><span>â”‚   [0x1C..0x1F] int d = 4     â† D çš„æˆå‘˜å˜é‡è¢«ç´§è´´åœ¨æ­¤å¤„ï¼ˆå¤ç”¨ C å°¾éƒ¨ç©ºé—´ï¼‰</span></span>
<span class="line"><span>â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ offset 0x20</span></span>
<span class="line"><span>â”‚ A è™šåŸºå­å¯¹è±¡ï¼ˆ16 bytesï¼‰</span></span>
<span class="line"><span>â”‚   [0x20..0x27] vptr_A-in-D   â† æŒ‡å‘ D çš„ vtableï¼ˆA è§†å›¾ï¼‰</span></span>
<span class="line"><span>â”‚   [0x28..0x2B] int a = 1</span></span>
<span class="line"><span>â”‚   [0x2C..0x2F] padding</span></span>
<span class="line"><span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ sizeof(D) = 48</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></div><!----><!----><!----></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link vp-meta-label" href="https://github.com/yedou37/yedou37.github.io/edit/main/src/interview/cpp.md" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" rel="noopener noreferrer" target="_blank"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon" name="edit"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<!----></a></div><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">æœ€è¿‘æ›´æ–°: </span><time class="vp-meta-info" datetime="2026-02-13T13:37:57.000Z" data-allow-mismatch>2026/2/13 13:37</time></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: 137401103+yedou37@users.noreply.github.com">yedou37</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><!----><a class="route-link auto-link next" href="/interview/Leetcode.html" aria-label="Leetcode"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow end"></span></div><div class="link">Leetcode<!----></div></a></nav><!----><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper" vp-footer><div class="vp-footer">è®°å½•é¢è¯•å¤ä¹  & è¯¾ç¨‹å¤§ä½œä¸š</div><div class="vp-copyright">Copyright Â© 2026 yedou </div></footer></div><!--]--><!--]--><!--[--><!----><!--[--><!--]--><!--]--><!--]--></div>
    <script type="module" src="/assets/app-DErs339O.js" defer></script>
  </body>
</html>
